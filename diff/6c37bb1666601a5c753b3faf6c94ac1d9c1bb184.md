---
exclude: true
aside: false
footer: false
editLink: false
lastUpdated: false
description: 9 files modified.
version: EA 23.57 Nightly
changes: AI_Idle/ActEffect/BaseTileMap/CardRenderer/HitSummary/TraitBrewery/UIInventory/UIRecipeInfo/Widget
---

# EA 23.57 Nightly

December 15, 2024

9 files modified.

## Breaking Changes

None.
## AI_Idle

[`@@ -155,20 +155,20 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L155)
```cs:line-numbers=155
			Thing thing2 = owner.things.Find("polish_powder");
			if (thing2 != null && EClass._map.props.installed.Find<TraitGrindstone>() != null)
			{
				foreach (Thing thing7 in owner.things) // [!code --]
				foreach (Thing thing8 in owner.things) // [!code ++]
				{
					if (!thing7.IsEquipment || thing7.encLV >= 0) // [!code --]
					if (!thing8.IsEquipment || thing8.encLV >= 0) // [!code ++]
					{
						continue;
					}
					for (int i = 0; i < 5; i++)
					{
						if (thing7.encLV >= 0) // [!code --]
						if (thing8.encLV >= 0) // [!code ++]
						{
							break;
						}
						owner.Say("polish", owner, thing7); // [!code --]
						thing7.ModEncLv(1); // [!code --]
						owner.Say("polish", owner, thing8); // [!code ++]
						thing8.ModEncLv(1); // [!code ++]
						thing2.ModNum(-1);
						if (thing2.isDestroyed)
						{
```

[`@@ -192,6 +192,17 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L192)
```cs:line-numbers=192
				});
				yield return Restart();
			}
			if (EClass.rnd(20) == 0) // [!code ++]
			{ // [!code ++]
				Thing thing3 = owner.things.Find((Thing a) => a.parent == owner && a.isGifted && (a.category.id == "skillbook" || a.category.id == "ancientbook")); // [!code ++]
				if (thing3 != null && thing3.trait.CanRead(owner)) // [!code ++]
				{ // [!code ++]
					yield return Do(new AI_Read // [!code ++]
					{ // [!code ++]
						target = thing3 // [!code ++]
					}); // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (EClass.rnd(100) == 0 && !EClass._zone.IsRegion && owner.HasElement(1227))
			{
				List<Chara> list2 = new List<Chara>();
```

[`@@ -388,7 +399,7 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L388)
```cs:line-numbers=388
		}
		else if (EClass.player.stats.turns > owner.turnLastSeen + 50 && Los.IsVisible(EClass.pc, owner) && owner.CanSee(EClass.pc))
		{
			if (EClass.rnd(5) == 0 && owner.hostility >= Hostility.Neutral && EClass.pc.IsPCC && EClass.pc.pccData.state == PCCState.Undie) // [!code --]
			if (EClass.rnd(5) == 0 && owner.hostility >= Hostility.Neutral && EClass.pc.IsPCC && EClass.pc.pccData.state == PCCState.Undie && EClass.pc.pos.cell.IsTopWaterAndNoSnow) // [!code ++]
			{
				owner.Talk("pervert3");
			}
```

[`@@ -426,9 +437,9 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L426)
```cs:line-numbers=426
		{
			if (owner.noMove)
			{
				foreach (Thing thing8 in owner.pos.Things) // [!code --]
				foreach (Thing thing9 in owner.pos.Things) // [!code ++]
				{
					if (thing8.IsInstalled && thing8.trait is TraitGeneratorWheel) // [!code --]
					if (thing9.IsInstalled && thing9.trait is TraitGeneratorWheel) // [!code ++]
					{
						owner.Talk("labor");
						owner.PlayAnime(AnimeID.Shiver);
```

[`@@ -478,19 +489,19 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L478)
```cs:line-numbers=478
	}
	if (EClass.rnd(2000) == 0 && owner.IsHuman && (owner.host == null || owner.host.ride != owner))
	{
		Thing thing3 = owner.things.Find((Thing a) => !a.IsNegativeGift && a.trait.CanDrink(owner), recursive: false); // [!code --]
		if (thing3 != null && thing3.trait is TraitPotion && owner.IsPCParty) // [!code --]
		Thing thing4 = owner.things.Find((Thing a) => !a.IsNegativeGift && a.trait.CanDrink(owner), recursive: false); // [!code ++]
		if (thing4 != null && thing4.trait is TraitPotion && owner.IsPCParty) // [!code ++]
		{
			thing3 = null; // [!code --]
			thing4 = null; // [!code ++]
		}
		if (thing3 == null && (owner.homeBranch == null || !owner.homeBranch.policies.IsActive(2503))) // [!code --]
		if (thing4 == null && (owner.homeBranch == null || !owner.homeBranch.policies.IsActive(2503))) // [!code ++]
		{
			thing3 = ThingGen.Create("crimAle"); // [!code --]
			owner.Drink(thing3); // [!code --]
			thing4 = ThingGen.Create("crimAle"); // [!code ++]
			owner.Drink(thing4); // [!code ++]
		}
		if (thing3 != null && !thing3.isDestroyed) // [!code --]
		if (thing4 != null && !thing4.isDestroyed) // [!code ++]
		{
			owner.TryUse(thing3); // [!code --]
			owner.TryUse(thing4); // [!code ++]
			yield return Restart();
		}
	}
```

[`@@ -610,8 +621,8 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L610)
```cs:line-numbers=610
	}
	if (EClass.rnd(EClass.debug.enable ? 3 : 30) == 0)
	{
		Thing thing4 = owner.things.Find<TraitBall>(); // [!code --]
		if (thing4 == null) // [!code --]
		Thing thing5 = owner.things.Find<TraitBall>(); // [!code ++]
		if (thing5 == null) // [!code ++]
		{
			owner.pos.ForeachNeighbor(delegate(Point p)
			{
```

[`@@ -628,7 +639,7 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L628)
```cs:line-numbers=628
			{
				if (EClass.rnd(3) != 0 && chara4 != owner && chara4.Dist(owner) <= 6 && chara4.Dist(owner) >= 3 && Los.IsVisible(chara4, owner))
				{
					ActThrow.Throw(owner, chara4.pos, thing4); // [!code --]
					ActThrow.Throw(owner, chara4.pos, thing5); // [!code ++]
					break;
				}
			}
```

[`@@ -683,26 +694,26 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L683)
```cs:line-numbers=683
			{
				break;
			}
			List<Thing> list3 = owner.things.List((Thing a) => a.parent == owner && (a.category.id == "spellbook" || a.category.id == "ancientbook" || a.category.id == "skillbook")); // [!code --]
			Thing thing5 = null; // [!code --]
			List<Thing> list3 = owner.things.List((Thing a) => a.parent == owner && (a.category.id == "spellbook" || a.category.id == "ancientbook" || a.category.id == "skillbook"), onlyAccessible: true); // [!code ++]
			Thing thing6 = null; // [!code ++]
			if (list3.Count > 0)
			{
				thing5 = list3.RandomItem(); // [!code --]
				if (!thing5.trait.CanRead(owner)) // [!code --]
				thing6 = list3.RandomItem(); // [!code ++]
				if (!thing6.trait.CanRead(owner)) // [!code ++]
				{
					thing5 = null; // [!code --]
					thing6 = null; // [!code ++]
				}
			}
			if (thing5 == null) // [!code --]
			if (thing6 == null) // [!code ++]
			{
				if (owner.things.IsFull())
				{
					break;
				}
				thing5 = ThingGen.CreateFromCategory((EClass.rnd(5) != 0) ? "spellbook" : "ancientbook"); // [!code --]
				thing5.isNPCProperty = true; // [!code --]
				thing6 = ThingGen.CreateFromCategory((EClass.rnd(5) != 0) ? "spellbook" : "ancientbook"); // [!code ++]
				thing6.isNPCProperty = true; // [!code ++]
			}
			if (!(thing5.id == "1084") || !owner.IsPCFaction) // [!code --]
			if (!(thing6.id == "1084") || !owner.IsPCFaction) // [!code ++]
			{
				if (!owner.HasElement(285))
				{
```

[`@@ -710,7 +721,7 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L710)
```cs:line-numbers=710
				}
				yield return Do(new AI_Read
				{
					target = thing5 // [!code --]
					target = thing6 // [!code ++]
				});
			}
			break;
```

[`@@ -772,10 +783,10 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/AI_Idle.cs#L772)
```cs:line-numbers=772
	}
	if (EClass.rnd(100) == 0 && owner.id == "bee")
	{
		Thing thing6 = EClass._map.ListThing<TraitBeekeep>()?.RandomItem(); // [!code --]
		if (thing6 != null) // [!code --]
		Thing thing7 = EClass._map.ListThing<TraitBeekeep>()?.RandomItem(); // [!code ++]
		if (thing7 != null) // [!code ++]
		{
			yield return DoGoto(thing6.pos); // [!code --]
			yield return DoGoto(thing7.pos); // [!code ++]
		}
	}
	string aiIdle = owner.source.aiIdle;
```

## ActEffect

[`@@ -894,9 +894,9 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L894)
```cs:line-numbers=894
		TC.PlaySound("curse3");
		TC.PlayEffect("curse");
		TC.Say("forgetItems", TC);
		int num5 = power / 50 + 1 + EClass.rnd(3); // [!code --]
		int num3 = power / 50 + 1 + EClass.rnd(3); // [!code ++]
		List<Thing> source = TC.things.List((Thing t) => t.c_IDTState == 0);
		for (int j = 0; j < num5; j++) // [!code --]
		for (int j = 0; j < num3; j++) // [!code ++]
		{
			source.RandomItem().c_IDTState = 5;
		}
```

[`@@ -908,10 +908,10 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L908)
```cs:line-numbers=908
	case EffectId.EnchantArmorGreat:
	{
		bool armor = id == EffectId.EnchantArmor || id == EffectId.EnchantArmorGreat;
		bool flag2 = id == EffectId.EnchantWeaponGreat || id == EffectId.EnchantArmorGreat; // [!code --]
		bool flag3 = id == EffectId.EnchantWeaponGreat || id == EffectId.EnchantArmorGreat; // [!code ++]
		if (!tc.isThing)
		{
			LayerDragGrid.CreateEnchant(CC, armor, flag2, state); // [!code --]
			LayerDragGrid.CreateEnchant(CC, armor, flag3, state); // [!code ++]
			return;
		}
		cc.PlaySound("identify");
```

[`@@ -922,8 +922,8 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L922)
```cs:line-numbers=922
			tc.ModEncLv(-1);
			break;
		}
		int num = (flag2 ? 4 : 2) + (blessed ? 1 : 0); // [!code --]
		if (tc.encLV >= num) // [!code --]
		int num4 = (flag3 ? 4 : 2) + (blessed ? 1 : 0); // [!code ++]
		if (tc.encLV >= num4) // [!code ++]
		{
			cc.Say("enc_resist", tc);
			break;
```

[`@@ -959,17 +959,17 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L959)
```cs:line-numbers=959
			LayerDragGrid.CreateUncurse(CC, state);
			return;
		}
		Thing thing3 = tc.Thing; // [!code --]
		if (thing3.blessedState == BlessedState.Cursed) // [!code --]
		Thing thing2 = tc.Thing; // [!code ++]
		if (thing2.blessedState == BlessedState.Cursed) // [!code ++]
		{
			thing3.SetBlessedState(BlessedState.Normal); // [!code --]
			thing2.SetBlessedState(BlessedState.Normal); // [!code ++]
		}
		else if (thing3.blessedState == BlessedState.Doomed) // [!code --]
		else if (thing2.blessedState == BlessedState.Doomed) // [!code ++]
		{
			thing3.SetBlessedState(BlessedState.Normal); // [!code --]
			thing2.SetBlessedState(BlessedState.Normal); // [!code ++]
		}
		thing3.GetRootCard()?.TryStack(thing3); // [!code --]
		LayerInventory.SetDirty(thing3); // [!code --]
		thing2.GetRootCard()?.TryStack(thing2); // [!code ++]
		LayerInventory.SetDirty(thing2); // [!code ++]
		break;
	}
	case EffectId.Lighten:
```

[`@@ -985,7 +985,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L985)
```cs:line-numbers=985
		}
		cc.PlaySound("offering");
		cc.PlayEffect("buff");
		int num4 = (tc.isWeightChanged ? tc.c_weight : tc.Thing.source.weight); // [!code --]
		int num5 = (tc.isWeightChanged ? tc.c_weight : tc.Thing.source.weight); // [!code ++]
		tc.isWeightChanged = true;
		Element orCreateElement = tc.elements.GetOrCreateElement(64);
		Element orCreateElement2 = tc.elements.GetOrCreateElement(65);
```

[`@@ -994,10 +994,10 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L994)
```cs:line-numbers=994
		bool flag5 = tc.IsEquipmentOrRanged || tc.IsThrownWeapon || tc.IsAmmo;
		if (flag)
		{
			num4 = (int)(0.01f * (float)num4 * (float)power * 0.75f + 500f); // [!code --]
			if (num4 < 1) // [!code --]
			num5 = (int)(0.01f * (float)num5 * (float)power * 0.75f + 500f); // [!code ++]
			if (num5 < 1) // [!code ++]
			{
				num4 = 1; // [!code --]
				num5 = 1; // [!code ++]
			}
			if (flag5)
			{
```

[`@@ -1016,7 +1016,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1016)
```cs:line-numbers=1016
		}
		else
		{
			num4 = num4 * (100 - power / 10) / 100; // [!code --]
			num5 = num5 * (100 - power / 10) / 100; // [!code ++]
			if (blessed)
			{
				power /= 4;
```

[`@@ -1036,7 +1036,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1036)
```cs:line-numbers=1036
			}
			cc.Say("lighten", cc, tc);
		}
		tc.c_weight = num4; // [!code --]
		tc.c_weight = num5; // [!code ++]
		tc.SetDirtyWeight();
		if (tc.parent == null)
		{
```

[`@@ -1060,13 +1060,13 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1060)
```cs:line-numbers=1060
		cc.PlayEffect("identify");
		cc.Say("reconstruct", cc, tc);
		EClass.game.cards.uidNext += EClass.rnd(30);
		Thing thing2 = ThingGen.Create(tc.id, -1, tc.LV * power / 100); // [!code --]
		thing2.SetBlessedState(state); // [!code --]
		Thing thing3 = ThingGen.Create(tc.id, -1, tc.LV * power / 100); // [!code ++]
		thing3.SetBlessedState(state); // [!code ++]
		tc.Destroy();
		CC.Pick(thing2, msg: false); // [!code --]
		CC.Pick(thing3, msg: false); // [!code ++]
		if (!CC.IsPC)
		{
			CC.TryEquip(thing2); // [!code --]
			CC.TryEquip(thing3); // [!code ++]
		}
		break;
	}
```

[`@@ -1087,28 +1087,28 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1087)
```cs:line-numbers=1087
		string name = tc.Name;
		if (row == null)
		{
			bool num2 = id == EffectId.ChangeMaterialGreater; // [!code --]
			bool flag3 = id == EffectId.ChangeMaterialLesser; // [!code --]
			bool num = id == EffectId.ChangeMaterialGreater; // [!code ++]
			bool flag2 = id == EffectId.ChangeMaterialLesser; // [!code ++]
			string text2 = tc.Thing.source.tierGroup;
			Dictionary<string, SourceMaterial.TierList> tierMap = SourceMaterial.tierMap;
			int num3 = 1; // [!code --]
			int num2 = 1; // [!code ++]
			if (flag)
			{
				num3 -= 2; // [!code --]
				num2 -= 2; // [!code ++]
			}
			if (blessed)
			{
				num3++; // [!code --]
				num2++; // [!code ++]
			}
			if (num2) // [!code --]
			if (num) // [!code ++]
			{
				num3++; // [!code --]
				num2++; // [!code ++]
			}
			if (flag3) // [!code --]
			if (flag2) // [!code ++]
			{
				num3 -= 2; // [!code --]
				num2 -= 2; // [!code ++]
			}
			num3 = Mathf.Clamp(num3 + EClass.rnd(2), 0, 4); // [!code --]
			num2 = Mathf.Clamp(num2 + EClass.rnd(2), 0, 4); // [!code ++]
			if (EClass.rnd(10) == 0)
			{
				text2 = ((text2 == "metal") ? "leather" : "metal");
```

[`@@ -1116,7 +1116,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1116)
```cs:line-numbers=1116
			SourceMaterial.TierList tierList = (text2.IsEmpty() ? tierMap.RandomItem() : tierMap[text2]);
			for (int i = 0; i < 1000; i++)
			{
				row = tierList.tiers[num3].Select(); // [!code --]
				row = tierList.tiers[num2].Select(); // [!code ++]
				if (row != tc.material)
				{
					break;
```

[`@@ -1125,11 +1125,14 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/ActEffect.cs#L1125)
```cs:line-numbers=1125
		}
		cc.PlaySound("offering");
		cc.PlayEffect("buff");
		foreach (Element item2 in tc.elements.dict.Values.ToList()) // [!code --]
		if (tc.id == "log" && tc.material.alias == "carbone") // [!code ++]
		{
			if (item2.IsTrait && item2.vBase != 0) // [!code --]
			foreach (Element item2 in tc.elements.dict.Values.ToList()) // [!code ++]
			{
				tc.elements.ModBase(item2.id, -item2.vBase); // [!code --]
				if (item2.IsTrait && item2.vBase != 0) // [!code ++]
				{ // [!code ++]
					tc.elements.ModBase(item2.id, -item2.vBase); // [!code ++]
				} // [!code ++]
			}
		}
		tc.ChangeMaterial(row);
```

## BaseTileMap

[`@@ -1254,7 +1254,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L1254)
```cs:line-numbers=1254
			fogged = true;
		}
	}
	goto IL_7a63; // [!code --]
	goto IL_7a73; // [!code ++]
	IL_1668:
	if (this.cell.isSlopeEdge)
	{
```

[`@@ -1859,7 +1859,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L1859)
```cs:line-numbers=1859
	}
	if (!buildMode && this.cell.highlight != 0)
	{
		if (this.cell._block != 0) // [!code --]
		if (this.cell._block != 0 && !this.cell.hasDoor) // [!code ++]
		{
			screen.guide.DrawWall(this.cell.GetPoint(), EMono.Colors.blockColors.MapHighlight, useMarkerPass: true);
		}
```

[`@@ -2449,239 +2449,31 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2449)
```cs:line-numbers=2449
	{
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof)
		{
			goto IL_6f59; // [!code --]
			goto IL_6f69; // [!code ++]
		}
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock)
		{
			Room obj = this.cell.FrontRight.room;
			if (obj == null || !obj.HasRoof)
			{
				goto IL_6f59; // [!code --]
				goto IL_6f69; // [!code ++]
			}
		}
	}
	goto IL_6fb9; // [!code --]
	IL_6fb9: // [!code --]
	if (this.cell.effect != null) // [!code --]
	{ // [!code --]
		if (this.cell.effect.IsLiquid) // [!code --]
		{ // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code --]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code --]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code --]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code --]
			param.mat = defaultMaterial; // [!code --]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code --]
			sourceEffect.renderData.Draw(param); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code --]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code --]
			if (sourceEffect2.anime.Length != 0) // [!code --]
			{ // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code --]
				{ // [!code --]
					float num19 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code --]
					if (!(num19 >= (float)sourceEffect2.anime[0])) // [!code --]
					{ // [!code --]
						param.tile += num19; // [!code --]
					} // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					float num20 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code --]
					param.tile += num20; // [!code --]
				} // [!code --]
			} // [!code --]
			if (this.cell.effect.IsFire) // [!code --]
			{ // [!code --]
				rendererEffect.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				this.cell.effect.source.renderData.Draw(param); // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	param.color = floorLight; // [!code --]
	if (this.cell.critter != null) // [!code --]
	{ // [!code --]
		Critter critter = this.cell.critter; // [!code --]
		int snowTile = critter.tile; // [!code --]
		if (snowed && critter.SnowTile != 0) // [!code --]
		{ // [!code --]
			critter.x = 0.06f; // [!code --]
			critter.y = -0.06f; // [!code --]
			snowTile = critter.SnowTile; // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			critter.Update(); // [!code --]
		} // [!code --]
		pass = passObjSS; // [!code --]
		batch = pass.batches[pass.batchIdx]; // [!code --]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m23 = param.z; // [!code --]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code --]
		batch.colors[pass.idx] = floorLight; // [!code --]
		pass.idx++; // [!code --]
		if (pass.idx == pass.batchSize) // [!code --]
		{ // [!code --]
			pass.NextBatch(); // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail != null) // [!code --]
	{ // [!code --]
		TransAnime anime3 = detail.anime; // [!code --]
		if (anime3 != null && !anime3.animeBlock) // [!code --]
		{ // [!code --]
			TransAnime anime4 = detail.anime; // [!code --]
			param.x += anime4.v.x; // [!code --]
			param.y += anime4.v.y; // [!code --]
			param.z += anime4.v.z; // [!code --]
		} // [!code --]
	} // [!code --]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code --]
	{ // [!code --]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code --]
		if (!snowed || sourceObj.snowTile <= 0) // [!code --]
		{ // [!code --]
			param.snow = snowed; // [!code --]
			param.mat = this.cell.matObj; // [!code --]
			orgY = param.y; // [!code --]
			if (param.liquidLv > 0) // [!code --]
			{ // [!code --]
				if (sourceObj.pref.Float) // [!code --]
				{ // [!code --]
					param.y += 0.01f * floatY; // [!code --]
					if (liquidLv > 10) // [!code --]
					{ // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
					} // [!code --]
					liquidLv -= (int)(floatY * 0.5f); // [!code --]
					param.liquidLv = liquidLv; // [!code --]
				} // [!code --]
				if (sourceObj.tileType.IsWaterTop) // [!code --]
				{ // [!code --]
					param.liquidLv = 0; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					{ // [!code --]
						param.liquid = 1f; // [!code --]
					} // [!code --]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code --]
					{ // [!code --]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code --]
					} // [!code --]
				} // [!code --]
			} // [!code --]
			if (sourceObj.useAltColor) // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			if (sourceObj.HasGrowth) // [!code --]
			{ // [!code --]
				this.cell.growth.OnRenderTileMap(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				if (this.cell.autotileObj != 0) // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code --]
				} // [!code --]
				else if (sourceObj.tileType.IsUseBlockDir) // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code --]
				} // [!code --]
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code --]
				{ // [!code --]
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code --]
				} // [!code --]
				orgY = param.y; // [!code --]
				orgZ = param.z; // [!code --]
				param.y += sourceObj.pref.y; // [!code --]
				param.z += sourceObj.pref.z; // [!code --]
				sourceObj.renderData.Draw(param); // [!code --]
				param.y = orgY; // [!code --]
				param.z = orgZ; // [!code --]
				int shadow3 = sourceObj.pref.shadow; // [!code --]
				if (shadow3 > 1 && !this.cell.ignoreObjShadow) // [!code --]
				{ // [!code --]
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow3], sourceObj.pref, 0, param.snow); // [!code --]
				} // [!code --]
				param.y = orgY; // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code --]
	{ // [!code --]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code --]
	} // [!code --]
	if (highlightCells) // [!code --]
	{ // [!code --]
		switch (ActionMode.FlagCell.mode) // [!code --]
		{ // [!code --]
		case AM_FlagCell.Mode.flagWallPillar: // [!code --]
			if (this.cell.isToggleWallPillar) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagSnow: // [!code --]
			if (this.cell.isClearSnow) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagFloat: // [!code --]
			if (this.cell.isForceFloat) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagClear: // [!code --]
			if (this.cell.isClearArea) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail == null) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	if (highlightArea && detail.area != null) // [!code --]
	{ // [!code --]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code --]
	} // [!code --]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code --]
	goto IL_6fc9; // [!code ++]
	IL_6f69: // [!code ++]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code ++]
	{
		param.tile = detail.footmark.tile; // [!code --]
		param.mat = matFloor; // [!code --]
		param.matColor = 104025f; // [!code --]
		renderFootmark.Draw(param); // [!code --]
		param.tile = num12; // [!code ++]
		rendererFov.Draw(param); // [!code ++]
	}
	goto IL_7a63; // [!code --]
	IL_7a63: // [!code --]
	goto IL_6fc9; // [!code ++]
	IL_7a73: // [!code ++]
	if (detail.things.Count == 0 && detail.charas.Count == 0)
	{
		return;
	}
	int num21 = 0; // [!code --]
	int num19 = 0; // [!code ++]
	thingPos.x = 0f;
	thingPos.y = 0f;
	thingPos.z = 0f;
```

[`@@ -2711,17 +2503,17 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2711)
```cs:line-numbers=2711
		param.y -= TileType.FloorWaterShallow.FloorHeight;
	}
	Thing thing = null;
	bool shadow4 = liquidLv == 0; // [!code --]
	float num22 = 0f; // [!code --]
	float num23 = 0f; // [!code --]
	bool shadow3 = liquidLv == 0; // [!code ++]
	float num20 = 0f; // [!code ++]
	float num21 = 0f; // [!code ++]
	bool flag10 = false;
	float num24 = 0f; // [!code --]
	float num22 = 0f; // [!code ++]
	bool flag11 = false;
	float num25 = 0f; // [!code --]
	float num23 = 0f; // [!code ++]
	if (detail.things.Count > 0 && isSeen)
	{
		_ = zSetting.max1;
		float num26 = 0f; // [!code --]
		float num24 = 0f; // [!code ++]
		for (int m = 0; m < detail.things.Count; m++)
		{
			Thing t = detail.things[m];
```

[`@@ -2736,12 +2528,12 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2736)
```cs:line-numbers=2736
			{
				pref = rendererObjDummy.shadowPref;
			}
			float num27 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code --]
			float num25 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code ++]
			if (t.ignoreStackHeight)
			{
				thingPos.y -= num22; // [!code --]
				thingPos.y -= num20; // [!code ++]
			}
			shadow4 = thingPos.y < 0.16f && num25 < 0.16f; // [!code --]
			shadow3 = thingPos.y < 0.16f && num23 < 0.16f; // [!code ++]
			_ = pref.bypassShadow;
			param.shadowFix = 0f - thingPos.y;
			param.liquidLv = ((thingPos.y + (float)t.altitude < 0.1f) ? liquidLv : 0);
```

[`@@ -2751,20 +2543,20 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2751)
```cs:line-numbers=2751
				SetRoofHeight(param, this.cell, cx, cz);
				_actorPos.x = param.x;
				_actorPos.y = param.y;
				_actorPos.z = param.z + num26; // [!code --]
				_actorPos.z = param.z + num24; // [!code ++]
				if (this.room != null)
				{
					param.color = GetRoofLight(this.room.lot);
				}
				shadow4 = false; // [!code --]
				shadow3 = false; // [!code ++]
				param.liquidLv = 0;
			}
			else
			{
				param.snow = snowed;
				_actorPos.x = orgX + num23; // [!code --]
				_actorPos.x = orgX + num21; // [!code ++]
				_actorPos.y = orgY;
				_actorPos.z = orgZ + num26 + thingPos.z; // [!code --]
				_actorPos.z = orgZ + num24 + thingPos.z; // [!code ++]
				if (tileType.CanStack || !isInstalled)
				{
					if (thing?.id != t.id)
```

[`@@ -2774,7 +2566,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2774)
```cs:line-numbers=2774
					_actorPos.y += thingPos.y;
					if (t.trait.IgnoreLastStackHeight && (thing == null || !thing.trait.IgnoreLastStackHeight))
					{
						_actorPos.y -= num22; // [!code --]
						_actorPos.y -= num20; // [!code ++]
					}
					_actorPos.z += renderSetting.thingZ + (float)m * -0.01f + zSetting.mod1 * thingPos.y;
				}
```

[`@@ -2791,7 +2583,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2791)
```cs:line-numbers=2791
						freePos.z += rampFix2.z;
						if (!this.cell.IsTopWater || t.altitude > 0)
						{
							num25 += rampFix2.y; // [!code --]
							num23 += rampFix2.y; // [!code ++]
						}
						liquidLv -= (int)(rampFix2.y * 150f);
						if (liquidLv < 0)
```

[`@@ -2801,17 +2593,17 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2801)
```cs:line-numbers=2801
					}
					else if (!flag11 && t.trait.IsChangeFloorHeight)
					{
						orgY += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
						orgY += num25 + (float)t.altitude * altitudeFix.y; // [!code ++]
						orgZ += (float)t.altitude * altitudeFix.z;
						freePos.y += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
						freePos.y += num25 + (float)t.altitude * altitudeFix.y; // [!code ++]
						if (!this.cell.IsTopWater || t.altitude > 0)
						{
							num25 += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
							num23 += num25 + (float)t.altitude * altitudeFix.y; // [!code ++]
						}
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1));
						_actorPos.z += pref.z;
						thingPos.z += pref.z;
						liquidLv -= (int)(num27 * 150f); // [!code --]
						liquidLv -= (int)(num25 * 150f); // [!code ++]
						if (liquidLv < 0)
						{
							liquidLv = 0;
```

[`@@ -2819,7 +2611,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2819)
```cs:line-numbers=2819
					}
					else
					{
						thingPos.y += num27; // [!code --]
						thingPos.y += num25; // [!code ++]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1));
						_actorPos.z += pref.z;
						if (pref.height >= 0f)
```

[`@@ -2834,7 +2626,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2834)
```cs:line-numbers=2834
				}
				else
				{
					thingPos.y += num27; // [!code --]
					thingPos.y += num25; // [!code ++]
					_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1));
					_actorPos.z += pref.z;
					thingPos.z += pref.z;
```

[`@@ -2842,10 +2634,10 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2842)
```cs:line-numbers=2842
				if (t.isFloating && isWater && !hasBridge && !flag)
				{
					flag = true;
					float num28 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
					orgY += 0.01f * floatY - num28; // [!code --]
					num24 = num27; // [!code --]
					_actorPos.y += 0.01f * floatY - num28; // [!code --]
					float num26 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
					orgY += 0.01f * floatY - num26; // [!code ++]
					num22 = num25; // [!code ++]
					_actorPos.y += 0.01f * floatY - num26; // [!code ++]
					if (liquidLv > 10)
					{
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10;
```

[`@@ -2857,10 +2649,10 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2857)
```cs:line-numbers=2857
					}
					param.liquidLv = liquidLv;
				}
				num22 = num27; // [!code --]
				num20 = num25; // [!code ++]
				if (t.sourceCard.multisize && !t.trait.IsGround)
				{
					num26 += zSetting.multiZ; // [!code --]
					num24 += zSetting.multiZ; // [!code ++]
				}
				orgZ += t.renderer.data.stackZ;
				if (param.liquidLv > 0)
```

[`@@ -2905,7 +2697,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2905)
```cs:line-numbers=2905
					flag10 = true;
				}
				tileType.GetMountHeight(ref _actorPos, Point.shared.Set(index), t.dir, t);
				shadow4 = false; // [!code --]
				shadow3 = false; // [!code ++]
				param.liquidLv = 0;
				if (t.freePos)
				{
```

[`@@ -2937,35 +2729,35 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2937)
```cs:line-numbers=2937
			{
				if (iconMode != 0)
				{
					int num29 = 0; // [!code --]
					int num27 = 0; // [!code ++]
					switch (iconMode)
					{
					case CardIconMode.Visibility:
						if (t.isMasked)
						{
							num29 = 17; // [!code --]
							num27 = 17; // [!code ++]
						}
						break;
					case CardIconMode.State:
						if (t.placeState == PlaceState.installed)
						{
							num29 = 18; // [!code --]
							num27 = 18; // [!code ++]
						}
						break;
					case CardIconMode.Deconstruct:
						if (t.isDeconstructing)
						{
							num29 = 14; // [!code --]
							num27 = 14; // [!code ++]
						}
						break;
					}
					if (t.isNPCProperty && !EMono.debug.godBuild)
					{
						num29 = 13; // [!code --]
						num27 = 13; // [!code ++]
					}
					if (num29 != 0) // [!code --]
					if (num27 != 0) // [!code ++]
					{
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num29); // [!code --]
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num27); // [!code ++]
					}
				}
				t.SetRenderParam(param);
```

[`@@ -2982,17 +2774,17 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L2982)
```cs:line-numbers=2982
						_actorPos.x = EMono.pc.renderer.position.x;
						_actorPos.y = EMono.pc.renderer.position.y - pref.height;
						_actorPos.z = EMono.pc.renderer.position.z + 0.02f;
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow4 || tileType.AlwaysShowShadow)); // [!code --]
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow3 || tileType.AlwaysShowShadow)); // [!code ++]
					});
				}
				else
				{
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow4 || tileType.AlwaysShowShadow)); // [!code --]
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow3 || tileType.AlwaysShowShadow)); // [!code ++]
				}
			}
			if (isInstalled)
			{
				num23 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
				num21 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
			}
			param.x = orgX;
			param.y = orgY;
```

[`@@ -3005,12 +2797,12 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L3005)
```cs:line-numbers=3005
			}
		}
	}
	orgY += num24; // [!code --]
	orgY += num22; // [!code ++]
	if (detail.charas.Count <= 0)
	{
		return;
	}
	param.shadowFix = 0f - num25; // [!code --]
	param.shadowFix = 0f - num23; // [!code ++]
	param.color += 1310720f;
	float max = zSetting.max2;
	for (int n = 0; n < detail.charas.Count; n++)
```

[`@@ -3035,9 +2827,9 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L3035)
```cs:line-numbers=3035
				{
					Vector3 position = restrainer.owner.renderer.position;
					float defCharaHeight = EMono.setting.render.defCharaHeight;
					float num30 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code --]
					float num28 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code ++]
					_actorPos.x = position.x + getRestrainPos.x * (float)((restrainer.owner.dir % 2 == 0) ? 1 : (-1));
					_actorPos.y = position.y + num30; // [!code --]
					_actorPos.y = position.y + num28; // [!code ++]
					_actorPos.z = position.z + getRestrainPos.z;
					param.liquidLv = 0;
					param.shadowFix = orgY - _actorPos.y;
```

[`@@ -3052,22 +2844,22 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L3052)
```cs:line-numbers=3052
		{
			if (chara.IsDeadOrSleeping && chara.IsPCC)
			{
				float num31 = chara.renderer.data.size.y * 0.3f; // [!code --]
				float num29 = chara.renderer.data.size.y * 0.3f; // [!code ++]
				if (thingPos.y > max)
				{
					thingPos.y = max;
				}
				float num32 = thingPos.y + num31; // [!code --]
				float num33 = (float)n * -0.01f; // [!code --]
				if (num32 > zSetting.thresh1) // [!code --]
				float num30 = thingPos.y + num29; // [!code ++]
				float num31 = (float)n * -0.01f; // [!code ++]
				if (num30 > zSetting.thresh1) // [!code ++]
				{
					num33 = zSetting.mod1; // [!code --]
					num31 = zSetting.mod1; // [!code ++]
				}
				_actorPos.x += thingPos.x;
				_actorPos.y += thingPos.y;
				_actorPos.z += renderSetting.laydownZ + num33; // [!code --]
				_actorPos.z += renderSetting.laydownZ + num31; // [!code ++]
				param.liquidLv = ((thingPos.y == 0f && liquidLv > 0) ? 90 : 0);
				thingPos.y += num31 * 0.8f; // [!code --]
				thingPos.y += num29 * 0.8f; // [!code ++]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0);
			}
			else
```

[`@@ -3087,10 +2879,10 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L3087)
```cs:line-numbers=3087
				}
				if (!chara.IsPC && !chara.renderer.IsMoving && detail.charas.Count > 1 && (detail.charas.Count != 2 || !detail.charas[0].IsDeadOrSleeping || !detail.charas[0].IsPCC))
				{
					_actorPos += renderSetting.charaPos[1 + ((num21 < 4) ? num21 : 3)]; // [!code --]
					_actorPos += renderSetting.charaPos[1 + ((num19 < 4) ? num19 : 3)]; // [!code ++]
				}
				_actorPos.z += 0.01f * (float)n + renderSetting.charaZ;
				num21++; // [!code --]
				num19++; // [!code ++]
				if (flag10)
				{
					_actorPos.z += chara.renderer.data.hangedFixZ;
```

[`@@ -3103,13 +2895,221 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/BaseTileMap.cs#L3103)
```cs:line-numbers=3103
		param.z = orgZ;
	}
	return;
	IL_6f59: // [!code --]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code --]
	IL_6fc9: // [!code ++]
	if (this.cell.effect != null) // [!code ++]
	{
		param.tile = num12; // [!code --]
		rendererFov.Draw(param); // [!code --]
		if (this.cell.effect.IsLiquid) // [!code ++]
		{ // [!code ++]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code ++]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code ++]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code ++]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code ++]
			param.mat = defaultMaterial; // [!code ++]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code ++]
			sourceEffect.renderData.Draw(param); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			param.tile = this.cell.effect.source._tiles[0]; // [!code ++]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code ++]
			if (sourceEffect2.anime.Length != 0) // [!code ++]
			{ // [!code ++]
				if (sourceEffect2.anime.Length > 2) // [!code ++]
				{ // [!code ++]
					float num32 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code ++]
					if (!(num32 >= (float)sourceEffect2.anime[0])) // [!code ++]
					{ // [!code ++]
						param.tile += num32; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					float num33 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code ++]
					param.tile += num33; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (this.cell.effect.IsFire) // [!code ++]
			{ // [!code ++]
				rendererEffect.Draw(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				this.cell.effect.source.renderData.Draw(param); // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	param.color = floorLight; // [!code ++]
	if (this.cell.critter != null) // [!code ++]
	{ // [!code ++]
		Critter critter = this.cell.critter; // [!code ++]
		int snowTile = critter.tile; // [!code ++]
		if (snowed && critter.SnowTile != 0) // [!code ++]
		{ // [!code ++]
			critter.x = 0.06f; // [!code ++]
			critter.y = -0.06f; // [!code ++]
			snowTile = critter.SnowTile; // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			critter.Update(); // [!code ++]
		} // [!code ++]
		pass = passObjSS; // [!code ++]
		batch = pass.batches[pass.batchIdx]; // [!code ++]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m23 = param.z; // [!code ++]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code ++]
		batch.colors[pass.idx] = floorLight; // [!code ++]
		pass.idx++; // [!code ++]
		if (pass.idx == pass.batchSize) // [!code ++]
		{ // [!code ++]
			pass.NextBatch(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail != null) // [!code ++]
	{ // [!code ++]
		TransAnime anime3 = detail.anime; // [!code ++]
		if (anime3 != null && !anime3.animeBlock) // [!code ++]
		{ // [!code ++]
			TransAnime anime4 = detail.anime; // [!code ++]
			param.x += anime4.v.x; // [!code ++]
			param.y += anime4.v.y; // [!code ++]
			param.z += anime4.v.z; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code ++]
	{ // [!code ++]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code ++]
		if (!snowed || sourceObj.snowTile <= 0) // [!code ++]
		{ // [!code ++]
			param.snow = snowed; // [!code ++]
			param.mat = this.cell.matObj; // [!code ++]
			orgY = param.y; // [!code ++]
			if (param.liquidLv > 0) // [!code ++]
			{ // [!code ++]
				if (sourceObj.pref.Float) // [!code ++]
				{ // [!code ++]
					param.y += 0.01f * floatY; // [!code ++]
					if (liquidLv > 10) // [!code ++]
					{ // [!code ++]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
					} // [!code ++]
					liquidLv -= (int)(floatY * 0.5f); // [!code ++]
					param.liquidLv = liquidLv; // [!code ++]
				} // [!code ++]
				if (sourceObj.tileType.IsWaterTop) // [!code ++]
				{ // [!code ++]
					param.liquidLv = 0; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquid = 1f; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code ++]
					} // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (sourceObj.useAltColor) // [!code ++]
			{ // [!code ++]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			if (sourceObj.HasGrowth) // [!code ++]
			{ // [!code ++]
				this.cell.growth.OnRenderTileMap(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				if (this.cell.autotileObj != 0) // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code ++]
				} // [!code ++]
				else if (sourceObj.tileType.IsUseBlockDir) // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code ++]
				} // [!code ++]
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code ++]
				{ // [!code ++]
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code ++]
				} // [!code ++]
				orgY = param.y; // [!code ++]
				orgZ = param.z; // [!code ++]
				param.y += sourceObj.pref.y; // [!code ++]
				param.z += sourceObj.pref.z; // [!code ++]
				sourceObj.renderData.Draw(param); // [!code ++]
				param.y = orgY; // [!code ++]
				param.z = orgZ; // [!code ++]
				int shadow4 = sourceObj.pref.shadow; // [!code ++]
				if (shadow4 > 1 && !this.cell.ignoreObjShadow) // [!code ++]
				{ // [!code ++]
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow4], sourceObj.pref, 0, param.snow); // [!code ++]
				} // [!code ++]
				param.y = orgY; // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code ++]
	{ // [!code ++]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code ++]
	} // [!code ++]
	if (highlightCells) // [!code ++]
	{ // [!code ++]
		switch (ActionMode.FlagCell.mode) // [!code ++]
		{ // [!code ++]
		case AM_FlagCell.Mode.flagWallPillar: // [!code ++]
			if (this.cell.isToggleWallPillar) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagSnow: // [!code ++]
			if (this.cell.isClearSnow) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagFloat: // [!code ++]
			if (this.cell.isForceFloat) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagClear: // [!code ++]
			if (this.cell.isClearArea) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail == null) // [!code ++]
	{ // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	if (highlightArea && detail.area != null) // [!code ++]
	{ // [!code ++]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code ++]
	} // [!code ++]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code ++]
	{ // [!code ++]
		param.tile = detail.footmark.tile; // [!code ++]
		param.mat = matFloor; // [!code ++]
		param.matColor = 104025f; // [!code ++]
		renderFootmark.Draw(param); // [!code ++]
	}
	goto IL_6fb9; // [!code --]
	goto IL_7a73; // [!code ++]
	void Draw(int tile)
	{
		pass = passEdge;
```

## CardRenderer

[`@@ -230,7 +230,10 @@ public override void Draw(RenderParam p, ref Vector3 v, bool drawShadow)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/CardRenderer.cs#L230)
```cs:line-numbers=230
		}
		int shadow = pref.shadow;
		bool flag2 = isChara && owner.isHidden && !EClass.pc.canSeeInvisible && (!EClass.pc.hasTelepathy || !owner.Chara.race.visibleWithTelepathy);
		p.x += pref.x * (float)((!owner.flipX) ? 1 : (-1)); // [!code --]
		if (isChara) // [!code ++]
		{ // [!code ++]
			p.x += pref.x * (float)((!owner.flipX) ? 1 : (-1)); // [!code ++]
		} // [!code ++]
		p.y += pref.y;
		if (drawShadow && shadow != 1 && SubPassData.Current.shadow && (!flag2 || owner.IsPC))
		{
```

## HitSummary

[`@@ -24,6 +24,7 @@ public void Clear()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/HitSummary.cs#L24)
```cs:line-numbers=24
		money = (count = (countValid = 0));
		targets.Clear();
		groups.Clear();
		SetRecipe(recipe); // [!code ++]
	}

	public void SetRecipe(Recipe r)
```

[`@@ -33,7 +34,7 @@ public void SetRecipe(Recipe r)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/HitSummary.cs#L33)
```cs:line-numbers=33
	if (r != null && !r.UseStock && r.source.NeedFactory)
	{
		PropSet propSet = EClass._map.Installed.cardMap.TryGetValue(r.source.idFactory);
		if (propSet == null || propSet.Count == 0) // [!code --]
		if ((propSet == null || propSet.Count == 0) && EClass.pc.things.Find((Thing t) => t.id == r.source.idFactory) == null) // [!code ++]
		{
			hasFactory = false;
		}
```

## TraitBrewery

[`@@ -91,7 +91,7 @@ public override bool OnChildDecay(Card c, bool firstDecay)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/TraitBrewery.cs#L91)
```cs:line-numbers=91
		{
			return false;
		}
		c = ThingGen.Create(productID).SetNum(num2); // [!code --]
		c = ((!thing.isCopy) ? ThingGen.Create(productID).SetNum(num2) : ThingGen.Create("ash3").SetNum(Mathf.Min(num2, 10))); // [!code ++]
		break;
	}
	default:
```

## UIInventory

[`@@ -773,10 +773,23 @@ public void RefreshMenu()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/UIInventory.cs#L773)
```cs:line-numbers=773
					uIContextMenu7.Show();
				});
			}
			if (EMono.core.config.game.advancedMenu) // [!code ++]
			{ // [!code ++]
				UIContextMenu uIContextMenu8 = uIContextMenu.AddChild("anchor"); // [!code ++]
				foreach (RectPosition p in Util.EnumToList<RectPosition>()) // [!code ++]
				{ // [!code ++]
					uIContextMenu8.AddButton(((data.customAnchor == p) ? "★ " : "") + p.ToString().lang(), delegate // [!code ++]
					{ // [!code ++]
						data.customAnchor = p; // [!code ++]
						window.UpdateSaveData(); // [!code ++]
						SE.ClickGeneral(); // [!code ++]
					}); // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (EMono.debug.enable)
			{
				UIContextMenu uIContextMenu8 = uIContextMenu.AddChild("debug", TextAnchor.UpperRight); // [!code --]
				uIContextMenu8.AddToggle("toggleGrid", EMono.core.config.game.useGrid, delegate(bool a) // [!code --]
				UIContextMenu uIContextMenu9 = uIContextMenu.AddChild("debug", TextAnchor.UpperRight); // [!code ++]
				uIContextMenu9.AddToggle("toggleGrid", EMono.core.config.game.useGrid, delegate(bool a) // [!code ++]
				{
					EMono.core.config.game.useGrid = a;
					foreach (LayerInventory item4 in LayerInventory.listInv)
```

[`@@ -785,7 +798,7 @@ public void RefreshMenu()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/UIInventory.cs#L785)
```cs:line-numbers=785
						item4.invs[0].RefreshGrid();
					}
				});
				uIContextMenu8.AddSlider("iconSize", (float a) => a.ToString() ?? "", EMono.game.config.gridIconSize, delegate(float b) // [!code --]
				uIContextMenu9.AddSlider("iconSize", (float a) => a.ToString() ?? "", EMono.game.config.gridIconSize, delegate(float b) // [!code ++]
				{
					EMono.game.config.gridIconSize = (int)b;
					RefreshGrid();
```

## UIRecipeInfo

[`@@ -305,7 +305,7 @@ public void Refresh()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/UIRecipeInfo.cs#L305)
```cs:line-numbers=305
		if (!r.UseStock && r.source.NeedFactory)
		{
			PropSet propSet = EMono._map.Installed.cardMap.TryGetValue(r.source.idFactory);
			if (propSet == null || propSet.Count == 0) // [!code --]
			if ((propSet == null || propSet.Count == 0) && EMono.pc.things.Find((Thing t) => t.id == r.source.idFactory) == null) // [!code ++]
			{
				note.Space(8);
				note.AddText("noFactory".lang(r.source.NameFactory), FontColor.Bad);
```

## Widget

[`@@ -445,8 +445,8 @@ protected void ClampToScreen(RectTransform rect, float margin = 10f)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/6c37bb1666601a5c753b3faf6c94ac1d9c1bb184/Elin/Widget.cs#L445)
```cs:line-numbers=445
		Vector2 vector2 = new Vector2((float)Screen.width - margin, (float)Screen.height - margin);
		Vector3 vector3 = vector - rect.rect.min;
		Vector3 vector4 = vector2 - rect.rect.max;
		position.x = (int)Mathf.Clamp(position.x, vector3.x - 20f, vector4.x + 20f); // [!code --]
		position.y = (int)Mathf.Clamp(position.y, vector3.y - 20f, vector4.y + 20f); // [!code --]
		position.x = Mathf.Clamp(position.x, vector3.x - 20f, vector4.x + 20f); // [!code ++]
		position.y = Mathf.Clamp(position.y, vector3.y - 20f, vector4.y + 20f); // [!code ++]
		rect.position = position;
	}
}
```
