---
exclude: true
aside: false
pageClass: diff-single-page
footer: false
editLink: false
lastUpdated: false
description: 13 files modified. 2 new files created.
version: EA 23.184 Nightly Patch 1
changes: Chara/CraftUtil/DramaManager/DramaOutcome/DramaSequence/Party/Point/+QuestNasu/Region/TraitChara/TraitMixedFood/TraitNanasu/TraitStairsLocked/Zone/+Zone_DungeonFairy
---

# EA 23.184 Nightly Patch 1

August 20, 2025

13 files modified. 2 new files created.

## Important Changes

Possible breaking changes. Click the filename to view the chunk.
### [Point (1)](#point)
```cs:no-line-numbers
public Point GetNearestPoint(bool allowBlock = false, bool allowChara = true, bool allowInstalled = true, bool ignoreCenter = false) // [!code --]
public Point GetNearestPoint(bool allowBlock = false, bool allowChara = true, bool allowInstalled = true, bool ignoreCenter = false, int minRadius = 0) // [!code ++]
```
## Chara

[`public override void Die(Element e = null, Card origin = null, AttackSource atta`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Chara.cs#L5087-L5093)
```cs:line-numbers=5087
				MakeEgg();
				if (IsPCFaction)
				{
					EClass.Branch.RemoveMemeber(this); // [!code --]
					homeBranch.RemoveMemeber(this); // [!code ++]
				}
			}
			PlayEffect("revive");
```

[`public void TryDropBossLoot()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Chara.cs#L5408-L5413)
```cs:line-numbers=5408
		EClass.Sound.StopBGM(3f);
		EClass._zone.SetBGM(1, refresh: false);
		break;
	case "fairy_raina": // [!code ++]
	case "fairy_poina": // [!code ++]
	{ // [!code ++]
		bool num2 = EClass._map.FindChara((id == "fairy_raina") ? "fairy_poina" : "fairy_raina") == null; // [!code ++]
		QuestNasu questNasu = EClass.game.quests.Get<QuestNasu>(); // [!code ++]
		if (num2 && questNasu != null && questNasu.phase == 1) // [!code ++]
		{ // [!code ++]
			num = 5; // [!code ++]
			flag = (flag2 = true); // [!code ++]
			EClass.Sound.StopBGM(3f); // [!code ++]
			EClass._zone.SetBGM(1, refresh: false); // [!code ++]
			EClass.player.DropReward(ThingGen.Create("backpack_holding")); // [!code ++]
			questNasu.NextPhase(); // [!code ++]
		} // [!code ++]
		break; // [!code ++]
	} // [!code ++]
	case "isygarad":
	{
		num = 5;
```

## CraftUtil

[`public static void WrapIngredient(Card product, Chara c, Card ing, WrapType wrap`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/CraftUtil.cs#L175-L181)
```cs:line-numbers=175
		if (value.IsFoodTraitMain)
		{
			int num = value.Value;
			if (product.id == "lunch_dystopia" && (wrapType == WrapType.Dark || num < 0)) // [!code --]
			if (ing.id == "lunch_dystopia" && (wrapType == WrapType.Dark || num < 0)) // [!code ++]
			{
				num *= -1;
			}
```

## DramaManager

[`public void ParseLine(Dictionary<string, string> item)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/DramaManager.cs#L402-L407)
```cs:line-numbers=402
		flag2 = true;
		lastTalk.AddChoice(new DramaChoice(text, jump, p2, cHECK, text4));
		break;
	case "addTempActor": // [!code ++]
	{ // [!code ++]
		Person person = new Person(actor); // [!code ++]
		Chara chara = EMono.game.cards.globalCharas.Find(actor) ?? EMono._map.FindChara(actor); // [!code ++]
		if (chara != null) // [!code ++]
		{ // [!code ++]
			person.SetChara(chara); // [!code ++]
		} // [!code ++]
		sequence.AddActor(actor, person); // [!code ++]
		break; // [!code ++]
	} // [!code ++]
	case "addActor":
	{
		if (actor == "god")
```

[`public void ParseLine(Dictionary<string, string> item)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/DramaManager.cs#L886-L895)
```cs:line-numbers=886
	case "destroy":
		AddEvent(delegate
		{
			Chara chara = EMono._map.FindChara(p2); // [!code --]
			if (chara != null) // [!code --]
			Chara chara2 = EMono._map.FindChara(p2); // [!code ++]
			if (chara2 != null) // [!code ++]
			{
				chara.Destroy(); // [!code --]
				chara2.Destroy(); // [!code ++]
			}
			else
			{
```

[`public bool CheckIF(string IF)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/DramaManager.cs#L1079-L1084)
```cs:line-numbers=1079
		return EMono.player.dialogFlags.TryGetValue(array[1], 0) == 0;
	case "hasItem":
		return EMono.pc.things.Find(array[1]) != null;
	case "nasuDeliver": // [!code ++]
		if (EMono.game.quests.GetPhase<QuestNasu>() == 2) // [!code ++]
		{ // [!code ++]
			return EMono.pc.things.Find("backpack_holding") != null; // [!code ++]
		} // [!code ++]
		return false; // [!code ++]
	case "isCompleted":
		return EMono.game.quests.IsCompleted(array[1]);
	case "costRecruit":
```

## DramaOutcome

[`public void revive_pet()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/DramaOutcome.cs#L321-L326)
```cs:line-numbers=321
		cc.ModAffinity(EMono.pc, -2);
	}

	public void nasu_join() // [!code ++]
	{ // [!code ++]
		if (cc.id == "fairy_nanasu") // [!code ++]
		{ // [!code ++]
			cc.MakeAlly(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void melilith_friend()
	{
		if (cc.id == "melilith" && EMono.game.quests.completedIDs.Contains("melilith"))
```

## DramaSequence

[`public DramaActor GetActor(string id)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/DramaSequence.cs#L64-L69)
```cs:line-numbers=64
	{
		return AddActor(id, new Person(id));
	}
	if (EClass.core.IsGameStarted) // [!code ++]
	{ // [!code ++]
		Chara chara = EClass.game.cards.globalCharas.Find(id) ?? EClass._map.FindChara(id); // [!code ++]
		if (chara != null) // [!code ++]
		{ // [!code ++]
			return AddActor(id, new Person(chara)); // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (actors.Count <= 0)
	{
		return GetActor("narrator");
```

## Party

[`public void AddMemeber(Chara c, bool showMsg = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Party.cs#L86-L91)
```cs:line-numbers=86
		WidgetRoster.SetDirty();
	}

	public Chara Find(string id) // [!code ++]
	{ // [!code ++]
		foreach (Chara member in members) // [!code ++]
		{ // [!code ++]
			if (member.id == id) // [!code ++]
			{ // [!code ++]
				return member; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return null; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void RemoveMember(Chara c)
	{
		if (c.host != null)
```

## Point

[`public float GetAngle2(Point to)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Point.cs#L604-L665)
```cs:line-numbers=604
		return Mathf.Atan2(to.z - z, num) * 57.29578f;
	}

	public Point GetNearestPoint(bool allowBlock = false, bool allowChara = true, bool allowInstalled = true, bool ignoreCenter = false) // [!code --]
	public Point GetNearestPoint(bool allowBlock = false, bool allowChara = true, bool allowInstalled = true, bool ignoreCenter = false, int minRadius = 0) // [!code ++]
	{
		Point p = new Point();
		int num = 1; // [!code --]
		int num2 = x; // [!code --]
		int num3 = z; // [!code --]
		if (IsValid(num2, num3)) // [!code --]
		int r = 1; // [!code ++]
		int num = x; // [!code ++]
		int num2 = z; // [!code ++]
		if (IsValid(num, num2)) // [!code ++]
		{
			return p;
		}
		if (IsValid(num2, num3 + 1)) // [!code --]
		if (IsValid(num, num2 + 1)) // [!code ++]
		{
			return p;
		}
		for (int i = 0; i < 30; i++)
		{
			for (int j = 0; j < num; j++) // [!code --]
			for (int j = 0; j < r; j++) // [!code ++]
			{
				num2++; // [!code --]
				if (IsValid(num2, num3)) // [!code --]
				num++; // [!code ++]
				if (IsValid(num, num2)) // [!code ++]
				{
					return p;
				}
			}
			for (int k = 0; k < num; k++) // [!code --]
			for (int k = 0; k < r; k++) // [!code ++]
			{
				num3++; // [!code --]
				if (IsValid(num2, num3)) // [!code --]
				num2++; // [!code ++]
				if (IsValid(num, num2)) // [!code ++]
				{
					return p;
				}
			}
			num++; // [!code --]
			for (int l = 0; l < num; l++) // [!code --]
			r++; // [!code ++]
			for (int l = 0; l < r; l++) // [!code ++]
			{
				num2--; // [!code --]
				if (IsValid(num2, num3)) // [!code --]
				num--; // [!code ++]
				if (IsValid(num, num2)) // [!code ++]
				{
					return p;
				}
			}
			for (int m = 0; m < num; m++) // [!code --]
			for (int m = 0; m < r; m++) // [!code ++]
			{
				num3--; // [!code --]
				if (IsValid(num2, num3)) // [!code --]
				num2--; // [!code ++]
				if (IsValid(num, num2)) // [!code ++]
				{
					return p;
				}
			}
			num++; // [!code --]
			r++; // [!code ++]
		}
		p.Set(this);
		return p;
		bool IsValid(int dx, int dz)
		{
			p.Set(dx, dz);
			if (minRadius > r / 2) // [!code ++]
			{ // [!code ++]
				return false; // [!code ++]
			} // [!code ++]
			if (!p.IsInBounds || !map.Contains(dx, dz) || (ignoreCenter && dx == x && dz == z))
			{
				return false;
```

## +QuestNasu

::: details File Created
```cs
public class QuestNasu : QuestSequence
{
	public override void OnComplete()
	{
		Thing thing = EClass.pc.things.Find("backpack_holding");
		person.chara.AddCard(thing);
		thing.isGifted = true;
		DropReward(ThingGen.Create("697").SetNum(77));
		DropReward(TraitSeed.MakeSeed("feywood").SetNum(10));
		DropReward(TraitSeed.MakeSeed("coralwood").SetNum(10));
		if (person.chara.IsPCFaction)
		{
			person.chara.homeBranch.BanishMember(person.chara);
		}
	}
}
```

:::
## Region

[`public void CheckRandomSites()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Region.cs#L79-L105)
```cs:line-numbers=79
			dateCheckSites = EClass.world.date.GetRaw() + 1440;
			UpdateRandomSites();
		}
		if (FindZone("foxtown_nefu") == null) // [!code --]
		{ // [!code --]
			SpatialGen.Create("foxtown_nefu", this, register: true); // [!code --]
		} // [!code --]
		if (FindZone("little_garden") == null) // [!code --]
		{ // [!code --]
			SpatialGen.Create("little_garden", this, register: true); // [!code --]
		} // [!code --]
		if (FindZone("cave_yeek") == null) // [!code --]
		{ // [!code --]
			SpatialGen.Create("cave_yeek", this, register: true); // [!code --]
		} // [!code --]
		if (FindZone("village_exile") == null) // [!code --]
		{ // [!code --]
			SpatialGen.Create("village_exile", this, register: true); // [!code --]
		} // [!code --]
		if (FindZone("temple_undersea") == null) // [!code --]
		TryAddZone("cave_fairy"); // [!code ++]
		TryAddZone("foxtown_nefu"); // [!code ++]
		TryAddZone("little_garden"); // [!code ++]
		TryAddZone("cave_yeek"); // [!code ++]
		TryAddZone("village_exile"); // [!code ++]
		TryAddZone("temple_undersea"); // [!code ++]
		elomap.objmap.UpdateMeshImmediate(); // [!code ++]
		void TryAddZone(string id) // [!code ++]
		{
			SpatialGen.Create("temple_undersea", this, register: true); // [!code --]
			if (FindZone(id) == null) // [!code ++]
			{ // [!code ++]
				SpatialGen.Create(id, this, register: true); // [!code ++]
			} // [!code ++]
		}
		elomap.objmap.UpdateMeshImmediate(); // [!code --]
	}

	public void RenewRandomSites()
```

## TraitChara

[`public virtual bool CanSellPlan`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/TraitChara.cs#L98-L104)
```cs:line-numbers=98

	public virtual Adv_Type AdvType => Adv_Type.None;

	public virtual bool EnableTone => !IsUnique; // [!code --]
	public virtual bool EnableTone // [!code ++]
	{ // [!code ++]
		get // [!code ++]
		{ // [!code ++]
			if (IsUnique) // [!code ++]
			{ // [!code ++]
				return !LayerDrama.Instance; // [!code ++]
			} // [!code ++]
			return true; // [!code ++]
		} // [!code ++]
	} // [!code ++]

	public virtual bool CanBeTamed
	{
```

## TraitMixedFood

[`public class TraitMixedFood : TraitFood`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/TraitMixedFood.cs#L1-L6)
```cs:line-numbers=1
public class TraitMixedFood : TraitFood // [!code --]
public class TraitMixedFood : TraitFoodMeal // [!code ++]
{
	public override bool CanSearchContent => false;

	public override bool CanStack => false;
 // [!code ++]
	public override int DefaultStock => 1; // [!code ++]
}
```

## TraitNanasu

[`public class TraitNanasu : TraitUniqueChara`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/TraitNanasu.cs#L1-L4)
```cs:line-numbers=1
public class TraitNanasu : TraitUniqueChara
{
	public override bool CanInvite => false; // [!code --]
	public override bool CanInvite => EClass.game.quests.IsCompleted("nasu"); // [!code ++]
 // [!code ++]
	public override bool CanBeBanished => EClass.game.quests.IsCompleted("nasu"); // [!code ++]
}
```

## TraitStairsLocked

[`public override bool OnUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/TraitStairsLocked.cs#L19-L24)
```cs:line-numbers=19
		Zone.ignoreSpawnAnime = true;
		EClass._zone.AddCard(thing, owner.pos.x, owner.pos.z);
		thing.SetPlaceState(PlaceState.installed);
		if (EClass._zone is Zone_DungeonFairy) // [!code ++]
		{ // [!code ++]
			EClass.pc.party.Find("fairy_nanasu")?.Talk("unlock_stairs_nasu"); // [!code ++]
		} // [!code ++]
		return true;
	}
}
```

## Zone

[`public Point GetSpawnPos(Chara c, ZoneTransition.EnterState destState = ZoneTran`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Zone.cs#L1425-L1431)
```cs:line-numbers=1425
			}
			if (base.lv == 0)
			{
				goto IL_0499; // [!code --]
				goto IL_04a1; // [!code ++]
			}
			flag = base.lv <= 0;
			break;
```

[`public Point GetSpawnPos(Chara c, ZoneTransition.EnterState destState = ZoneTran`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/0fad4a29dd2404966cd1a08f5bde958d0b4dbaa4/Elin/Zone.cs#L1464-L1470)
```cs:line-numbers=1464
			break;
		}
		break;
		IL_0499: // [!code --]
		IL_04a1: // [!code ++]
		enterState = ZoneTransition.EnterState.Center;
	}
	foreach (Thing thing5 in map.things)
```

## +Zone_DungeonFairy

::: details File Created
```cs
public class Zone_DungeonFairy : Zone_Dungeon
{
	public override int MinLv => LvBoss;

	public override bool CanUnlockExit
	{
		get
		{
			if (EClass.pc.party.Find("fairy_nanasu") != null)
			{
				return EClass.game.quests.GetPhase<QuestNasu>() == 0;
			}
			return false;
		}
	}

	public int LvBoss => -5;

	public bool IsBossLv => base.lv == LvBoss;

	public override string GetDungenID()
	{
		if (IsBossLv)
		{
			return "CavernBig";
		}
		return base.GetDungenID();
	}

	public override void OnGenerateMap()
	{
		if (IsBossLv)
		{
			Chara t = CharaGen.Create("fairy_poina");
			Chara t2 = CharaGen.Create("fairy_raina");
			Point point = EClass._map.FindThing<TraitStairsUp>().owner.pos.GetNearestPoint(allowBlock: false, allowChara: false, allowInstalled: false, ignoreCenter: true, 5) ?? EClass._map.GetCenterPos();
			AddCard(t, point);
			AddCard(t2, point.GetNearestPoint(allowBlock: false, allowChara: false, allowInstalled: false) ?? point);
			LayerDrama.Activate("fairy_nanasu", "fairy_nanasu", "battle", EClass.pc.party.Find("fairy_nanasu"));
		}
		base.OnGenerateMap();
	}
}
```

:::