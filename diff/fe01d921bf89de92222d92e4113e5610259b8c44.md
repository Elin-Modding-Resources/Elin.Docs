---
exclude: true
aside: false
pageClass: diff-single-page
footer: false
editLink: false
lastUpdated: false
description: 5 files modified.
version: EA 23.252 Stable Patch 2
changes: BaseTileMap/Card/CoreDebug/DramaOutcome/TraitASMR
---

# EA 23.252 Stable Patch 2

December 24, 2025

5 files modified.

## Important Changes

**None.**
## BaseTileMap

[`public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/BaseTileMap.cs#L653-L659)
```cs:line-numbers=653
		heightLightMod = 0f;
	}
	map.rooms.Refresh();
	noSlopMode = EInput.isAltDown && EInput.isShiftDown; // [!code --]
	noSlopMode = (buildMode ? (!EMono.game.config.slope) : (EInput.isAltDown && EInput.isShiftDown)); // [!code ++]
	RefreshHeight();
	innerMode = ((!buildMode && isIndoor) ? defaultInnerMode : InnerMode.None);
	if (EMono.pc.IsInActiveZone)
```

[`public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/BaseTileMap.cs#L875-L892)
```cs:line-numbers=875
	int valueOrDefault = (this.room?.lot?.idBGM).GetValueOrDefault();
	if (valueOrDefault == 0)
	{
		goto IL_1710; // [!code --]
		goto IL_172c; // [!code ++]
	}
	if (!(EMono.Sound.currentPlaylist != EMono.Sound.plLot))
	{
		BGMData data = EMono.Sound.plLot.list[0].data;
		if ((object)data != null && data.id == valueOrDefault)
		{
			goto IL_1710; // [!code --]
			goto IL_172c; // [!code ++]
		}
	}
	goto IL_172f; // [!code --]
	IL_1739: // [!code --]
	goto IL_174b; // [!code ++]
	IL_1755: // [!code ++]
	if (this.room != lastRoom)
	{
		screen.RefreshWeather();
```

[`public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/BaseTileMap.cs#L895-L916)
```cs:line-numbers=895
		SoundManager.bgmVolumeMod = ((!LayerDrama.maxBGMVolume && !EMono._map.IsIndoor && this.room != null && !this.room.data.atrium && this.room.HasRoof) ? (-0.6f) : 0f);
		screenHighlight = ScreenHighlight.None;
		return;
		IL_1710: // [!code --]
		IL_172c: // [!code ++]
		if (valueOrDefault == 0 && EMono.Sound.currentPlaylist == EMono.Sound.plLot)
		{
			goto IL_172f; // [!code --]
			goto IL_174b; // [!code ++]
		}
		goto IL_1739; // [!code --]
		IL_172f: // [!code --]
		goto IL_1755; // [!code ++]
		IL_174b: // [!code ++]
		EMono._zone.RefreshBGM();
		goto IL_1739; // [!code --]
		goto IL_1755; // [!code ++]
	}

	public void RefreshHeight()
	{
		if (EMono.game != null)
		{
			float num = (((buildMode && !EMono.game.config.slope) || noSlopMode) ? 0f : ((float)EMono.game.config.slopeMod * 0.01f)); // [!code --]
			float num = (noSlopMode ? 0f : ((float)EMono.game.config.slopeMod * 0.01f)); // [!code ++]
			_heightMod = heightMod;
			_heightMod.x = num;
			_heightMod.y *= num;
```

[`public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/BaseTileMap.cs#L1282-L3198)
```cs:line-numbers=1282
		}
	}
	goto IL_7ba5;
	IL_169b: // [!code --]
	if (this.cell.isSlopeEdge) // [!code --]
	IL_6fea: // [!code ++]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code ++]
	{
		float num3 = (float)height * _heightMod.y; // [!code --]
		orgY = param.y; // [!code --]
		orgZ = param.z; // [!code --]
		param.dir = this.cell.blockDir; // [!code --]
		if (snowed) // [!code --]
		{ // [!code --]
			param.color = floorLight; // [!code --]
		} // [!code --]
		SourceBlock.Row defBlock; // [!code --]
		if (sourceBlock.tileType.IsFullBlock) // [!code --]
		snowed = true; // [!code ++]
	} // [!code ++]
	if (this.cell.effect != null) // [!code ++]
	{ // [!code ++]
		if (this.cell.effect.IsLiquid) // [!code ++]
		{
			defBlock = sourceBlock; // [!code --]
			param.mat = matBlock; // [!code --]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code ++]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code ++]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code ++]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code ++]
			param.mat = defaultMaterial; // [!code ++]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code ++]
			sourceEffect.renderData.Draw(param); // [!code ++]
		}
		else
		{
			defBlock = sourceFloor._defBlock; // [!code --]
			param.mat = matFloor; // [!code --]
			param.tile = defBlock._tiles[this.cell.blockDir % defBlock._tiles.Length]; // [!code --]
			if (defBlock.id != 1) // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code ++]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code ++]
			if (sourceEffect2.anime.Length != 0) // [!code ++]
			{
				param.matColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code ++]
				{ // [!code ++]
					float num3 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code ++]
					if (!(num3 >= (float)sourceEffect2.anime[0])) // [!code ++]
					{ // [!code ++]
						param.tile += num3; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					float num4 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code ++]
					param.tile += num4; // [!code ++]
				} // [!code ++]
			}
			else // [!code --]
			if (this.cell.effect.IsFire) // [!code ++]
			{
				param.matColor = 104025f; // [!code --]
				rendererEffect.Draw(param); // [!code ++]
			}
		} // [!code --]
		for (int j = 0; (float)j < num3 / heightBlockSize; j++) // [!code --]
		{ // [!code --]
			param.y += ugFix.y; // [!code --]
			param.z += ugFix.z + slopeFixZ * (float)j; // [!code --]
			defBlock.renderData.Draw(param); // [!code --]
			if (this.cell.pcSync && EMono.player.lightPower > 0f) // [!code --]
			else // [!code ++]
			{
				float num4 = param.tile; // [!code --]
				param.tile = 0f; // [!code --]
				rendererFov.Draw(param); // [!code --]
				param.tile = num4; // [!code --]
				this.cell.effect.source.renderData.Draw(param); // [!code ++]
			}
		}
		param.y = orgY; // [!code --]
		param.z = orgZ; // [!code --]
	}
	param.color = floorLight;
	if (!isWater && (this.cell.Front.sourceFloor.tileType.IsWater || this.cell.Right.sourceFloor.tileType.IsWater) && this.cell.sourceBlock.tileType.RenderWaterBlock && !flag) // [!code --]
	if (this.cell.critter != null) // [!code ++]
	{
		orgY = param.y; // [!code --]
		orgZ = param.z; // [!code --]
		int num5 = 0; // [!code --]
		if (sourceBlock.tileType.IsFullBlock) // [!code --]
		Critter critter = this.cell.critter; // [!code ++]
		int snowTile = critter.tile; // [!code ++]
		if (snowed && critter.SnowTile != 0) // [!code ++]
		{
			SourceBlock.Row row3 = sourceBlock; // [!code --]
			num5 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			critter.x = 0.06f; // [!code ++]
			critter.y = -0.06f; // [!code ++]
			snowTile = critter.SnowTile; // [!code ++]
		}
		else
		{
			SourceBlock.Row row3 = sourceFloor._defBlock; // [!code --]
			num5 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code --]
		} // [!code --]
		if (((this.cell.Front.shore / 12) & 1) == 0 && this.cell.Front.sourceFloor.tileType.IsWater && this.cell.Front.height <= height && this.cell.Front.sourceBlock.tileType.RenderWaterBlock) // [!code --]
		{ // [!code --]
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Front.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Front.height * _heightMod.y; // [!code --]
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z; // [!code --]
			param.tile = num5 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			rendererWaterBlock.Draw(param); // [!code --]
		} // [!code --]
		if (((this.cell.Right.shore / 12) & 8) == 0 && this.cell.Right.sourceFloor.tileType.IsWater && this.cell.Right.height <= height && this.cell.Right.sourceBlock.tileType.RenderWaterBlock) // [!code --]
		{ // [!code --]
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Right.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Right.height * _heightMod.y; // [!code --]
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z; // [!code --]
			param.tile = num5 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			rendererWaterBlock.Draw(param); // [!code --]
		} // [!code --]
		param.y = orgY; // [!code --]
		param.z = orgZ; // [!code --]
	} // [!code --]
	if (showBorder && !this.cell.outOfBounds) // [!code --]
	{ // [!code --]
		param.matColor = 104025f; // [!code --]
		if (cx == EMono._map.bounds.x) // [!code --]
		{ // [!code --]
			renderBorder.Draw(param, 12 + (EMono.world.date.IsNight ? 4 : 0)); // [!code --]
		} // [!code --]
		else if (cx == EMono._map.bounds.maxX) // [!code --]
		{ // [!code --]
			renderBorder.Draw(param, 13 + (EMono.world.date.IsNight ? 4 : 0)); // [!code --]
		} // [!code --]
		if (cz == EMono._map.bounds.z) // [!code --]
		{ // [!code --]
			renderBorder.Draw(param, 14 + (EMono.world.date.IsNight ? 4 : 0)); // [!code --]
			critter.Update(); // [!code ++]
		}
		else if (cz == EMono._map.bounds.maxZ) // [!code --]
		pass = passObjSS; // [!code ++]
		batch = pass.batches[pass.batchIdx]; // [!code ++]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m23 = param.z; // [!code ++]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code ++]
		batch.colors[pass.idx] = floorLight; // [!code ++]
		pass.idx++; // [!code ++]
		if (pass.idx == pass.batchSize) // [!code ++]
		{
			renderBorder.Draw(param, 15 + (EMono.world.date.IsNight ? 4 : 0)); // [!code --]
			pass.NextBatch(); // [!code ++]
		}
	}
	if (this.cell.isSkyFloor || (detail != null && detail.anime != null && detail.anime.drawBlock)) // [!code --]
	if (detail != null) // [!code ++]
	{
		orgY = param.y; // [!code --]
		orgZ = param.z; // [!code --]
		SourceBlock.Row defBlock2 = sourceFloor._defBlock; // [!code --]
		param.mat = matFloor; // [!code --]
		param.tile = defBlock2._tiles[this.cell.blockDir % defBlock2._tiles.Length]; // [!code --]
		if (defBlock2.id != 1) // [!code --]
		{ // [!code --]
			param.matColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			param.matColor = 104025f; // [!code --]
		} // [!code --]
		for (int k = 0; k < ((!this.cell.isSkyFloor) ? 1 : EMono._map.config.skyBlockHeight); k++) // [!code --]
		TransAnime anime3 = detail.anime; // [!code ++]
		if (anime3 != null && !anime3.animeBlock) // [!code ++]
		{
			param.y += ugFix.y; // [!code --]
			param.z += ugFix.z + slopeFixZ * (float)k; // [!code --]
			defBlock2.renderData.Draw(param); // [!code --]
			TransAnime anime4 = detail.anime; // [!code ++]
			param.x += anime4.v.x; // [!code ++]
			param.y += anime4.v.y; // [!code ++]
			param.z += anime4.v.z; // [!code ++]
		}
		param.y = orgY; // [!code --]
		param.z = orgZ; // [!code --]
	}
	if (!sourceFloor.tileType.IsSkipFloor) // [!code --]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code ++]
	{
		if ((hasBridge && sourceBridge.tileType.CastShadowSelf) || this.cell.castFloorShadow) // [!code --]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code ++]
		if (!snowed || sourceObj.snowTile <= 0) // [!code ++]
		{
			floorLight2 = _lightMod * light * 0.2f + _baseBrightness + _shadowStrength * floorShadowStrength * (isWater ? 0.7f : (hasBridge ? 1f : (0.6f * (1f - nightRatio)))); // [!code --]
			if (snowed) // [!code --]
			param.snow = snowed; // [!code ++]
			param.mat = this.cell.matObj; // [!code ++]
			orgY = param.y; // [!code ++]
			if (param.liquidLv > 0) // [!code ++]
			{
				floorLight2 = (int)((double)floorLight2 * 0.85 * 50.0) * 262144 + snowColorToken; // [!code --]
				if (sourceObj.pref.Float) // [!code ++]
				{ // [!code ++]
					param.y += 0.01f * floatY; // [!code ++]
					if (liquidLv > 10) // [!code ++]
					{ // [!code ++]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
					} // [!code ++]
					liquidLv -= (int)(floatY * 0.5f); // [!code ++]
					param.liquidLv = liquidLv; // [!code ++]
				} // [!code ++]
				if (sourceObj.tileType.IsWaterTop) // [!code ++]
				{ // [!code ++]
					param.liquidLv = 0; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquid = 1f; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code ++]
					} // [!code ++]
				} // [!code ++]
			}
			else // [!code --]
			if (sourceObj.useAltColor) // [!code ++]
			{
				floorLight2 = (int)(floorLight2 * 50f) * 262144 + ((this.cell.lightR >= 64) ? 63 : this.cell.lightR) * 4096 + ((this.cell.lightG >= 64) ? 63 : this.cell.lightG) * 64 + ((this.cell.lightB >= 64) ? 63 : this.cell.lightB); // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code ++]
			}
			param.color = floorLight2; // [!code --]
			if (this.cell.lotShade) // [!code --]
			else // [!code ++]
			{
				floorLight = floorLight2; // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code ++]
			}
		} // [!code --]
		floorMatColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code --]
		if (isWater && flag) // [!code --]
		{ // [!code --]
			param.y -= 0.01f * floatY; // [!code --]
		} // [!code --]
		if (!sourceBlock.tileType.IsSkipFloor || sourceBlock.transparent || hasBridge || this.cell.hasDoor || this.cell.skipRender) // [!code --]
		{ // [!code --]
			param.mat = matFloor; // [!code --]
			param.tile = sourceFloor._tiles[floorDir % sourceFloor._tiles.Length]; // [!code --]
			param.matColor = floorMatColor; // [!code --]
			param.snow = snowed; // [!code --]
			if (this.cell.isDeck) // [!code --]
			if (sourceObj.HasGrowth) // [!code ++]
			{
				param.z += 1f; // [!code --]
				if ((bool)sourceFloor.renderData.subData) // [!code --]
				this.cell.growth.OnRenderTileMap(param); // [!code ++]
				if (this.cell.obj == 118 && Core.fixedFrame % 10f == 0f && sourceObj.growth.IsMature) // [!code ++]
				{
					sourceFloor.renderData.subData.Draw(param); // [!code --]
					EMono.scene.psFey.transform.position = new Vector3(param.x, param.y, param.z - 2f); // [!code ++]
					EMono.scene.psFey.Emit(1); // [!code ++]
				}
				sourceFloor.renderData.Draw(param); // [!code --]
				param.z -= 1f; // [!code --]
			}
			else
			{
				if ((bool)sourceFloor.renderData.subData) // [!code --]
				if (this.cell.autotileObj != 0) // [!code ++]
				{
					sourceFloor.renderData.subData.Draw(param); // [!code --]
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code ++]
				}
				sourceFloor.renderData.Draw(param); // [!code --]
			} // [!code --]
			int num6 = 0; // [!code --]
			if (isSnowCovered && sourceFloor == FLOOR.sourceSnow && !this.cell.hasDoor) // [!code --]
			{ // [!code --]
				if (!this.cell.Right.IsSnowTile && this.cell.Right.topHeight == this.cell.topHeight) // [!code --]
				else if (sourceObj.tileType.IsUseBlockDir) // [!code ++]
				{
					num6++; // [!code --]
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code ++]
				}
				if (!this.cell.Front.IsSnowTile && this.cell.Front.topHeight == this.cell.topHeight) // [!code --]
				else // [!code ++]
				{
					num6 += 2; // [!code --]
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code ++]
				}
				if (num6 != 0) // [!code --]
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code ++]
				{
					param.tile = 448 + num6 + 12; // [!code --]
					param.z -= 0.1f; // [!code --]
					sourceFloor.renderData.Draw(param); // [!code --]
					param.z += 0.1f; // [!code --]
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code ++]
				}
			} // [!code --]
			if (this.cell.shadow != 0 && !hasBridge && !this.cell.skipRender) // [!code --]
			{ // [!code --]
				if (snowed) // [!code --]
				orgY = param.y; // [!code ++]
				orgZ = param.z; // [!code ++]
				param.y += sourceObj.pref.y; // [!code ++]
				param.z += sourceObj.pref.z; // [!code ++]
				sourceObj.renderData.Draw(param); // [!code ++]
				param.y = orgY; // [!code ++]
				param.z = orgZ; // [!code ++]
				int shadow3 = sourceObj.pref.shadow; // [!code ++]
				if (shadow3 > 1 && !this.cell.ignoreObjShadow) // [!code ++]
				{
					if (sourceFloor == FLOOR.sourceSnow) // [!code --]
					{ // [!code --]
						param.tile = 448 + this.cell.shadow + 8 + (this.cell.HasFence ? 4 : 0); // [!code --]
						param.z -= 0.01f; // [!code --]
						sourceFloor.renderData.Draw(param); // [!code --]
					} // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					pass = passEdge; // [!code --]
					batch = pass.batches[pass.batchIdx]; // [!code --]
					batch.matrices[pass.idx].m03 = param.x + ambientShadowFix[this.cell.shadow].x; // [!code --]
					batch.matrices[pass.idx].m13 = param.y + ambientShadowFix[this.cell.shadow].y; // [!code --]
					batch.matrices[pass.idx].m23 = param.z + ambientShadowFix[this.cell.shadow].z; // [!code --]
					batch.tiles[pass.idx] = 448 + this.cell.shadow; // [!code --]
					batch.colors[pass.idx] = param.color; // [!code --]
					batch.matColors[pass.idx] = 104025f; // [!code --]
					pass.idx++; // [!code --]
					if (pass.idx == pass.batchSize) // [!code --]
					{ // [!code --]
						pass.NextBatch(); // [!code --]
					} // [!code --]
				} // [!code --]
				if (!sourceFloor.ignoreTransition && !snowed) // [!code --]
				{ // [!code --]
					Cell back = this.cell.Back; // [!code --]
					if (back.sourceBlock.transition[0] != -1 && back.isSeen && !back.hasDoor) // [!code --]
					{ // [!code --]
						pass = passFloor; // [!code --]
						batch = pass.batches[pass.batchIdx]; // [!code --]
						batch.matrices[pass.idx].m03 = param.x + transitionFix[0].x; // [!code --]
						batch.matrices[pass.idx].m13 = param.y + transitionFix[0].y; // [!code --]
						batch.matrices[pass.idx].m23 = param.z + transitionFix[0].z; // [!code --]
						batch.tiles[pass.idx] = 480 + back.sourceBlock.transition[0] + Rand.bytes[index % Rand.MaxBytes] % back.sourceBlock.transition[1]; // [!code --]
						batch.colors[pass.idx] = param.color; // [!code --]
						batch.matColors[pass.idx] = GetColorInt(ref back.matBlock.matColor, back.sourceBlock.colorMod); // [!code --]
						pass.idx++; // [!code --]
						if (pass.idx == pass.batchSize) // [!code --]
						{ // [!code --]
							pass.NextBatch(); // [!code --]
						} // [!code --]
					} // [!code --]
					back = this.cell.Left; // [!code --]
					if (back.sourceBlock.transition[0] != -1 && back.isSeen && !back.hasDoor) // [!code --]
					{ // [!code --]
						pass = passFloor; // [!code --]
						batch = pass.batches[pass.batchIdx]; // [!code --]
						batch.matrices[pass.idx].m03 = param.x + transitionFix[1].x; // [!code --]
						batch.matrices[pass.idx].m13 = param.y + transitionFix[1].y; // [!code --]
						batch.matrices[pass.idx].m23 = param.z + transitionFix[1].z; // [!code --]
						batch.tiles[pass.idx] = 512 + back.sourceBlock.transition[0] + Rand.bytes[index % Rand.MaxBytes] % back.sourceBlock.transition[1]; // [!code --]
						batch.colors[pass.idx] = param.color; // [!code --]
						batch.matColors[pass.idx] = GetColorInt(ref back.matBlock.matColor, back.sourceBlock.colorMod); // [!code --]
						pass.idx++; // [!code --]
						if (pass.idx == pass.batchSize) // [!code --]
						{ // [!code --]
							pass.NextBatch(); // [!code --]
						} // [!code --]
					} // [!code --]
				} // [!code --]
			} // [!code --]
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num6 == 0) // [!code --]
			{ // [!code --]
				pass = (isWater ? passAutoTileWater : passAutoTile); // [!code --]
				batch = pass.batches[pass.batchIdx]; // [!code --]
				batch.matrices[pass.idx].m03 = param.x; // [!code --]
				batch.matrices[pass.idx].m13 = param.y; // [!code --]
				batch.matrices[pass.idx].m23 = param.z + ((hasBridge || this.cell._block != 0) ? 0.8f : 0f); // [!code --]
				batch.tiles[pass.idx] = (26 + sourceFloor.autotile / 2) * 32 + sourceFloor.autotile % 2 * 16 + this.cell.autotile; // [!code --]
				batch.colors[pass.idx] = param.color + (float)((int)(sourceFloor.autotileBrightness * 100f) * 262144); // [!code --]
				batch.matColors[pass.idx] = param.matColor; // [!code --]
				pass.idx++; // [!code --]
				if (pass.idx == pass.batchSize) // [!code --]
				{ // [!code --]
					pass.NextBatch(); // [!code --]
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow3], sourceObj.pref, 0, param.snow); // [!code ++]
				}
				param.y = orgY; // [!code ++]
			}
		}
		if (isWater) // [!code --]
	} // [!code ++]
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code ++]
	{ // [!code ++]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code ++]
	} // [!code ++]
	if (highlightCells) // [!code ++]
	{ // [!code ++]
		switch (ActionMode.FlagCell.mode) // [!code ++]
		{
			int num7 = 12; // [!code --]
			int num8 = this.cell.shore / num7; // [!code --]
			int num9 = this.cell.shore % num7; // [!code --]
			bool isShoreSand = this.cell.isShoreSand; // [!code --]
			if (this.cell.shore != 0) // [!code --]
		case AM_FlagCell.Mode.flagWallPillar: // [!code ++]
			if (this.cell.isToggleWallPillar) // [!code ++]
			{
				Cell cell = ((((uint)num8 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num8 & 2u) != 0) ? this.cell.Right : ((((uint)num8 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code --]
				if (isShoreSand && !cell.sourceFloor.isBeach) // [!code --]
				{ // [!code --]
					cell = ((((uint)num8 & 8u) != 0) ? this.cell.Left : ((((uint)num8 & 4u) != 0) ? this.cell.Front : ((((uint)num8 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code --]
				} // [!code --]
				if (!cell.IsSnowTile) // [!code --]
				{ // [!code --]
					param.matColor = GetColorInt(ref cell.matFloor.matColor, cell.sourceFloor.colorMod); // [!code --]
					if (isShoreSand) // [!code --]
					{ // [!code --]
						pass = passShore; // [!code --]
						batch = pass.batches[pass.batchIdx]; // [!code --]
						batch.matrices[pass.idx].m03 = param.x; // [!code --]
						batch.matrices[pass.idx].m13 = param.y; // [!code --]
						batch.matrices[pass.idx].m23 = param.z; // [!code --]
						batch.tiles[pass.idx] = 768 + this.cell.shore / num7; // [!code --]
						batch.colors[pass.idx] = param.color; // [!code --]
						batch.matColors[pass.idx] = param.matColor; // [!code --]
						pass.idx++; // [!code --]
						if (pass.idx == pass.batchSize) // [!code --]
						{ // [!code --]
							pass.NextBatch(); // [!code --]
						} // [!code --]
						num9 = 2; // [!code --]
					} // [!code --]
					else // [!code --]
					{ // [!code --]
						num9 = cell.sourceFloor.edge; // [!code --]
					} // [!code --]
					param.tile = (24 + num9 / 2) * 32 + num9 % 2 * 16 + num8; // [!code --]
					rendererShore.Draw(param); // [!code --]
				} // [!code --]
				passArea.Add(param, 34f, 0f); // [!code ++]
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num7) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagSnow: // [!code ++]
			if (this.cell.isClearSnow) // [!code ++]
			{
				param.tile = 785f; // [!code --]
				param.matColor = GetColorInt(ref this.cell.BackLeft.matFloor.matColor, this.cell.BackLeft.sourceFloor.colorMod); // [!code --]
				passShore.Add(param); // [!code --]
				Draw(60); // [!code --]
				passArea.Add(param, 34f, 0f); // [!code ++]
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num7) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagFloat: // [!code ++]
			if (this.cell.isForceFloat) // [!code ++]
			{
				param.tile = 786f; // [!code --]
				param.matColor = GetColorInt(ref this.cell.BackRight.matFloor.matColor, this.cell.BackRight.sourceFloor.colorMod); // [!code --]
				passShore.Add(param); // [!code --]
				Draw(56); // [!code --]
				passArea.Add(param, 34f, 0f); // [!code ++]
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num7) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num7) & 4u) != 0) // [!code --]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagClear: // [!code ++]
			if (this.cell.isClearArea) // [!code ++]
			{
				param.tile = 787f; // [!code --]
				param.matColor = GetColorInt(ref this.cell.FrontRight.matFloor.matColor, this.cell.FrontRight.sourceFloor.colorMod); // [!code --]
				passShore.Add(param); // [!code --]
				Draw(48); // [!code --]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail == null) // [!code ++]
	{ // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	if (highlightArea && detail.area != null) // [!code ++]
	{ // [!code ++]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code ++]
	} // [!code ++]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code ++]
	{ // [!code ++]
		param.tile = detail.footmark.tile; // [!code ++]
		param.mat = matFloor; // [!code ++]
		param.matColor = 104025f; // [!code ++]
		renderFootmark.Draw(param); // [!code ++]
	} // [!code ++]
	goto IL_7ba5; // [!code ++]
	IL_6f8a: // [!code ++]
	int num5; // [!code ++]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code ++]
	{ // [!code ++]
		param.tile = num5; // [!code ++]
		rendererFov.Draw(param); // [!code ++]
	} // [!code ++]
	goto IL_6fea; // [!code ++]
	IL_7ba5: // [!code ++]
	if (detail.things.Count == 0 && detail.charas.Count == 0) // [!code ++]
	{ // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	int num6 = 0; // [!code ++]
	thingPos.x = 0f; // [!code ++]
	thingPos.y = 0f; // [!code ++]
	thingPos.z = 0f; // [!code ++]
	freePos.x = (freePos.y = (freePos.z = 0f)); // [!code ++]
	if (this.cell.HasRamp) // [!code ++]
	{ // [!code ++]
		Vector3 rampFix = sourceBlock.tileType.GetRampFix(this.cell.blockDir); // [!code ++]
		param.x += rampFix.x; // [!code ++]
		param.y += rampFix.y; // [!code ++]
		param.z += rampFix.z; // [!code ++]
		freePos.x += rampFix.x; // [!code ++]
		freePos.y += rampFix.y; // [!code ++]
		freePos.z += rampFix.z; // [!code ++]
	} // [!code ++]
	param.y += (flag ? 0f : ((this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight)); // [!code ++]
	orgPos.x = (orgX = param.x); // [!code ++]
	orgPos.y = (orgY = param.y); // [!code ++]
	orgPos.z = (orgZ = param.z); // [!code ++]
	if (flag && liquidLv > 0) // [!code ++]
	{ // [!code ++]
		if (liquidLv > 10) // [!code ++]
		{ // [!code ++]
			liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
		} // [!code ++]
		liquidLv -= (int)(floatY * 0.5f); // [!code ++]
		param.liquidLv = liquidLv; // [!code ++]
		param.y -= TileType.FloorWaterShallow.FloorHeight; // [!code ++]
	} // [!code ++]
	Thing thing = null; // [!code ++]
	bool shadow = liquidLv == 0; // [!code ++]
	float num7 = 0f; // [!code ++]
	float num8 = 0f; // [!code ++]
	float num9 = 0f; // [!code ++]
	float num10 = 0f; // [!code ++]
	bool flag6 = false; // [!code ++]
	float num11 = 0f; // [!code ++]
	bool flag7 = false; // [!code ++]
	float num12 = 0f; // [!code ++]
	if (detail.things.Count > 0 && isSeen) // [!code ++]
	{ // [!code ++]
		_ = zSetting.max1; // [!code ++]
		float num13 = 0f; // [!code ++]
		for (int j = 0; j < detail.things.Count; j++) // [!code ++]
		{ // [!code ++]
			Thing t = detail.things[j]; // [!code ++]
			if ((fogged && !t.isRoofItem) || ((t.isHidden || t.trait.HideInAdv || t.isMasked) && !EMono.scene.actionMode.ShowMaskedThings) || (t.isRoofItem && ((this.room == null && !sourceBlock.tileType.IsFullBlock && !EMono._zone.IsPCFaction && !buildMode) || (lowBlock && !showFullWall && this.room != null) || (noRoofMode && currentRoom == null))) || (flag3 && !t.isRoofItem)) // [!code ++]
			{ // [!code ++]
				continue; // [!code ++]
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num7) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num7) & 4u) != 0) // [!code --]
			TileType tileType = t.trait.tileType; // [!code ++]
			bool isInstalled = t.IsInstalled; // [!code ++]
			SourcePref pref = t.Pref; // [!code ++]
			if (!isInstalled && t.category.tileDummy != 0) // [!code ++]
			{
				param.tile = 788f; // [!code --]
				param.matColor = GetColorInt(ref this.cell.FrontLeft.matFloor.matColor, this.cell.FrontLeft.sourceFloor.colorMod); // [!code --]
				passShore.Add(param); // [!code --]
				Draw(52); // [!code --]
				pref = rendererObjDummy.shadowPref; // [!code ++]
			}
			if (this.cell._bridge != 0 && this.cell.isBridgeEdge && this.cell.bridgePillar != byte.MaxValue) // [!code --]
			float num14 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code ++]
			if (t.ignoreStackHeight) // [!code ++]
			{
				pass = passEdge; // [!code --]
				batch = pass.batches[pass.batchIdx]; // [!code --]
				batch.matrices[pass.idx].m03 = param.x + waterEdgeBridgeFix.x; // [!code --]
				batch.matrices[pass.idx].m13 = param.y + waterEdgeBridgeFix.y; // [!code --]
				batch.matrices[pass.idx].m23 = param.z + waterEdgeBridgeFix.z; // [!code --]
				batch.tiles[pass.idx] = 616 + waterAnimeIndex % 4; // [!code --]
				batch.colors[pass.idx] = param.color; // [!code --]
				batch.matColors[pass.idx] = 104025f; // [!code --]
				pass.idx++; // [!code --]
				if (pass.idx == pass.batchSize) // [!code --]
				thingPos.y -= num7; // [!code ++]
				thingPos -= altitudeFix * num8; // [!code ++]
			} // [!code ++]
			shadow = thingPos.y < 0.16f && num12 < 0.16f; // [!code ++]
			_ = pref.bypassShadow; // [!code ++]
			param.shadowFix = 0f - thingPos.y; // [!code ++]
			param.liquidLv = ((thingPos.y + (float)t.altitude < 0.1f) ? liquidLv : 0); // [!code ++]
			if (t.isRoofItem) // [!code ++]
			{ // [!code ++]
				param.snow = isSnowCovered && !this.cell.isClearSnow; // [!code ++]
				SetRoofHeight(param, this.cell, cx, cz); // [!code ++]
				_actorPos.x = param.x; // [!code ++]
				_actorPos.y = param.y; // [!code ++]
				_actorPos.z = param.z + num13; // [!code ++]
				if (this.room != null) // [!code ++]
				{
					pass.NextBatch(); // [!code --]
					param.color = GetRoofLight(this.room.lot); // [!code ++]
				}
				shadow = false; // [!code ++]
				param.liquidLv = 0; // [!code ++]
			}
			bool flag6 = false; // [!code --]
			if (isShoreSand) // [!code --]
			else // [!code ++]
			{
				if (((uint)num8 & (true ? 1u : 0u)) != 0) // [!code --]
				param.snow = snowed; // [!code ++]
				_actorPos.x = orgX + num10; // [!code ++]
				_actorPos.y = orgY; // [!code ++]
				_actorPos.z = orgZ + num13 + thingPos.z; // [!code ++]
				if (tileType.CanStack || !isInstalled) // [!code ++]
				{
					if (((uint)num8 & 8u) != 0) // [!code --]
					if (thing?.id != t.id) // [!code ++]
					{
						if ((num8 & 2) == 0 && (num8 & 4) == 0) // [!code --]
						{ // [!code --]
							Draw(16); // [!code --]
						} // [!code --]
						flag6 = true; // [!code --]
						_actorPos.x += thingPos.x; // [!code ++]
					}
					if (((uint)num8 & 2u) != 0) // [!code --]
					_actorPos.y += thingPos.y; // [!code ++]
					if (t.trait.IgnoreLastStackHeight && (thing == null || !thing.trait.IgnoreLastStackHeight)) // [!code ++]
					{
						if ((num8 & 8) == 0 && (num8 & 4) == 0) // [!code --]
						thingPos.y -= num7; // [!code ++]
						if (thing != null) // [!code ++]
						{
							Draw(20); // [!code --]
							_actorPos.z -= 0.2f; // [!code ++]
							thingPos.z -= 0.2f; // [!code ++]
						}
						flag6 = true; // [!code --]
						_actorPos.y -= num7; // [!code ++]
					}
					_actorPos.z += renderSetting.thingZ + (float)j * -0.01f + zSetting.mod1 * thingPos.y; // [!code ++]
				}
				if (((uint)num8 & 4u) != 0) // [!code --]
				if (isInstalled) // [!code ++]
				{
					if (((uint)num8 & 8u) != 0) // [!code --]
					if (t.TileType.IsRamp) // [!code ++]
					{
						if ((num8 & 2) == 0 && (num8 & 1) == 0) // [!code --]
						Vector3 rampFix2 = t.TileType.GetRampFix(t.dir, pref); // [!code ++]
						orgX += rampFix2.x; // [!code ++]
						orgY += rampFix2.y; // [!code ++]
						orgZ += rampFix2.z; // [!code ++]
						freePos.x += rampFix2.x; // [!code ++]
						freePos.y += rampFix2.y; // [!code ++]
						freePos.z += rampFix2.z; // [!code ++]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code ++]
						{
							Draw(24); // [!code --]
							num12 += rampFix2.y; // [!code ++]
						}
						flag6 = true; // [!code --]
					} // [!code --]
					if (((uint)num8 & 2u) != 0) // [!code --]
						liquidLv -= (int)(rampFix2.y * 150f); // [!code ++]
						if (liquidLv < 0) // [!code ++]
						{ // [!code ++]
							liquidLv = 0; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					else if (!flag7 && t.trait.IsChangeFloorHeight && !t.ignoreStackHeight) // [!code ++]
					{
						if ((num8 & 8) == 0 && (num8 & 1) == 0) // [!code --]
						orgY += num14 + (float)t.altitude * altitudeFix.y; // [!code ++]
						orgZ += (float)t.altitude * altitudeFix.z; // [!code ++]
						freePos.y += num14 + (float)t.altitude * altitudeFix.y; // [!code ++]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code ++]
						{
							Draw(28); // [!code --]
							num12 += num14 + (float)t.altitude * altitudeFix.y; // [!code ++]
						} // [!code ++]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
						_actorPos.z += pref.z; // [!code ++]
						thingPos.z += pref.z; // [!code ++]
						if (liquidLv < 0) // [!code ++]
						{ // [!code ++]
							liquidLv = 0; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						thingPos.y += num14; // [!code ++]
						if (tileType.UseMountHeight) // [!code ++]
						{ // [!code ++]
							if (tileType != TileType.Illumination || !this.cell.HasObj) // [!code ++]
							{ // [!code ++]
								if (noRoofMode && currentRoom == null && t.altitude >= lowWallObjAltitude) // [!code ++]
								{ // [!code ++]
									continue; // [!code ++]
								} // [!code ++]
								if (hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code ++]
								{ // [!code ++]
									Room room = ((t.dir == 0) ? this.cell.Back.room : this.cell.Left.room); // [!code ++]
									if (t.trait.AlwaysHideOnLowWall) // [!code ++]
									{ // [!code ++]
										if (room == null || !room.data.showWallItem) // [!code ++]
										{ // [!code ++]
											continue; // [!code ++]
										} // [!code ++]
									} // [!code ++]
									else if (t.altitude >= lowWallObjAltitude) // [!code ++]
									{ // [!code ++]
										continue; // [!code ++]
									} // [!code ++]
								} // [!code ++]
							} // [!code ++]
							if (tileType.UseHangZFix) // [!code ++]
							{ // [!code ++]
								flag6 = true; // [!code ++]
							} // [!code ++]
							tileType.GetMountHeight(ref _actorPos, Point.shared.Set(index), t.dir, t); // [!code ++]
							shadow = false; // [!code ++]
							param.liquidLv = 0; // [!code ++]
							if (t.freePos) // [!code ++]
							{ // [!code ++]
								_actorPos.x += t.fx; // [!code ++]
								_actorPos.y += t.fy; // [!code ++]
							} // [!code ++]
						} // [!code ++]
						else // [!code ++]
						{ // [!code ++]
							thingPos.y += (float)t.altitude * altitudeFix.y; // [!code ++]
							thingPos.z += (float)t.altitude * altitudeFix.z; // [!code ++]
						} // [!code ++]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
						_actorPos.z += pref.z; // [!code ++]
						if (pref.height >= 0f) // [!code ++]
						{ // [!code ++]
							thingPos.z += pref.z; // [!code ++]
						}
						flag6 = true; // [!code --]
					} // [!code ++]
					if (!tileType.UseMountHeight && j > 10) // [!code ++]
					{ // [!code ++]
						flag7 = true; // [!code ++]
					}
				}
				if (!flag6) // [!code --]
				else // [!code ++]
				{
					if (!this.cell.Front.sourceFloor.tileType.IsWater && !this.cell.Front.isDeck) // [!code --]
					thingPos.y += num14; // [!code ++]
					_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
					_actorPos.z += pref.z; // [!code ++]
					thingPos.z += pref.z; // [!code ++]
				} // [!code ++]
				if (t.isFloating && isWater && !hasBridge && !flag) // [!code ++]
				{ // [!code ++]
					flag = true; // [!code ++]
					float num15 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
					orgY += 0.01f * floatY - num15; // [!code ++]
					if (!t.trait.IsChangeFloorHeight) // [!code ++]
					{
						Draw(8); // [!code --]
						num11 = num14; // [!code ++]
					}
					if (!this.cell.Right.sourceFloor.tileType.IsWater && !this.cell.Right.isDeck) // [!code --]
					_actorPos.y += 0.01f * floatY - num15; // [!code ++]
					if (liquidLv > 10) // [!code ++]
					{
						Draw(12); // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
					} // [!code ++]
					liquidLv -= (int)(floatY * 0.5f); // [!code ++]
					if (liquidLv < 0) // [!code ++]
					{ // [!code ++]
						liquidLv = 0; // [!code ++]
					} // [!code ++]
					param.liquidLv = liquidLv; // [!code ++]
				} // [!code ++]
				num7 = num14; // [!code ++]
				if (t.sourceCard.multisize && !t.trait.IsGround) // [!code ++]
				{ // [!code ++]
					num13 += zSetting.multiZ; // [!code ++]
				} // [!code ++]
				orgZ += t.renderer.data.stackZ; // [!code ++]
				if (param.liquidLv > 0) // [!code ++]
				{ // [!code ++]
					param.liquidLv += pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 1; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + pref.liquidModMax; // [!code ++]
					}
				}
			}
			if (!flag6) // [!code --]
			if (!isInstalled || !tileType.UseMountHeight) // [!code ++]
			{
				if (!this.cell.Back.sourceFloor.tileType.IsWater && !this.cell.Back.isDeck) // [!code --]
				if (t.altitude != 0) // [!code ++]
				{
					pass = passEdge; // [!code --]
					batch = pass.batches[pass.batchIdx]; // [!code --]
					batch.tiles[pass.idx] = 608 + waterAnimeIndex % 4; // [!code --]
					batch.matColors[pass.idx] = 104025f; // [!code --]
					if (((uint)(this.cell.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
					_actorPos += altitudeFix * t.altitude; // [!code ++]
					if (!t.isRoofItem) // [!code ++]
					{
						if (isShoreSand) // [!code --]
						{ // [!code --]
							param.matColor = GetColorInt(ref this.cell.Back.matFloor.matColor, this.cell.Back.sourceFloor.colorMod); // [!code --]
							batch.matrices[pass.idx].m03 = param.x + waterEdgeFixShoreSand.x; // [!code --]
							batch.matrices[pass.idx].m13 = param.y + waterEdgeFixShoreSand.y; // [!code --]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShoreSand.z; // [!code --]
							batch.tiles[pass.idx] = 640 + seaAnimeIndexes[waterAnimeIndex % seaAnimeIndexes.Length]; // [!code --]
							batch.matColors[pass.idx] = param.matColor; // [!code --]
						} // [!code --]
						else // [!code --]
						{ // [!code --]
							batch.matrices[pass.idx].m03 = param.x; // [!code --]
							batch.matrices[pass.idx].m13 = param.y; // [!code --]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShore.z; // [!code --]
						} // [!code --]
						num9 += (float)t.altitude; // [!code ++]
						num8 = t.altitude; // [!code ++]
					}
					else // [!code --]
				} // [!code ++]
				if (num9 >= 2f && ((this.cell.Back.room != null && this.cell.Back.IsRoomEdge) || (this.cell.Left.room != null && this.cell.Left.IsRoomEdge)) && hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code ++]
				{ // [!code ++]
					continue; // [!code ++]
				} // [!code ++]
				if (t.freePos) // [!code ++]
				{ // [!code ++]
					if (t.isRoofItem) // [!code ++]
					{
						batch.matrices[pass.idx].m03 = param.x; // [!code --]
						batch.matrices[pass.idx].m13 = param.y; // [!code --]
						batch.matrices[pass.idx].m23 = param.z + waterEdgeFix.z; // [!code --]
						batch.tiles[pass.idx] += 12f; // [!code --]
						_actorPos.x += t.fx; // [!code ++]
						_actorPos.y += t.fy - (float)t.altitude * altitudeFix.y; // [!code ++]
					}
					batch.colors[pass.idx] = param.color; // [!code --]
					pass.idx++; // [!code --]
					if (pass.idx == pass.batchSize) // [!code --]
					else // [!code ++]
					{
						pass.NextBatch(); // [!code --]
						_actorPos.x = orgX + t.fx - freePos.x; // [!code ++]
						_actorPos.y = orgY + t.fy - freePos.y; // [!code ++]
					}
				}
				if (!this.cell.Left.sourceFloor.tileType.IsWater && !this.cell.Left.isDeck) // [!code --]
				if (t.trait is TraitDoor && (t.trait as TraitDoor).IsOpen()) // [!code ++]
				{
					pass = passEdge; // [!code --]
					batch = pass.batches[pass.batchIdx]; // [!code --]
					batch.tiles[pass.idx] = 612 + waterAnimeIndex % 4; // [!code --]
					batch.matColors[pass.idx] = 104025f; // [!code --]
					if (((uint)(this.cell.shore / num7) & 8u) != 0) // [!code --]
					_actorPos.z += -0.5f; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (!t.sourceCard.multisize || (t.pos.x == cx && t.pos.z == cz)) // [!code ++]
			{ // [!code ++]
				if (iconMode != 0) // [!code ++]
				{ // [!code ++]
					int num16 = 0; // [!code ++]
					switch (iconMode) // [!code ++]
					{
						if (isShoreSand) // [!code --]
					case CardIconMode.Visibility: // [!code ++]
						if (t.isMasked) // [!code ++]
						{
							param.matColor = GetColorInt(ref this.cell.Left.matFloor.matColor, this.cell.Left.sourceFloor.colorMod); // [!code --]
							batch.matrices[pass.idx].m03 = param.x + waterEdgeFixShoreSand.x; // [!code --]
							batch.matrices[pass.idx].m13 = param.y + waterEdgeFixShoreSand.y; // [!code --]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShoreSand.z; // [!code --]
							batch.tiles[pass.idx] = 644 + seaAnimeIndexes[waterAnimeIndex % seaAnimeIndexes.Length]; // [!code --]
							batch.matColors[pass.idx] = param.matColor; // [!code --]
							num16 = 17; // [!code ++]
						}
						else // [!code --]
						break; // [!code ++]
					case CardIconMode.State: // [!code ++]
						if (t.placeState == PlaceState.installed) // [!code ++]
						{
							batch.matrices[pass.idx].m03 = param.x; // [!code --]
							batch.matrices[pass.idx].m13 = param.y; // [!code --]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShore.z; // [!code --]
							num16 = 18; // [!code ++]
						} // [!code ++]
						break; // [!code ++]
					case CardIconMode.Deconstruct: // [!code ++]
						if (t.isDeconstructing) // [!code ++]
						{ // [!code ++]
							num16 = 14; // [!code ++]
						}
						break; // [!code ++]
					}
					else // [!code --]
					if (t.isNPCProperty && !EMono.debug.godBuild) // [!code ++]
					{
						batch.matrices[pass.idx].m03 = param.x; // [!code --]
						batch.matrices[pass.idx].m13 = param.y; // [!code --]
						batch.matrices[pass.idx].m23 = param.z + waterEdgeFix.z; // [!code --]
						batch.tiles[pass.idx] += 12f; // [!code --]
						num16 = 13; // [!code ++]
					}
					batch.colors[pass.idx] = param.color; // [!code --]
					pass.idx++; // [!code --]
					if (pass.idx == pass.batchSize) // [!code --]
					if (num16 != 0) // [!code ++]
					{
						pass.NextBatch(); // [!code --]
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num16); // [!code ++]
					}
				}
				t.SetRenderParam(param); // [!code ++]
				if (_lowblock && t.trait.UseLowblock && !this.cell.HasFullBlock) // [!code ++]
				{ // [!code ++]
					param.tile += ((param.tile < 0f) ? (-64) : 64); // [!code ++]
				} // [!code ++]
				if (t.trait is TraitTrolley && EMono.pc.ai is AI_Trolley aI_Trolley && aI_Trolley.trolley.owner == t) // [!code ++]
				{ // [!code ++]
					RenderParam _param = new RenderParam(param); // [!code ++]
					EMono.core.actionsLateUpdate.Add(delegate // [!code ++]
					{ // [!code ++]
						t.SetRenderParam(_param); // [!code ++]
						_actorPos.x = EMono.pc.renderer.position.x; // [!code ++]
						_actorPos.y = EMono.pc.renderer.position.y - pref.height; // [!code ++]
						_actorPos.z = EMono.pc.renderer.position.z + 0.02f; // [!code ++]
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code ++]
					}); // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code ++]
				} // [!code ++]
			}
			if (flag) // [!code --]
			if (isInstalled) // [!code ++]
			{
				param.y += 0.01f * floatY; // [!code --]
				num10 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
			} // [!code ++]
			param.x = orgX; // [!code ++]
			param.y = orgY; // [!code ++]
			param.z = orgZ; // [!code ++]
			param.color = floorLight; // [!code ++]
			thing = t; // [!code ++]
			if (pref.Float) // [!code ++]
			{ // [!code ++]
				liquidLv = 0; // [!code ++]
			}
		} // [!code --]
		if (flag) // [!code --]
		{ // [!code --]
			param.z -= 1f; // [!code --]
		}
	}
	if (this.cell.skipRender) // [!code --]
	orgY += num11; // [!code ++]
	if (detail.charas.Count <= 0) // [!code ++]
	{
		if (this.cell.pcSync) // [!code --]
		{ // [!code --]
			param.tile = 0f; // [!code --]
			rendererFov.Draw(param); // [!code --]
		} // [!code --]
		return;
	}
	if (hasBridge) // [!code --]
	param.shadowFix = 0f - num12; // [!code ++]
	param.color += 1310720f; // [!code ++]
	float max = zSetting.max2; // [!code ++]
	for (int k = 0; k < detail.charas.Count; k++) // [!code ++]
	{
		param.y = (float)(cz - cx) * screen.tileAlign.y + (float)(int)this.cell.bridgeHeight * _heightMod.y; // [!code --]
		param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)(int)this.cell.bridgeHeight * _heightMod.z; // [!code --]
		if (flag) // [!code --]
		Chara chara = detail.charas[k]; // [!code ++]
		if (chara.host != null || (chara != EMono.pc && chara != LayerDrama.alwaysVisible && (flag3 || fogged || (!showAllCards && !EMono.player.CanSee(chara))))) // [!code ++]
		{
			param.y += 0.01f * floatY; // [!code --]
			continue; // [!code ++]
		}
		param.color = floorLight; // [!code --]
		param.mat = matBridge; // [!code --]
		floorMatColor = ((sourceBridge.colorMod == 0) ? 104025 : GetColorInt(ref matBridge.matColor, sourceBridge.colorMod)); // [!code --]
		param.dir = this.cell.floorDir; // [!code --]
		param.tile = sourceBridge._tiles[this.cell.floorDir % sourceBridge._tiles.Length]; // [!code --]
		param.matColor = floorMatColor; // [!code --]
		sourceBridge.renderData.Draw(param); // [!code --]
		if (this.cell.autotileBridge != 0 && sourceBridge.autotile != 0) // [!code --]
		_actorPos.x = orgX; // [!code ++]
		_actorPos.y = orgY; // [!code ++]
		_actorPos.z = orgZ; // [!code ++]
		chara.SetRenderParam(param); // [!code ++]
		_ = chara.IsAliveInCurrentZone; // [!code ++]
		if (chara.isRestrained) // [!code ++]
		{
			pass = passAutoTile; // [!code --]
			batch = pass.batches[pass.batchIdx]; // [!code --]
			batch.matrices[pass.idx].m03 = param.x; // [!code --]
			batch.matrices[pass.idx].m13 = param.y; // [!code --]
			batch.matrices[pass.idx].m23 = param.z + ((this.cell._block != 0) ? 0.8f : 0f); // [!code --]
			batch.tiles[pass.idx] = (26 + sourceBridge.autotile / 2) * 32 + sourceBridge.autotile % 2 * 16 + this.cell.autotileBridge; // [!code --]
			batch.colors[pass.idx] = param.color + (float)((int)(sourceBridge.autotileBrightness * 100f) * 262144); // [!code --]
			batch.matColors[pass.idx] = param.matColor; // [!code --]
			pass.idx++; // [!code --]
			if (pass.idx == pass.batchSize) // [!code --]
			TraitShackle restrainer = chara.GetRestrainer(); // [!code ++]
			if (restrainer != null) // [!code ++]
			{
				pass.NextBatch(); // [!code --]
				Vector3 getRestrainPos = restrainer.GetRestrainPos; // [!code ++]
				if (getRestrainPos != default(Vector3)) // [!code ++]
				{ // [!code ++]
					Vector3 position = restrainer.owner.renderer.position; // [!code ++]
					float defCharaHeight = EMono.setting.render.defCharaHeight; // [!code ++]
					float num17 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code ++]
					_actorPos.x = position.x + getRestrainPos.x * (float)((restrainer.owner.dir % 2 == 0) ? 1 : (-1)); // [!code ++]
					_actorPos.y = position.y + num17; // [!code ++]
					_actorPos.z = position.z + getRestrainPos.z; // [!code ++]
					param.liquidLv = 0; // [!code ++]
					param.shadowFix = orgY - _actorPos.y; // [!code ++]
					chara.renderer.SetFirst(first: true); // [!code ++]
					chara.renderer.Draw(param, ref _actorPos, drawShadow: true); // [!code ++]
					param.shadowFix = 0f; // [!code ++]
					continue; // [!code ++]
				} // [!code ++]
			}
		}
		if (this.cell.shadow != 0) // [!code --]
		if (!chara.sourceCard.multisize || (chara.pos.x == cx && chara.pos.z == cz)) // [!code ++]
		{
			if (sourceBridge == FLOOR.sourceSnow) // [!code --]
			if (chara.IsDeadOrSleeping && chara.IsPCC) // [!code ++]
			{
				param.tile = 448 + this.cell.shadow + 8 + (this.cell.HasFence ? 4 : 0); // [!code --]
				param.z -= 0.01f; // [!code --]
				sourceBridge.renderData.Draw(param); // [!code --]
				float num18 = chara.renderer.data.size.y * 0.3f; // [!code ++]
				if (thingPos.y > max) // [!code ++]
				{ // [!code ++]
					thingPos.y = max; // [!code ++]
				} // [!code ++]
				float num19 = thingPos.y + num18; // [!code ++]
				float num20 = (float)k * -0.01f; // [!code ++]
				if (num19 > zSetting.thresh1) // [!code ++]
				{ // [!code ++]
					num20 = zSetting.mod1; // [!code ++]
				} // [!code ++]
				_actorPos.x += thingPos.x; // [!code ++]
				_actorPos.y += thingPos.y; // [!code ++]
				_actorPos.z += renderSetting.laydownZ + num20; // [!code ++]
				param.liquidLv = ((thingPos.y == 0f && liquidLv > 0) ? 90 : 0); // [!code ++]
				thingPos.y += num18 * 0.8f; // [!code ++]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code ++]
			}
			else
			{
				pass = passEdge; // [!code --]
				batch = pass.batches[pass.batchIdx]; // [!code --]
				batch.matrices[pass.idx].m03 = param.x + ambientShadowFix[this.cell.shadow].x; // [!code --]
				batch.matrices[pass.idx].m13 = param.y + ambientShadowFix[this.cell.shadow].y; // [!code --]
				batch.matrices[pass.idx].m23 = param.z + ambientShadowFix[this.cell.shadow].z; // [!code --]
				batch.tiles[pass.idx] = 448 + this.cell.shadow; // [!code --]
				batch.colors[pass.idx] = blockLight; // [!code --]
				batch.matColors[pass.idx] = 104025f; // [!code --]
				pass.idx++; // [!code --]
				if (pass.idx == pass.batchSize) // [!code --]
				param.liquidLv = liquidLv; // [!code ++]
				if (isUnderwater) // [!code ++]
				{
					pass.NextBatch(); // [!code --]
					if (chara.Pref.FloatUnderwater) // [!code ++]
					{ // [!code ++]
						float num21 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
						float num22 = floatYs[chara.uid % 10] + 10f + (float)(chara.uid % 30); // [!code ++]
						orgY += 0.01f * num22 - num21; // [!code ++]
						_actorPos.y += 0.01f * num22 - num21; // [!code ++]
						param.shadowFix -= 0.01f * num22 - num21; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else if (liquidLv > 0) // [!code ++]
				{ // [!code ++]
					if (chara.Pref.Float && !flag && !hasBridge) // [!code ++]
					{ // [!code ++]
						if (liquidLv > 20) // [!code ++]
						{ // [!code ++]
							float num23 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
							orgY += 0.01f * floatY - num23; // [!code ++]
							_actorPos.y += 0.01f * floatY - num23; // [!code ++]
							int num24 = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
							num24 -= (int)(floatY * 0.5f); // [!code ++]
							param.liquidLv = num24; // [!code ++]
						} // [!code ++]
						else // [!code ++]
						{ // [!code ++]
							param.liquidLv -= 20; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					param.liquidLv += chara.Pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 1; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + chara.Pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + chara.Pref.liquidModMax; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				if (!chara.IsPC && !chara.renderer.IsMoving && detail.charas.Count > 1 && (detail.charas.Count != 2 || !detail.charas[0].IsDeadOrSleeping || !detail.charas[0].IsPCC)) // [!code ++]
				{ // [!code ++]
					_actorPos += renderSetting.charaPos[1 + ((num6 < 4) ? num6 : 3)]; // [!code ++]
				}
				_actorPos.z += 0.01f * (float)k + renderSetting.charaZ; // [!code ++]
				num6++; // [!code ++]
				if (flag6) // [!code ++]
				{ // [!code ++]
					_actorPos.z += chara.renderer.data.hangedFixZ; // [!code ++]
				} // [!code ++]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code ++]
			}
		}
		if (this.cell.isBridgeEdge && this.cell.bridgeHeight - this.cell.height >= 3 && this.cell.bridgePillar != byte.MaxValue && !noSlopMode) // [!code --]
		param.x = orgX; // [!code ++]
		param.y = orgY; // [!code ++]
		param.z = orgZ; // [!code ++]
	} // [!code ++]
	return; // [!code ++]
	IL_169b: // [!code ++]
	if (this.cell.isSlopeEdge) // [!code ++]
	{ // [!code ++]
		float num25 = (float)height * _heightMod.y; // [!code ++]
		orgY = param.y; // [!code ++]
		orgZ = param.z; // [!code ++]
		param.dir = this.cell.blockDir; // [!code ++]
		if (snowed) // [!code ++]
		{
			orgY = param.y; // [!code --]
			orgZ = param.z; // [!code --]
			param.y += bridgeFix.y; // [!code --]
			param.z += bridgeFix.z; // [!code --]
			param.dir = 0; // [!code --]
			SourceBlock.Row row4 = sourceBridge._bridgeBlock; // [!code --]
			float num10 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code --]
			if (this.cell.sourceFloor.tileType == TileType.Sky) // [!code --]
			{ // [!code --]
				num10 += (float)EMono._map.config.skyBlockHeight; // [!code --]
			} // [!code --]
			int num11 = (int)(num10 / heightBlockSize) + 2; // [!code --]
			if (this.cell.bridgePillar != 0) // [!code --]
			param.color = floorLight; // [!code ++]
		} // [!code ++]
		SourceBlock.Row defBlock; // [!code ++]
		if (sourceBlock.tileType.IsFullBlock) // [!code ++]
		{ // [!code ++]
			defBlock = sourceBlock; // [!code ++]
			param.mat = matBlock; // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			defBlock = sourceFloor._defBlock; // [!code ++]
			param.mat = matFloor; // [!code ++]
			param.tile = defBlock._tiles[this.cell.blockDir % defBlock._tiles.Length]; // [!code ++]
			if (defBlock.id != 1) // [!code ++]
			{
				row4 = EMono.sources.blocks.rows[this.cell.bridgePillar]; // [!code --]
				param.tile = row4._tiles[0] + ((num11 == 2) ? 32 : 0); // [!code --]
				param.mat = ((sourceBridge.DefaultMaterial == row4.DefaultMaterial) ? sourceBridge.DefaultMaterial : row4.DefaultMaterial); // [!code --]
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, row4.colorMod)); // [!code --]
				param.matColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code ++]
			}
			else
			{
				param.mat = matBlock; // [!code --]
				param.tile = row4._tiles[0] + 32; // [!code --]
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref matBridge.matColor, row4.colorMod)); // [!code --]
				param.matColor = 104025f; // [!code ++]
			}
			param.y += ugFixBridgeTop.y; // [!code --]
			param.z += ugFixBridgeTop.z; // [!code --]
			for (int l = 0; l < num11; l++) // [!code --]
		} // [!code ++]
		for (int l = 0; (float)l < num25 / heightBlockSize; l++) // [!code ++]
		{ // [!code ++]
			param.y += ugFix.y; // [!code ++]
			param.z += ugFix.z + slopeFixZ * (float)l; // [!code ++]
			defBlock.renderData.Draw(param); // [!code ++]
			if (this.cell.pcSync && EMono.player.lightPower > 0f) // [!code ++]
			{
				if (l == num11 - 1) // [!code --]
				{ // [!code --]
					param.y = (float)(cz - cx) * screen.tileAlign.y + (float)height * _heightMod.y + ugFixBridgeBottom.y; // [!code --]
					param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)height * _heightMod.z + ugFixBridgeBottom.z; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.y += ugFixBridge.y; // [!code --]
					param.z += ugFixBridge.z; // [!code --]
				} // [!code --]
				row4.renderData.Draw(param); // [!code --]
				float num26 = param.tile; // [!code ++]
				param.tile = 0f; // [!code ++]
				rendererFov.Draw(param); // [!code ++]
				param.tile = num26; // [!code ++]
			}
			param.y = orgY; // [!code --]
			param.z = orgZ; // [!code --]
		}
		param.y = orgY; // [!code ++]
		param.z = orgZ; // [!code ++]
	}
	if (!buildMode && this.cell.highlight != 0) // [!code --]
	param.color = floorLight; // [!code ++]
	if (!isWater && (this.cell.Front.sourceFloor.tileType.IsWater || this.cell.Right.sourceFloor.tileType.IsWater) && this.cell.sourceBlock.tileType.RenderWaterBlock && !flag) // [!code ++]
	{
		if (this.cell._block != 0 && !this.cell.hasDoor) // [!code --]
		orgY = param.y; // [!code ++]
		orgZ = param.z; // [!code ++]
		int num27 = 0; // [!code ++]
		if (sourceBlock.tileType.IsFullBlock) // [!code ++]
		{
			screen.guide.DrawWall(this.cell.GetPoint(), EMono.Colors.blockColors.MapHighlight, useMarkerPass: true); // [!code --]
			SourceBlock.Row row3 = sourceBlock; // [!code ++]
			num27 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
		}
		else
		{
			passGuideFloor.Add(this.cell.GetPoint(), (int)this.cell.highlight); // [!code --]
			SourceBlock.Row row3 = sourceFloor._defBlock; // [!code ++]
			num27 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code ++]
		} // [!code ++]
		if (((this.cell.Front.shore / 12) & 1) == 0 && this.cell.Front.sourceFloor.tileType.IsWater && this.cell.Front.height <= height && this.cell.Front.sourceBlock.tileType.RenderWaterBlock) // [!code ++]
		{ // [!code ++]
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Front.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Front.height * _heightMod.y; // [!code ++]
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z; // [!code ++]
			param.tile = num27 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param); // [!code ++]
		} // [!code ++]
		if (((this.cell.Right.shore / 12) & 8) == 0 && this.cell.Right.sourceFloor.tileType.IsWater && this.cell.Right.height <= height && this.cell.Right.sourceBlock.tileType.RenderWaterBlock) // [!code ++]
		{ // [!code ++]
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Right.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Right.height * _heightMod.y; // [!code ++]
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z; // [!code ++]
			param.tile = num27 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param); // [!code ++]
		}
		param.y = orgY; // [!code ++]
		param.z = orgZ; // [!code ++]
	}
	param.color = blockLight; // [!code --]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && (snowed || this.cell.isClearSnow) && (this.cell.Front.HasRoof || this.cell.Right.HasRoof)) // [!code --]
	if (showBorder && !this.cell.outOfBounds) // [!code ++]
	{
		snowed = false; // [!code --]
		param.matColor = 104025f; // [!code ++]
		if (cx == EMono._map.bounds.x) // [!code ++]
		{ // [!code ++]
			renderBorder.Draw(param, 12 + (EMono.world.date.IsNight ? 4 : 0)); // [!code ++]
		} // [!code ++]
		else if (cx == EMono._map.bounds.maxX) // [!code ++]
		{ // [!code ++]
			renderBorder.Draw(param, 13 + (EMono.world.date.IsNight ? 4 : 0)); // [!code ++]
		} // [!code ++]
		if (cz == EMono._map.bounds.z) // [!code ++]
		{ // [!code ++]
			renderBorder.Draw(param, 14 + (EMono.world.date.IsNight ? 4 : 0)); // [!code ++]
		} // [!code ++]
		else if (cz == EMono._map.bounds.maxZ) // [!code ++]
		{ // [!code ++]
			renderBorder.Draw(param, 15 + (EMono.world.date.IsNight ? 4 : 0)); // [!code ++]
		} // [!code ++]
	}
	int num12 = 0; // [!code --]
	if (sourceBlock.id != 0) // [!code --]
	if (this.cell.isSkyFloor || (detail != null && detail.anime != null && detail.anime.drawBlock)) // [!code ++]
	{
		this.tileType = sourceBlock.tileType; // [!code --]
		roomHeight = 0f; // [!code --]
		int blockDir = this.cell.blockDir; // [!code --]
		bool flag7 = false; // [!code --]
		switch (wallClipMode) // [!code --]
		orgY = param.y; // [!code ++]
		orgZ = param.z; // [!code ++]
		SourceBlock.Row defBlock2 = sourceFloor._defBlock; // [!code ++]
		param.mat = matFloor; // [!code ++]
		param.tile = defBlock2._tiles[this.cell.blockDir % defBlock2._tiles.Length]; // [!code ++]
		if (defBlock2.id != 1) // [!code ++]
		{
		case WallClipMode.ByRoom: // [!code --]
			if (!this.tileType.RepeatBlock) // [!code --]
			{ // [!code --]
				break; // [!code --]
			} // [!code --]
			if (currentRoom == null || showFullWall) // [!code --]
			param.matColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			param.matColor = 104025f; // [!code ++]
		} // [!code ++]
		for (int m = 0; m < ((!this.cell.isSkyFloor) ? 1 : EMono._map.config.skyBlockHeight); m++) // [!code ++]
		{ // [!code ++]
			param.y += ugFix.y; // [!code ++]
			param.z += ugFix.z + slopeFixZ * (float)m; // [!code ++]
			defBlock2.renderData.Draw(param); // [!code ++]
		} // [!code ++]
		param.y = orgY; // [!code ++]
		param.z = orgZ; // [!code ++]
	} // [!code ++]
	if (!sourceFloor.tileType.IsSkipFloor) // [!code ++]
	{ // [!code ++]
		if ((hasBridge && sourceBridge.tileType.CastShadowSelf) || this.cell.castFloorShadow) // [!code ++]
		{ // [!code ++]
			floorLight2 = _lightMod * light * 0.2f + _baseBrightness + _shadowStrength * floorShadowStrength * (isWater ? 0.7f : (hasBridge ? 1f : (0.6f * (1f - nightRatio)))); // [!code ++]
			if (snowed) // [!code ++]
			{
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code --]
				_lowblock = lowBlock; // [!code --]
				floorLight2 = (int)((double)floorLight2 * 0.85 * 50.0) * 262144 + snowColorToken; // [!code ++]
			}
			else if (this.room != this.cell.Front.room && (this.cell.Front.room == currentRoom || (this.room?.lot != currentLot && this.cell.Front.room?.lot == currentLot))) // [!code --]
			else // [!code ++]
			{
				this.room = this.cell.Front.room; // [!code --]
				_lowblock = !this.cell.Front.lotWall && !this.cell.Front.fullWall; // [!code --]
				floorLight2 = (int)(floorLight2 * 50f) * 262144 + ((this.cell.lightR >= 64) ? 63 : this.cell.lightR) * 4096 + ((this.cell.lightG >= 64) ? 63 : this.cell.lightG) * 64 + ((this.cell.lightB >= 64) ? 63 : this.cell.lightB); // [!code ++]
			}
			else if (this.room != this.cell.Right.room && (this.cell.Right.room == currentRoom || (this.room?.lot != currentLot && this.cell.Right.room?.lot == currentLot))) // [!code --]
			param.color = floorLight2; // [!code ++]
			if (this.cell.lotShade) // [!code ++]
			{
				this.room = this.cell.Right.room; // [!code --]
				_lowblock = !this.cell.Right.lotWall && !this.cell.Right.fullWall; // [!code --]
				floorLight = floorLight2; // [!code ++]
			}
			else if (this.tileType.IsFullBlock && this.room != this.cell.FrontRight.room && (this.cell.FrontRight.room == currentRoom || (this.room?.lot != currentLot && this.cell.FrontRight.room?.lot == currentLot))) // [!code --]
		} // [!code ++]
		floorMatColor = ((sourceFloor.colorMod == 0) ? 104025 : GetColorInt(ref matFloor.matColor, sourceFloor.colorMod)); // [!code ++]
		if (isWater && flag) // [!code ++]
		{ // [!code ++]
			param.y -= 0.01f * floatY; // [!code ++]
		} // [!code ++]
		if (!sourceBlock.tileType.IsSkipFloor || sourceBlock.transparent || hasBridge || this.cell.hasDoor || this.cell.skipRender) // [!code ++]
		{ // [!code ++]
			param.mat = matFloor; // [!code ++]
			param.tile = sourceFloor._tiles[floorDir % sourceFloor._tiles.Length]; // [!code ++]
			param.matColor = floorMatColor; // [!code ++]
			param.snow = snowed; // [!code ++]
			if (this.cell.isDeck) // [!code ++]
			{
				this.room = this.cell.FrontRight.room; // [!code --]
				_lowblock = !this.cell.FrontRight.lotWall && !this.cell.FrontRight.fullWall; // [!code --]
				param.z += 1f; // [!code ++]
				if ((bool)sourceFloor.renderData.subData) // [!code ++]
				{ // [!code ++]
					sourceFloor.renderData.subData.Draw(param); // [!code ++]
				} // [!code ++]
				sourceFloor.renderData.Draw(param); // [!code ++]
				param.z -= 1f; // [!code ++]
			}
			else
			{
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code --]
				_lowblock = true; // [!code --]
				if (!this.tileType.IsFullBlock) // [!code --]
				if ((bool)sourceFloor.renderData.subData) // [!code ++]
				{
					if (this.cell.lotWall) // [!code --]
					{ // [!code --]
						_lowblock = false; // [!code --]
					} // [!code --]
					else if (this.room == currentRoom) // [!code --]
					{ // [!code --]
						_lowblock = !this.cell.fullWall; // [!code --]
					} // [!code --]
					sourceFloor.renderData.subData.Draw(param); // [!code ++]
				}
				sourceFloor.renderData.Draw(param); // [!code ++]
			}
			flag7 = (this.room != null && this.room.data.atrium) || (this.cell.room != null && this.cell.room.data.atrium); // [!code --]
			if (flag7) // [!code --]
			{ // [!code --]
				_lowblock = false; // [!code --]
			} // [!code --]
			if (this.room == null && alwaysLowblock) // [!code --]
			{ // [!code --]
				_lowblock = true; // [!code --]
				roomHeight = 0f; // [!code --]
			} // [!code --]
			if (this.room != null) // [!code --]
			int num28 = 0; // [!code ++]
			if (isSnowCovered && sourceFloor == FLOOR.sourceSnow && !this.cell.hasDoor) // [!code ++]
			{
				maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)this.room.lot.mh * _heightMod.y; // [!code --]
				if (showRoof) // [!code --]
				if (!this.cell.Right.IsSnowTile && this.cell.Right.topHeight == this.cell.topHeight) // [!code ++]
				{
					roomHeight = this.room.lot.realHeight; // [!code --]
					break; // [!code --]
					num28++; // [!code ++]
				}
				if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code --]
				if (!this.cell.Front.IsSnowTile && this.cell.Front.topHeight == this.cell.topHeight) // [!code ++]
				{
					roomHeight = 0f; // [!code --]
					break; // [!code --]
					num28 += 2; // [!code ++]
				}
				int num13 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code --]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num13) ? this.room.lot.height : num13) + 0.01f * (float)this.room.lot.heightFix; // [!code --]
			} // [!code --]
			break; // [!code --]
		case WallClipMode.ByLot: // [!code --]
			if (defaultBlockHeight > 0f || isIndoor) // [!code --]
			{ // [!code --]
				_lowblock = cx != 0 && cz != Size - 1 && ((!this.cell.Back.HasBlock && !this.cell.Back.isWallEdge) || (!this.cell.Left.HasBlock && !this.cell.Left.isWallEdge) || !this.cell.Back.Left.HasBlock); // [!code --]
				if (!_lowblock) // [!code --]
				if (num28 != 0) // [!code ++]
				{
					roomHeight = defaultBlockHeight * EMono.setting.render.roomHeightMod; // [!code --]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)(int)this.cell.TopHeight * _heightMod.y; // [!code --]
					param.tile = 448 + num28 + 12; // [!code ++]
					param.z -= 0.1f; // [!code ++]
					sourceFloor.renderData.Draw(param); // [!code ++]
					param.z += 0.1f; // [!code ++]
				}
				break; // [!code --]
			}
			if (showFullWall) // [!code --]
			if (this.cell.shadow != 0 && !hasBridge && !this.cell.skipRender) // [!code ++]
			{
				_lowblock = this.room != null; // [!code --]
				if (_lowblock) // [!code --]
				if (snowed) // [!code ++]
				{
					if (this.cell.Back.IsRoomEdge && this.cell.Right.IsRoomEdge && this.cell.Back.room == null && this.cell.Right.room == null && this.cell.Right.Front.room?.lot == this.room?.lot) // [!code --]
					if (sourceFloor == FLOOR.sourceSnow) // [!code ++]
					{
						_lowblock = false; // [!code --]
						param.tile = 448 + this.cell.shadow + 8 + (this.cell.HasFence ? 4 : 0); // [!code ++]
						param.z -= 0.01f; // [!code ++]
						sourceFloor.renderData.Draw(param); // [!code ++]
					}
				}
				else if (this.cell.Back.room != null && this.cell.Back.room.lot == (this.cell.Front.room ?? this.cell.Right.room)?.lot) // [!code --]
				else // [!code ++]
				{
					_lowblock = true; // [!code --]
					pass = passEdge; // [!code ++]
					batch = pass.batches[pass.batchIdx]; // [!code ++]
					batch.matrices[pass.idx].m03 = param.x + ambientShadowFix[this.cell.shadow].x; // [!code ++]
					batch.matrices[pass.idx].m13 = param.y + ambientShadowFix[this.cell.shadow].y; // [!code ++]
					batch.matrices[pass.idx].m23 = param.z + ambientShadowFix[this.cell.shadow].z; // [!code ++]
					batch.tiles[pass.idx] = 448 + this.cell.shadow; // [!code ++]
					batch.colors[pass.idx] = param.color; // [!code ++]
					batch.matColors[pass.idx] = 104025f; // [!code ++]
					pass.idx++; // [!code ++]
					if (pass.idx == pass.batchSize) // [!code ++]
					{ // [!code ++]
						pass.NextBatch(); // [!code ++]
					} // [!code ++]
				}
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				_lowblock = lowBlock; // [!code --]
			} // [!code --]
			if (this.tileType.RepeatBlock) // [!code --]
			{ // [!code --]
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code --]
				if (this.room != null && (!noRoofMode || currentRoom != null) && (!showFullWall || currentRoom == null || this.room.lot == currentRoom.lot)) // [!code --]
				if (!sourceFloor.ignoreTransition && !snowed) // [!code ++]
				{
					roomHeight = ((_lowblock && !this.tileType.ForceRpeatBlock) ? 0f : this.room.lot.realHeight); // [!code --]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)this.room.lot.mh * _heightMod.y; // [!code --]
					Cell back = this.cell.Back; // [!code ++]
					if (back.sourceBlock.transition[0] != -1 && back.isSeen && !back.hasDoor) // [!code ++]
					{ // [!code ++]
						pass = passFloor; // [!code ++]
						batch = pass.batches[pass.batchIdx]; // [!code ++]
						batch.matrices[pass.idx].m03 = param.x + transitionFix[0].x; // [!code ++]
						batch.matrices[pass.idx].m13 = param.y + transitionFix[0].y; // [!code ++]
						batch.matrices[pass.idx].m23 = param.z + transitionFix[0].z; // [!code ++]
						batch.tiles[pass.idx] = 480 + back.sourceBlock.transition[0] + Rand.bytes[index % Rand.MaxBytes] % back.sourceBlock.transition[1]; // [!code ++]
						batch.colors[pass.idx] = param.color; // [!code ++]
						batch.matColors[pass.idx] = GetColorInt(ref back.matBlock.matColor, back.sourceBlock.colorMod); // [!code ++]
						pass.idx++; // [!code ++]
						if (pass.idx == pass.batchSize) // [!code ++]
						{ // [!code ++]
							pass.NextBatch(); // [!code ++]
						} // [!code ++]
					} // [!code ++]
					back = this.cell.Left; // [!code ++]
					if (back.sourceBlock.transition[0] != -1 && back.isSeen && !back.hasDoor) // [!code ++]
					{ // [!code ++]
						pass = passFloor; // [!code ++]
						batch = pass.batches[pass.batchIdx]; // [!code ++]
						batch.matrices[pass.idx].m03 = param.x + transitionFix[1].x; // [!code ++]
						batch.matrices[pass.idx].m13 = param.y + transitionFix[1].y; // [!code ++]
						batch.matrices[pass.idx].m23 = param.z + transitionFix[1].z; // [!code ++]
						batch.tiles[pass.idx] = 512 + back.sourceBlock.transition[0] + Rand.bytes[index % Rand.MaxBytes] % back.sourceBlock.transition[1]; // [!code ++]
						batch.colors[pass.idx] = param.color; // [!code ++]
						batch.matColors[pass.idx] = GetColorInt(ref back.matBlock.matColor, back.sourceBlock.colorMod); // [!code ++]
						pass.idx++; // [!code ++]
						if (pass.idx == pass.batchSize) // [!code ++]
						{ // [!code ++]
							pass.NextBatch(); // [!code ++]
						} // [!code ++]
					} // [!code ++]
				}
			}
			break; // [!code --]
		} // [!code --]
		if (!_lowblock && (double)roomHeight > 1.2 && this.tileType.RepeatBlock) // [!code --]
		{ // [!code --]
			num12 = 1; // [!code --]
		} // [!code --]
		else if (lowBlock) // [!code --]
		{ // [!code --]
			num12 = 2; // [!code --]
		} // [!code --]
		param.mat = matBlock; // [!code --]
		param.dir = this.cell.blockDir; // [!code --]
		param.snow = snowed; // [!code --]
		switch (this.tileType.blockRenderMode) // [!code --]
		{ // [!code --]
		case BlockRenderMode.FullBlock: // [!code --]
		{ // [!code --]
			bool invisible = sourceBlock.tileType.Invisible; // [!code --]
			if (invisible && (!buildMode || ActionMode.Cinema.IsActive)) // [!code --]
			{ // [!code --]
				break; // [!code --]
			} // [!code --]
			if (this.cell.isSurrounded) // [!code --]
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num28 == 0) // [!code ++]
			{
				switch (innerMode) // [!code --]
				pass = (isWater ? passAutoTileWater : passAutoTile); // [!code ++]
				batch = pass.batches[pass.batchIdx]; // [!code ++]
				batch.matrices[pass.idx].m03 = param.x; // [!code ++]
				batch.matrices[pass.idx].m13 = param.y; // [!code ++]
				batch.matrices[pass.idx].m23 = param.z + ((hasBridge || this.cell._block != 0) ? 0.8f : 0f); // [!code ++]
				batch.tiles[pass.idx] = (26 + sourceFloor.autotile / 2) * 32 + sourceFloor.autotile % 2 * 16 + this.cell.autotile; // [!code ++]
				batch.colors[pass.idx] = param.color + (float)((int)(sourceFloor.autotileBrightness * 100f) * 262144); // [!code ++]
				batch.matColors[pass.idx] = param.matColor; // [!code ++]
				pass.idx++; // [!code ++]
				if (pass.idx == pass.batchSize) // [!code ++]
				{
				case InnerMode.InnerBlock: // [!code --]
				case InnerMode.BuildMode: // [!code --]
					blockLight = _baseBrightness + fogBrightness; // [!code --]
					param.color = (int)(50f * blockLight) * 262144; // [!code --]
					param.matColor = 104025f; // [!code --]
					param.tile = (buildMode ? 1 : 2) + ((_lowblock || defaultBlockHeight > 0f) ? 3000000 : 0); // [!code --]
					rendererInnerBlock.Draw(param); // [!code --]
					return; // [!code --]
				case InnerMode.None: // [!code --]
				case InnerMode.Height: // [!code --]
					param.color = blockLight; // [!code --]
					break; // [!code --]
					pass.NextBatch(); // [!code ++]
				}
			}
			if (snowed) // [!code --]
			{ // [!code --]
				param.color = floorLight; // [!code --]
			} // [!code --]
			param.color -= (int)(_shadowStrength * 0.8f * 50f) * 262144; // [!code --]
			if (currentRoom != null && !showFullWall) // [!code --]
		} // [!code ++]
		if (isWater) // [!code ++]
		{ // [!code ++]
			int num29 = 12; // [!code ++]
			int num30 = this.cell.shore / num29; // [!code ++]
			int num31 = this.cell.shore % num29; // [!code ++]
			bool isShoreSand = this.cell.isShoreSand; // [!code ++]
			if (this.cell.shore != 0) // [!code ++]
			{
				_lowblock = true; // [!code --]
				roomHeight = 0f; // [!code --]
				if (this.cell.room != currentRoom && (this.cell.Front.room == currentRoom || this.cell.Right.room == currentRoom || this.cell.FrontRight.room == currentRoom) && (this.cell.Back.room != currentRoom || this.cell.Right.room != currentRoom) && (this.cell.Front.room != currentRoom || this.cell.Left.room != currentRoom)) // [!code --]
				Cell cell = ((((uint)num30 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num30 & 2u) != 0) ? this.cell.Right : ((((uint)num30 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code ++]
				if (isShoreSand && !cell.sourceFloor.isBeach) // [!code ++]
				{
					_lowblock = false; // [!code --]
					cell = ((((uint)num30 & 8u) != 0) ? this.cell.Left : ((((uint)num30 & 4u) != 0) ? this.cell.Front : ((((uint)num30 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code ++]
				}
				if (!_lowblock) // [!code --]
				if (!cell.IsSnowTile) // [!code ++]
				{
					int num14 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code --]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num14) ? currentRoom.lot.height : num14) + 0.01f * (float)currentRoom.lot.heightFix; // [!code --]
					param.matColor = GetColorInt(ref cell.matFloor.matColor, cell.sourceFloor.colorMod); // [!code ++]
					if (isShoreSand) // [!code ++]
					{ // [!code ++]
						pass = passShore; // [!code ++]
						batch = pass.batches[pass.batchIdx]; // [!code ++]
						batch.matrices[pass.idx].m03 = param.x; // [!code ++]
						batch.matrices[pass.idx].m13 = param.y; // [!code ++]
						batch.matrices[pass.idx].m23 = param.z; // [!code ++]
						batch.tiles[pass.idx] = 768 + this.cell.shore / num29; // [!code ++]
						batch.colors[pass.idx] = param.color; // [!code ++]
						batch.matColors[pass.idx] = param.matColor; // [!code ++]
						pass.idx++; // [!code ++]
						if (pass.idx == pass.batchSize) // [!code ++]
						{ // [!code ++]
							pass.NextBatch(); // [!code ++]
						} // [!code ++]
						num31 = 2; // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						num31 = cell.sourceFloor.edge; // [!code ++]
					} // [!code ++]
					param.tile = (24 + num31 / 2) * 32 + num31 % 2 * 16 + num30; // [!code ++]
					rendererShore.Draw(param); // [!code ++]
				}
			}
			if (flag7) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num29) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num29) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				_lowblock = (!this.cell.Front.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Front.HasFullBlock || !this.cell.Left.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Left.HasFullBlock); // [!code --]
				if (_lowblock) // [!code --]
				{ // [!code --]
					roomHeight = 0f; // [!code --]
				} // [!code --]
				param.tile = 785f; // [!code ++]
				param.matColor = GetColorInt(ref this.cell.BackLeft.matFloor.matColor, this.cell.BackLeft.sourceFloor.colorMod); // [!code ++]
				passShore.Add(param); // [!code ++]
				Draw(60); // [!code ++]
			}
			if (invisible) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num29) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num29) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				roomHeight = 0f; // [!code --]
				_lowblock = false; // [!code --]
				param.tile = 786f; // [!code ++]
				param.matColor = GetColorInt(ref this.cell.BackRight.matFloor.matColor, this.cell.BackRight.sourceFloor.colorMod); // [!code ++]
				passShore.Add(param); // [!code ++]
				Draw(56); // [!code ++]
			}
			if (this.cell.Things.Count > 0) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num29) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num29) & 4u) != 0) // [!code ++]
			{
				_lowblock = false; // [!code --]
				param.tile = 787f; // [!code ++]
				param.matColor = GetColorInt(ref this.cell.FrontRight.matFloor.matColor, this.cell.FrontRight.sourceFloor.colorMod); // [!code ++]
				passShore.Add(param); // [!code ++]
				Draw(48); // [!code ++]
			}
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + (_lowblock ? 3000000 : 0); // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			if (roomHeight == 0f) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num29) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num29) & 4u) != 0) // [!code ++]
			{
				if (!this.cell.hasDoor) // [!code --]
				{ // [!code --]
					sourceBlock.renderData.Draw(param); // [!code --]
				} // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0, isBlock: true); // [!code --]
			} // [!code --]
			Room room = this.cell.Front.room ?? this.cell.room; // [!code --]
			if (room == null && this.cell.Right.room != null) // [!code --]
			{ // [!code --]
				room = this.cell.Right.room; // [!code --]
			} // [!code --]
			if (!invisible && room != null) // [!code --]
			{ // [!code --]
				if (room.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
				{ // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco); // [!code --]
					param.matColor = room.lot.colDeco; // [!code --]
					float y = param.y; // [!code --]
					param.y += (float)room.lot.decoFix * 0.01f; // [!code --]
					rendererWallDeco.Draw(param); // [!code --]
					param.y = y; // [!code --]
				} // [!code --]
				if (room.lot.idDeco2 != 0 && roomHeight != 0f && (float)room.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
				{ // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2); // [!code --]
					param.matColor = room.lot.colDeco2; // [!code --]
					float y2 = param.y; // [!code --]
					float num15 = param.z; // [!code --]
					param.y += (float)room.lot.decoFix2 * 0.01f; // [!code --]
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
					rendererWallDeco.Draw(param); // [!code --]
					param.y = y2; // [!code --]
					param.z = num15; // [!code --]
				} // [!code --]
			} // [!code --]
			room = this.cell.Right.room ?? this.cell.room; // [!code --]
			if (room == null && this.cell.Front.room != null) // [!code --]
			{ // [!code --]
				room = this.cell.Front.room; // [!code --]
				param.tile = 788f; // [!code ++]
				param.matColor = GetColorInt(ref this.cell.FrontLeft.matFloor.matColor, this.cell.FrontLeft.sourceFloor.colorMod); // [!code ++]
				passShore.Add(param); // [!code ++]
				Draw(52); // [!code ++]
			}
			if (!invisible && room != null) // [!code --]
			if (this.cell._bridge != 0 && this.cell.isBridgeEdge && this.cell.bridgePillar != byte.MaxValue) // [!code ++]
			{
				if (room.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
				{ // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco) * -1; // [!code --]
					param.matColor = room.lot.colDeco; // [!code --]
					float y3 = param.y; // [!code --]
					param.y += (float)room.lot.decoFix * 0.01f; // [!code --]
					rendererWallDeco.Draw(param); // [!code --]
					param.y = y3; // [!code --]
				} // [!code --]
				if (room.lot.idDeco2 != 0 && roomHeight != 0f && (float)room.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
				pass = passEdge; // [!code ++]
				batch = pass.batches[pass.batchIdx]; // [!code ++]
				batch.matrices[pass.idx].m03 = param.x + waterEdgeBridgeFix.x; // [!code ++]
				batch.matrices[pass.idx].m13 = param.y + waterEdgeBridgeFix.y; // [!code ++]
				batch.matrices[pass.idx].m23 = param.z + waterEdgeBridgeFix.z; // [!code ++]
				batch.tiles[pass.idx] = 616 + waterAnimeIndex % 4; // [!code ++]
				batch.colors[pass.idx] = param.color; // [!code ++]
				batch.matColors[pass.idx] = 104025f; // [!code ++]
				pass.idx++; // [!code ++]
				if (pass.idx == pass.batchSize) // [!code ++]
				{
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2) * -1; // [!code --]
					param.matColor = room.lot.colDeco2; // [!code --]
					float y4 = param.y; // [!code --]
					float num16 = param.z; // [!code --]
					param.y += (float)room.lot.decoFix2 * 0.01f; // [!code --]
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
					rendererWallDeco.Draw(param); // [!code --]
					param.y = y4; // [!code --]
					param.z = num16; // [!code --]
					pass.NextBatch(); // [!code ++]
				}
			}
			break; // [!code --]
		} // [!code --]
		case BlockRenderMode.WallOrFence: // [!code --]
		{ // [!code --]
			if (map.config.fullWallHeight) // [!code --]
			{ // [!code --]
				showFullWall = true; // [!code --]
				_lowblock = false; // [!code --]
			} // [!code --]
			orgY = param.y; // [!code --]
			orgZ = param.z; // [!code --]
			param.color = (this.tileType.IsFence ? (floorLight - (float)((int)(_shadowStrength * 0.8f * 50f) * 262144)) : blockLight); // [!code --]
			bool flag8 = blockDir == 1 || _lowblock || flag7; // [!code --]
			bool flag9 = blockDir == 0 || _lowblock || flag7; // [!code --]
			if (!showFullWall && currentRoom != null) // [!code --]
			bool flag8 = false; // [!code ++]
			if (isShoreSand) // [!code ++]
			{
				if (!flag8) // [!code --]
				if (((uint)num30 & (true ? 1u : 0u)) != 0) // [!code ++]
				{
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Front.room != currentRoom)) // [!code --]
					if (((uint)num30 & 8u) != 0) // [!code ++]
					{
						if (!this.cell.IsRoomEdge || (this.cell.Front.room != this.cell.room && this.cell.FrontRight.room != this.cell.room)) // [!code --]
						if ((num30 & 2) == 0 && (num30 & 4) == 0) // [!code ++]
						{
							flag8 = true; // [!code --]
							Draw(16); // [!code ++]
						}
						flag8 = true; // [!code ++]
					}
					else if ((!this.cell.Front.lotWall || this.cell.Front.room?.lot != currentLot) && this.cell.Front.room != currentRoom) // [!code --]
					if (((uint)num30 & 2u) != 0) // [!code ++]
					{
						if ((num30 & 8) == 0 && (num30 & 4) == 0) // [!code ++]
						{ // [!code ++]
							Draw(20); // [!code ++]
						} // [!code ++]
						flag8 = true;
					}
				}
				if (!flag9) // [!code --]
				if (((uint)num30 & 4u) != 0) // [!code ++]
				{
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Right.room != currentRoom)) // [!code --]
					if (((uint)num30 & 8u) != 0) // [!code ++]
					{
						if (!this.cell.IsRoomEdge || (this.cell.Right.room != this.cell.room && this.cell.FrontRight.room != this.cell.room)) // [!code --]
						if ((num30 & 2) == 0 && (num30 & 1) == 0) // [!code ++]
						{
							flag9 = true; // [!code --]
							Draw(24); // [!code ++]
						}
						flag8 = true; // [!code ++]
					}
					else if ((!this.cell.Right.lotWall || this.cell.Right.room?.lot != currentLot) && this.cell.Right.room != currentRoom) // [!code --]
					if (((uint)num30 & 2u) != 0) // [!code ++]
					{
						flag9 = true; // [!code --]
						if ((num30 & 8) == 0 && (num30 & 1) == 0) // [!code ++]
						{ // [!code ++]
							Draw(28); // [!code ++]
						} // [!code ++]
						flag8 = true; // [!code ++]
					}
				}
			} // [!code --]
			if (blockDir == 0 || blockDir == 2) // [!code --]
			{ // [!code --]
				param.dir = 0; // [!code --]
				Room room2 = this.cell.Front.room ?? this.cell.room; // [!code --]
				if (room2 != null && this.tileType.IsWall) // [!code --]
				if (!flag8) // [!code ++]
				{
					if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
					{ // [!code --]
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco); // [!code --]
						param.matColor = room2.lot.colDeco; // [!code --]
						param.y += (float)room2.lot.decoFix * 0.01f; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
					} // [!code --]
					if (room2.lot.idDeco2 != 0 && roomHeight != 0f && !flag8 && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
					if (!this.cell.Front.sourceFloor.tileType.IsWater && !this.cell.Front.isDeck) // [!code ++]
					{
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2); // [!code --]
						param.matColor = room2.lot.colDeco2; // [!code --]
						param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code --]
						param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
						param.z = orgZ; // [!code --]
						Draw(8); // [!code ++]
					}
				} // [!code --]
				Cell left = this.cell.Left; // [!code --]
				if (blockDir == 2 && left.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code --]
				{ // [!code --]
					_sourceBlock = left.sourceBlock; // [!code --]
					param.mat = left.matBlock; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					_sourceBlock = sourceBlock; // [!code --]
					param.mat = matBlock; // [!code --]
				} // [!code --]
				this.tileType = _sourceBlock.tileType; // [!code --]
				param.tile = (tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock) ? 32 : 0)); // [!code --]
				if (_sourceBlock.useAltColor) // [!code --]
				{ // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code --]
				} // [!code --]
				if (roomHeight == 0f || flag8 || !this.tileType.RepeatBlock) // [!code --]
				{ // [!code --]
					if (!this.cell.hasDoor) // [!code --]
					if (!this.cell.Right.sourceFloor.tileType.IsWater && !this.cell.Right.isDeck) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						Draw(12); // [!code ++]
					}
				}
				else // [!code --]
				{ // [!code --]
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code --]
				} // [!code --]
				param.z += cornerWallFix2.z; // [!code --]
				if ((blockDir == 2 || (this.cell.Front.HasWallOrFence && this.cell.Front.blockDir != 0)) != this.cell.isToggleWallPillar) // [!code --]
			} // [!code ++]
			if (!flag8) // [!code ++]
			{ // [!code ++]
				if (!this.cell.Back.sourceFloor.tileType.IsWater && !this.cell.Back.isDeck) // [!code ++]
				{
					if (this.cell.Back.IsSnowTile && this.cell.Right.IsSnowTile) // [!code --]
					pass = passEdge; // [!code ++]
					batch = pass.batches[pass.batchIdx]; // [!code ++]
					batch.tiles[pass.idx] = 608 + waterAnimeIndex % 4; // [!code ++]
					batch.matColors[pass.idx] = 104025f; // [!code ++]
					if (((uint)(this.cell.shore / num29) & (true ? 1u : 0u)) != 0) // [!code ++]
					{
						param.snow = true; // [!code --]
						if (isShoreSand) // [!code ++]
						{ // [!code ++]
							param.matColor = GetColorInt(ref this.cell.Back.matFloor.matColor, this.cell.Back.sourceFloor.colorMod); // [!code ++]
							batch.matrices[pass.idx].m03 = param.x + waterEdgeFixShoreSand.x; // [!code ++]
							batch.matrices[pass.idx].m13 = param.y + waterEdgeFixShoreSand.y; // [!code ++]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShoreSand.z; // [!code ++]
							batch.tiles[pass.idx] = 640 + seaAnimeIndexes[waterAnimeIndex % seaAnimeIndexes.Length]; // [!code ++]
							batch.matColors[pass.idx] = param.matColor; // [!code ++]
						} // [!code ++]
						else // [!code ++]
						{ // [!code ++]
							batch.matrices[pass.idx].m03 = param.x; // [!code ++]
							batch.matrices[pass.idx].m13 = param.y; // [!code ++]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShore.z; // [!code ++]
						} // [!code ++]
					}
					param.tile = _sourceBlock._tiles[0] + ((flag8 && flag9 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					if (roomHeight == 0f || !this.tileType.RepeatBlock || (flag8 && flag9 && !flag7)) // [!code --]
					else // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						batch.matrices[pass.idx].m03 = param.x; // [!code ++]
						batch.matrices[pass.idx].m13 = param.y; // [!code ++]
						batch.matrices[pass.idx].m23 = param.z + waterEdgeFix.z; // [!code ++]
						batch.tiles[pass.idx] += 12f; // [!code ++]
					}
					else // [!code --]
					batch.colors[pass.idx] = param.color; // [!code ++]
					pass.idx++; // [!code ++]
					if (pass.idx == pass.batchSize) // [!code ++]
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code --]
						pass.NextBatch(); // [!code ++]
					}
				}
				if (!flag8 && !showRoof && this.cell.Left.HasWallOrFence && this.cell.Left.blockDir != 0 && !this.cell.Left.isToggleWallPillar) // [!code --]
				if (!this.cell.Left.sourceFloor.tileType.IsWater && !this.cell.Left.isDeck) // [!code ++]
				{
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					param.x += cornerWallFix3.x; // [!code --]
					param.y += cornerWallFix3.y; // [!code --]
					param.z += cornerWallFix3.z; // [!code --]
					if (!flag7 && (roomHeight == 0f || flag8)) // [!code --]
					pass = passEdge; // [!code ++]
					batch = pass.batches[pass.batchIdx]; // [!code ++]
					batch.tiles[pass.idx] = 612 + waterAnimeIndex % 4; // [!code ++]
					batch.matColors[pass.idx] = 104025f; // [!code ++]
					if (((uint)(this.cell.shore / num29) & 8u) != 0) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						if (isShoreSand) // [!code ++]
						{ // [!code ++]
							param.matColor = GetColorInt(ref this.cell.Left.matFloor.matColor, this.cell.Left.sourceFloor.colorMod); // [!code ++]
							batch.matrices[pass.idx].m03 = param.x + waterEdgeFixShoreSand.x; // [!code ++]
							batch.matrices[pass.idx].m13 = param.y + waterEdgeFixShoreSand.y; // [!code ++]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShoreSand.z; // [!code ++]
							batch.tiles[pass.idx] = 644 + seaAnimeIndexes[waterAnimeIndex % seaAnimeIndexes.Length]; // [!code ++]
							batch.matColors[pass.idx] = param.matColor; // [!code ++]
						} // [!code ++]
						else // [!code ++]
						{ // [!code ++]
							batch.matrices[pass.idx].m03 = param.x; // [!code ++]
							batch.matrices[pass.idx].m13 = param.y; // [!code ++]
							batch.matrices[pass.idx].m23 = param.z + waterEdgeFixShore.z; // [!code ++]
						} // [!code ++]
					}
					else
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code --]
					} // [!code --]
					param.x = orgX; // [!code --]
				} // [!code --]
				else if (this.cell.FrontLeft.HasWallOrFence && this.cell.FrontLeft.blockDir != 0 && (!flag8 || !this.cell.Left.HasWall) && !this.cell.isToggleWallPillar) // [!code --]
				{ // [!code --]
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					param.x += cornerWallFix.x; // [!code --]
					param.y += cornerWallFix.y; // [!code --]
					param.z += cornerWallFix.z; // [!code --]
					if (!flag7 && (roomHeight == 0f || flag8)) // [!code --]
					{ // [!code --]
						_sourceBlock.renderData.Draw(param); // [!code --]
						batch.matrices[pass.idx].m03 = param.x; // [!code ++]
						batch.matrices[pass.idx].m13 = param.y; // [!code ++]
						batch.matrices[pass.idx].m23 = param.z + waterEdgeFix.z; // [!code ++]
						batch.tiles[pass.idx] += 12f; // [!code ++]
					}
					else // [!code --]
					batch.colors[pass.idx] = param.color; // [!code ++]
					pass.idx++; // [!code ++]
					if (pass.idx == pass.batchSize) // [!code ++]
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code --]
						pass.NextBatch(); // [!code ++]
					}
					param.x = orgX; // [!code --]
				}
			}
			if (blockDir == 1 || blockDir == 2) // [!code --]
			if (flag) // [!code ++]
			{
				param.y = orgY; // [!code --]
				param.z = orgZ; // [!code --]
				param.dir = 1; // [!code --]
				Room room3 = this.cell.Right.room ?? this.cell.room; // [!code --]
				if (room3 != null && this.tileType.IsWall) // [!code --]
				{ // [!code --]
					if (room3.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
					{ // [!code --]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco); // [!code --]
						param.matColor = room3.lot.colDeco; // [!code --]
						param.y += (float)room3.lot.decoFix * 0.01f; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
					} // [!code --]
					if (room3.lot.idDeco2 != 0 && roomHeight != 0f && !flag9 && (float)room3.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
					{ // [!code --]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco2); // [!code --]
						param.matColor = room3.lot.colDeco2; // [!code --]
						param.y += (float)room3.lot.decoFix2 * 0.01f; // [!code --]
						param.z += (float)room3.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
						param.z = orgZ; // [!code --]
					} // [!code --]
				} // [!code --]
				if (blockDir == 2 && this.cell.room == null && this.cell.Right.room != null) // [!code --]
				{ // [!code --]
					Room room4 = this.cell.Right.room; // [!code --]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)room4.lot.mh * _heightMod.y; // [!code --]
					if (showRoof) // [!code --]
					{ // [!code --]
						roomHeight = room4.lot.realHeight; // [!code --]
					} // [!code --]
					else if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code --]
					{ // [!code --]
						roomHeight = 0f; // [!code --]
					} // [!code --]
					else // [!code --]
					{ // [!code --]
						int num17 = ((room4.data.maxHeight == 0) ? 2 : room4.data.maxHeight); // [!code --]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room4.lot.height < num17) ? room4.lot.height : num17) + 0.01f * (float)room4.lot.heightFix; // [!code --]
					} // [!code --]
				} // [!code --]
				Cell back2 = this.cell.Back; // [!code --]
				if (blockDir == 2 && back2.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code --]
				{ // [!code --]
					_sourceBlock = back2.sourceBlock; // [!code --]
					param.mat = back2.matBlock; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					_sourceBlock = sourceBlock; // [!code --]
					param.mat = matBlock; // [!code --]
				} // [!code --]
				this.tileType = _sourceBlock.tileType; // [!code --]
				param.tile = (tile = -_sourceBlock._tiles[0] + ((flag9 && this.tileType.UseLowBlock) ? (-32) : 0)); // [!code --]
				if (_sourceBlock.useAltColor) // [!code --]
				{ // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code --]
				} // [!code --]
				param.color += _rightWallShade; // [!code --]
				if (roomHeight == 0f || flag9 || !this.tileType.RepeatBlock) // [!code --]
				{ // [!code --]
					if (!this.cell.hasDoor) // [!code --]
					{ // [!code --]
						_sourceBlock.renderData.Draw(param); // [!code --]
					} // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code --]
				} // [!code --]
				if ((this.cell.Right.HasWallOrFence && this.cell.Right.blockDir != 1) != this.cell.isToggleWallPillar && (blockDir != 2 || !this.cell.isToggleWallPillar)) // [!code --]
				{ // [!code --]
					if (this.cell.Left.IsSnowTile && this.cell.Front.IsSnowTile) // [!code --]
					{ // [!code --]
						param.snow = true; // [!code --]
					} // [!code --]
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag9 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					if (!flag7 && (roomHeight == 0f || !this.tileType.RepeatBlock || flag9)) // [!code --]
					{ // [!code --]
						_sourceBlock.renderData.Draw(param); // [!code --]
					} // [!code --]
					else // [!code --]
					{ // [!code --]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code --]
					} // [!code --]
					param.x = orgX; // [!code --]
				} // [!code --]
				param.y += 0.01f * floatY; // [!code ++]
			}
			param.y = orgY; // [!code --]
			param.z = orgZ; // [!code --]
			break; // [!code --]
		}
		case BlockRenderMode.HalfBlock: // [!code --]
			param.color = floorLight; // [!code --]
			_sourceBlock = ((sourceBlock.id == 5) ? EMono.sources.blocks.rows[matBlock.defBlock] : sourceBlock); // [!code --]
			param.tile = _sourceBlock._tiles[0]; // [!code --]
			param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.colorMod)); // [!code --]
			param.tile2 = _sourceBlock.sourceAutoFloor._tiles[0]; // [!code --]
			param.halfBlockColor = ((_sourceBlock.sourceAutoFloor.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.sourceAutoFloor.colorMod)); // [!code --]
			sourceBlock.renderData.Draw(param); // [!code --]
			break; // [!code --]
		case BlockRenderMode.Pillar: // [!code --]
		if (flag) // [!code ++]
		{
			RenderData renderData2 = sourceBlock.renderData; // [!code --]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			int num18 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code --]
			if (num18 == 0) // [!code --]
			param.z -= 1f; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.skipRender) // [!code ++]
	{ // [!code ++]
		if (this.cell.pcSync) // [!code ++]
		{ // [!code ++]
			param.tile = 0f; // [!code ++]
			rendererFov.Draw(param); // [!code ++]
		} // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	if (hasBridge) // [!code ++]
	{ // [!code ++]
		param.y = (float)(cz - cx) * screen.tileAlign.y + (float)(int)this.cell.bridgeHeight * _heightMod.y; // [!code ++]
		param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)(int)this.cell.bridgeHeight * _heightMod.z; // [!code ++]
		if (flag) // [!code ++]
		{ // [!code ++]
			param.y += 0.01f * floatY; // [!code ++]
		} // [!code ++]
		param.color = floorLight; // [!code ++]
		param.mat = matBridge; // [!code ++]
		floorMatColor = ((sourceBridge.colorMod == 0) ? 104025 : GetColorInt(ref matBridge.matColor, sourceBridge.colorMod)); // [!code ++]
		param.dir = this.cell.floorDir; // [!code ++]
		param.tile = sourceBridge._tiles[this.cell.floorDir % sourceBridge._tiles.Length]; // [!code ++]
		param.matColor = floorMatColor; // [!code ++]
		sourceBridge.renderData.Draw(param); // [!code ++]
		if (this.cell.autotileBridge != 0 && sourceBridge.autotile != 0) // [!code ++]
		{ // [!code ++]
			pass = passAutoTile; // [!code ++]
			batch = pass.batches[pass.batchIdx]; // [!code ++]
			batch.matrices[pass.idx].m03 = param.x; // [!code ++]
			batch.matrices[pass.idx].m13 = param.y; // [!code ++]
			batch.matrices[pass.idx].m23 = param.z + ((this.cell._block != 0) ? 0.8f : 0f); // [!code ++]
			batch.tiles[pass.idx] = (26 + sourceBridge.autotile / 2) * 32 + sourceBridge.autotile % 2 * 16 + this.cell.autotileBridge; // [!code ++]
			batch.colors[pass.idx] = param.color + (float)((int)(sourceBridge.autotileBrightness * 100f) * 262144); // [!code ++]
			batch.matColors[pass.idx] = param.matColor; // [!code ++]
			pass.idx++; // [!code ++]
			if (pass.idx == pass.batchSize) // [!code ++]
			{
				renderData2.Draw(param); // [!code --]
				pass.NextBatch(); // [!code ++]
			} // [!code ++]
		} // [!code ++]
		if (this.cell.shadow != 0) // [!code ++]
		{ // [!code ++]
			if (sourceBridge == FLOOR.sourceSnow) // [!code ++]
			{ // [!code ++]
				param.tile = 448 + this.cell.shadow + 8 + (this.cell.HasFence ? 4 : 0); // [!code ++]
				param.z -= 0.01f; // [!code ++]
				sourceBridge.renderData.Draw(param); // [!code ++]
			}
			else
			{
				renderData2.DrawRepeat(param, num18, sourceBlock.tileType.RepeatSize); // [!code --]
				pass = passEdge; // [!code ++]
				batch = pass.batches[pass.batchIdx]; // [!code ++]
				batch.matrices[pass.idx].m03 = param.x + ambientShadowFix[this.cell.shadow].x; // [!code ++]
				batch.matrices[pass.idx].m13 = param.y + ambientShadowFix[this.cell.shadow].y; // [!code ++]
				batch.matrices[pass.idx].m23 = param.z + ambientShadowFix[this.cell.shadow].z; // [!code ++]
				batch.tiles[pass.idx] = 448 + this.cell.shadow; // [!code ++]
				batch.colors[pass.idx] = blockLight; // [!code ++]
				batch.matColors[pass.idx] = 104025f; // [!code ++]
				pass.idx++; // [!code ++]
				if (pass.idx == pass.batchSize) // [!code ++]
				{ // [!code ++]
					pass.NextBatch(); // [!code ++]
				} // [!code ++]
			}
			param.tile = renderData2.idShadow; // [!code --]
			SourcePref shadowPref2 = renderData2.shadowPref; // [!code --]
			int shadow3 = shadowPref2.shadow; // [!code --]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow3], shadowPref2, 0, param.snow); // [!code --]
			break; // [!code --]
		}
		default: // [!code --]
			param.color = floorLight; // [!code --]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + ((_lowblock && this.tileType.UseLowBlock) ? 3000000 : 0); // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			if (roomHeight == 0f) // [!code --]
		if (this.cell.isBridgeEdge && this.cell.bridgeHeight - this.cell.height >= 3 && this.cell.bridgePillar != byte.MaxValue && !noSlopMode) // [!code ++]
		{ // [!code ++]
			orgY = param.y; // [!code ++]
			orgZ = param.z; // [!code ++]
			param.y += bridgeFix.y; // [!code ++]
			param.z += bridgeFix.z; // [!code ++]
			param.dir = 0; // [!code ++]
			SourceBlock.Row row4 = sourceBridge._bridgeBlock; // [!code ++]
			float num32 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code ++]
			if (this.cell.sourceFloor.tileType == TileType.Sky) // [!code ++]
			{
				sourceBlock.renderData.Draw(param); // [!code --]
				num32 += (float)EMono._map.config.skyBlockHeight; // [!code ++]
			} // [!code ++]
			int num33 = (int)(num32 / heightBlockSize) + 2; // [!code ++]
			if (this.cell.bridgePillar != 0) // [!code ++]
			{ // [!code ++]
				row4 = EMono.sources.blocks.rows[this.cell.bridgePillar]; // [!code ++]
				param.tile = row4._tiles[0] + ((num33 == 2) ? 32 : 0); // [!code ++]
				param.mat = ((sourceBridge.DefaultMaterial == row4.DefaultMaterial) ? sourceBridge.DefaultMaterial : row4.DefaultMaterial); // [!code ++]
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, row4.colorMod)); // [!code ++]
			}
			else
			{
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock); // [!code --]
				param.mat = matBlock; // [!code ++]
				param.tile = row4._tiles[0] + 32; // [!code ++]
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref matBridge.matColor, row4.colorMod)); // [!code ++]
			}
			break; // [!code --]
			param.y += ugFixBridgeTop.y; // [!code ++]
			param.z += ugFixBridgeTop.z; // [!code ++]
			for (int n = 0; n < num33; n++) // [!code ++]
			{ // [!code ++]
				if (n == num33 - 1) // [!code ++]
				{ // [!code ++]
					param.y = (float)(cz - cx) * screen.tileAlign.y + (float)height * _heightMod.y + ugFixBridgeBottom.y; // [!code ++]
					param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)height * _heightMod.z + ugFixBridgeBottom.z; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.y += ugFixBridge.y; // [!code ++]
					param.z += ugFixBridge.z; // [!code ++]
				} // [!code ++]
				row4.renderData.Draw(param); // [!code ++]
			} // [!code ++]
			param.y = orgY; // [!code ++]
			param.z = orgZ; // [!code ++]
		}
	}
	if (this.cell.pcSync && EMono.player.lightPower > 0f && !cinemaMode) // [!code --]
	if (!buildMode && this.cell.highlight != 0) // [!code ++]
	{
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof) // [!code --]
		if (this.cell._block != 0 && !this.cell.hasDoor) // [!code ++]
		{
			goto IL_6f8a; // [!code --]
			screen.guide.DrawWall(this.cell.GetPoint(), EMono.Colors.blockColors.MapHighlight, useMarkerPass: true); // [!code ++]
		}
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock) // [!code --]
		else // [!code ++]
		{
			Room obj = this.cell.FrontRight.room; // [!code --]
			if (obj == null || !obj.HasRoof) // [!code --]
			{ // [!code --]
				goto IL_6f8a; // [!code --]
			} // [!code --]
			passGuideFloor.Add(this.cell.GetPoint(), (int)this.cell.highlight); // [!code ++]
		}
	}
	goto IL_6fea; // [!code --]
	IL_6f8a: // [!code --]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code --]
	{ // [!code --]
		param.tile = num12; // [!code --]
		rendererFov.Draw(param); // [!code --]
	} // [!code --]
	goto IL_6fea; // [!code --]
	IL_7ba5: // [!code --]
	if (detail.things.Count == 0 && detail.charas.Count == 0) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	int num19 = 0; // [!code --]
	thingPos.x = 0f; // [!code --]
	thingPos.y = 0f; // [!code --]
	thingPos.z = 0f; // [!code --]
	freePos.x = (freePos.y = (freePos.z = 0f)); // [!code --]
	if (this.cell.HasRamp) // [!code --]
	{ // [!code --]
		Vector3 rampFix = sourceBlock.tileType.GetRampFix(this.cell.blockDir); // [!code --]
		param.x += rampFix.x; // [!code --]
		param.y += rampFix.y; // [!code --]
		param.z += rampFix.z; // [!code --]
		freePos.x += rampFix.x; // [!code --]
		freePos.y += rampFix.y; // [!code --]
		freePos.z += rampFix.z; // [!code --]
	} // [!code --]
	param.y += (flag ? 0f : ((this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight)); // [!code --]
	orgPos.x = (orgX = param.x); // [!code --]
	orgPos.y = (orgY = param.y); // [!code --]
	orgPos.z = (orgZ = param.z); // [!code --]
	if (flag && liquidLv > 0) // [!code --]
	param.color = blockLight; // [!code ++]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && (snowed || this.cell.isClearSnow) && (this.cell.Front.HasRoof || this.cell.Right.HasRoof)) // [!code ++]
	{
		if (liquidLv > 10) // [!code --]
		{ // [!code --]
			liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
		} // [!code --]
		liquidLv -= (int)(floatY * 0.5f); // [!code --]
		param.liquidLv = liquidLv; // [!code --]
		param.y -= TileType.FloorWaterShallow.FloorHeight; // [!code --]
		snowed = false; // [!code ++]
	}
	Thing thing = null; // [!code --]
	bool shadow = liquidLv == 0; // [!code --]
	float num20 = 0f; // [!code --]
	float num21 = 0f; // [!code --]
	float num22 = 0f; // [!code --]
	float num23 = 0f; // [!code --]
	bool flag10 = false; // [!code --]
	float num24 = 0f; // [!code --]
	bool flag11 = false; // [!code --]
	float num25 = 0f; // [!code --]
	if (detail.things.Count > 0 && isSeen) // [!code --]
	num5 = 0; // [!code ++]
	if (sourceBlock.id != 0) // [!code ++]
	{
		_ = zSetting.max1; // [!code --]
		float num26 = 0f; // [!code --]
		for (int m = 0; m < detail.things.Count; m++) // [!code --]
		this.tileType = sourceBlock.tileType; // [!code ++]
		roomHeight = 0f; // [!code ++]
		int blockDir = this.cell.blockDir; // [!code ++]
		bool flag9 = false; // [!code ++]
		switch (wallClipMode) // [!code ++]
		{
			Thing t = detail.things[m]; // [!code --]
			if ((fogged && !t.isRoofItem) || ((t.isHidden || t.trait.HideInAdv || t.isMasked) && !EMono.scene.actionMode.ShowMaskedThings) || (t.isRoofItem && ((this.room == null && !sourceBlock.tileType.IsFullBlock && !EMono._zone.IsPCFaction) || (lowBlock && !showFullWall && this.room != null) || (noRoofMode && currentRoom == null))) || (flag3 && !t.isRoofItem)) // [!code --]
		case WallClipMode.ByRoom: // [!code ++]
			if (!this.tileType.RepeatBlock) // [!code ++]
			{
				continue; // [!code --]
				break; // [!code ++]
			}
			TileType tileType = t.trait.tileType; // [!code --]
			bool isInstalled = t.IsInstalled; // [!code --]
			SourcePref pref = t.Pref; // [!code --]
			if (!isInstalled && t.category.tileDummy != 0) // [!code --]
			if (currentRoom == null || showFullWall) // [!code ++]
			{
				pref = rendererObjDummy.shadowPref; // [!code --]
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code ++]
				_lowblock = lowBlock; // [!code ++]
			}
			float num27 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code --]
			if (t.ignoreStackHeight) // [!code --]
			else if (this.room != this.cell.Front.room && (this.cell.Front.room == currentRoom || (this.room?.lot != currentLot && this.cell.Front.room?.lot == currentLot))) // [!code ++]
			{
				thingPos.y -= num20; // [!code --]
				thingPos -= altitudeFix * num21; // [!code --]
				this.room = this.cell.Front.room; // [!code ++]
				_lowblock = !this.cell.Front.lotWall && !this.cell.Front.fullWall; // [!code ++]
			}
			shadow = thingPos.y < 0.16f && num25 < 0.16f; // [!code --]
			_ = pref.bypassShadow; // [!code --]
			param.shadowFix = 0f - thingPos.y; // [!code --]
			param.liquidLv = ((thingPos.y + (float)t.altitude < 0.1f) ? liquidLv : 0); // [!code --]
			if (t.isRoofItem) // [!code --]
			else if (this.room != this.cell.Right.room && (this.cell.Right.room == currentRoom || (this.room?.lot != currentLot && this.cell.Right.room?.lot == currentLot))) // [!code ++]
			{
				param.snow = isSnowCovered && !this.cell.isClearSnow; // [!code --]
				SetRoofHeight(param, this.cell, cx, cz); // [!code --]
				_actorPos.x = param.x; // [!code --]
				_actorPos.y = param.y; // [!code --]
				_actorPos.z = param.z + num26; // [!code --]
				if (this.room != null) // [!code --]
				{ // [!code --]
					param.color = GetRoofLight(this.room.lot); // [!code --]
				} // [!code --]
				shadow = false; // [!code --]
				param.liquidLv = 0; // [!code --]
				this.room = this.cell.Right.room; // [!code ++]
				_lowblock = !this.cell.Right.lotWall && !this.cell.Right.fullWall; // [!code ++]
			}
			else // [!code --]
			else if (this.tileType.IsFullBlock && this.room != this.cell.FrontRight.room && (this.cell.FrontRight.room == currentRoom || (this.room?.lot != currentLot && this.cell.FrontRight.room?.lot == currentLot))) // [!code ++]
			{
				param.snow = snowed; // [!code --]
				_actorPos.x = orgX + num23; // [!code --]
				_actorPos.y = orgY; // [!code --]
				_actorPos.z = orgZ + num26 + thingPos.z; // [!code --]
				if (tileType.CanStack || !isInstalled) // [!code --]
				this.room = this.cell.FrontRight.room; // [!code ++]
				_lowblock = !this.cell.FrontRight.lotWall && !this.cell.FrontRight.fullWall; // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code ++]
				_lowblock = true; // [!code ++]
				if (!this.tileType.IsFullBlock) // [!code ++]
				{
					if (thing?.id != t.id) // [!code --]
					if (this.cell.lotWall) // [!code ++]
					{
						_actorPos.x += thingPos.x; // [!code --]
						_lowblock = false; // [!code ++]
					}
					_actorPos.y += thingPos.y; // [!code --]
					if (t.trait.IgnoreLastStackHeight && (thing == null || !thing.trait.IgnoreLastStackHeight)) // [!code --]
					else if (this.room == currentRoom) // [!code ++]
					{
						thingPos.y -= num20; // [!code --]
						if (thing != null) // [!code --]
						{ // [!code --]
							_actorPos.z -= 0.2f; // [!code --]
							thingPos.z -= 0.2f; // [!code --]
						} // [!code --]
						_actorPos.y -= num20; // [!code --]
						_lowblock = !this.cell.fullWall; // [!code ++]
					}
					_actorPos.z += renderSetting.thingZ + (float)m * -0.01f + zSetting.mod1 * thingPos.y; // [!code --]
				}
				if (isInstalled) // [!code --]
			} // [!code ++]
			flag9 = (this.room != null && this.room.data.atrium) || (this.cell.room != null && this.cell.room.data.atrium); // [!code ++]
			if (flag9) // [!code ++]
			{ // [!code ++]
				_lowblock = false; // [!code ++]
			} // [!code ++]
			if (this.room == null && alwaysLowblock) // [!code ++]
			{ // [!code ++]
				_lowblock = true; // [!code ++]
				roomHeight = 0f; // [!code ++]
			} // [!code ++]
			if (this.room != null) // [!code ++]
			{ // [!code ++]
				maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)this.room.lot.mh * _heightMod.y; // [!code ++]
				if (showRoof) // [!code ++]
				{
					if (t.TileType.IsRamp) // [!code --]
					{ // [!code --]
						Vector3 rampFix2 = t.TileType.GetRampFix(t.dir, pref); // [!code --]
						orgX += rampFix2.x; // [!code --]
						orgY += rampFix2.y; // [!code --]
						orgZ += rampFix2.z; // [!code --]
						freePos.x += rampFix2.x; // [!code --]
						freePos.y += rampFix2.y; // [!code --]
						freePos.z += rampFix2.z; // [!code --]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code --]
						{ // [!code --]
							num25 += rampFix2.y; // [!code --]
						} // [!code --]
						liquidLv -= (int)(rampFix2.y * 150f); // [!code --]
						if (liquidLv < 0) // [!code --]
						{ // [!code --]
							liquidLv = 0; // [!code --]
						} // [!code --]
					} // [!code --]
					else if (!flag11 && t.trait.IsChangeFloorHeight && !t.ignoreStackHeight) // [!code --]
					{ // [!code --]
						orgY += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
						orgZ += (float)t.altitude * altitudeFix.z; // [!code --]
						freePos.y += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code --]
						{ // [!code --]
							num25 += num27 + (float)t.altitude * altitudeFix.y; // [!code --]
						} // [!code --]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
						_actorPos.z += pref.z; // [!code --]
						thingPos.z += pref.z; // [!code --]
						if (liquidLv < 0) // [!code --]
						{ // [!code --]
							liquidLv = 0; // [!code --]
						} // [!code --]
					} // [!code --]
					else // [!code --]
					{ // [!code --]
						thingPos.y += num27; // [!code --]
						if (tileType.UseMountHeight) // [!code --]
						{ // [!code --]
							if (tileType != TileType.Illumination || !this.cell.HasObj) // [!code --]
							{ // [!code --]
								if (noRoofMode && currentRoom == null && t.altitude >= lowWallObjAltitude) // [!code --]
								{ // [!code --]
									continue; // [!code --]
								} // [!code --]
								if (hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code --]
								{ // [!code --]
									Room room5 = ((t.dir == 0) ? this.cell.Back.room : this.cell.Left.room); // [!code --]
									if (t.trait.AlwaysHideOnLowWall) // [!code --]
									{ // [!code --]
										if (room5 == null || !room5.data.showWallItem) // [!code --]
										{ // [!code --]
											continue; // [!code --]
										} // [!code --]
									} // [!code --]
									else if (t.altitude >= lowWallObjAltitude) // [!code --]
									{ // [!code --]
										continue; // [!code --]
									} // [!code --]
								} // [!code --]
							} // [!code --]
							if (tileType.UseHangZFix) // [!code --]
							{ // [!code --]
								flag10 = true; // [!code --]
							} // [!code --]
							tileType.GetMountHeight(ref _actorPos, Point.shared.Set(index), t.dir, t); // [!code --]
							shadow = false; // [!code --]
							param.liquidLv = 0; // [!code --]
							if (t.freePos) // [!code --]
							{ // [!code --]
								_actorPos.x += t.fx; // [!code --]
								_actorPos.y += t.fy; // [!code --]
							} // [!code --]
						} // [!code --]
						else // [!code --]
						{ // [!code --]
							thingPos.y += (float)t.altitude * altitudeFix.y; // [!code --]
							thingPos.z += (float)t.altitude * altitudeFix.z; // [!code --]
						} // [!code --]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
						_actorPos.z += pref.z; // [!code --]
						if (pref.height >= 0f) // [!code --]
						{ // [!code --]
							thingPos.z += pref.z; // [!code --]
						} // [!code --]
					} // [!code --]
					if (!tileType.UseMountHeight && m > 10) // [!code --]
					{ // [!code --]
						flag11 = true; // [!code --]
					} // [!code --]
					roomHeight = this.room.lot.realHeight; // [!code ++]
					break; // [!code ++]
				}
				else // [!code --]
				if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code ++]
				{
					thingPos.y += num27; // [!code --]
					_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
					_actorPos.z += pref.z; // [!code --]
					thingPos.z += pref.z; // [!code --]
					roomHeight = 0f; // [!code ++]
					break; // [!code ++]
				}
				if (t.isFloating && isWater && !hasBridge && !flag) // [!code --]
				int num34 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code ++]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num34) ? this.room.lot.height : num34) + 0.01f * (float)this.room.lot.heightFix; // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case WallClipMode.ByLot: // [!code ++]
			if (defaultBlockHeight > 0f || isIndoor) // [!code ++]
			{ // [!code ++]
				_lowblock = cx != 0 && cz != Size - 1 && ((!this.cell.Back.HasBlock && !this.cell.Back.isWallEdge) || (!this.cell.Left.HasBlock && !this.cell.Left.isWallEdge) || !this.cell.Back.Left.HasBlock); // [!code ++]
				if (!_lowblock) // [!code ++]
				{
					flag = true; // [!code --]
					float num28 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
					orgY += 0.01f * floatY - num28; // [!code --]
					if (!t.trait.IsChangeFloorHeight) // [!code --]
					{ // [!code --]
						num24 = num27; // [!code --]
					} // [!code --]
					_actorPos.y += 0.01f * floatY - num28; // [!code --]
					if (liquidLv > 10) // [!code --]
					{ // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
					} // [!code --]
					liquidLv -= (int)(floatY * 0.5f); // [!code --]
					if (liquidLv < 0) // [!code --]
					roomHeight = defaultBlockHeight * EMono.setting.render.roomHeightMod; // [!code ++]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)(int)this.cell.TopHeight * _heightMod.y; // [!code ++]
				} // [!code ++]
				break; // [!code ++]
			} // [!code ++]
			if (showFullWall) // [!code ++]
			{ // [!code ++]
				_lowblock = this.room != null; // [!code ++]
				if (_lowblock) // [!code ++]
				{ // [!code ++]
					if (this.cell.Back.IsRoomEdge && this.cell.Right.IsRoomEdge && this.cell.Back.room == null && this.cell.Right.room == null && this.cell.Right.Front.room?.lot == this.room?.lot) // [!code ++]
					{
						liquidLv = 0; // [!code --]
						_lowblock = false; // [!code ++]
					}
					param.liquidLv = liquidLv; // [!code --]
				}
				num20 = num27; // [!code --]
				if (t.sourceCard.multisize && !t.trait.IsGround) // [!code --]
				else if (this.cell.Back.room != null && this.cell.Back.room.lot == (this.cell.Front.room ?? this.cell.Right.room)?.lot) // [!code ++]
				{
					num26 += zSetting.multiZ; // [!code --]
					_lowblock = true; // [!code ++]
				}
				orgZ += t.renderer.data.stackZ; // [!code --]
				if (param.liquidLv > 0) // [!code --]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				_lowblock = lowBlock; // [!code ++]
			} // [!code ++]
			if (this.tileType.RepeatBlock) // [!code ++]
			{ // [!code ++]
				this.room = this.room ?? this.cell.Front.room ?? this.cell.Right.room ?? this.cell.FrontRight.room; // [!code ++]
				if (this.room != null && (!noRoofMode || currentRoom != null) && (!showFullWall || currentRoom == null || this.room.lot == currentRoom.lot)) // [!code ++]
				{
					param.liquidLv += pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					{ // [!code --]
						param.liquidLv = 1; // [!code --]
					} // [!code --]
					else if (param.liquidLv > 99 + pref.liquidModMax) // [!code --]
					{ // [!code --]
						param.liquidLv = 99 + pref.liquidModMax; // [!code --]
					} // [!code --]
					roomHeight = ((_lowblock && !this.tileType.ForceRpeatBlock) ? 0f : this.room.lot.realHeight); // [!code ++]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)this.room.lot.mh * _heightMod.y; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		} // [!code ++]
		if (!_lowblock && (double)roomHeight > 1.2 && this.tileType.RepeatBlock) // [!code ++]
		{ // [!code ++]
			num5 = 1; // [!code ++]
		} // [!code ++]
		else if (lowBlock) // [!code ++]
		{ // [!code ++]
			num5 = 2; // [!code ++]
		} // [!code ++]
		param.mat = matBlock; // [!code ++]
		param.dir = this.cell.blockDir; // [!code ++]
		param.snow = snowed; // [!code ++]
		switch (this.tileType.blockRenderMode) // [!code ++]
		{ // [!code ++]
		case BlockRenderMode.FullBlock: // [!code ++]
		{ // [!code ++]
			bool invisible = sourceBlock.tileType.Invisible; // [!code ++]
			if (invisible && (!buildMode || ActionMode.Cinema.IsActive)) // [!code ++]
			{ // [!code ++]
				break; // [!code ++]
			} // [!code ++]
			if (this.cell.isSurrounded) // [!code ++]
			{ // [!code ++]
				switch (innerMode) // [!code ++]
				{ // [!code ++]
				case InnerMode.InnerBlock: // [!code ++]
				case InnerMode.BuildMode: // [!code ++]
					blockLight = _baseBrightness + fogBrightness; // [!code ++]
					param.color = (int)(50f * blockLight) * 262144; // [!code ++]
					param.matColor = 104025f; // [!code ++]
					param.tile = (buildMode ? 1 : 2) + ((_lowblock || defaultBlockHeight > 0f) ? 3000000 : 0); // [!code ++]
					rendererInnerBlock.Draw(param); // [!code ++]
					return; // [!code ++]
				case InnerMode.None: // [!code ++]
				case InnerMode.Height: // [!code ++]
					param.color = blockLight; // [!code ++]
					break; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (snowed) // [!code ++]
			{ // [!code ++]
				param.color = floorLight; // [!code ++]
			} // [!code ++]
			param.color -= (int)(_shadowStrength * 0.8f * 50f) * 262144; // [!code ++]
			if (currentRoom != null && !showFullWall) // [!code ++]
			{ // [!code ++]
				_lowblock = true; // [!code ++]
				roomHeight = 0f; // [!code ++]
				if (this.cell.room != currentRoom && (this.cell.Front.room == currentRoom || this.cell.Right.room == currentRoom || this.cell.FrontRight.room == currentRoom) && (this.cell.Back.room != currentRoom || this.cell.Right.room != currentRoom) && (this.cell.Front.room != currentRoom || this.cell.Left.room != currentRoom)) // [!code ++]
				{ // [!code ++]
					_lowblock = false; // [!code ++]
				} // [!code ++]
				if (!_lowblock) // [!code ++]
				{ // [!code ++]
					int num35 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code ++]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num35) ? currentRoom.lot.height : num35) + 0.01f * (float)currentRoom.lot.heightFix; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (flag9) // [!code ++]
			{ // [!code ++]
				_lowblock = (!this.cell.Front.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Front.HasFullBlock || !this.cell.Left.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Left.HasFullBlock); // [!code ++]
				if (_lowblock) // [!code ++]
				{ // [!code ++]
					roomHeight = 0f; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (invisible) // [!code ++]
			{ // [!code ++]
				roomHeight = 0f; // [!code ++]
				_lowblock = false; // [!code ++]
			} // [!code ++]
			if (this.cell.Things.Count > 0) // [!code ++]
			{ // [!code ++]
				_lowblock = false; // [!code ++]
			} // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + (_lowblock ? 3000000 : 0); // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
			if (roomHeight == 0f) // [!code ++]
			{ // [!code ++]
				if (!this.cell.hasDoor) // [!code ++]
				{ // [!code ++]
					sourceBlock.renderData.Draw(param); // [!code ++]
				}
			}
			if (!isInstalled || !tileType.UseMountHeight) // [!code --]
			else // [!code ++]
			{
				if (t.altitude != 0) // [!code --]
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0, isBlock: true); // [!code ++]
			} // [!code ++]
			Room room2 = this.cell.Front.room ?? this.cell.room; // [!code ++]
			if (room2 == null && this.cell.Right.room != null) // [!code ++]
			{ // [!code ++]
				room2 = this.cell.Right.room; // [!code ++]
			} // [!code ++]
			if (!invisible && room2 != null) // [!code ++]
			{ // [!code ++]
				if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
				{
					_actorPos += altitudeFix * t.altitude; // [!code --]
					num22 += (float)t.altitude; // [!code --]
					num21 = t.altitude; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco); // [!code ++]
					param.matColor = room2.lot.colDeco; // [!code ++]
					float y = param.y; // [!code ++]
					param.y += (float)room2.lot.decoFix * 0.01f; // [!code ++]
					rendererWallDeco.Draw(param); // [!code ++]
					param.y = y; // [!code ++]
				}
				if (num22 >= 2f && ((this.cell.Back.room != null && this.cell.Back.IsRoomEdge) || (this.cell.Left.room != null && this.cell.Left.IsRoomEdge)) && hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code --]
				if (room2.lot.idDeco2 != 0 && roomHeight != 0f && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
				{
					continue; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2); // [!code ++]
					param.matColor = room2.lot.colDeco2; // [!code ++]
					float y2 = param.y; // [!code ++]
					float num36 = param.z; // [!code ++]
					param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code ++]
					param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
					rendererWallDeco.Draw(param); // [!code ++]
					param.y = y2; // [!code ++]
					param.z = num36; // [!code ++]
				}
				if (t.freePos) // [!code --]
			} // [!code ++]
			room2 = this.cell.Right.room ?? this.cell.room; // [!code ++]
			if (room2 == null && this.cell.Front.room != null) // [!code ++]
			{ // [!code ++]
				room2 = this.cell.Front.room; // [!code ++]
			} // [!code ++]
			if (!invisible && room2 != null) // [!code ++]
			{ // [!code ++]
				if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
				{
					_actorPos.x = orgX + t.fx - freePos.x; // [!code --]
					_actorPos.y = orgY + t.fy - freePos.y; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco) * -1; // [!code ++]
					param.matColor = room2.lot.colDeco; // [!code ++]
					float y3 = param.y; // [!code ++]
					param.y += (float)room2.lot.decoFix * 0.01f; // [!code ++]
					rendererWallDeco.Draw(param); // [!code ++]
					param.y = y3; // [!code ++]
				}
				if (t.trait is TraitDoor && (t.trait as TraitDoor).IsOpen()) // [!code --]
				if (room2.lot.idDeco2 != 0 && roomHeight != 0f && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
				{
					_actorPos.z += -0.5f; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2) * -1; // [!code ++]
					param.matColor = room2.lot.colDeco2; // [!code ++]
					float y4 = param.y; // [!code ++]
					float num37 = param.z; // [!code ++]
					param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code ++]
					param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
					rendererWallDeco.Draw(param); // [!code ++]
					param.y = y4; // [!code ++]
					param.z = num37; // [!code ++]
				}
			}
			if (!t.sourceCard.multisize || (t.pos.x == cx && t.pos.z == cz)) // [!code --]
			break; // [!code ++]
		} // [!code ++]
		case BlockRenderMode.WallOrFence: // [!code ++]
		{ // [!code ++]
			if (map.config.fullWallHeight) // [!code ++]
			{
				if (iconMode != 0) // [!code --]
				showFullWall = true; // [!code ++]
				_lowblock = false; // [!code ++]
			} // [!code ++]
			orgY = param.y; // [!code ++]
			orgZ = param.z; // [!code ++]
			param.color = (this.tileType.IsFence ? (floorLight - (float)((int)(_shadowStrength * 0.8f * 50f) * 262144)) : blockLight); // [!code ++]
			bool flag10 = blockDir == 1 || _lowblock || flag9; // [!code ++]
			bool flag11 = blockDir == 0 || _lowblock || flag9; // [!code ++]
			if (!showFullWall && currentRoom != null) // [!code ++]
			{ // [!code ++]
				if (!flag10) // [!code ++]
				{
					int num29 = 0; // [!code --]
					switch (iconMode) // [!code --]
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Front.room != currentRoom)) // [!code ++]
					{
					case CardIconMode.Visibility: // [!code --]
						if (t.isMasked) // [!code --]
						{ // [!code --]
							num29 = 17; // [!code --]
						} // [!code --]
						break; // [!code --]
					case CardIconMode.State: // [!code --]
						if (t.placeState == PlaceState.installed) // [!code --]
						{ // [!code --]
							num29 = 18; // [!code --]
						} // [!code --]
						break; // [!code --]
					case CardIconMode.Deconstruct: // [!code --]
						if (t.isDeconstructing) // [!code --]
						if (!this.cell.IsRoomEdge || (this.cell.Front.room != this.cell.room && this.cell.FrontRight.room != this.cell.room)) // [!code ++]
						{
							num29 = 14; // [!code --]
							flag10 = true; // [!code ++]
						}
						break; // [!code --]
					} // [!code --]
					if (t.isNPCProperty && !EMono.debug.godBuild) // [!code --]
					{ // [!code --]
						num29 = 13; // [!code --]
					}
					if (num29 != 0) // [!code --]
					else if ((!this.cell.Front.lotWall || this.cell.Front.room?.lot != currentLot) && this.cell.Front.room != currentRoom) // [!code ++]
					{
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num29); // [!code --]
						flag10 = true; // [!code ++]
					}
				}
				t.SetRenderParam(param); // [!code --]
				if (_lowblock && t.trait.UseLowblock && !this.cell.HasFullBlock) // [!code --]
				if (!flag11) // [!code ++]
				{
					param.tile += ((param.tile < 0f) ? (-64) : 64); // [!code --]
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Right.room != currentRoom)) // [!code ++]
					{ // [!code ++]
						if (!this.cell.IsRoomEdge || (this.cell.Right.room != this.cell.room && this.cell.FrontRight.room != this.cell.room)) // [!code ++]
						{ // [!code ++]
							flag11 = true; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					else if ((!this.cell.Right.lotWall || this.cell.Right.room?.lot != currentLot) && this.cell.Right.room != currentRoom) // [!code ++]
					{ // [!code ++]
						flag11 = true; // [!code ++]
					} // [!code ++]
				}
				if (t.trait is TraitTrolley && EMono.pc.ai is AI_Trolley aI_Trolley && aI_Trolley.trolley.owner == t) // [!code --]
			} // [!code ++]
			if (blockDir == 0 || blockDir == 2) // [!code ++]
			{ // [!code ++]
				param.dir = 0; // [!code ++]
				Room room3 = this.cell.Front.room ?? this.cell.room; // [!code ++]
				if (room3 != null && this.tileType.IsWall) // [!code ++]
				{
					RenderParam _param = new RenderParam(param); // [!code --]
					EMono.core.actionsLateUpdate.Add(delegate // [!code --]
					if (room3.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
					{
						t.SetRenderParam(_param); // [!code --]
						_actorPos.x = EMono.pc.renderer.position.x; // [!code --]
						_actorPos.y = EMono.pc.renderer.position.y - pref.height; // [!code --]
						_actorPos.z = EMono.pc.renderer.position.z + 0.02f; // [!code --]
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code --]
					}); // [!code --]
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco); // [!code ++]
						param.matColor = room3.lot.colDeco; // [!code ++]
						param.y += (float)room3.lot.decoFix * 0.01f; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
					} // [!code ++]
					if (room3.lot.idDeco2 != 0 && roomHeight != 0f && !flag10 && (float)room3.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
					{ // [!code ++]
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco2); // [!code ++]
						param.matColor = room3.lot.colDeco2; // [!code ++]
						param.y += (float)room3.lot.decoFix2 * 0.01f; // [!code ++]
						param.z += (float)room3.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
						param.z = orgZ; // [!code ++]
					} // [!code ++]
				}
				else // [!code --]
				Cell left = this.cell.Left; // [!code ++]
				if (blockDir == 2 && left.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code ++]
				{
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code --]
					_sourceBlock = left.sourceBlock; // [!code ++]
					param.mat = left.matBlock; // [!code ++]
				}
			} // [!code --]
			if (isInstalled) // [!code --]
			{ // [!code --]
				num23 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
			} // [!code --]
			param.x = orgX; // [!code --]
			param.y = orgY; // [!code --]
			param.z = orgZ; // [!code --]
			param.color = floorLight; // [!code --]
			thing = t; // [!code --]
			if (pref.Float) // [!code --]
			{ // [!code --]
				liquidLv = 0; // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	orgY += num24; // [!code --]
	if (detail.charas.Count <= 0) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	param.shadowFix = 0f - num25; // [!code --]
	param.color += 1310720f; // [!code --]
	float max = zSetting.max2; // [!code --]
	for (int n = 0; n < detail.charas.Count; n++) // [!code --]
	{ // [!code --]
		Chara chara = detail.charas[n]; // [!code --]
		if (chara.host != null || (chara != EMono.pc && chara != LayerDrama.alwaysVisible && (flag3 || fogged || (!showAllCards && !EMono.player.CanSee(chara))))) // [!code --]
		{ // [!code --]
			continue; // [!code --]
		} // [!code --]
		_actorPos.x = orgX; // [!code --]
		_actorPos.y = orgY; // [!code --]
		_actorPos.z = orgZ; // [!code --]
		chara.SetRenderParam(param); // [!code --]
		_ = chara.IsAliveInCurrentZone; // [!code --]
		if (chara.isRestrained) // [!code --]
		{ // [!code --]
			TraitShackle restrainer = chara.GetRestrainer(); // [!code --]
			if (restrainer != null) // [!code --]
			{ // [!code --]
				Vector3 getRestrainPos = restrainer.GetRestrainPos; // [!code --]
				if (getRestrainPos != default(Vector3)) // [!code --]
				else // [!code ++]
				{
					Vector3 position = restrainer.owner.renderer.position; // [!code --]
					float defCharaHeight = EMono.setting.render.defCharaHeight; // [!code --]
					float num30 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code --]
					_actorPos.x = position.x + getRestrainPos.x * (float)((restrainer.owner.dir % 2 == 0) ? 1 : (-1)); // [!code --]
					_actorPos.y = position.y + num30; // [!code --]
					_actorPos.z = position.z + getRestrainPos.z; // [!code --]
					param.liquidLv = 0; // [!code --]
					param.shadowFix = orgY - _actorPos.y; // [!code --]
					chara.renderer.SetFirst(first: true); // [!code --]
					chara.renderer.Draw(param, ref _actorPos, drawShadow: true); // [!code --]
					param.shadowFix = 0f; // [!code --]
					continue; // [!code --]
					_sourceBlock = sourceBlock; // [!code ++]
					param.mat = matBlock; // [!code ++]
				}
			} // [!code --]
		} // [!code --]
		if (!chara.sourceCard.multisize || (chara.pos.x == cx && chara.pos.z == cz)) // [!code --]
		{ // [!code --]
			if (chara.IsDeadOrSleeping && chara.IsPCC) // [!code --]
			{ // [!code --]
				float num31 = chara.renderer.data.size.y * 0.3f; // [!code --]
				if (thingPos.y > max) // [!code --]
				this.tileType = _sourceBlock.tileType; // [!code ++]
				param.tile = (tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock) ? 32 : 0)); // [!code ++]
				if (_sourceBlock.useAltColor) // [!code ++]
				{
					thingPos.y = max; // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code ++]
				}
				float num32 = thingPos.y + num31; // [!code --]
				float num33 = (float)n * -0.01f; // [!code --]
				if (num32 > zSetting.thresh1) // [!code --]
				else // [!code ++]
				{
					num33 = zSetting.mod1; // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code ++]
				}
				_actorPos.x += thingPos.x; // [!code --]
				_actorPos.y += thingPos.y; // [!code --]
				_actorPos.z += renderSetting.laydownZ + num33; // [!code --]
				param.liquidLv = ((thingPos.y == 0f && liquidLv > 0) ? 90 : 0); // [!code --]
				thingPos.y += num31 * 0.8f; // [!code --]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.liquidLv = liquidLv; // [!code --]
				if (isUnderwater) // [!code --]
				if (roomHeight == 0f || flag10 || !this.tileType.RepeatBlock) // [!code ++]
				{
					if (chara.Pref.FloatUnderwater) // [!code --]
					if (!this.cell.hasDoor) // [!code ++]
					{
						float num34 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
						float num35 = floatYs[chara.uid % 10] + 10f + (float)(chara.uid % 30); // [!code --]
						orgY += 0.01f * num35 - num34; // [!code --]
						_actorPos.y += 0.01f * num35 - num34; // [!code --]
						param.shadowFix -= 0.01f * num35 - num34; // [!code --]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					}
				}
				else if (liquidLv > 0) // [!code --]
				else // [!code ++]
				{
					if (chara.Pref.Float && !flag && !hasBridge) // [!code --]
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code ++]
				} // [!code ++]
				param.z += cornerWallFix2.z; // [!code ++]
				if ((blockDir == 2 || (this.cell.Front.HasWallOrFence && this.cell.Front.blockDir != 0)) != this.cell.isToggleWallPillar) // [!code ++]
				{ // [!code ++]
					if (this.cell.Back.IsSnowTile && this.cell.Right.IsSnowTile) // [!code ++]
					{
						if (liquidLv > 20) // [!code --]
						{ // [!code --]
							float num36 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
							orgY += 0.01f * floatY - num36; // [!code --]
							_actorPos.y += 0.01f * floatY - num36; // [!code --]
							int num37 = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
							num37 -= (int)(floatY * 0.5f); // [!code --]
							param.liquidLv = num37; // [!code --]
						} // [!code --]
						else // [!code --]
						{ // [!code --]
							param.liquidLv -= 20; // [!code --]
						} // [!code --]
						param.snow = true; // [!code ++]
					}
					param.liquidLv += chara.Pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag10 && flag11 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					if (roomHeight == 0f || !this.tileType.RepeatBlock || (flag10 && flag11 && !flag9)) // [!code ++]
					{
						param.liquidLv = 1; // [!code --]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					}
					else if (param.liquidLv > 99 + chara.Pref.liquidModMax) // [!code --]
					else // [!code ++]
					{
						param.liquidLv = 99 + chara.Pref.liquidModMax; // [!code --]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code ++]
					}
				}
				if (!chara.IsPC && !chara.renderer.IsMoving && detail.charas.Count > 1 && (detail.charas.Count != 2 || !detail.charas[0].IsDeadOrSleeping || !detail.charas[0].IsPCC)) // [!code --]
				{ // [!code --]
					_actorPos += renderSetting.charaPos[1 + ((num19 < 4) ? num19 : 3)]; // [!code --]
				} // [!code --]
				_actorPos.z += 0.01f * (float)n + renderSetting.charaZ; // [!code --]
				num19++; // [!code --]
				if (flag10) // [!code --]
				{ // [!code --]
					_actorPos.z += chara.renderer.data.hangedFixZ; // [!code --]
				} // [!code --]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code --]
			} // [!code --]
		} // [!code --]
		param.x = orgX; // [!code --]
		param.y = orgY; // [!code --]
		param.z = orgZ; // [!code --]
	} // [!code --]
	return; // [!code --]
	IL_6fea: // [!code --]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code --]
	{ // [!code --]
		snowed = true; // [!code --]
	} // [!code --]
	if (this.cell.effect != null) // [!code --]
	{ // [!code --]
		if (this.cell.effect.IsLiquid) // [!code --]
		{ // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code --]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code --]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code --]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code --]
			param.mat = defaultMaterial; // [!code --]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code --]
			sourceEffect.renderData.Draw(param); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code --]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code --]
			if (sourceEffect2.anime.Length != 0) // [!code --]
			{ // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code --]
				if (!flag10 && !showRoof && this.cell.Left.HasWallOrFence && this.cell.Left.blockDir != 0 && !this.cell.Left.isToggleWallPillar) // [!code ++]
				{
					float num38 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code --]
					if (!(num38 >= (float)sourceEffect2.anime[0])) // [!code --]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					param.x += cornerWallFix3.x; // [!code ++]
					param.y += cornerWallFix3.y; // [!code ++]
					param.z += cornerWallFix3.z; // [!code ++]
					if (!flag9 && (roomHeight == 0f || flag10)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{
						param.tile += num38; // [!code --]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code ++]
					}
					param.x = orgX; // [!code ++]
				}
				else // [!code --]
				else if (this.cell.FrontLeft.HasWallOrFence && this.cell.FrontLeft.blockDir != 0 && (!flag10 || !this.cell.Left.HasWall) && !this.cell.isToggleWallPillar) // [!code ++]
				{
					float num39 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code --]
					param.tile += num39; // [!code --]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					param.x += cornerWallFix.x; // [!code ++]
					param.y += cornerWallFix.y; // [!code ++]
					param.z += cornerWallFix.z; // [!code ++]
					if (!flag9 && (roomHeight == 0f || flag10)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code ++]
					} // [!code ++]
					param.x = orgX; // [!code ++]
				}
			}
			if (this.cell.effect.IsFire) // [!code --]
			{ // [!code --]
				rendererEffect.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				this.cell.effect.source.renderData.Draw(param); // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	param.color = floorLight; // [!code --]
	if (this.cell.critter != null) // [!code --]
	{ // [!code --]
		Critter critter = this.cell.critter; // [!code --]
		int snowTile = critter.tile; // [!code --]
		if (snowed && critter.SnowTile != 0) // [!code --]
		{ // [!code --]
			critter.x = 0.06f; // [!code --]
			critter.y = -0.06f; // [!code --]
			snowTile = critter.SnowTile; // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			critter.Update(); // [!code --]
		} // [!code --]
		pass = passObjSS; // [!code --]
		batch = pass.batches[pass.batchIdx]; // [!code --]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m23 = param.z; // [!code --]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code --]
		batch.colors[pass.idx] = floorLight; // [!code --]
		pass.idx++; // [!code --]
		if (pass.idx == pass.batchSize) // [!code --]
		{ // [!code --]
			pass.NextBatch(); // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail != null) // [!code --]
	{ // [!code --]
		TransAnime anime3 = detail.anime; // [!code --]
		if (anime3 != null && !anime3.animeBlock) // [!code --]
		{ // [!code --]
			TransAnime anime4 = detail.anime; // [!code --]
			param.x += anime4.v.x; // [!code --]
			param.y += anime4.v.y; // [!code --]
			param.z += anime4.v.z; // [!code --]
		} // [!code --]
	} // [!code --]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code --]
	{ // [!code --]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code --]
		if (!snowed || sourceObj.snowTile <= 0) // [!code --]
		{ // [!code --]
			param.snow = snowed; // [!code --]
			param.mat = this.cell.matObj; // [!code --]
			orgY = param.y; // [!code --]
			if (param.liquidLv > 0) // [!code --]
			if (blockDir == 1 || blockDir == 2) // [!code ++]
			{
				if (sourceObj.pref.Float) // [!code --]
				param.y = orgY; // [!code ++]
				param.z = orgZ; // [!code ++]
				param.dir = 1; // [!code ++]
				Room room4 = this.cell.Right.room ?? this.cell.room; // [!code ++]
				if (room4 != null && this.tileType.IsWall) // [!code ++]
				{
					param.y += 0.01f * floatY; // [!code --]
					if (liquidLv > 10) // [!code --]
					if (room4.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
					{
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room4.lot.idDeco); // [!code ++]
						param.matColor = room4.lot.colDeco; // [!code ++]
						param.y += (float)room4.lot.decoFix * 0.01f; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
					} // [!code ++]
					if (room4.lot.idDeco2 != 0 && roomHeight != 0f && !flag11 && (float)room4.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
					{ // [!code ++]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room4.lot.idDeco2); // [!code ++]
						param.matColor = room4.lot.colDeco2; // [!code ++]
						param.y += (float)room4.lot.decoFix2 * 0.01f; // [!code ++]
						param.z += (float)room4.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
						param.z = orgZ; // [!code ++]
					}
					liquidLv -= (int)(floatY * 0.5f); // [!code --]
					param.liquidLv = liquidLv; // [!code --]
				} // [!code --]
				if (sourceObj.tileType.IsWaterTop) // [!code --]
				{ // [!code --]
					param.liquidLv = 0; // [!code --]
				}
				else // [!code --]
				if (blockDir == 2 && this.cell.room == null && this.cell.Right.room != null) // [!code ++]
				{
					param.liquidLv += sourceObj.pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					Room room5 = this.cell.Right.room; // [!code ++]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)room5.lot.mh * _heightMod.y; // [!code ++]
					if (showRoof) // [!code ++]
					{
						param.liquid = 1f; // [!code --]
						roomHeight = room5.lot.realHeight; // [!code ++]
					}
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code --]
					else if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code ++]
					{
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code --]
						roomHeight = 0f; // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						int num38 = ((room5.data.maxHeight == 0) ? 2 : room5.data.maxHeight); // [!code ++]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room5.lot.height < num38) ? room5.lot.height : num38) + 0.01f * (float)room5.lot.heightFix; // [!code ++]
					}
				}
			} // [!code --]
			if (sourceObj.useAltColor) // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			if (sourceObj.HasGrowth) // [!code --]
			{ // [!code --]
				this.cell.growth.OnRenderTileMap(param); // [!code --]
				if (this.cell.obj == 118 && Core.fixedFrame % 10f == 0f && sourceObj.growth.IsMature) // [!code --]
				Cell back2 = this.cell.Back; // [!code ++]
				if (blockDir == 2 && back2.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code ++]
				{
					EMono.scene.psFey.transform.position = new Vector3(param.x, param.y, param.z - 2f); // [!code --]
					EMono.scene.psFey.Emit(1); // [!code --]
					_sourceBlock = back2.sourceBlock; // [!code ++]
					param.mat = back2.matBlock; // [!code ++]
				}
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				if (this.cell.autotileObj != 0) // [!code --]
				else // [!code ++]
				{
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code --]
					_sourceBlock = sourceBlock; // [!code ++]
					param.mat = matBlock; // [!code ++]
				}
				else if (sourceObj.tileType.IsUseBlockDir) // [!code --]
				this.tileType = _sourceBlock.tileType; // [!code ++]
				param.tile = (tile = -_sourceBlock._tiles[0] + ((flag11 && this.tileType.UseLowBlock) ? (-32) : 0)); // [!code ++]
				if (_sourceBlock.useAltColor) // [!code ++]
				{
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code ++]
				}
				else
				{
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code --]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code ++]
				}
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code --]
				param.color += _rightWallShade; // [!code ++]
				if (roomHeight == 0f || flag11 || !this.tileType.RepeatBlock) // [!code ++]
				{
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code --]
					if (!this.cell.hasDoor) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
				}
				orgY = param.y; // [!code --]
				orgZ = param.z; // [!code --]
				param.y += sourceObj.pref.y; // [!code --]
				param.z += sourceObj.pref.z; // [!code --]
				sourceObj.renderData.Draw(param); // [!code --]
				param.y = orgY; // [!code --]
				param.z = orgZ; // [!code --]
				int shadow4 = sourceObj.pref.shadow; // [!code --]
				if (shadow4 > 1 && !this.cell.ignoreObjShadow) // [!code --]
				else // [!code ++]
				{ // [!code ++]
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code ++]
				} // [!code ++]
				if ((this.cell.Right.HasWallOrFence && this.cell.Right.blockDir != 1) != this.cell.isToggleWallPillar && (blockDir != 2 || !this.cell.isToggleWallPillar)) // [!code ++]
				{
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow4], sourceObj.pref, 0, param.snow); // [!code --]
					if (this.cell.Left.IsSnowTile && this.cell.Front.IsSnowTile) // [!code ++]
					{ // [!code ++]
						param.snow = true; // [!code ++]
					} // [!code ++]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag11 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					if (!flag9 && (roomHeight == 0f || !this.tileType.RepeatBlock || flag11)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code ++]
					} // [!code ++]
					param.x = orgX; // [!code ++]
				}
				param.y = orgY; // [!code --]
			}
			param.y = orgY; // [!code ++]
			param.z = orgZ; // [!code ++]
			break; // [!code ++]
		}
	} // [!code --]
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code --]
	{ // [!code --]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code --]
	} // [!code --]
	if (highlightCells) // [!code --]
	{ // [!code --]
		switch (ActionMode.FlagCell.mode) // [!code --]
		case BlockRenderMode.HalfBlock: // [!code ++]
			param.color = floorLight; // [!code ++]
			_sourceBlock = ((sourceBlock.id == 5) ? EMono.sources.blocks.rows[matBlock.defBlock] : sourceBlock); // [!code ++]
			param.tile = _sourceBlock._tiles[0]; // [!code ++]
			param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.colorMod)); // [!code ++]
			param.tile2 = _sourceBlock.sourceAutoFloor._tiles[0]; // [!code ++]
			param.halfBlockColor = ((_sourceBlock.sourceAutoFloor.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.sourceAutoFloor.colorMod)); // [!code ++]
			sourceBlock.renderData.Draw(param); // [!code ++]
			break; // [!code ++]
		case BlockRenderMode.Pillar: // [!code ++]
		{
		case AM_FlagCell.Mode.flagWallPillar: // [!code --]
			if (this.cell.isToggleWallPillar) // [!code --]
			RenderData renderData2 = sourceBlock.renderData; // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
			int num39 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code ++]
			if (num39 == 0) // [!code ++]
			{
				passArea.Add(param, 34f, 0f); // [!code --]
				renderData2.Draw(param); // [!code ++]
			}
			break; // [!code --]
		case AM_FlagCell.Mode.flagSnow: // [!code --]
			if (this.cell.isClearSnow) // [!code --]
			else // [!code ++]
			{
				passArea.Add(param, 34f, 0f); // [!code --]
				renderData2.DrawRepeat(param, num39, sourceBlock.tileType.RepeatSize); // [!code ++]
			}
			param.tile = renderData2.idShadow; // [!code ++]
			SourcePref shadowPref2 = renderData2.shadowPref; // [!code ++]
			int shadow4 = shadowPref2.shadow; // [!code ++]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow4], shadowPref2, 0, param.snow); // [!code ++]
			break;
		case AM_FlagCell.Mode.flagFloat: // [!code --]
			if (this.cell.isForceFloat) // [!code --]
		} // [!code ++]
		default: // [!code ++]
			param.color = floorLight; // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + ((_lowblock && this.tileType.UseLowBlock) ? 3000000 : 0); // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
			if (roomHeight == 0f) // [!code ++]
			{
				passArea.Add(param, 34f, 0f); // [!code --]
				sourceBlock.renderData.Draw(param); // [!code ++]
			}
			break; // [!code --]
		case AM_FlagCell.Mode.flagClear: // [!code --]
			if (this.cell.isClearArea) // [!code --]
			else // [!code ++]
			{
				passArea.Add(param, 34f, 0f); // [!code --]
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock); // [!code ++]
			}
			break;
		}
	}
	if (detail == null) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	if (highlightArea && detail.area != null) // [!code --]
	{ // [!code --]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code --]
	} // [!code --]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code --]
	if (this.cell.pcSync && EMono.player.lightPower > 0f && !cinemaMode) // [!code ++]
	{
		param.tile = detail.footmark.tile; // [!code --]
		param.mat = matFloor; // [!code --]
		param.matColor = 104025f; // [!code --]
		renderFootmark.Draw(param); // [!code --]
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof) // [!code ++]
		{ // [!code ++]
			goto IL_6f8a; // [!code ++]
		} // [!code ++]
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock) // [!code ++]
		{ // [!code ++]
			Room obj = this.cell.FrontRight.room; // [!code ++]
			if (obj == null || !obj.HasRoof) // [!code ++]
			{ // [!code ++]
				goto IL_6f8a; // [!code ++]
			} // [!code ++]
		} // [!code ++]
	}
	goto IL_7ba5; // [!code --]
	goto IL_6fea; // [!code ++]
	void Draw(int tile)
	{
		pass = passEdge;
```

## Card

[`public virtual SubPassData GetSubPassData()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/Card.cs#L6300-L6306)
```cs:line-numbers=6300

	public void SetFreePos(Point point)
	{
		freePos = EClass.game.config.FreePos && isThing && TileType.FreeStyle && !sourceCard.multisize && !EClass.scene.actionMode.IsRoofEditMode(this); // [!code --]
		freePos = EClass.game.config.FreePos && isThing && TileType.FreeStyle; // [!code ++]
		if (freePos)
		{
			Vector3 vector = point.Position();
```

[`public void RenderMarker(Point point, bool active, HitResult result, bool main,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/Card.cs#L6349-L6355)
```cs:line-numbers=6349
		v.y = renderParam.y;
		v.z = renderParam.z;
	}
	if (TileType.UseMountHeight && !EClass.scene.actionMode.IsRoofEditMode(this)) // [!code --]
	else if (TileType.UseMountHeight) // [!code ++]
	{
		TileType.GetMountHeight(ref v, point, this.dir, this);
	}
```

## CoreDebug

[`public static string Fix_RemoveDemitas()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/CoreDebug.cs#L1937-L1942)
```cs:line-numbers=1937
	if (list.Count > 1)
	{
		Chara chara = list[1];
		chara.RemoveGlobal(); // [!code ++]
		chara.homeBranch.BanishMember(chara);
		chara.Destroy();
		return "Demitas Removed!";
```

[`public static string Fix_RemoveDemitas()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/CoreDebug.cs#L1944-L1949)
```cs:line-numbers=1944
		return "Not enough Demitas!";
	}

	[ConsoleCommand("")] // [!code ++]
	public static string Fix_RemoveAshland() // [!code ++]
	{ // [!code ++]
		List<Chara> list = new List<Chara>(); // [!code ++]
		foreach (Chara value in EClass.game.cards.globalCharas.Values) // [!code ++]
		{ // [!code ++]
			if (value.id == "ashland") // [!code ++]
			{ // [!code ++]
				list.Add(value); // [!code ++]
			} // [!code ++]
		} // [!code ++]
		if (list.Count > 1) // [!code ++]
		{ // [!code ++]
			Chara chara = list[1]; // [!code ++]
			chara.RemoveGlobal(); // [!code ++]
			chara.homeBranch.BanishMember(chara); // [!code ++]
			chara.Destroy(); // [!code ++]
			return "Ashland Removed!"; // [!code ++]
		} // [!code ++]
		return "Not enough Ashland!"; // [!code ++]
	} // [!code ++]
 // [!code ++]
	[ConsoleCommand("")]
	public static string Fix_RemoveDesignations()
	{
```

## DramaOutcome

[`public void QuestExploration_AfterCrystal()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/DramaOutcome.cs#L122-L131)
```cs:line-numbers=122
		chara.MoveHome(EMono.game.StartZone);
		chara.RemoveEditorTag(EditorTag.AINoMove);
		chara = EMono.game.cards.globalCharas.Find("ashland");
		EMono.ui.Say("Possible mod bug: 404 Ashland Not Found"); // [!code --]
		chara = CharaGen.Create("ashland"); // [!code --]
		chara.SetGlobal(); // [!code --]
		chara.MoveHome(EMono.game.StartZone); // [!code --]
		if (chara == null) // [!code ++]
		{ // [!code ++]
			EMono.ui.Say("Possible mod bug: 404 Ashland Not Found"); // [!code ++]
			chara = CharaGen.Create("ashland"); // [!code ++]
			chara.SetGlobal(); // [!code ++]
			chara.MoveHome(EMono.game.StartZone); // [!code ++]
		} // [!code ++]
	}

	public void QuestExploration_AfterComplete()
```

## TraitASMR

[`public class TraitASMR : Trait`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fe01d921bf89de92222d92e4113e5610259b8c44/Elin/TraitASMR.cs#L7-L13)
```cs:line-numbers=7
	public override void OnCreate(int lv)
	{
		ExcelData.Sheet dialogSheet = Lang.GetDialogSheet("asmr");
		owner.c_idRefCard = GetParam(1) ?? ((EClass.rnd(EClass.debug.enable ? 2 : 10) != 0) ? "jure" : dialogSheet.map.RandomItem()["id"]); // [!code --]
		owner.c_idRefCard = GetParam(1) ?? ((EClass.rnd(2) != 0) ? "jure" : dialogSheet.map.RandomItem()["id"]); // [!code ++]
	}

	public override void OnImportMap()
```
