---
exclude: true
aside: false
pageClass: diff-single-page
footer: false
editLink: false
lastUpdated: false
description: 35 files modified.
version: EA 23.74 Hotfix 4
changes: ACT/AM_MoveInstalled/ActEffect/ActMelee/ActionMode/BaseListPeople/BaseTileMap/Card/Chara/CharaBody/CoreDebug/CoreExtension/DramaManager/DropdownGrid/Effect/EffectIRenderer/FEAT/FactionBranch/Game/HitSummary/Map/Party/Props/Recipe/RenderRow/SpawnSetting/TCExtra/TaskBuild/TaskHarvest/TraitBinocular/TraitFoodEggFertilized/UIDragGridIngredients/UIHomeInfo/UIInventory/WidgetStatsBar
---

# EA 23.74 Hotfix 4

January 7, 2025

35 files modified.

## Important Changes

Possible breaking changes. Click the filename to view the chunk.
### [Game (1)](#game)
```cs:no-line-numbers
public void Save(bool isAutoSave = false, Action onComplete = null, bool silent = false) // [!code --]

```
## ACT

[`@@ -45,6 +45,10 @@ public static Act Create(string id)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ACT.cs#L45-L50)
```cs:line-numbers=45

	public static Act Create(SourceElement.Row row)
	{
		if (row == null) // [!code ++]
		{ // [!code ++]
			row = EClass.sources.elements.alias["AI_SelfHarm"]; // [!code ++]
		} // [!code ++]
		Act act = ClassCache.Create<Act>(row.type.IsEmpty(row.alias), "Elin") ?? new Act();
		if (act != null)
		{
```

## AM_MoveInstalled

[`@@ -305,6 +305,19 @@ public override void OnProcessTiles(Point point, int dir)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/AM_MoveInstalled.cs#L305-L310)
```cs:line-numbers=305
			{
				target.SetPlaceState(PlaceState.roaming);
			}
			if (!target.isRoofItem) // [!code ++]
			{ // [!code ++]
				target.ForeachPoint(delegate(Point p, bool center) // [!code ++]
				{ // [!code ++]
					if (p.IsBlocked && p.HasChara) // [!code ++]
					{ // [!code ++]
						foreach (Chara item in p.ListCharas()) // [!code ++]
						{ // [!code ++]
							EClass.pc.Kick(item, ignoreSelf: true, karmaLoss: false, show: false); // [!code ++]
						} // [!code ++]
					} // [!code ++]
				}); // [!code ++]
			} // [!code ++]
		}
		SE.Click();
		if (target.renderer.hasActor)
```

## ActEffect

[`@@ -307,10 +307,14 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActEffect.cs#L307-L316)
```cs:line-numbers=307
			}
			num4 = num4 * Act.powerMod / 100;
			c.DamageHP(num4, e.id, power * num / 100, AttackSource.None, chara ?? CC);
			if (c.IsAliveInCurrentZone && CC.IsAliveInCurrentZone && id == EffectId.DrainMana && c.isChara && CC.isChara) // [!code --]
			if (c.IsAliveInCurrentZone && CC.IsAliveInCurrentZone && id == EffectId.DrainMana && c.isChara && CC.isChara && c.Chara.mana.value > 0) // [!code ++]
			{
				int num6 = num4 * power * num / 10000; // [!code --]
				int num6 = num4 * num / 100; // [!code ++]
				Debug.Log(num4 + " v:" + num6 + " evalue:" + e.Value + " power:" + power + " elepMod:" + num);
				if (num6 > c.Chara.mana.value) // [!code ++]
				{ // [!code ++]
					num6 = c.Chara.mana.value; // [!code ++]
				} // [!code ++]
				c.Chara.mana.Mod(-num6);
				CC.Chara.mana.Mod(num6);
			}
```

## ActMelee

[`@@ -153,11 +153,7 @@ public bool Attack(float dmgMulti = 1f, bool maxRoll = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActMelee.cs#L153-L163)
```cs:line-numbers=153
			{
				if (!item.Equals(obj))
				{
					Chara firstChara = item.FirstChara; // [!code --]
					if (firstChara != null && firstChara.IsHostile(Act.CC)) // [!code --]
					{ // [!code --]
						Attack(item.FirstChara, item); // [!code --]
					} // [!code --]
					item.FirstChara?.IsHostile(Act.CC); // [!code ++]
				}
			}
		}
```

[`@@ -183,7 +179,6 @@ void Attack(Card _tc, Point _tp)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActMelee.cs#L183-L189)
```cs:line-numbers=183
					{
						Act act = Act.CC.elements.GetElement(traitAmmoTalisman.owner.refVal)?.act ?? ACT.Create(traitAmmoTalisman.owner.refVal);
						Act.powerMod = traitAmmo.owner.encLV;
						Card tC = Act.TC; // [!code --]
						if (act.Perform(Act.CC, Act.TC, Act.TP))
						{
							usedTalisman = true;
```

[`@@ -191,7 +186,6 @@ void Attack(Card _tc, Point _tp)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActMelee.cs#L191-L197)
```cs:line-numbers=191
							int spellExp = Act.CC.elements.GetSpellExp(Act.CC, act, 200);
							Act.CC.ModExp(act.id, spellExp);
						}
						Act.TC = tC; // [!code --]
						Act.powerMod = 100;
					}
				}
```

[`@@ -210,6 +204,7 @@ void Attack(Card _tc, Point _tp)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActMelee.cs#L210-L215)
```cs:line-numbers=210
					LayerInventory.SetDirty(w);
				}
			}
			Act.TC = _tc; // [!code ++]
			Act.CC.DoHostileAction(Act.TC);
		}
	}
```

## ActionMode

[`@@ -704,7 +704,7 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActionMode.cs#L704-L710)
```cs:line-numbers=704
	if (EClass.ui.currentDrag != null)
	{
		EClass.ui.OnDrag();
		if (EInput.leftMouse.down || EInput.rightMouse.down) // [!code --]
		if (EInput.leftMouse.down || EInput.rightMouse.down || EInput.isCancel) // [!code ++]
		{
			if (Input.GetMouseButton(0) && EInput.rightMouse.down)
			{
```

[`@@ -712,7 +712,7 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/ActionMode.cs#L712-L718)
```cs:line-numbers=712
			}
			else
			{
				EClass.ui.EndDrag(EInput.rightMouse.down); // [!code --]
				EClass.ui.EndDrag(EInput.rightMouse.down || EInput.isCancel); // [!code ++]
			}
		}
	}
```

## BaseListPeople

[`@@ -196,7 +196,8 @@ void AddText(Hobby h, string lang)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseListPeople.cs#L196-L202)
```cs:line-numbers=196
				{
					SourceElement.Row row = EClass.sources.elements.map[h.source.elements[j]];
					int num2 = h.source.elements[j + 1];
					P_2.t.note.AddText("NoteText_small", "・ " + "workBonus_skill".lang(row.GetName().ToTitleCase(), ((num2 > 0) ? "+" : "") + ((num2 < 0) ? (num2 / 10) : Mathf.Max(1, num2 * h.GetEfficiency(a) / 1000))) + ((row.id == 2115 || row.id == 2207) ? (" " + "fixedFactionSkill".lang()) : ""), (num2 >= 0) ? FontColor.Default : FontColor.Bad); // [!code --]
					int num3 = ((num2 < 0 || row.id == 2115 || row.id == 2207) ? (num2 / 10) : Mathf.Max(0, num2 * h.GetEfficiency(a) * a.homeBranch.efficiency / 100 / 1000)); // [!code ++]
					P_2.t.note.AddText("NoteText_small", "・ " + "workBonus_skill".lang(row.GetName().ToTitleCase(), ((num2 > 0) ? "+" : "") + num3) + ((row.id == 2115 || row.id == 2207) ? (" " + "fixedFactionSkill".lang()) : ""), (num2 >= 0) ? FontColor.Default : FontColor.Bad); // [!code ++]
				}
			}
			string[] array2 = h.source.GetDetail().SplitNewline();
```

## BaseTileMap

[`@@ -1254,11 +1254,238 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1254-L1264)
```cs:line-numbers=1254
			fogged = true;
		}
	}
	goto IL_7aa2; // [!code --]
	goto IL_7aaf; // [!code ++]
	IL_6f7f: // [!code ++]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code ++]
	{ // [!code ++]
		snowed = true; // [!code ++]
	} // [!code ++]
	if (this.cell.effect != null) // [!code ++]
	{ // [!code ++]
		if (this.cell.effect.IsLiquid) // [!code ++]
		{ // [!code ++]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code ++]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code ++]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code ++]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code ++]
			param.mat = defaultMaterial; // [!code ++]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code ++]
			sourceEffect.renderData.Draw(param); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			param.tile = this.cell.effect.source._tiles[0]; // [!code ++]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code ++]
			if (sourceEffect2.anime.Length != 0) // [!code ++]
			{ // [!code ++]
				if (sourceEffect2.anime.Length > 2) // [!code ++]
				{ // [!code ++]
					float num3 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code ++]
					if (!(num3 >= (float)sourceEffect2.anime[0])) // [!code ++]
					{ // [!code ++]
						param.tile += num3; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					float num4 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code ++]
					param.tile += num4; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (this.cell.effect.IsFire) // [!code ++]
			{ // [!code ++]
				rendererEffect.Draw(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				this.cell.effect.source.renderData.Draw(param); // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	param.color = floorLight; // [!code ++]
	if (this.cell.critter != null) // [!code ++]
	{ // [!code ++]
		Critter critter = this.cell.critter; // [!code ++]
		int snowTile = critter.tile; // [!code ++]
		if (snowed && critter.SnowTile != 0) // [!code ++]
		{ // [!code ++]
			critter.x = 0.06f; // [!code ++]
			critter.y = -0.06f; // [!code ++]
			snowTile = critter.SnowTile; // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			critter.Update(); // [!code ++]
		} // [!code ++]
		pass = passObjSS; // [!code ++]
		batch = pass.batches[pass.batchIdx]; // [!code ++]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m23 = param.z; // [!code ++]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code ++]
		batch.colors[pass.idx] = floorLight; // [!code ++]
		pass.idx++; // [!code ++]
		if (pass.idx == pass.batchSize) // [!code ++]
		{ // [!code ++]
			pass.NextBatch(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail != null) // [!code ++]
	{ // [!code ++]
		TransAnime anime3 = detail.anime; // [!code ++]
		if (anime3 != null && !anime3.animeBlock) // [!code ++]
		{ // [!code ++]
			TransAnime anime4 = detail.anime; // [!code ++]
			param.x += anime4.v.x; // [!code ++]
			param.y += anime4.v.y; // [!code ++]
			param.z += anime4.v.z; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code ++]
	{ // [!code ++]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code ++]
		if (!snowed || sourceObj.snowTile <= 0) // [!code ++]
		{ // [!code ++]
			param.snow = snowed; // [!code ++]
			param.mat = this.cell.matObj; // [!code ++]
			orgY = param.y; // [!code ++]
			if (param.liquidLv > 0) // [!code ++]
			{ // [!code ++]
				if (sourceObj.pref.Float) // [!code ++]
				{ // [!code ++]
					param.y += 0.01f * floatY; // [!code ++]
					if (liquidLv > 10) // [!code ++]
					{ // [!code ++]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
					} // [!code ++]
					liquidLv -= (int)(floatY * 0.5f); // [!code ++]
					param.liquidLv = liquidLv; // [!code ++]
				} // [!code ++]
				if (sourceObj.tileType.IsWaterTop) // [!code ++]
				{ // [!code ++]
					param.liquidLv = 0; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquid = 1f; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code ++]
					} // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (sourceObj.useAltColor) // [!code ++]
			{ // [!code ++]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			if (sourceObj.HasGrowth) // [!code ++]
			{ // [!code ++]
				this.cell.growth.OnRenderTileMap(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				if (this.cell.autotileObj != 0) // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code ++]
				} // [!code ++]
				else if (sourceObj.tileType.IsUseBlockDir) // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code ++]
				} // [!code ++]
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code ++]
				{ // [!code ++]
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code ++]
				} // [!code ++]
				orgY = param.y; // [!code ++]
				orgZ = param.z; // [!code ++]
				param.y += sourceObj.pref.y; // [!code ++]
				param.z += sourceObj.pref.z; // [!code ++]
				sourceObj.renderData.Draw(param); // [!code ++]
				param.y = orgY; // [!code ++]
				param.z = orgZ; // [!code ++]
				int shadow3 = sourceObj.pref.shadow; // [!code ++]
				if (shadow3 > 1 && !this.cell.ignoreObjShadow) // [!code ++]
				{ // [!code ++]
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow3], sourceObj.pref, 0, param.snow); // [!code ++]
				} // [!code ++]
				param.y = orgY; // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code ++]
	{ // [!code ++]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code ++]
	} // [!code ++]
	if (highlightCells) // [!code ++]
	{ // [!code ++]
		switch (ActionMode.FlagCell.mode) // [!code ++]
		{ // [!code ++]
		case AM_FlagCell.Mode.flagWallPillar: // [!code ++]
			if (this.cell.isToggleWallPillar) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagSnow: // [!code ++]
			if (this.cell.isClearSnow) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagFloat: // [!code ++]
			if (this.cell.isForceFloat) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		case AM_FlagCell.Mode.flagClear: // [!code ++]
			if (this.cell.isClearArea) // [!code ++]
			{ // [!code ++]
				passArea.Add(param, 34f, 0f); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail == null) // [!code ++]
	{ // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	if (highlightArea && detail.area != null) // [!code ++]
	{ // [!code ++]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code ++]
	} // [!code ++]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code ++]
	{ // [!code ++]
		param.tile = detail.footmark.tile; // [!code ++]
		param.mat = matFloor; // [!code ++]
		param.matColor = 104025f; // [!code ++]
		renderFootmark.Draw(param); // [!code ++]
	} // [!code ++]
	goto IL_7aaf; // [!code ++]
	IL_6f1f: // [!code ++]
	int num5; // [!code ++]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code ++]
	{ // [!code ++]
		param.tile = num5; // [!code ++]
		rendererFov.Draw(param); // [!code ++]
	} // [!code ++]
	goto IL_6f7f; // [!code ++]
	IL_1668:
	if (this.cell.isSlopeEdge)
	{
		float num3 = (float)height * _heightMod.y; // [!code --]
		float num6 = (float)height * _heightMod.y; // [!code ++]
		orgY = param.y;
		orgZ = param.z;
		param.dir = this.cell.blockDir;
```

[`@@ -1288,17 +1515,17 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1288-L1304)
```cs:line-numbers=1288
				param.matColor = 104025f;
			}
		}
		for (int j = 0; (float)j < num3 / heightBlockSize; j++) // [!code --]
		for (int j = 0; (float)j < num6 / heightBlockSize; j++) // [!code ++]
		{
			param.y += ugFix.y;
			param.z += ugFix.z + slopeFixZ * (float)j;
			defBlock.renderData.Draw(param);
			if (this.cell.pcSync && EMono.player.lightPower > 0f)
			{
				float num4 = param.tile; // [!code --]
				float num7 = param.tile; // [!code ++]
				param.tile = 0f;
				rendererFov.Draw(param);
				param.tile = num4; // [!code --]
				param.tile = num7; // [!code ++]
			}
		}
		param.y = orgY;
```

[`@@ -1309,29 +1536,29 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1309-L1337)
```cs:line-numbers=1309
	{
		orgY = param.y;
		orgZ = param.z;
		int num5 = 0; // [!code --]
		int num8 = 0; // [!code ++]
		if (sourceBlock.tileType.IsFullBlock)
		{
			SourceBlock.Row row3 = sourceBlock;
			num5 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			num8 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
		}
		else
		{
			SourceBlock.Row row3 = sourceFloor._defBlock;
			num5 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code --]
			num8 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code ++]
		}
		if (((this.cell.Front.shore / 12) & 1) == 0 && this.cell.Front.sourceFloor.tileType.IsWater && this.cell.Front.height <= height && this.cell.Front.sourceBlock.tileType.RenderWaterBlock)
		{
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Front.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Front.height * _heightMod.y;
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z;
			param.tile = num5 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			param.tile = num8 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param);
		}
		if (((this.cell.Right.shore / 12) & 8) == 0 && this.cell.Right.sourceFloor.tileType.IsWater && this.cell.Right.height <= height && this.cell.Right.sourceBlock.tileType.RenderWaterBlock)
		{
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Right.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Right.height * _heightMod.y;
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z;
			param.tile = num5 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			param.tile = num8 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param);
		}
		param.y = orgY;
```

[`@@ -1429,20 +1656,20 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1429-L1448)
```cs:line-numbers=1429
				}
				sourceFloor.renderData.Draw(param);
			}
			int num6 = 0; // [!code --]
			int num9 = 0; // [!code ++]
			if (isSnowCovered && sourceFloor == FLOOR.sourceSnow && !this.cell.hasDoor)
			{
				if (!this.cell.Right.IsSnowTile && this.cell.Right.topHeight == this.cell.topHeight)
				{
					num6++; // [!code --]
					num9++; // [!code ++]
				}
				if (!this.cell.Front.IsSnowTile && this.cell.Front.topHeight == this.cell.topHeight)
				{
					num6 += 2; // [!code --]
					num9 += 2; // [!code ++]
				}
				if (num6 != 0) // [!code --]
				if (num9 != 0) // [!code ++]
				{
					param.tile = 448 + num6 + 12; // [!code --]
					param.tile = 448 + num9 + 12; // [!code ++]
					param.z -= 0.1f;
					sourceFloor.renderData.Draw(param);
					param.z += 0.1f;
```

[`@@ -1513,7 +1740,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1513-L1519)
```cs:line-numbers=1513
					}
				}
			}
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num6 == 0) // [!code --]
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num9 == 0) // [!code ++]
			{
				pass = (isWater ? passAutoTileWater : passAutoTile);
				batch = pass.batches[pass.batchIdx];
```

[`@@ -1532,16 +1759,16 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1532-L1547)
```cs:line-numbers=1532
		}
		if (isWater)
		{
			int num7 = 12; // [!code --]
			int num8 = this.cell.shore / num7; // [!code --]
			int num9 = this.cell.shore % num7; // [!code --]
			int num10 = 12; // [!code ++]
			int num11 = this.cell.shore / num10; // [!code ++]
			int num12 = this.cell.shore % num10; // [!code ++]
			bool isShoreSand = this.cell.isShoreSand;
			if (this.cell.shore != 0)
			{
				Cell cell = ((((uint)num8 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num8 & 2u) != 0) ? this.cell.Right : ((((uint)num8 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code --]
				Cell cell = ((((uint)num11 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num11 & 2u) != 0) ? this.cell.Right : ((((uint)num11 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code ++]
				if (isShoreSand && !cell.sourceFloor.isBeach)
				{
					cell = ((((uint)num8 & 8u) != 0) ? this.cell.Left : ((((uint)num8 & 4u) != 0) ? this.cell.Front : ((((uint)num8 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code --]
					cell = ((((uint)num11 & 8u) != 0) ? this.cell.Left : ((((uint)num11 & 4u) != 0) ? this.cell.Front : ((((uint)num11 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code ++]
				}
				if (!cell.IsSnowTile)
				{
```

[`@@ -1553,7 +1780,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1553-L1559)
```cs:line-numbers=1553
						batch.matrices[pass.idx].m03 = param.x;
						batch.matrices[pass.idx].m13 = param.y;
						batch.matrices[pass.idx].m23 = param.z;
						batch.tiles[pass.idx] = 768 + this.cell.shore / num7; // [!code --]
						batch.tiles[pass.idx] = 768 + this.cell.shore / num10; // [!code ++]
						batch.colors[pass.idx] = param.color;
						batch.matColors[pass.idx] = param.matColor;
						pass.idx++;
```

[`@@ -1561,38 +1788,38 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1561-L1598)
```cs:line-numbers=1561
						{
							pass.NextBatch();
						}
						num9 = 2; // [!code --]
						num12 = 2; // [!code ++]
					}
					else
					{
						num9 = cell.sourceFloor.edge; // [!code --]
						num12 = cell.sourceFloor.edge; // [!code ++]
					}
					param.tile = (24 + num9 / 2) * 32 + num9 % 2 * 16 + num8; // [!code --]
					param.tile = (24 + num12 / 2) * 32 + num12 % 2 * 16 + num11; // [!code ++]
					rendererShore.Draw(param);
				}
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num7) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num10) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num10) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				param.tile = 785f;
				param.matColor = GetColorInt(ref this.cell.BackLeft.matFloor.matColor, this.cell.BackLeft.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(60);
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num7) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num10) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num10) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				param.tile = 786f;
				param.matColor = GetColorInt(ref this.cell.BackRight.matFloor.matColor, this.cell.BackRight.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(56);
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num7) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num7) & 4u) != 0) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num10) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num10) & 4u) != 0) // [!code ++]
			{
				param.tile = 787f;
				param.matColor = GetColorInt(ref this.cell.FrontRight.matFloor.matColor, this.cell.FrontRight.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(48);
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num7) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num7) & 4u) != 0) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num10) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num10) & 4u) != 0) // [!code ++]
			{
				param.tile = 788f;
				param.matColor = GetColorInt(ref this.cell.FrontLeft.matFloor.matColor, this.cell.FrontLeft.sourceFloor.colorMod);
```

[`@@ -1618,27 +1845,27 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1618-L1644)
```cs:line-numbers=1618
			bool flag6 = false;
			if (isShoreSand)
			{
				if (((uint)num8 & (true ? 1u : 0u)) != 0) // [!code --]
				if (((uint)num11 & (true ? 1u : 0u)) != 0) // [!code ++]
				{
					if (((uint)num8 & 8u) != 0) // [!code --]
					if (((uint)num11 & 8u) != 0) // [!code ++]
					{
						Draw(16);
						flag6 = true;
					}
					if (((uint)num8 & 2u) != 0) // [!code --]
					if (((uint)num11 & 2u) != 0) // [!code ++]
					{
						Draw(20);
						flag6 = true;
					}
				}
				if (((uint)num8 & 4u) != 0) // [!code --]
				if (((uint)num11 & 4u) != 0) // [!code ++]
				{
					if (((uint)num8 & 8u) != 0) // [!code --]
					if (((uint)num11 & 8u) != 0) // [!code ++]
					{
						Draw(24);
						flag6 = true;
					}
					if (((uint)num8 & 2u) != 0) // [!code --]
					if (((uint)num11 & 2u) != 0) // [!code ++]
					{
						Draw(28);
						flag6 = true;
```

[`@@ -1664,7 +1891,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1664-L1670)
```cs:line-numbers=1664
					batch = pass.batches[pass.batchIdx];
					batch.tiles[pass.idx] = 608 + waterAnimeIndex % 4;
					batch.matColors[pass.idx] = 104025f;
					if (((uint)(this.cell.shore / num7) & (true ? 1u : 0u)) != 0) // [!code --]
					if (((uint)(this.cell.shore / num10) & (true ? 1u : 0u)) != 0) // [!code ++]
					{
						if (isShoreSand)
						{
```

[`@@ -1702,7 +1929,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1702-L1708)
```cs:line-numbers=1702
					batch = pass.batches[pass.batchIdx];
					batch.tiles[pass.idx] = 612 + waterAnimeIndex % 4;
					batch.matColors[pass.idx] = 104025f;
					if (((uint)(this.cell.shore / num7) & 8u) != 0) // [!code --]
					if (((uint)(this.cell.shore / num10) & 8u) != 0) // [!code ++]
					{
						if (isShoreSand)
						{
```

[`@@ -1818,16 +2045,16 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1818-L1833)
```cs:line-numbers=1818
			param.z += bridgeFix.z;
			param.dir = 0;
			SourceBlock.Row row4 = sourceBridge._bridgeBlock;
			float num10 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code --]
			float num13 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code ++]
			if (this.cell.sourceFloor.tileType == TileType.Sky)
			{
				num10 += (float)EMono._map.config.skyBlockHeight; // [!code --]
				num13 += (float)EMono._map.config.skyBlockHeight; // [!code ++]
			}
			int num11 = (int)(num10 / heightBlockSize) + 2; // [!code --]
			int num14 = (int)(num13 / heightBlockSize) + 2; // [!code ++]
			if (this.cell.bridgePillar != 0)
			{
				row4 = EMono.sources.blocks.rows[this.cell.bridgePillar];
				param.tile = row4._tiles[0] + ((num11 == 2) ? 32 : 0); // [!code --]
				param.tile = row4._tiles[0] + ((num14 == 2) ? 32 : 0); // [!code ++]
				param.mat = ((sourceBridge.DefaultMaterial == row4.DefaultMaterial) ? sourceBridge.DefaultMaterial : row4.DefaultMaterial);
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, row4.colorMod));
			}
```

[`@@ -1839,9 +2066,9 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1839-L1847)
```cs:line-numbers=1839
			}
			param.y += ugFixBridgeTop.y;
			param.z += ugFixBridgeTop.z;
			for (int l = 0; l < num11; l++) // [!code --]
			for (int l = 0; l < num14; l++) // [!code ++]
			{
				if (l == num11 - 1) // [!code --]
				if (l == num14 - 1) // [!code ++]
				{
					param.y = (float)(cz - cx) * screen.tileAlign.y + (float)height * _heightMod.y + ugFixBridgeBottom.y;
					param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)height * _heightMod.z + ugFixBridgeBottom.z;
```

[`@@ -1873,7 +2100,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1873-L1879)
```cs:line-numbers=1873
	{
		snowed = false;
	}
	int num12 = 0; // [!code --]
	num5 = 0; // [!code ++]
	if (sourceBlock.id != 0)
	{
		this.tileType = sourceBlock.tileType;
```

[`@@ -1946,8 +2173,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1946-L1953)
```cs:line-numbers=1946
					roomHeight = 0f;
					break;
				}
				int num13 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code --]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num13) ? this.room.lot.height : num13) + 0.01f * (float)this.room.lot.heightFix; // [!code --]
				int num15 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code ++]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num15) ? this.room.lot.height : num15) + 0.01f * (float)this.room.lot.heightFix; // [!code ++]
			}
			break;
		case WallClipMode.ByLot:
```

[`@@ -1993,11 +2220,11 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L1993-L2003)
```cs:line-numbers=1993
		}
		if (!_lowblock && (double)roomHeight > 1.2 && this.tileType.RepeatBlock)
		{
			num12 = 1; // [!code --]
			num5 = 1; // [!code ++]
		}
		else if (lowBlock)
		{
			num12 = 2; // [!code --]
			num5 = 2; // [!code ++]
		}
		param.mat = matBlock;
		param.dir = this.cell.blockDir;
```

[`@@ -2044,8 +2271,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2044-L2051)
```cs:line-numbers=2044
				}
				if (!_lowblock)
				{
					int num14 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code --]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num14) ? currentRoom.lot.height : num14) + 0.01f * (float)currentRoom.lot.heightFix; // [!code --]
					int num16 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code ++]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num16) ? currentRoom.lot.height : num16) + 0.01f * (float)currentRoom.lot.heightFix; // [!code ++]
				}
			}
			if (flag7)
```

[`@@ -2099,12 +2326,12 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2099-L2110)
```cs:line-numbers=2099
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2);
					param.matColor = room.lot.colDeco2;
					float y2 = param.y;
					float num15 = param.z; // [!code --]
					float num17 = param.z; // [!code ++]
					param.y += (float)room.lot.decoFix2 * 0.01f;
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco;
					rendererWallDeco.Draw(param);
					param.y = y2;
					param.z = num15; // [!code --]
					param.z = num17; // [!code ++]
				}
			}
			room = this.cell.Right.room ?? this.cell.room;
```

[`@@ -2128,12 +2355,12 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2128-L2139)
```cs:line-numbers=2128
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2) * -1;
					param.matColor = room.lot.colDeco2;
					float y4 = param.y;
					float num16 = param.z; // [!code --]
					float num18 = param.z; // [!code ++]
					param.y += (float)room.lot.decoFix2 * 0.01f;
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco;
					rendererWallDeco.Draw(param);
					param.y = y4;
					param.z = num16; // [!code --]
					param.z = num18; // [!code ++]
				}
			}
			break;
```

[`@@ -2227,7 +2454,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2227-L2233)
```cs:line-numbers=2227
				{
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod));
				}
				if (roomHeight == 0f || flag8) // [!code --]
				if (roomHeight == 0f || flag8 || !this.tileType.RepeatBlock) // [!code ++]
				{
					if (!this.cell.hasDoor)
					{
```

[`@@ -2331,8 +2558,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2331-L2338)
```cs:line-numbers=2331
					}
					else
					{
						int num17 = ((room4.data.maxHeight == 0) ? 2 : room4.data.maxHeight); // [!code --]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room4.lot.height < num17) ? room4.lot.height : num17) + 0.01f * (float)room4.lot.heightFix; // [!code --]
						int num19 = ((room4.data.maxHeight == 0) ? 2 : room4.data.maxHeight); // [!code ++]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room4.lot.height < num19) ? room4.lot.height : num19) + 0.01f * (float)room4.lot.heightFix; // [!code ++]
					}
				}
				Cell back2 = this.cell.Back;
```

[`@@ -2405,19 +2632,19 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2405-L2423)
```cs:line-numbers=2405
			RenderData renderData2 = sourceBlock.renderData;
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length];
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod));
			int num18 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code --]
			if (num18 == 0) // [!code --]
			int num20 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code ++]
			if (num20 == 0) // [!code ++]
			{
				renderData2.Draw(param);
			}
			else
			{
				renderData2.DrawRepeat(param, num18, sourceBlock.tileType.RepeatSize); // [!code --]
				renderData2.DrawRepeat(param, num20, sourceBlock.tileType.RepeatSize); // [!code ++]
			}
			param.tile = renderData2.idShadow;
			SourcePref shadowPref2 = renderData2.shadowPref;
			int shadow3 = shadowPref2.shadow; // [!code --]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow3], shadowPref2, 0, param.snow); // [!code --]
			int shadow4 = shadowPref2.shadow; // [!code ++]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow4], shadowPref2, 0, param.snow); // [!code ++]
			break;
		}
		default:
```

[`@@ -2439,245 +2666,19 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/BaseTileMap.cs#L2439-L2683)
```cs:line-numbers=2439
	{
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof)
		{
			goto IL_6f12; // [!code --]
			goto IL_6f1f; // [!code ++]
		}
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock)
		{
			Room obj = this.cell.FrontRight.room;
			if (obj == null || !obj.HasRoof)
			{
				goto IL_6f12; // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	goto IL_6f72; // [!code --]
	IL_6f72: // [!code --]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code --]
	{ // [!code --]
		snowed = true; // [!code --]
	} // [!code --]
	if (this.cell.effect != null) // [!code --]
	{ // [!code --]
		if (this.cell.effect.IsLiquid) // [!code --]
		{ // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code --]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code --]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code --]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code --]
			param.mat = defaultMaterial; // [!code --]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code --]
			sourceEffect.renderData.Draw(param); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code --]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code --]
			if (sourceEffect2.anime.Length != 0) // [!code --]
			{ // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code --]
				{ // [!code --]
					float num19 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code --]
					if (!(num19 >= (float)sourceEffect2.anime[0])) // [!code --]
					{ // [!code --]
						param.tile += num19; // [!code --]
					} // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					float num20 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code --]
					param.tile += num20; // [!code --]
				} // [!code --]
			} // [!code --]
			if (this.cell.effect.IsFire) // [!code --]
			{ // [!code --]
				rendererEffect.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				this.cell.effect.source.renderData.Draw(param); // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	param.color = floorLight; // [!code --]
	if (this.cell.critter != null) // [!code --]
	{ // [!code --]
		Critter critter = this.cell.critter; // [!code --]
		int snowTile = critter.tile; // [!code --]
		if (snowed && critter.SnowTile != 0) // [!code --]
		{ // [!code --]
			critter.x = 0.06f; // [!code --]
			critter.y = -0.06f; // [!code --]
			snowTile = critter.SnowTile; // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			critter.Update(); // [!code --]
		} // [!code --]
		pass = passObjSS; // [!code --]
		batch = pass.batches[pass.batchIdx]; // [!code --]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m23 = param.z; // [!code --]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code --]
		batch.colors[pass.idx] = floorLight; // [!code --]
		pass.idx++; // [!code --]
		if (pass.idx == pass.batchSize) // [!code --]
		{ // [!code --]
			pass.NextBatch(); // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail != null) // [!code --]
	{ // [!code --]
		TransAnime anime3 = detail.anime; // [!code --]
		if (anime3 != null && !anime3.animeBlock) // [!code --]
		{ // [!code --]
			TransAnime anime4 = detail.anime; // [!code --]
			param.x += anime4.v.x; // [!code --]
			param.y += anime4.v.y; // [!code --]
			param.z += anime4.v.z; // [!code --]
		} // [!code --]
	} // [!code --]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code --]
	{ // [!code --]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code --]
		if (!snowed || sourceObj.snowTile <= 0) // [!code --]
		{ // [!code --]
			param.snow = snowed; // [!code --]
			param.mat = this.cell.matObj; // [!code --]
			orgY = param.y; // [!code --]
			if (param.liquidLv > 0) // [!code --]
			{ // [!code --]
				if (sourceObj.pref.Float) // [!code --]
				{ // [!code --]
					param.y += 0.01f * floatY; // [!code --]
					if (liquidLv > 10) // [!code --]
					{ // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
					} // [!code --]
					liquidLv -= (int)(floatY * 0.5f); // [!code --]
					param.liquidLv = liquidLv; // [!code --]
				} // [!code --]
				if (sourceObj.tileType.IsWaterTop) // [!code --]
				{ // [!code --]
					param.liquidLv = 0; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					{ // [!code --]
						param.liquid = 1f; // [!code --]
					} // [!code --]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code --]
					{ // [!code --]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code --]
					} // [!code --]
				} // [!code --]
			} // [!code --]
			if (sourceObj.useAltColor) // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			if (sourceObj.HasGrowth) // [!code --]
			{ // [!code --]
				this.cell.growth.OnRenderTileMap(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				if (this.cell.autotileObj != 0) // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[0] + this.cell.autotileObj; // [!code --]
				} // [!code --]
				else if (sourceObj.tileType.IsUseBlockDir) // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[this.cell.blockDir % sourceObj._tiles.Length]; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.tile = sourceObj._tiles[this.cell.objDir % sourceObj._tiles.Length]; // [!code --]
				} // [!code --]
				if (_lowblock && sourceObj.tileType.IsSkipLowBlock) // [!code --]
				{ // [!code --]
					param.tile += ((param.tile > 0f) ? 1 : (-1)) * 3000000; // [!code --]
				} // [!code --]
				orgY = param.y; // [!code --]
				orgZ = param.z; // [!code --]
				param.y += sourceObj.pref.y; // [!code --]
				param.z += sourceObj.pref.z; // [!code --]
				sourceObj.renderData.Draw(param); // [!code --]
				param.y = orgY; // [!code --]
				param.z = orgZ; // [!code --]
				int shadow4 = sourceObj.pref.shadow; // [!code --]
				if (shadow4 > 1 && !this.cell.ignoreObjShadow) // [!code --]
				{ // [!code --]
					passShadow.AddShadow(param.x + sourceObj.renderData.offsetShadow.x, param.y + sourceObj.renderData.offsetShadow.y, param.z + sourceObj.renderData.offsetShadow.z, ShadowData.Instance.items[shadow4], sourceObj.pref, 0, param.snow); // [!code --]
				} // [!code --]
				param.y = orgY; // [!code --]
				goto IL_6f1f; // [!code ++]
			}
		}
	}
	if (this.cell.decal != 0 && sourceFloor.tileType.AllowBlood) // [!code --]
	{ // [!code --]
		passDecal.Add(param, (int)this.cell.decal, floorLight); // [!code --]
	} // [!code --]
	if (highlightCells) // [!code --]
	{ // [!code --]
		switch (ActionMode.FlagCell.mode) // [!code --]
		{ // [!code --]
		case AM_FlagCell.Mode.flagWallPillar: // [!code --]
			if (this.cell.isToggleWallPillar) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagSnow: // [!code --]
			if (this.cell.isClearSnow) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagFloat: // [!code --]
			if (this.cell.isForceFloat) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		case AM_FlagCell.Mode.flagClear: // [!code --]
			if (this.cell.isClearArea) // [!code --]
			{ // [!code --]
				passArea.Add(param, 34f, 0f); // [!code --]
			} // [!code --]
			break; // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail == null) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	if (highlightArea && detail.area != null) // [!code --]
	{ // [!code --]
		passArea.Add(param, (int)detail.area.GetTile(index) - ((!subtleHighlightArea) ? 1 : 0), 0f); // [!code --]
	} // [!code --]
	if (detail.footmark != null && sourceFloor.id != 0) // [!code --]
	{ // [!code --]
		param.tile = detail.footmark.tile; // [!code --]
		param.mat = matFloor; // [!code --]
		param.matColor = 104025f; // [!code --]
		renderFootmark.Draw(param); // [!code --]
	} // [!code --]
	goto IL_7aa2; // [!code --]
	IL_6f12: // [!code --]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code --]
	{ // [!code --]
		param.tile = num12; // [!code --]
		rendererFov.Draw(param); // [!code --]
	} // [!code --]
	goto IL_6f72; // [!code --]
	IL_7aa2: // [!code --]
	goto IL_6f7f; // [!code ++]
	IL_7aaf: // [!code ++]
	if (detail.things.Count == 0 && detail.charas.Count == 0)
	{
		return;
```

## Card

[`@@ -2575,6 +2575,10 @@ public void Create(string _id, int _idMat = -1, int genLv = -1)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Card.cs#L2575-L2580)
```cs:line-numbers=2575
	{
		LV = bp.lv;
	}
	if (id == "microchip") // [!code ++]
	{ // [!code ++]
		Debug.Log(id + "/" + _idMat + "/" + sourceCard.fixedMaterial); // [!code ++]
	} // [!code ++]
	if (sourceCard.fixedMaterial)
	{
		_material = EClass.sources.materials.alias[AliasMaterialOnCreate];
```

[`@@ -6687,6 +6691,10 @@ public virtual int SecondaryCompare(UIList.SortMode m, Card c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Card.cs#L6687-L6692)
```cs:line-numbers=6687
		num = encLV - c.encLV;
	}
	if (num == 0)
	{ // [!code ++]
		num = Num - c.Num; // [!code ++]
	} // [!code ++]
	if (num == 0) // [!code ++]
	{
		num = uid - c.uid;
	}
```

## Chara

[`@@ -1856,6 +1856,43 @@ public void AddRandomBodyPart(bool msg = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Chara.cs#L1856-L1861)
```cs:line-numbers=1856
		}
	}

	public void RemoveLastBodyPart(bool msg = false) // [!code ++]
	{ // [!code ++]
		if (body.slots.Count != 0) // [!code ++]
		{ // [!code ++]
			BodySlot bodySlot = body.slots.LastItem(); // [!code ++]
			body.RemoveBodyPartAt(body.slots.Count - 1); // [!code ++]
			if (msg) // [!code ++]
			{ // [!code ++]
				Say("lose_bodyparts", this, Element.Get(bodySlot.elementId).GetName().ToLower()); // [!code ++]
				PlaySound("offering"); // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void ResetBody() // [!code ++]
	{ // [!code ++]
		for (int num = body.slots.Count - 1; num >= 0; num--) // [!code ++]
		{ // [!code ++]
			BodySlot bodySlot = body.slots[num]; // [!code ++]
			if (bodySlot.elementId == 45 || bodySlot.elementId == 40) // [!code ++]
			{ // [!code ++]
				return; // [!code ++]
			} // [!code ++]
			body.RemoveBodyPart(num); // [!code ++]
		} // [!code ++]
		string[] array = race.figure.Split('|'); // [!code ++]
		foreach (string s in array) // [!code ++]
		{ // [!code ++]
			int num2 = ParseBodySlot(s); // [!code ++]
			if (num2 != -1) // [!code ++]
			{ // [!code ++]
				body.AddBodyPart(num2); // [!code ++]
			} // [!code ++]
		} // [!code ++]
		body.RefreshBodyParts(); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void ApplyRace(bool remove = false)
	{
		string[] array = race.figure.Split('|');
```

[`@@ -5595,6 +5632,7 @@ public void DoHostileAction(Card _tg, bool immediate = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Chara.cs#L5595-L5600)
```cs:line-numbers=5595
			{
				Thing t = ThingGen.Create("49");
				ActThrow.Throw(chara, pos, t);
				Act.TC = chara; // [!code ++]
			}
		}
	}
```

[`@@ -5990,9 +6028,9 @@ public override string GetHoverText2()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Chara.cs#L5990-L5998)
```cs:line-numbers=5990
	IEnumerable<BaseStats> enumerable = conditions.Concat((!IsPCFaction) ? new BaseStats[0] : new BaseStats[2] { hunger, stamina });
	if (enumerable.Count() > 0)
	{
		text = ""; // [!code --]
		text3 += Environment.NewLine;
		text3 += "<size=14>";
		int num = 0; // [!code ++]
		foreach (BaseStats item in enumerable)
		{
			string text4 = item.GetPhaseStr();
```

[`@@ -6020,9 +6058,18 @@ public override string GetHoverText2()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Chara.cs#L6020-L6028)
```cs:line-numbers=6020
					text4 = text4 + "{" + resistCon[item.id] + "}";
				}
			}
			num++; // [!code ++]
			text3 = text3 + text4.TagColor(c) + ", ";
		}
		text3 = text3.TrimEnd(", ".ToCharArray()) + "</size>"; // [!code --]
		if (num == 0) // [!code ++]
		{ // [!code ++]
			text3 = ""; // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			text = ""; // [!code ++]
			text3 = text3.TrimEnd(", ".ToCharArray()) + "</size>"; // [!code ++]
		} // [!code ++]
	}
	return text + text2 + text3;
}
```

## CharaBody

[`@@ -305,10 +305,15 @@ public void RefreshBodyParts()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CharaBody.cs#L305-L314)
```cs:line-numbers=305

	public void RemoveBodyPart(int ele)
	{
		int num = slots.FindIndex((BodySlot a) => a.elementId == ele); // [!code --]
		if (num != -1) // [!code --]
		int idx = slots.FindIndex((BodySlot a) => a.elementId == ele); // [!code ++]
		RemoveBodyPartAt(idx); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void RemoveBodyPartAt(int idx) // [!code ++]
	{ // [!code ++]
		if (idx != -1) // [!code ++]
		{
			BodySlot bodySlot = slots[num]; // [!code --]
			BodySlot bodySlot = slots[idx]; // [!code ++]
			if (bodySlot.thing != null)
			{
				Unequip(bodySlot);
```

[`@@ -325,7 +330,7 @@ public void RemoveBodyPart(int ele)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CharaBody.cs#L325-L331)
```cs:line-numbers=325
			{
				slotRange = null;
			}
			slots.RemoveAt(num); // [!code --]
			slots.RemoveAt(idx); // [!code ++]
		}
	}

```

## CoreDebug

[`@@ -905,16 +905,14 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CoreDebug.cs#L905-L920)
```cs:line-numbers=905
	}
	if (Input.GetKeyDown(KeyCode.F2))
	{
		EClass.pc.SetFeat(1355); // [!code --]
		foreach (Chara chara in EClass._map.charas) // [!code --]
		Chara targetChara = EClass.scene.mouseTarget.TargetChara; // [!code ++]
		if (targetChara != null) // [!code ++]
		{
			chara.ModAffinity(EClass.pc, -100 + EScriptable.rnd(200)); // [!code --]
			chara.hygiene.Mod(-50 + EScriptable.rnd(100)); // [!code --]
			EClass.pc.Pick(targetChara.MakeMilk()); // [!code ++]
			EClass.pc.Pick(targetChara.MakeGene()); // [!code ++]
			EClass.pc.Pick(targetChara.MakeBraineCell()); // [!code ++]
			EClass.pc.Pick(targetChara.MakeEgg(effect: true, 10)); // [!code ++]
		}
		Thing to = ThingGen.Create("gene"); // [!code --]
		to = DNA.CopyDNA(DNA.GenerateRandomGene(), to); // [!code --]
		EClass.pc.Pick(to); // [!code --]
		EClass.pc.Pick(ThingGen.Create("rune")); // [!code --]
		return;
	}
	if (Input.GetKeyDown(KeyCode.F3))
```

[`@@ -942,9 +940,9 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CoreDebug.cs#L942-L950)
```cs:line-numbers=942
		{
			EClass.Branch.ModExp(EClass.Branch.GetNextExp());
		}
		foreach (Chara member in EClass.pc.party.members) // [!code --]
		foreach (Chara chara in EClass._map.charas) // [!code ++]
		{
			member.AddExp(member.ExpToNext); // [!code --]
			chara.AddExp(chara.ExpToNext); // [!code ++]
		}
		EClass.pc.PlayEffect("boost");
		EClass.pc.PlaySound("boost");
```

[`@@ -1857,6 +1855,21 @@ public static string SetElement(string alias, int value, int potential = 100)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CoreDebug.cs#L1857-L1862)
```cs:line-numbers=1857
		return "Done.";
	}

	[ConsoleCommand("")] // [!code ++]
	public static string SpawnBoss(string id) // [!code ++]
	{ // [!code ++]
		if (!CheatEnabled()) // [!code ++]
		{ // [!code ++]
			return EnableCheat; // [!code ++]
		} // [!code ++]
		if (EClass.sources.charas.map.ContainsKey(id)) // [!code ++]
		{ // [!code ++]
			Chara chara = EClass._zone.SpawnMob(EClass.pc.pos.GetNearestPoint(), SpawnSetting.Boss(id)); // [!code ++]
			return "Spawned " + chara.Name; // [!code ++]
		} // [!code ++]
		return "'" + id + "' does not exist in the database."; // [!code ++]
	} // [!code ++]
 // [!code ++]
	[ConsoleCommand("")]
	public static string Spawn(string id, int num = 1, string aliasMat = "", int objLv = -1)
	{
```

## CoreExtension

[`@@ -1,4 +1,5 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CoreExtension.cs#L1-L4)
```cs:line-numbers=1
using System;
using System.Collections.Generic; // [!code ++]
using UnityEngine;

public static class CoreExtension
```

[`@@ -54,4 +55,28 @@ public static string TagColor(this string text, Func<bool> funcGood, Func<bool>`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/CoreExtension.cs#L54-L57)
```cs:line-numbers=54
		SkinColorProfile skinColorProfile = colors ?? SkinManager.CurrentColors;
		return text.TagColor(funcGood() ? skinColorProfile.textGood : ((funcBad != null && funcBad()) ? skinColorProfile.textBad : skinColorProfile.textDefault));
	}
 // [!code ++]
	public static void Sort(this List<Thing> things, UIList.SortMode m, bool ascending = false) // [!code ++]
	{ // [!code ++]
		foreach (Thing thing in things) // [!code ++]
		{ // [!code ++]
			thing.SetSortVal(m); // [!code ++]
		} // [!code ++]
		things.Sort(delegate(Thing a, Thing b) // [!code ++]
		{ // [!code ++]
			if (m == UIList.SortMode.ByName) // [!code ++]
			{ // [!code ++]
				if (ascending) // [!code ++]
				{ // [!code ++]
					return string.Compare(a.GetName(NameStyle.FullNoArticle, 1), b.GetName(NameStyle.FullNoArticle, 1)); // [!code ++]
				} // [!code ++]
				return string.Compare(b.GetName(NameStyle.FullNoArticle, 1), a.GetName(NameStyle.FullNoArticle, 1)); // [!code ++]
			} // [!code ++]
			if (a.sortVal == b.sortVal) // [!code ++]
			{ // [!code ++]
				return b.SecondaryCompare(m, a); // [!code ++]
			} // [!code ++]
			return (!ascending) ? (a.sortVal - b.sortVal) : (b.sortVal - a.sortVal); // [!code ++]
		}); // [!code ++]
	} // [!code ++]
}
```

## DramaManager

[`@@ -894,7 +894,7 @@ public void ParseLine(Dictionary<string, string> item)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DramaManager.cs#L894-L900)
```cs:line-numbers=894
	case "save":
		AddEvent(delegate
		{
			EMono.game.Save(isAutoSave: false, null, silent: true); // [!code --]
			EMono.game.Save(isAutoSave: false, silent: true); // [!code ++]
		});
		break;
	case "setHour":
```

## DropdownGrid

[`@@ -100,6 +100,7 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L100-L105)
```cs:line-numbers=100
	{
		onInstantiate = delegate(Recipe.Ingredient ingredient, ButtonGrid b)
		{
			List<Thing> things; // [!code ++]
			if (ingredient.id.IsEmpty())
			{
				b.SetIngredient(recipe, ingredient);
```

[`@@ -124,19 +125,19 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L124-L142)
```cs:line-numbers=124
				}
				if (!flag)
				{
					List<Thing> list2 = ListIngredients(ingredient, searchMode); // [!code --]
					if (list2.Count == 0) // [!code --]
					things = ListIngredients(ingredient, searchMode); // [!code ++]
					if (things.Count == 0) // [!code ++]
					{
						if (EMono.debug.godBuild && ingredient.thing == null)
						{
							Thing thing2 = ThingGen.Create(ingredient.IdThing, recipe.DefaultMaterial.alias).SetNum(99);
							list2.Add(thing2); // [!code --]
							things.Add(thing2); // [!code ++]
							ingredient.SetThing(thing2);
						}
						else
						{
							ingredient.SetThing();
							list2.Insert(0, null); // [!code --]
							things.Insert(0, null); // [!code ++]
						}
					}
					else if (!ingredient.optional)
```

[`@@ -146,7 +147,7 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L146-L152)
```cs:line-numbers=146
							int num2 = lastMats.TryGetValue(recipe.id, -1);
							if (num2 != -1)
							{
								foreach (Thing item in list2) // [!code --]
								foreach (Thing item in things) // [!code ++]
								{
									if (item.material.id == num2 && item.Num >= ingredient.req)
									{
```

[`@@ -158,7 +159,7 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L158-L164)
```cs:line-numbers=158
							if (ingredient.thing == null)
							{
								SourceMaterial.Row defaultMaterial = recipe.DefaultMaterial;
								foreach (Thing item2 in list2) // [!code --]
								foreach (Thing item2 in things) // [!code ++]
								{
									if (item2.material.id == defaultMaterial.id && item2.Num >= ingredient.req)
									{
```

[`@@ -169,19 +170,19 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L169-L187)
```cs:line-numbers=169
								if (EMono.debug.godBuild && ingredient.thing == null)
								{
									Thing thing3 = (ingredient.useCat ? ThingGen.CreateFromCategory(ingredient.id) : ThingGen.Create(ingredient.id, defaultMaterial.alias)).SetNum(99);
									list2.Add(thing3); // [!code --]
									things.Add(thing3); // [!code ++]
									ingredient.SetThing(thing3);
								}
							}
							if (ingredient.thing == null)
							{
								ingredient.SetThing(list2[0]); // [!code --]
								ingredient.SetThing(FindMax()); // [!code ++]
							}
						}
						else
						{
							bool flag2 = true;
							foreach (Thing item3 in list2) // [!code --]
							foreach (Thing item3 in things) // [!code ++]
							{
								if (ingredient.thing == item3)
								{
```

[`@@ -189,9 +190,9 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L189-L197)
```cs:line-numbers=189
									break;
								}
							}
							if (flag2) // [!code --]
							if (flag2 && ingredient.thing == null) // [!code ++]
							{
								ingredient.SetThing(list2[0]); // [!code --]
								ingredient.SetThing(FindMax()); // [!code ++]
							}
						}
					}
```

[`@@ -200,10 +201,10 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L200-L209)
```cs:line-numbers=200
				b.onClick.RemoveAllListeners();
				b.onClick.AddListener(delegate
				{
					List<Thing> list3 = ListIngredients(ingredient, searchMode); // [!code --]
					List<Thing> list2 = ListIngredients(ingredient, searchMode); // [!code ++]
					if (ingredient.optional)
					{
						if (list3.Count == 0 || list3[0] == null) // [!code --]
						if (list2.Count == 0 || list2[0] == null) // [!code ++]
						{
							SE.Beep();
							return;
```

[`@@ -216,10 +217,28 @@ public void BuildIngredients(Recipe _recipe, Image _icon, Action _onValueChange,`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/DropdownGrid.cs#L216-L225)
```cs:line-numbers=216
					}
					if ((bool)rectDrop)
					{
						Activate(ingredient, list3); // [!code --]
						Activate(ingredient, list2); // [!code ++]
					}
				});
			}
			Thing FindMax() // [!code ++]
			{ // [!code ++]
				if (things.Count == 0) // [!code ++]
				{ // [!code ++]
					return null; // [!code ++]
				} // [!code ++]
				int num3 = 0; // [!code ++]
				Thing result = null; // [!code ++]
				foreach (Thing item4 in things) // [!code ++]
				{ // [!code ++]
					if (item4.Num > num3) // [!code ++]
					{ // [!code ++]
						num3 = item4.Num; // [!code ++]
						result = item4; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				return result; // [!code ++]
			} // [!code ++]
		},
		onRedraw = delegate(Recipe.Ingredient a, ButtonGrid b, int i)
		{
```

## Effect

[`@@ -240,6 +240,7 @@ public void Kill()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Effect.cs#L240-L245)
```cs:line-numbers=240
	TweenUtil.KillTween(ref killTimer);
	TweenUtil.KillTween(ref moveTween);
	killed = true;
	OnKill(); // [!code ++]
	manager.Remove(this);
	if (pool && manager.effects.usePool)
	{
```

[`@@ -251,6 +252,10 @@ public void Kill()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Effect.cs#L251-L256)
```cs:line-numbers=251
		}
	}

	public virtual void OnKill() // [!code ++]
	{ // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void OnDisable()
	{
		if ((bool)base.transform.parent && !test)
```

## EffectIRenderer

[`@@ -122,4 +122,12 @@ public override void OnUpdate()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/EffectIRenderer.cs#L122-L125)
```cs:line-numbers=122
			card.renderer.isSynced = false;
		}
	}
 // [!code ++]
	public override void OnKill() // [!code ++]
	{ // [!code ++]
		if (card != null && card.renderer.hasActor) // [!code ++]
		{ // [!code ++]
			card.renderer.KillActor(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
}
```

## FEAT

[`@@ -432,9 +432,17 @@ public List<string> Apply(int a, ElementContainer owner, bool hint = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/FEAT.cs#L432-L440)
```cs:line-numbers=432
		break;
	case 1644:
		featRef[0] = a.ToString() ?? "";
		if (!hint && a > 0) // [!code --]
		if (!hint) // [!code ++]
		{
			owner.Chara.AddRandomBodyPart(owner.Chara.IsPC); // [!code --]
			if (a > 0) // [!code ++]
			{ // [!code ++]
				owner.Chara.AddRandomBodyPart(owner.Chara.IsPC); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				_ = a; // [!code ++]
				_ = 0; // [!code ++]
			} // [!code ++]
			if (owner.Chara.IsPC && (bool)WidgetEquip.Instance)
			{
				WidgetEquip.Instance.Rebuild();
```

## FactionBranch

[`@@ -192,14 +192,10 @@ public void RefreshEfficiency()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/FactionBranch.cs#L192-L205)
```cs:line-numbers=192
	int ration = 0;
	foreach (Chara member in members)
	{
		if (member.memberType != 0) // [!code --]
		if (member.memberType != 0 || member.IsPCParty || member.homeBranch == null || member.homeBranch.owner == null) // [!code ++]
		{
			continue;
		}
		if (member.IsPCParty || member.homeBranch == null || member.homeBranch.owner == null) // [!code --]
		{ // [!code --]
			return; // [!code --]
		} // [!code --]
		foreach (Hobby item in member.ListHobbies())
		{
			TryAdd(item);
```

[`@@ -213,6 +209,10 @@ public void RefreshEfficiency()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/FactionBranch.cs#L213-L218)
```cs:line-numbers=213
	{
		num -= (num2 - MaxPopulation) * 20 * 100 / (100 + 20 * (int)Mathf.Sqrt(ration));
	}
	if (efficiency < 0) // [!code ++]
	{ // [!code ++]
		efficiency = 0; // [!code ++]
	} // [!code ++]
	efficiency = num;
	void TryAdd(Hobby h)
	{
```

## Game

[`@@ -859,10 +859,10 @@ public void GotoTitle(bool showDialog = true)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Game.cs#L859-L868)
```cs:line-numbers=859
	{
		Dialog.YesNo("dialog_gotoTitle", delegate
		{
			EClass.game.Save(isAutoSave: true, delegate // [!code --]
			if (EClass.game.Save(isAutoSave: true)) // [!code ++]
			{
				EClass.scene.Init(Scene.Mode.Title);
			}); // [!code --]
			} // [!code ++]
		});
	}
	else
```

[`@@ -875,40 +875,27 @@ public void Quit()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Game.cs#L875-L914)
```cs:line-numbers=875
	{
		Dialog.YesNo("dialog_quit", delegate
		{
			EClass.game.Save(isAutoSave: true, delegate // [!code --]
			if (EClass.game.Save()) // [!code ++]
			{
				EClass.core.Quit();
			}); // [!code --]
			} // [!code ++]
		});
	}

	public void Save(bool isAutoSave = false, Action onComplete = null, bool silent = false) // [!code --]
	public bool Save(bool isAutoSave = false, bool silent = false) // [!code ++]
	{
		if (EClass.ui.IsDragging)
		{
			EClass.ui.EndDrag(canceled: true);
		}
		if (!isAutoSave && !silent) // [!code --]
		{ // [!code --]
			SE.WriteJournal(); // [!code --]
		} // [!code --]
		if (isAutoSave && EClass.debug.ignoreAutoSave)
		{
			onComplete?.Invoke(); // [!code --]
			return; // [!code --]
		} // [!code --]
		int num; // [!code --]
		if (EClass.core.config.game.autoBackup) // [!code --]
		{ // [!code --]
			num = ((backupTime >= (double)(EClass.core.config.game.backupInterval * 60 * 30)) ? 1 : 0); // [!code --]
			if (num != 0) // [!code --]
			{ // [!code --]
				backupTime = 0.0; // [!code --]
			} // [!code --]
			return true; // [!code ++]
		}
		else // [!code --]
		bool flag = EClass.core.config.game.autoBackup && backupTime >= (double)(EClass.core.config.game.backupInterval * 60 * 30); // [!code ++]
		if (flag) // [!code ++]
		{
			num = 0; // [!code --]
			backupTime = 0.0; // [!code ++]
		}
		EClass.core.config.TryUpdatePlayedHour();
		countLoadedMaps = 0;
```

[`@@ -921,19 +908,34 @@ public void Save(bool isAutoSave = false, Action onComplete = null, bool silent`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Game.cs#L921-L939)
```cs:line-numbers=921
		player.angle = EClass.pc.angle;
		version = EClass.core.version;
		EClass.ui.widgets.UpdateConfigs();
		OnBeforeSave(); // [!code --]
		GameIndex index = GameIO.SaveGame(); // [!code --]
		if (num != 0) // [!code --]
		GameIndex gameIndex = null; // [!code ++]
		try // [!code ++]
		{
			GameIO.MakeBackup(index); // [!code --]
			OnBeforeSave(); // [!code ++]
			gameIndex = GameIO.SaveGame(); // [!code ++]
		} // [!code ++]
		catch (Exception ex) // [!code ++]
		{ // [!code ++]
			EClass.ui.Say(ex.Message); // [!code ++]
			SE.Beep(); // [!code ++]
			Msg.Say("error_save"); // [!code ++]
			return false; // [!code ++]
		} // [!code ++]
		if (flag) // [!code ++]
		{ // [!code ++]
			GameIO.MakeBackup(gameIndex); // [!code ++]
			EClass.ui.Say("backupDone");
		}
		if (!silent)
		{
			if (!isAutoSave) // [!code ++]
			{ // [!code ++]
				SE.WriteJournal(); // [!code ++]
			} // [!code ++]
			Msg.Say("saved");
		}
		saveCount++;
		onComplete?.Invoke(); // [!code --]
		return true; // [!code ++]
	}

	public void OnBeforeSave()
```

## HitSummary

[`@@ -55,7 +55,7 @@ public bool CanExecute()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/HitSummary.cs#L55-L61)
```cs:line-numbers=55
	{
		return true;
	}
	if (recipe != null) // [!code --]
	if (recipe != null && !recipe.UseStock) // [!code ++]
	{
		foreach (Recipe.Ingredient ingredient in recipe.ingredients)
		{
```

## Map

[`@@ -1149,7 +1149,7 @@ public void SetBlockDir(int x, int z, int dir)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Map.cs#L1149-L1155)
```cs:line-numbers=1149
public void ModFire(int x, int z, int amount)
{
	Cell cell = cells[x, z];
	if (!cell.IsTopWaterAndNoSnow && !cell.IsSnowTile) // [!code --]
	if (amount <= 0 || (!cell.IsTopWaterAndNoSnow && !cell.IsSnowTile)) // [!code ++]
	{
		if (cell.effect == null && amount > 0)
		{
```

## Party

[`@@ -95,8 +95,8 @@ public void RemoveMember(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Party.cs#L95-L102)
```cs:line-numbers=95
		if (c.homeBranch != null)
		{
			c.homeBranch.RefreshEfficiency();
			c.RefreshWorkElements(c.homeBranch.elements); // [!code ++]
		}
		c.RefreshWorkElements(); // [!code --]
		WidgetRoster.SetDirty();
	}

```

## Props

[`@@ -214,7 +214,7 @@ public ThingStack ListThingStack(Recipe.Ingredient ing, StockSearchMode searchMo`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Props.cs#L214-L220)
```cs:line-numbers=214
		{
			FindCat(item);
		}
		stack.list.Sort((Thing a, Thing b) => b.Num - a.Num); // [!code --]
		stack.list.Sort(UIList.SortMode.ByCategory); // [!code ++]
		return stack;
	}
	Find(id2);
```

[`@@ -222,7 +222,7 @@ public ThingStack ListThingStack(Recipe.Ingredient ing, StockSearchMode searchMo`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Props.cs#L222-L228)
```cs:line-numbers=222
	{
		Find(item2);
	}
	stack.list.Sort((Thing a, Thing b) => b.Num - a.Num); // [!code --]
	stack.list.Sort(UIList.SortMode.ByCategory); // [!code ++]
	return stack;
	void Find(string id)
	{
```

## Recipe

[`@@ -857,14 +857,24 @@ public bool IsCraftable()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/Recipe.cs#L857-L870)
```cs:line-numbers=857
{
	foreach (Ingredient ingredient in ingredients)
	{
		if (!ingredient.optional) // [!code --]
		if (ingredient.optional) // [!code ++]
		{
			ThingStack thingStack = EClass._map.Stocked.ListThingStack(ingredient, StockSearchMode.AroundPC); // [!code --]
			if (thingStack.list.Count == 0 || thingStack.list[0].Num < ingredient.req) // [!code --]
			continue; // [!code ++]
		} // [!code ++]
		ThingStack thingStack = EClass._map.Stocked.ListThingStack(ingredient, StockSearchMode.AroundPC); // [!code ++]
		bool flag = false; // [!code ++]
		foreach (Thing item in thingStack.list) // [!code ++]
		{ // [!code ++]
			if (item.Num >= ingredient.req) // [!code ++]
			{
				return false; // [!code --]
				flag = true; // [!code ++]
				break; // [!code ++]
			}
		}
		if (!flag) // [!code ++]
		{ // [!code ++]
			return false; // [!code ++]
		} // [!code ++]
	}
	return true;
}
```

## RenderRow

[`@@ -63,6 +63,8 @@ public class RenderRow : SourceData.BaseRow, IRenderSource`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/RenderRow.cs#L63-L68)
```cs:line-numbers=63

	public bool multisize;

	public bool fixedMaterial; // [!code ++]
 // [!code ++]
	public SourcePref pref;

	[NonSerialized]
```

[`@@ -80,9 +82,6 @@ public class RenderRow : SourceData.BaseRow, IRenderSource`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/RenderRow.cs#L80-L88)
```cs:line-numbers=80
	[NonSerialized]
	public bool useRandomColor;

	[NonSerialized] // [!code --]
	public bool fixedMaterial; // [!code --]
 // [!code --]
	[NonSerialized]
	public SourceMaterial.Row DefaultMaterial;

```

[`@@ -156,6 +155,15 @@ public override void OnImportData(SourceData data)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/RenderRow.cs#L156-L161)
```cs:line-numbers=156
		base.OnImportData(data);
		_tiles = new int[0];
		SetTiles();
		if (defMat.Length > 0 && defMat[0] == '!') // [!code ++]
		{ // [!code ++]
			fixedMaterial = true; // [!code ++]
			defMat = defMat.Substring(1, defMat.Length - 1); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			fixedMaterial = false; // [!code ++]
		} // [!code ++]
	}

	public void SetRenderData()
```

[`@@ -230,19 +238,6 @@ public void SetRenderData()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/RenderRow.cs#L230-L248)
```cs:line-numbers=230
		{
			useAltColor = true;
		}
		if (defMat[0] == '!') // [!code --]
		{ // [!code --]
			fixedMaterial = true; // [!code --]
			defMat = defMat.Substring(1, defMat.Length - 1); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			fixedMaterial = false; // [!code --]
		} // [!code --]
		if (!sources.materials.alias.ContainsKey(defMat)) // [!code --]
		{ // [!code --]
			Debug.Log(defMat); // [!code --]
		} // [!code --]
		DefaultMaterial = sources.materials.alias[defMat];
	}

```

## SpawnSetting

[`@@ -56,6 +56,19 @@ public static SpawnSetting Boss(int filterLv, int fixedLv = -1)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/SpawnSetting.cs#L56-L61)
```cs:line-numbers=56
		};
	}

	public static SpawnSetting Boss(string id, string idEle = null, int fixedLv = -1) // [!code ++]
	{ // [!code ++]
		return new SpawnSetting // [!code ++]
		{ // [!code ++]
			id = id, // [!code ++]
			idEle = idEle, // [!code ++]
			fixedLv = fixedLv, // [!code ++]
			rarity = Rarity.Legendary, // [!code ++]
			isBoss = true, // [!code ++]
			tries = 10000 // [!code ++]
		}; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public static SpawnSetting Encounter(int lv)
	{
		return new SpawnSetting
```

## TCExtra

[`@@ -81,7 +81,13 @@ public override void OnDraw(ref Vector3 pos)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TCExtra.cs#L81-L87)
```cs:line-numbers=81
		flag4 = !flag4;
	}
	bool flag5 = useOffsetBack && data.useOffsetBack && flag;
	if (dirPos.Length == 0) // [!code --]
	if (base.owner.renderer.hasActor) // [!code ++]
	{ // [!code ++]
		v.x = base.owner.renderer.position.x + (flag5 ? data.offsetBack.x : data.offset.x); // [!code ++]
		v.y = base.owner.renderer.position.y + (flag5 ? data.offsetBack.y : data.offset.y); // [!code ++]
		v.z = base.owner.renderer.position.z + (flag5 ? data.offsetBack.z : data.offset.z) + FixPos.z + (flag2 ? (-0.5f) : 0f) + ((!flag2) ? 0f : (flag3 ? heldPosFlip.z : heldPos.z)); // [!code ++]
	} // [!code ++]
	else if (dirPos.Length == 0) // [!code ++]
	{
		v.x = base.owner.renderer.position.x + (flag5 ? data.offsetBack.x : data.offset.x) * (float)((!flag4) ? 1 : (-1)) + FixPos.x + flipFixX * (float)((!flag4) ? 1 : (-1)) + ((!flag2) ? 0f : (flag3 ? heldPosFlip.x : heldPos.x));
		v.y = base.owner.renderer.position.y + (flag5 ? data.offsetBack.y : data.offset.y) + FixPos.y + ((!flag2) ? 0f : (flag3 ? heldPosFlip.y : heldPos.y));
```

## TaskBuild

[`@@ -353,14 +353,20 @@ public override void OnProgressComplete()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TaskBuild.cs#L353-L366)
```cs:line-numbers=353
				_ = (item.trait as TraitNewZone).IsDownstairs;
			}
		}
		if (!pos.IsBlocked || !pos.HasChara) // [!code --]
		if (ActionMode.Build.IsActive && ActionMode.Build.IsRoofEditMode()) // [!code ++]
		{
			return;
		}
		foreach (Chara item2 in pos.ListCharas()) // [!code --]
		pos.ForeachMultiSize(recipe.W, recipe.H, delegate(Point p, bool center) // [!code ++]
		{
			EClass.pc.Kick(item2, ignoreSelf: true, karmaLoss: false, show: false); // [!code --]
		} // [!code --]
			if (p.IsBlocked && p.HasChara) // [!code ++]
			{ // [!code ++]
				foreach (Chara item2 in p.ListCharas()) // [!code ++]
				{ // [!code ++]
					EClass.pc.Kick(item2, ignoreSelf: true, karmaLoss: false, show: false); // [!code ++]
				} // [!code ++]
			} // [!code ++]
		}); // [!code ++]
	}

	public override void OnDestroy()
```

## TaskHarvest

[`@@ -491,6 +491,11 @@ public void HarvestThing()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TaskHarvest.cs#L491-L496)
```cs:line-numbers=491
	{
		num2 = 2.1999998f;
	}
	string text2 = target.id; // [!code ++]
	if (text2 == "glass" || text2 == "brick") // [!code ++]
	{ // [!code ++]
		num2 = 2.1999998f; // [!code ++]
	} // [!code ++]
	if (target.trait is TraitAmmo)
	{
		num2 = 50f;
```

## TraitBinocular

[`@@ -3,4 +3,6 @@ public class TraitBinocular : TraitViewMap`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TraitBinocular.cs#L3-L6)
```cs:line-numbers=3
	public override bool IsTool => true;

	public override bool ShowAsTool => true;
 // [!code ++]
	public override bool CanUseInUserZone => true; // [!code ++]
}
```

## TraitFoodEggFertilized

[`@@ -1,3 +1,5 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TraitFoodEggFertilized.cs#L1-L3)
```cs:line-numbers=1
using UnityEngine; // [!code ++]
 // [!code ++]
public class TraitFoodEggFertilized : TraitFoodEgg
{
	public override int DecaySpeed => 1;
```

[`@@ -25,6 +27,15 @@ public static Chara Incubate(Thing egg, Point pos, Card incubator = null)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/TraitFoodEggFertilized.cs#L25-L30)
```cs:line-numbers=25
	chara.SetMainElement(egg.c_idMainElement, 10, elemental: true);
	chara.SetFeat(1232, (incubator != null) ? 3 : 2, msg: true);
	chara.things.DestroyAll();
	if (chara.Evalue(1644) > 0) // [!code ++]
	{ // [!code ++]
		for (int i = 0; i < chara.Evalue(1644); i++) // [!code ++]
		{ // [!code ++]
			chara.RemoveLastBodyPart(); // [!code ++]
			Debug.Log(i + "/" + chara.body.slots.Count); // [!code ++]
		} // [!code ++]
		chara.elements.SetBase(1644, 0); // [!code ++]
	} // [!code ++]
	foreach (Element value in chara.elements.dict.Values)
	{
		if ((!(value.source.category != "attribute") || !(value.source.category != "skill")) && (!(value.source.category == "attribute") || value.source.tag.Contains("primary")) && value.ValueWithoutLink != 0)
```

## UIDragGridIngredients

[`@@ -55,11 +55,10 @@ public void Refresh()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/UIDragGridIngredients.cs#L55-L65)
```cs:line-numbers=55
				if (windowSaveData == null || !windowSaveData.excludeCraft)
				{
					list.Add(thing);
					thing.SetSortVal(UIList.SortMode.ByCategory); // [!code --]
				}
			}
		}
		list.Sort((Thing a, Thing b) => b.sortVal - a.sortVal); // [!code --]
		list.Sort(UIList.SortMode.ByCategory); // [!code ++]
	}
	this.list.callbacks = new UIList.Callback<Thing, ButtonGrid>
	{
```

## UIHomeInfo

[`@@ -410,7 +410,8 @@ public void RefreshReport()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/UIHomeInfo.cs#L410-L416)
```cs:line-numbers=410
	});
	if (EMono.debug.showExtra)
	{
		AddReport("efficiency:" + branch.efficiency); // [!code --]
		branch.RefreshEfficiency(); // [!code ++]
		AddReport("Efficiency:" + branch.efficiency); // [!code ++]
	}
	reports.Sort((ReportData a, ReportData b) => b.type - a.type);
	listReport.Clear();
```

## UIInventory

[`@@ -1007,7 +1007,7 @@ public Transform ShowAdvDistribution(UIContextMenu dis, Window.SaveData data)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/UIInventory.cs#L1007-L1013)
```cs:line-numbers=1007

	public void Sort(bool redraw = true)
	{
		UIList.SortMode i = (IsShop ? EMono.player.pref.sortInvShop : (IsAdvSort ? window.saveData.sortMode : EMono.player.pref.sortInv)); // [!code --]
		UIList.SortMode m = (IsShop ? EMono.player.pref.sortInvShop : (IsAdvSort ? window.saveData.sortMode : EMono.player.pref.sortInv)); // [!code ++]
		bool flag = true;
		while (flag)
		{
```

[`@@ -1040,26 +1040,9 @@ public void Sort(bool redraw = true)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/UIInventory.cs#L1040-L1065)
```cs:line-numbers=1040
			thing3.invY = 0;
			thing3.invX = -1;
		}
		thing3.SetSortVal(i, owner.currency); // [!code --]
		num++;
	}
	owner.Container.things.Sort(delegate(Thing a, Thing b) // [!code --]
	{ // [!code --]
		bool flag2 = (IsShop ? EMono.player.pref.sort_ascending_shop : (IsAdvSort ? window.saveData.sort_ascending : EMono.player.pref.sort_ascending)); // [!code --]
		if (i == UIList.SortMode.ByName) // [!code --]
		{ // [!code --]
			if (flag2) // [!code --]
			{ // [!code --]
				return string.Compare(a.GetName(NameStyle.FullNoArticle, 1), b.GetName(NameStyle.FullNoArticle, 1)); // [!code --]
			} // [!code --]
			return string.Compare(b.GetName(NameStyle.FullNoArticle, 1), a.GetName(NameStyle.FullNoArticle, 1)); // [!code --]
		} // [!code --]
		if (a.sortVal == b.sortVal) // [!code --]
		{ // [!code --]
			return b.SecondaryCompare(i, a); // [!code --]
		} // [!code --]
		return (!flag2) ? (a.sortVal - b.sortVal) : (b.sortVal - a.sortVal); // [!code --]
	}); // [!code --]
	owner.Container.things.Sort(m, IsShop ? EMono.player.pref.sort_ascending_shop : (IsAdvSort ? window.saveData.sort_ascending : EMono.player.pref.sort_ascending)); // [!code ++]
	if (!UseGrid)
	{
		int num2 = 0;
```

## WidgetStatsBar

[`@@ -191,9 +191,9 @@ public void Build()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/WidgetStatsBar.cs#L191-L199)
```cs:line-numbers=191
		Add(null, "fertility", iconFertility, delegate
		{
			object obj;
			if (EMono.Branch != null) // [!code --]
			if (EMono.Branch != null || EMono._zone is Zone_Tent) // [!code ++]
			{
				obj = (EMono.Branch.MaxSoil - EMono._zone.GetSoilCost()).ToString(); // [!code --]
				obj = (EMono._zone.MaxSoil - EMono._zone.GetSoilCost()).ToString(); // [!code ++]
				if (obj == null)
				{
					return "";
```

[`@@ -204,7 +204,7 @@ public void Build()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/7eeb80563246b83a9ffc99b8c6010f02499a47b3/Elin/WidgetStatsBar.cs#L204-L210)
```cs:line-numbers=204
				obj = "";
			}
			return (string)obj;
		}, () => (EMono.Branch == null || EMono.Branch.MaxSoil - EMono._zone.GetSoilCost() >= 0) ? FontColor.Default : FontColor.Bad, () => EMono._zone.IsPCFaction); // [!code --]
		}, () => ((EMono.Branch == null && !(EMono._zone is Zone_Tent)) || EMono._zone.MaxSoil - EMono._zone.GetSoilCost() >= 0) ? FontColor.Default : FontColor.Bad, () => EMono._zone.IsPCFaction || EMono._zone is Zone_Tent); // [!code ++]
	}
	if (extra.weight)
	{
```
