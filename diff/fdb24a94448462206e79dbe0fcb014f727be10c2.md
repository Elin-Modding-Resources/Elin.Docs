---
exclude: true
aside: false
footer: false
editLink: false
lastUpdated: false
description: 42 files modified. 1 new file created.
version: EA 23.63 Nightly
changes: AI_Idle/ActEffect/ActThrow/BaseGameScreen/BodySlot/CSTR/Card/Chara/CharaBody/ConSuffocation/Core/CoreConfig/CoreDebug/FortuneRollData/HomeResourceWorth/HotItemHeld/LayerConfig/LayerEditPortrait/LayerMod/LayerTitle/LayerUploader/ModManager/Player/Point/Portrait/Recipe/RecipeCard/Scene/SerializedCards/SourceMaterial/+TaskChopWoord/TaskWater/Thing/ThingContainer/TraitAdventurer/TraitChara/TraitCrafter/TraitGiftJure/TraitKettle/TraitMoongate/TraitMoongateEx/TraitRollingFortune/WidgetSearch/Zone
---

# EA 23.63 Nightly

December 22, 2024

42 files modified. 1 new file created.

## Breaking changes

Click the file name to view the chunk.
### [ModManager (1)](#modmanager)
```cs:no-line-numbers
public IniData GetElinIni() // [!code --]

```
### [Point (1)](#point)
```cs:no-line-numbers
public void ModFire(int value) // [!code --]
public void ModFire(int value, bool extinguish = false) // [!code ++]
```
### [Portrait (1)](#portrait)
```cs:no-line-numbers
public void SetPortrait(string id, Color colorOverlay = default(Color)) // [!code --]
public void SetPortrait(string id, Color colorOverlay = default(Color), bool applyColorMod = true) // [!code ++]
```
### [SourceMaterial (1)](#sourcematerial)
```cs:no-line-numbers
public void PlayHitEffect(Point p) // [!code --]
public void PlayHitEffect(Point p, int emit = 2) // [!code ++]
```
## AI_Idle

[`@@ -105,7 +105,7 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/AI_Idle.cs#L105)
```cs:line-numbers=105
				}
			}
		}
		if (EClass.rnd(3) == 0 && owner.mana.value > 0) // [!code --]
		if (EClass.rnd(3) == 0 && owner.mana.value > 0 && !EClass._zone.IsRegion) // [!code ++]
		{
			Act act = null;
			Act actRevive = null;
```

## ActEffect

[`@@ -361,7 +361,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ActEffect.cs#L361)
```cs:line-numbers=361
		}
		if (e.id == 911)
		{
			p.ModFire(-20); // [!code --]
			p.ModFire(-20, extinguish: true); // [!code ++]
		}
	}
	if (RapidCount == 0)
```

## ActThrow

[`@@ -162,7 +162,7 @@ public static EffectIRenderer Throw(Card c, Point p, Card target, Thing t, Throw`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ActThrow.cs#L162)
```cs:line-numbers=162
		{
			Act.TC.Say("throw_hit", t, Act.TC);
		}
		Act.TP.ModFire(-50); // [!code --]
		Act.TP.ModFire(-50, extinguish: true); // [!code ++]
		if (Act.TC != null && Act.TC.isChara)
		{
			if (t.trait.CanDrink(Act.TC.Chara))
```

## BaseGameScreen

[`@@ -531,6 +531,14 @@ public void RefreshAll()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/BaseGameScreen.cs#L531)
```cs:line-numbers=531
	{
		grading.material.EnableKeyword("CLOUD_ON");
	}
	if (EMono.core.config.graphic.floorEx) // [!code ++]
	{ // [!code ++]
		EMono.scene.matFloorEx.EnableKeyword("EX_ON"); // [!code ++]
	} // [!code ++]
	else // [!code ++]
	{ // [!code ++]
		EMono.scene.matFloorEx.DisableKeyword("EX_ON"); // [!code ++]
	} // [!code ++]
	grading.profile.vignette.enable = EMono.scene.profile.light.vignette;
	grading.profile.vignette.vignetteColor = EMono.scene.profile.light.vignetteColor;
	RefreshSky();
```

## BodySlot

[`@@ -9,7 +9,7 @@ public class BodySlot : EClass`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/BodySlot.cs#L9)
```cs:line-numbers=9

	public int index;

	public int indexHnd; // [!code --]
	public int indexPart; // [!code ++]

	public string name => EClass.sources.elements.map[elementId].GetText();

```

## CSTR

[`@@ -22,6 +22,8 @@ public class CSTR`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CSTR.cs#L22)
```cs:line-numbers=22

	public const int idCat = 11;

	public const int extraNameRef = 12; // [!code ++]
 // [!code ++]
	public const int context = 20;

	public const int idTalk = 21;
```

## Card

[`@@ -1477,6 +1477,18 @@ public string c_altName2`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Card.cs#L1477)
```cs:line-numbers=1477
		}
	}

	public string c_extraNameRef // [!code ++]
	{ // [!code ++]
		get // [!code ++]
		{ // [!code ++]
			return GetStr(12); // [!code ++]
		} // [!code ++]
		set // [!code ++]
		{ // [!code ++]
			SetStr(12, value); // [!code ++]
		} // [!code ++]
	} // [!code ++]
 // [!code ++]
	public string c_refText
	{
		get
```

[`@@ -4844,6 +4856,7 @@ public void MakeRefFrom(Card c1, Card c2 = null)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Card.cs#L4844)
```cs:line-numbers=4844
			c_idRefCard2 = c2.id;
			c_altName2 = (c2.IsPC ? c2.c_altName : c2.GetName(NameStyle.Ref, (!c2.isChara) ? 1 : 0));
		}
		c_extraNameRef = (c1.IsPC ? EClass.pc.c_altName : c1.c_extraNameRef); // [!code ++]
	}

	public void SetHidden(bool hide = true)
```

[`@@ -5124,6 +5137,16 @@ public void PlaySoundDrop(bool spatial = true)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Card.cs#L5124)
```cs:line-numbers=5124
		PlaySound(material.GetSoundDrop(sourceCard), 1f, spatial);
	}

	public void PlaySoundImpact(bool spatial = true) // [!code ++]
	{ // [!code ++]
		PlaySound(material.GetSoundImpact(sourceCard), 1f, spatial); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void PlaySoundDead(bool spatial = true) // [!code ++]
	{ // [!code ++]
		PlaySound(material.GetSoundDead(sourceCard), 1f, spatial); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public SoundSource PlaySound(string id, float v = 1f, bool spatial = true)
	{
		if (IsPC)
```

[`@@ -6561,6 +6584,11 @@ public void SetDeconstruct(bool deconstruct)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Card.cs#L6561)
```cs:line-numbers=6561
		}
	}

	public virtual bool MatchEncSearch(string s) // [!code ++]
	{ // [!code ++]
		return false; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public virtual void SetSortVal(UIList.SortMode m, CurrencyType currency = CurrencyType.Money)
	{
		switch (m)
```

## Chara

[`@@ -940,7 +940,7 @@ void Build(Hobby h)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Chara.cs#L940)
```cs:line-numbers=940

	public Stats sleepiness => Stats.Sleepiness.Set(_cints, 17, this);

	public Stats SAN => Stats.SAN.Set(_cints, 17, this); // [!code --]
	public Stats SAN => Stats.SAN.Set(_cints, 18, this); // [!code ++]

	public bool CanGainConResist
	{
```

[`@@ -1689,7 +1689,7 @@ public void RefreshSpeed(Element.BonusInfo info = null)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Chara.cs#L1689)
```cs:line-numbers=1689
			info?.AddFix(EClass.player.lastEmptyAlly * 10 - 10, "exceedParty".lang());
		}
	}
	else if (base.LV >= 1000) // [!code --]
	else if (base.LV >= 1000 && currentZone is Zone_Void) // [!code ++]
	{
		num += EClass.curve((base.LV - 900) / 100 * 10, 500, 100);
		info?.AddFix(EClass.curve((base.LV - 900) / 100 * 10, 500, 100), "enemySpeedBuff".lang());
```

[`@@ -8065,6 +8065,7 @@ public void InitStats(bool onDeserialize = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Chara.cs#L8065)
```cs:line-numbers=8065
		_cints[14] = 70;
		_cints[15] = 70;
		_cints[17] = 0;
		_cints[18] = 0; // [!code ++]
	}
	foreach (Condition condition in conditions)
	{
```

[`@@ -8487,7 +8488,10 @@ public void OnSleep(Thing bed = null, int days = 1)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Chara.cs#L8487)
```cs:line-numbers=8487
		{
			num += traitPillow.owner.Power / 2;
		}
		num += Evalue(750) * 5; // [!code --]
		if (bed != null) // [!code ++]
		{ // [!code ++]
			num += bed.Evalue(750) * 5; // [!code ++]
		} // [!code ++]
		OnSleep(num, days);
	}

```

[`@@ -8832,7 +8836,7 @@ public void RefreshFaithElement()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Chara.cs#L8832)
```cs:line-numbers=8832
			int num2 = array[i + 1] * num / 50;
			if (array[i] == 79)
			{
				num2 = EClass.curve(num2, 100, 20, 60); // [!code --]
				num2 = EClass.curve(num2, array[i + 1] * 2, 10, 50); // [!code ++]
			}
			if (num2 >= 20 && array[i] >= 950 && array[i] < 970)
			{
```

## CharaBody

[`@@ -464,12 +464,7 @@ public int GetAttackStyleElement(AttackStyle style)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CharaBody.cs#L464)
```cs:line-numbers=464

	public int GetSortVal(BodySlot slot)
	{
		int num = slot.element.sort * 10; // [!code --]
		if (slot.elementId == 35) // [!code --]
		{ // [!code --]
			num += owner.body.slots.IndexOf(slot); // [!code --]
		} // [!code --]
		return -num; // [!code --]
		return -(slot.element.sort * 100 + owner.body.slots.IndexOf(slot)); // [!code ++]
	}

	public void SetBodyIndexText(BodySlot b, UIText t)
```

[`@@ -478,25 +473,25 @@ public void SetBodyIndexText(BodySlot b, UIText t)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CharaBody.cs#L478)
```cs:line-numbers=478
	{
		return;
	}
	if (b.elementId == 35) // [!code --]
	if (b.indexPart == 0) // [!code ++]
	{
		if (b.indexHnd == 0) // [!code --]
		int num = 0; // [!code ++]
		foreach (BodySlot slot in slots) // [!code ++]
		{
			int num = 0; // [!code --]
			foreach (BodySlot slot in slots) // [!code --]
			if (slot.elementId == b.element.id) // [!code ++]
			{
				if (slot.elementId == 35) // [!code --]
				{ // [!code --]
					num++; // [!code --]
				} // [!code --]
				if (b == slot) // [!code --]
				{ // [!code --]
					break; // [!code --]
				} // [!code --]
				num++; // [!code ++]
			} // [!code ++]
			if (b == slot) // [!code ++]
			{ // [!code ++]
				break; // [!code ++]
			}
			b.indexHnd = num; // [!code --]
		}
		t.SetText(b.indexHnd.ToString() ?? ""); // [!code --]
		b.indexPart = num; // [!code ++]
	} // [!code ++]
	if (b.elementId == 35) // [!code ++]
	{ // [!code ++]
		t.SetText(b.indexPart.ToString() ?? ""); // [!code ++]
		t.SetActive(enable: true);
	}
	else
```

## ConSuffocation

[`@@ -40,13 +40,13 @@ public override void Tick()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ConSuffocation.cs#L40)
```cs:line-numbers=40
	}
	if (base.value >= 100 && !EClass._zone.IsRegion)
	{
		owner.DamageHP(10 + owner.MaxHP / 20, AttackSource.Condition); // [!code --]
		owner.DamageHP((base.value - 100) / 10 + owner.MaxHP / 20, AttackSource.Condition); // [!code ++]
	}
	if (owner != null && owner.IsAliveInCurrentZone)
	{
		if (!owner.Cell.CanSuffocate())
		{
			Mod(-20); // [!code --]
			Mod(-25); // [!code ++]
		}
		else if (!EClass._zone.IsRegion)
		{
```

## Core

[`@@ -1,7 +1,11 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Core.cs#L1)
```cs:line-numbers=1
using System;
using System.Collections;
using System.Collections.Generic;
using System.IO; // [!code ++]
using System.Text; // [!code ++]
using DG.Tweening;
using IniParser; // [!code ++]
using IniParser.Model; // [!code ++]
using ReflexCLI;
using Steamworks;
using UnityEngine;
```

[`@@ -738,4 +742,98 @@ public void ApplySkins()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Core.cs#L738)
```cs:line-numbers=738
			componentsInChildren[i].ApplySkin();
		}
	}
 // [!code ++]
	public static IniData GetElinIni() // [!code ++]
	{ // [!code ++]
		string pathIni = CorePath.PathIni; // [!code ++]
		try // [!code ++]
		{ // [!code ++]
			string ie = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; // [!code ++]
			FileIniDataParser fileIniDataParser = new FileIniDataParser(); // [!code ++]
			if (!File.Exists(pathIni)) // [!code ++]
			{ // [!code ++]
				File.CreateText(pathIni).Close(); // [!code ++]
			} // [!code ++]
			IniData iniData = fileIniDataParser.ReadFile(pathIni, Encoding.UTF8); // [!code ++]
			if (iniData.GetKey("pass").IsEmpty()) // [!code ++]
			{ // [!code ++]
				string text = ""; // [!code ++]
				for (int i = 0; i < 4; i++) // [!code ++]
				{ // [!code ++]
					text += ie.RandomItem(); // [!code ++]
				} // [!code ++]
				iniData.Global["pass"] = text; // [!code ++]
				fileIniDataParser.WriteFile(pathIni, iniData); // [!code ++]
			} // [!code ++]
			return iniData; // [!code ++]
		} // [!code ++]
		catch (Exception message) // [!code ++]
		{ // [!code ++]
			Debug.Log(message); // [!code ++]
			Debug.Log("exception: Failed to parse:" + pathIni); // [!code ++]
			return null; // [!code ++]
		} // [!code ++]
	} // [!code ++]
 // [!code ++]
	public static void SaveElinIni(IniData ini) // [!code ++]
	{ // [!code ++]
		new FileIniDataParser().WriteFile(CorePath.PathIni, ini); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public static void TryWarnMod(Action action, bool warn = true) // [!code ++]
	{ // [!code ++]
		if (warn) // [!code ++]
		{ // [!code ++]
			IniData ini = GetElinIni(); // [!code ++]
			if (ini.Global["agreed_usercontens_usage_terms"] != "yes") // [!code ++]
			{ // [!code ++]
				string[] items = new string[3] { "readTerms", "agree", "disagree" }; // [!code ++]
				Dialog.List("dialogTermsOfUseUGC".lang(), items, (string j) => j, delegate(int c, string d) // [!code ++]
				{ // [!code ++]
					switch (c) // [!code ++]
					{ // [!code ++]
					case 0: // [!code ++]
						LayerHelp.Toggle("custom", "terms2"); // [!code ++]
						return false; // [!code ++]
					case 1: // [!code ++]
						ini.Global["agreed_usercontens_usage_terms"] = "yes"; // [!code ++]
						SaveElinIni(ini); // [!code ++]
						action(); // [!code ++]
						break; // [!code ++]
					} // [!code ++]
					return true; // [!code ++]
				}, canCancel: true); // [!code ++]
				return; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		action(); // [!code ++]
	} // [!code ++]
 // [!code ++]
	public static void TryWarnUpload(Action action) // [!code ++]
	{ // [!code ++]
		IniData ini = GetElinIni(); // [!code ++]
		if (ini.Global["agreed_usercontents_upload_terms"] != "yes") // [!code ++]
		{ // [!code ++]
			string[] items = new string[3] { "readTerms", "agree", "disagree" }; // [!code ++]
			Dialog.List("dialogTermsOfUse".lang(), items, (string j) => j, delegate(int c, string d) // [!code ++]
			{ // [!code ++]
				switch (c) // [!code ++]
				{ // [!code ++]
				case 0: // [!code ++]
					LayerHelp.Toggle("custom", "terms"); // [!code ++]
					return false; // [!code ++]
				case 1: // [!code ++]
					ini.Global["agreed_usercontents_upload_terms"] = "yes"; // [!code ++]
					SaveElinIni(ini); // [!code ++]
					action(); // [!code ++]
					break; // [!code ++]
				} // [!code ++]
				return true; // [!code ++]
			}, canCancel: true); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			action(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
}
```

## CoreConfig

[`@@ -286,6 +286,8 @@ public class GraphicSetting`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CoreConfig.cs#L286)
```cs:line-numbers=286

		public bool fixedResolution;

		public bool floorEx; // [!code ++]
 // [!code ++]
		public bool cloud;

		public bool firefly;
```

[`@@ -658,6 +660,10 @@ public static CoreConfig TryLoadConfig()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CoreConfig.cs#L658)
```cs:line-numbers=658
		coreConfig.game.backupInterval = 8;
		coreConfig.game.autoBackup = true;
	}
	if (coreConfig.version.IsBelow(0, 23, 63)) // [!code ++]
	{ // [!code ++]
		coreConfig.graphic.floorEx = true; // [!code ++]
	} // [!code ++]
	if (coreConfig.version.IsBelow(0, 22, 17))
	{
		coreConfig.game.tutorial = true;
```

## CoreDebug

[`@@ -905,8 +905,8 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CoreDebug.cs#L905)
```cs:line-numbers=905
	}
	if (Input.GetKeyDown(KeyCode.F2))
	{
		EClass._zone.TryGenerateEvolved(force: true); // [!code --]
		EClass._zone.SpawnMob(null, SpawnSetting.Boss(100)); // [!code --]
		EClass.pc.Pick(EClass.pc.MakeMilk(effect: true, 10)); // [!code ++]
		EClass.pc.Pick(EClass.pc.MakeEgg(effect: true, 10)); // [!code ++]
		Chara targetChara = EClass.scene.mouseTarget.TargetChara;
		if (targetChara != null)
		{
```

[`@@ -915,17 +915,6 @@ public void UpdateInput()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/CoreDebug.cs#L915)
```cs:line-numbers=915
			EClass.pc.Pick(targetChara.MakeBraineCell());
			EClass.pc.Pick(targetChara.MakeEgg(effect: true, 10));
		}
		if (EClass.game.quests.Get<QuestDebt>() == null) // [!code --]
		{ // [!code --]
			Chara chara = CharaGen.Create("loytel"); // [!code --]
			EClass._zone.AddCard(chara, EClass.pc.pos); // [!code --]
			chara.SetGlobal(); // [!code --]
			Quest q = EClass.game.quests.Add("debt", "loytel"); // [!code --]
			EClass.game.quests.Start(q); // [!code --]
			EClass.pc.party.RemoveMember(chara); // [!code --]
			Hostility hostility2 = (chara.c_originalHostility = Hostility.Ally); // [!code --]
			chara.hostility = hostility2; // [!code --]
		} // [!code --]
		return;
	}
	if (Input.GetKeyDown(KeyCode.F3))
```

## FortuneRollData

[`@@ -13,6 +13,9 @@ public class Prize : EClass`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L13)
```cs:line-numbers=13
		[JsonProperty]
		public string id;

		[JsonProperty] // [!code ++]
		public string idRef; // [!code ++]
 // [!code ++]
		[JsonProperty]
		public bool claimed;

```

[`@@ -20,6 +23,10 @@ public class Prize : EClass`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L20)
```cs:line-numbers=20

		public int GetNum()
		{
			if (id == "ration") // [!code ++]
			{ // [!code ++]
				return 10; // [!code ++]
			} // [!code ++]
			if (id == "medal")
			{
				if (grade != 2)
```

[`@@ -58,7 +65,20 @@ public int GetNum()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L58)
```cs:line-numbers=58
	public void AddNote(UINote n)
	{
		string text = "_circle".lang().TagColor(EClass.sources.materials.alias[mats[grade]].GetColor()) + "  " + Lang.GetList("fortuneroll")[grade];
		string text2 = (model.IsUnique ? "★" : "") + EClass.sources.cards.map[id].GetName().ToTitleCase(); // [!code --]
		string text2 = (model.IsUnique ? "★" : "") + EClass.sources.cards.map[id].GetName(); // [!code ++]
		string text3 = id; // [!code ++]
		if (!(text3 == "panty")) // [!code ++]
		{ // [!code ++]
			if (text3 == "mathammer") // [!code ++]
			{ // [!code ++]
				text2 = "_of".lang(EClass.sources.materials.alias[idRef].GetName(), text2); // [!code ++]
			} // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			string name = EClass.sources.cards.map[idRef].GetName(); // [!code ++]
			text2 = "_of".lang(name, text2); // [!code ++]
		} // [!code ++]
		int num = GetNum();
		if (num > 1)
		{
```

[`@@ -68,13 +88,13 @@ public void AddNote(UINote n)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L68)
```cs:line-numbers=68
			{
				text2 = "fortuneroll_claimed".lang();
			}
			n.AddTopic("TopicDomain", text, text2.TagColor(model.IsUnique ? FontColor.Great : FontColor.Good)); // [!code --]
			n.AddTopic("TopicDomain", text, text2.ToTitleCase().TagColor(model.IsUnique ? FontColor.Great : FontColor.Good)); // [!code ++]
		}
	}

	public static string[] mats = new string[4] { "plastic", "water", "hide_dragon", "gold" };

	public static int[] chances = new int[4] { 1, 10, 20, 50 }; // [!code --]
	public static int[] chances = new int[4] { 1, 8, 25, 60 }; // [!code ++]

	[JsonProperty]
	public List<Prize> prizes = new List<Prize>();
```

[`@@ -108,23 +128,40 @@ public void RefreshPrize()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L108)
```cs:line-numbers=108
	prizes.Clear();
	Rand.SetSeed(EClass.game.seed + seed + count);
	List<List<string>> list = GetPrizeList();
	Add(3); // [!code --]
	Add(2); // [!code --]
	Add(2); // [!code --]
	Add(1); // [!code --]
	Add(1); // [!code --]
	Add(1); // [!code --]
	if (EClass._zone.IsTown && EClass._zone.lv == 0) // [!code ++]
	{ // [!code ++]
		Add(3); // [!code ++]
		Add(2); // [!code ++]
		Add(2); // [!code ++]
		Add(1); // [!code ++]
		Add(1); // [!code ++]
		Add(1); // [!code ++]
	} // [!code ++]
	Rand.SetSeed();
	void Add(int grade)
	{
		List<string> list2 = list[grade];
		int index = EClass.rnd(list2.Count);
		Prize item = new Prize // [!code --]
		Prize prize = new Prize // [!code ++]
		{
			id = list2[index],
			grade = grade
		};
		prizes.Add(item); // [!code --]
		string id = prize.id; // [!code ++]
		if (!(id == "panty")) // [!code ++]
		{ // [!code ++]
			if (id == "mathammer") // [!code ++]
			{ // [!code ++]
				SourceMaterial.Row randomMaterial = MATERIAL.GetRandomMaterial(20); // [!code ++]
				prize.idRef = randomMaterial.alias; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			IEnumerable<SourceChara.Row> ie = EClass.sources.charas.map.Values.Where((SourceChara.Row r) => (r.model.trait as TraitChara).IsWearingPanty && !r.HasTag(CTAG.noRandomProduct)); // [!code ++]
			prize.idRef = ie.RandomItem().id; // [!code ++]
		} // [!code ++]
		prizes.Add(prize); // [!code ++]
		list2.RemoveAt(index);
	}
}
```

[`@@ -137,14 +174,22 @@ public List<List<string>> GetPrizeList()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L137)
```cs:line-numbers=137
			new List<string>
			{
				"microchip", "1089", "150", "855", "medal", "water", "goods_charm", "electronicsS", "electronics", "plat",
				"plat" // [!code --]
				"plat", "ration", "backpack2", "sister", "rp_food", "rp_block", "157" // [!code ++]
			},
			new List<string>
			{
				"computer", "834", "1090", "goods_figure", "goods_canvas", "mb_1", "mb_2", "mb_3", "mb_4", "mb_5",
				"1174", "1085", "toilet", "714", "nobility", "plat", "1165", "mathammer", "medal" // [!code --]
				"1174", "1085", "toilet", "714", "nobility", "plat", "1165", "mathammer", "medal", "bbq", // [!code ++]
				"panty", "beehive", "ticket_resident", "lovepotion", "crystal_sun" // [!code ++]
			},
			new List<string> { "goods_coin", "goods_coin", "plat", "1165", "boat3", "medal" } // [!code --]
			new List<string> // [!code ++]
			{ // [!code ++]
				(EClass.player.luckycoin < 10) ? "goods_coin" : "plat", // [!code ++]
				"plat", // [!code ++]
				"1165", // [!code ++]
				"boat3", // [!code ++]
				"medal" // [!code ++]
			} // [!code ++]
		};
	}

```

[`@@ -157,10 +202,34 @@ public void GetPrize(int grade, int seed)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L157)
```cs:line-numbers=157
	{
		prize = list.RandomItem();
	}
	Thing thing = null; // [!code --]
	Card card = null; // [!code ++]
	if (prize != null)
	{
		thing = ThingGen.Create(prize.id).SetNum(prize.GetNum()); // [!code --]
		if (prize.id == "sister") // [!code ++]
		{ // [!code ++]
			card = CharaGen.Create("sister"); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			card = ThingGen.Create(prize.id).SetNum(prize.GetNum()); // [!code ++]
			switch (card.id) // [!code ++]
			{ // [!code ++]
			case "rp_food": // [!code ++]
			case "rp_block": // [!code ++]
				card.SetLv(10); // [!code ++]
				break; // [!code ++]
			case "goods_coin": // [!code ++]
				EClass.player.luckycoin++; // [!code ++]
				break; // [!code ++]
			case "mathammer": // [!code ++]
				card.ChangeMaterial(prize.idRef); // [!code ++]
				break; // [!code ++]
			case "panty": // [!code ++]
				card.c_idRefCard = prize.idRef; // [!code ++]
				card.rarity = Rarity.Legendary; // [!code ++]
				break; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		if (grade != 3)
		{
			prize.claimed = true;
```

[`@@ -168,9 +237,17 @@ public void GetPrize(int grade, int seed)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/FortuneRollData.cs#L168)
```cs:line-numbers=168
		}
		else
		{
			thing = ThingGen.Create(GetPrizeList()[0].RandomItem()); // [!code --]
			card = ThingGen.Create(GetPrizeList()[0].RandomItem()); // [!code ++]
		} // [!code ++]
		if (card.isChara) // [!code ++]
		{ // [!code ++]
			EClass._zone.AddCard(card, EClass.pc.pos.GetNearestPoint(allowBlock: false, allowChara: false) ?? EClass.pc.pos); // [!code ++]
			card.Chara.MakeMinion(EClass.pc); // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			EClass.pc.Pick(card.Thing); // [!code ++]
		}
		EClass.pc.Pick(thing); // [!code --]
		Rand.SetSeed();
	}

```

## HomeResourceWorth

[`@@ -1,4 +1,5 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/HomeResourceWorth.cs#L1)
```cs:line-numbers=1
using System.Collections.Generic;
using System.Linq; // [!code ++]
using Newtonsoft.Json;
using UnityEngine;

```

[`@@ -64,54 +65,60 @@ public List<Thing> ListHeirloom()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/HomeResourceWorth.cs#L64)
```cs:line-numbers=64
	long num = 0L;
	int num2 = branch.Evalue(2814);
	int num3 = branch.Evalue(2823);
	foreach (Thing thing in EClass._map.things) // [!code --]
	List<Thing> list3 = EClass._map.things.Where((Thing t) => t.IsInstalled && t.HasTag(CTAG.tourism)).ToList(); // [!code ++]
	foreach (Thing item in list3) // [!code ++]
	{ // [!code ++]
		item.sortVal = GetPrice(item); // [!code ++]
	} // [!code ++]
	list3.Sort((Thing a, Thing b) => b.sortVal - a.sortVal); // [!code ++]
	foreach (Thing item2 in list3) // [!code ++]
	{
		if (!thing.IsInstalled) // [!code --]
		if (!item2.HasTag(CTAG.tourism)) // [!code ++]
		{
			continue;
		}
		if (thing.HasTag(CTAG.tourism)) // [!code --]
		bool flag = item2.trait is TraitFigure; // [!code ++]
		if (flag) // [!code ++]
		{
			bool flag = thing.trait is TraitFigure; // [!code --]
			if (flag) // [!code --]
			{ // [!code --]
				if (array[thing.pos.index] != 0) // [!code --]
				{ // [!code --]
					continue; // [!code --]
				} // [!code --]
				array[thing.pos.index]++; // [!code --]
			} // [!code --]
			string text = ""; // [!code --]
			int num4 = 1; // [!code --]
			if (flag) // [!code --]
			if (array[item2.pos.index] != 0) // [!code ++]
			{
				text = "figure_" + thing.c_idRefCard; // [!code --]
				num4 = 2; // [!code --]
				continue; // [!code ++]
			}
			else // [!code --]
			{ // [!code --]
				text = thing.id + "_" + thing.idSkin; // [!code --]
			} // [!code --]
			if (!hashSet.Contains(text)) // [!code --]
			array[item2.pos.index]++; // [!code ++]
		} // [!code ++]
		string text = ""; // [!code ++]
		int num4 = 1; // [!code ++]
		if (flag) // [!code ++]
		{ // [!code ++]
			text = "figure_" + item2.c_idRefCard; // [!code ++]
			num4 = 2; // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			text = item2.id + "_" + item2.idSkin; // [!code ++]
		} // [!code ++]
		if (!hashSet.Contains(text)) // [!code ++]
		{ // [!code ++]
			int num5 = item2.sortVal * num4; // [!code ++]
			if (num3 > 0) // [!code ++]
			{
				int num5 = GetPrice(thing) * num4; // [!code --]
				if (num3 > 0) // [!code --]
				{ // [!code --]
					num5 = num5 * (110 + (int)Mathf.Sqrt(num3) * 4) / 100; // [!code --]
				} // [!code --]
				num += num5; // [!code --]
				hashSet.Add(text); // [!code --]
				num5 = num5 * (110 + (int)Mathf.Sqrt(num3) * 4) / 100; // [!code ++]
			}
			else if (num2 > 0) // [!code --]
			num += num5; // [!code ++]
			hashSet.Add(text); // [!code ++]
		} // [!code ++]
		else if (num2 > 0) // [!code ++]
		{ // [!code ++]
			int num6 = item2.sortVal * num4 / Mathf.Max(20, 30 - (int)Mathf.Sqrt(num2)); // [!code ++]
			if (num6 > 0) // [!code ++]
			{
				int num6 = GetPrice(thing) * num4 / Mathf.Max(20, 30 - (int)Mathf.Sqrt(num2)); // [!code --]
				if (num6 > 0) // [!code --]
				{ // [!code --]
					num += num6; // [!code --]
				} // [!code --]
				num += num6; // [!code ++]
			}
		}
		if (thing.IsFurniture || thing.trait is TraitToolMusic) // [!code --]
	} // [!code ++]
	foreach (Thing thing in EClass._map.things) // [!code ++]
	{ // [!code ++]
		if (thing.IsInstalled && (thing.IsFurniture || thing.trait is TraitToolMusic)) // [!code ++]
		{
			list2.Add(thing);
		}
```

## HotItemHeld

[`@@ -396,6 +396,13 @@ public bool TrySetToolAct(ActPlan p)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/HotItemHeld.cs#L396)
```cs:line-numbers=396
		{
			return true;
		}
		if (thing.HasElement(225) && p.TrySetAct(new TaskChopWoord // [!code ++]
		{ // [!code ++]
			pos = pos.Copy() // [!code ++]
		})) // [!code ++]
		{ // [!code ++]
			return true; // [!code ++]
		} // [!code ++]
	}
	if (pos.HasChara)
	{
```

## LayerConfig

[`@@ -81,6 +81,8 @@ public class LayerConfig : ELayer`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerConfig.cs#L81)
```cs:line-numbers=81

	public UIButton toggleBalloon;

	public UIButton toggleFloorEx; // [!code ++]
 // [!code ++]
	public UIItem fontUI;

	public UIItem fontChatbox;
```

[`@@ -434,17 +436,34 @@ public void Refresh()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerConfig.cs#L434)
```cs:line-numbers=434
	toggleFirefly.SetToggle(ELayer.config.graphic.firefly, delegate(bool on)
	{
		ELayer.config.graphic.firefly = on;
		ELayer.screen.RefreshSky(); // [!code --]
		if (ELayer.core.IsGameStarted) // [!code ++]
		{ // [!code ++]
			ELayer.screen.RefreshSky(); // [!code ++]
		} // [!code ++]
	}); // [!code ++]
	toggleFloorEx.SetToggle(ELayer.config.graphic.floorEx, delegate(bool on) // [!code ++]
	{ // [!code ++]
		ELayer.config.graphic.floorEx = on; // [!code ++]
		if (ELayer.core.IsGameStarted) // [!code ++]
		{ // [!code ++]
			ELayer.screen.RefreshAll(); // [!code ++]
		} // [!code ++]
	});
	toggleGodray.SetToggle(ELayer.config.graphic.godray, delegate(bool on)
	{
		ELayer.config.graphic.godray = on;
		ELayer.screen.RefreshSky(); // [!code --]
		if (ELayer.core.IsGameStarted) // [!code ++]
		{ // [!code ++]
			ELayer.screen.RefreshSky(); // [!code ++]
		} // [!code ++]
	});
	toggleBlizzard.SetToggle(ELayer.config.graphic.blizzard, delegate(bool on)
	{
		ELayer.config.graphic.blizzard = on;
		ELayer.screen.RefreshSky(); // [!code --]
		if (ELayer.core.IsGameStarted) // [!code ++]
		{ // [!code ++]
			ELayer.screen.RefreshSky(); // [!code ++]
		} // [!code ++]
	});
	toggleAllyLight.SetToggle(ELayer.config.graphic.drawAllyLight, delegate(bool on)
	{
```

## LayerEditPortrait

[`@@ -57,17 +57,18 @@ public void Activate(Chara _chara, PCCData _pcc = null, Action<Color> _action =`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerEditPortrait.cs#L57)
```cs:line-numbers=57
	}
	uiPicker.SetColor(hairColor, hairColor, delegate(PickerState state, Color _c)
	{
		ColorUtility.TryParseHtmlString("#" + ColorUtility.ToHtmlStringRGBA(_c), out var color); // [!code ++]
		if (pcc == null)
		{
			chara.SetInt(105, IntColor.ToInt(_c)); // [!code --]
			chara.SetInt(105, IntColor.ToInt(color)); // [!code ++]
		}
		else
		{
			pcc.SetColor("hair", _c); // [!code --]
			pcc.SetColor("hair", color); // [!code ++]
		}
		portrait.SetChara(chara, pcc);
		action(_c); // [!code --]
		hairColor = _c; // [!code --]
		action(color); // [!code ++]
		hairColor = color; // [!code ++]
		hasColorChanged = true;
	});
	RefreshList();
```

## LayerMod

[`@@ -67,9 +67,12 @@ public override void OnInit()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerMod.cs#L67)
```cs:line-numbers=67
				{
					uIContextMenu.AddButton("mod_publish", delegate
					{
						Dialog.YesNo("mod_publish_warn".lang(a.title, a.id, a.author), delegate // [!code --]
						Core.TryWarnUpload(delegate // [!code ++]
						{
							ELayer.core.steam.CreateUserContent(a); // [!code --]
							Dialog.YesNo("mod_publish_warn".lang(a.title, a.id, a.author), delegate // [!code ++]
							{ // [!code ++]
								ELayer.core.steam.CreateUserContent(a); // [!code ++]
							}); // [!code ++]
						});
					});
				}
```

## LayerTitle

[`@@ -77,8 +77,11 @@ public void OnClickStart()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerTitle.cs#L77)
```cs:line-numbers=77
	{
		if (ELayer.ui.GetTopLayer() is LayerTitle)
		{
			embark = ELayer.ui.AddLayer<LayerEditBio>(); // [!code --]
			SoundManager.current.PlayBGM(CurrentTitle.bgm); // [!code --]
			Core.TryWarnMod(delegate // [!code ++]
			{ // [!code ++]
				embark = ELayer.ui.AddLayer<LayerEditBio>(); // [!code ++]
				SoundManager.current.PlayBGM(CurrentTitle.bgm); // [!code ++]
			}, ELayer.core.mods.CountUserMod() > 0); // [!code ++]
		}
	}

```

[`@@ -91,7 +94,10 @@ public void OnClickContinue()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerTitle.cs#L91)
```cs:line-numbers=91
	{
		if (ELayer.ui.GetTopLayer() is LayerTitle)
		{
			ELayer.ui.AddLayer<LayerLoadGame>().Init(_backup: false); // [!code --]
			Core.TryWarnMod(delegate // [!code ++]
			{ // [!code ++]
				ELayer.ui.AddLayer<LayerLoadGame>().Init(_backup: false); // [!code ++]
			}, ELayer.core.mods.CountUserMod() > 0); // [!code ++]
		}
	}

```

## LayerUploader

[`@@ -1,6 +1,5 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerUploader.cs#L1)
```cs:line-numbers=1
using System;
using System.Collections.Generic;
using IniParser; // [!code --]
using IniParser.Model;
using UnityEngine;
using UnityEngine.UI;
```

[`@@ -46,7 +45,7 @@ public class LayerUploader : ELayer`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerUploader.cs#L46)
```cs:line-numbers=46

	public override void OnInit()
	{
		ini = ELayer.core.mods.GetElinIni(); // [!code --]
		ini = Core.GetElinIni(); // [!code ++]
		string text = ini.GetKey("pass") ?? "password";
		inputId.text = ELayer._map.custom?.id ?? "new_zone";
		inputPassword.text = text;
```

[`@@ -90,7 +89,7 @@ public void SaveID()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerUploader.cs#L90)
```cs:line-numbers=90
			ELayer._map.custom.id = inputId.text;
		}
		ini.Global["pass"] = inputPassword.text;
		new FileIniDataParser().WriteFile(ModManager.PathIni, ini); // [!code --]
		Core.SaveElinIni(ini); // [!code ++]
	}

	public void ExportMap()
```

[`@@ -102,7 +101,7 @@ public void ExportMap()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerUploader.cs#L102)
```cs:line-numbers=102

	public void Upload()
	{
		if (ini.Global["agreed"].IsEmpty() || ELayer.debug.enable) // [!code --]
		if (ini.Global["agreed_usercontents_upload_terms"] != "yes") // [!code ++]
		{
			string[] items = new string[3] { "readTerms", "agree", "disagree" };
			Dialog.List("dialogTermsOfUse".lang(), items, (string j) => j, delegate(int c, string d)
```

[`@@ -113,7 +112,7 @@ public void Upload()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/LayerUploader.cs#L113)
```cs:line-numbers=113
				LayerHelp.Toggle("custom", "terms");
				return false;
			case 1:
				ini.Global["agreed"] = "yes"; // [!code --]
				ini.Global["agreed_usercontents_upload_terms"] = "yes"; // [!code ++]
				Upload();
				break;
			}
```

## ModManager

[`@@ -2,10 +2,8 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ModManager.cs#L2)
```cs:line-numbers=2
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Text; // [!code --]
using HeathenEngineering.SteamworksIntegration;
using HeathenEngineering.SteamworksIntegration.API;
using IniParser; // [!code --]
using IniParser.Model;
using NPOI.SS.UserModel;
using NPOI.XSSF.UserModel;
```

[`@@ -22,8 +20,6 @@ public struct SheetIndex`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ModManager.cs#L22)
```cs:line-numbers=22
		public int old;
	}

	public static readonly string PasswordChar = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; // [!code --]
 // [!code --]
	public static List<object> ListPluginObject = new List<object>();

	public static bool disableMod = false;
```

[`@@ -36,42 +32,10 @@ public struct SheetIndex`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ModManager.cs#L36)
```cs:line-numbers=36

	public static bool IsInitialized => BaseModManager.isInitialized;

	public static string PathIni => CorePath.PathIni; // [!code --]
 // [!code --]
	public IniData GetElinIni() // [!code --]
	{ // [!code --]
		try // [!code --]
		{ // [!code --]
			FileIniDataParser fileIniDataParser = new FileIniDataParser(); // [!code --]
			if (!File.Exists(PathIni)) // [!code --]
			{ // [!code --]
				File.CreateText(PathIni).Close(); // [!code --]
			} // [!code --]
			IniData iniData = fileIniDataParser.ReadFile(PathIni, Encoding.UTF8); // [!code --]
			if (iniData.GetKey("pass").IsEmpty()) // [!code --]
			{ // [!code --]
				string text = ""; // [!code --]
				for (int i = 0; i < 4; i++) // [!code --]
				{ // [!code --]
					text += PasswordChar.RandomItem(); // [!code --]
				} // [!code --]
				iniData.Global["pass"] = text; // [!code --]
				fileIniDataParser.WriteFile(PathIni, iniData); // [!code --]
			} // [!code --]
			return iniData; // [!code --]
		} // [!code --]
		catch (Exception message) // [!code --]
		{ // [!code --]
			Debug.Log(message); // [!code --]
			Debug.Log("exception: Failed to parse:" + PathIni); // [!code --]
			return null; // [!code --]
		} // [!code --]
	} // [!code --]
 // [!code --]
	public override void Init(string path, string defaultPackage = "_Elona")
	{
		base.Init(path, defaultPackage);
		IniData elinIni = GetElinIni(); // [!code --]
		IniData elinIni = Core.GetElinIni(); // [!code ++]
		Debug.Log("IsOffline:" + BaseCore.IsOffline);
		if (elinIni != null)
		{
```

[`@@ -88,7 +52,7 @@ public override void Init(string path, string defaultPackage = "_Elona")`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ModManager.cs#L88)
```cs:line-numbers=88
			DirectoryInfo parent = new DirectoryInfo(App.Client.GetAppInstallDirectory(SteamSettings.behaviour.settings.applicationId)).Parent.Parent;
			dirWorkshop = new DirectoryInfo(parent.FullName + "/workshop/content/2135150");
			elinIni.Global["path_workshop"] = dirWorkshop.FullName ?? "";
			new FileIniDataParser().WriteFile(PathIni, elinIni); // [!code --]
			Core.SaveElinIni(elinIni); // [!code ++]
		}
	}
	if (dirWorkshop != null && !dirWorkshop.Exists)
```

[`@@ -325,6 +289,19 @@ public ModPackage AddWorkshopPackage(WorkshopItem item, bool isInPackages = fals`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ModManager.cs#L325)
```cs:line-numbers=325
		return modPackage;
	}

	public int CountUserMod() // [!code ++]
	{ // [!code ++]
		int num = 0; // [!code ++]
		foreach (BaseModPackage package in packages) // [!code ++]
		{ // [!code ++]
			if (!package.builtin) // [!code ++]
			{ // [!code ++]
				num++; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return num; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public override void ParseExtra(DirectoryInfo dir, BaseModPackage package)
	{
		switch (dir.Name)
```

## Player

[`@@ -755,6 +755,9 @@ public void OnLeaveZone()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Player.cs#L755)
```cs:line-numbers=755
	[JsonProperty]
	public int giftJure;

	[JsonProperty] // [!code ++]
	public int luckycoin; // [!code ++]
 // [!code ++]
	[JsonProperty]
	public float angle;

```

## Point

[`@@ -905,8 +905,14 @@ public void SetObj(int id = 0, int value = 1, int dir = 0)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Point.cs#L905)
```cs:line-numbers=905
		map.SetObj(x, z, id, value, dir);
	}

	public void ModFire(int value) // [!code --]
	public void ModFire(int value, bool extinguish = false) // [!code ++]
	{
		if (extinguish && cell.HasFire) // [!code ++]
		{ // [!code ++]
			PlaySound("extinguish"); // [!code ++]
			PlayEffect("smoke"); // [!code ++]
			PlayEffect("vanish"); // [!code ++]
		} // [!code ++]
		map.ModFire(x, z, value);
	}

```

[`@@ -1106,6 +1112,21 @@ public T FindThing<T>() where T : Trait`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Point.cs#L1106)
```cs:line-numbers=1106
		return null;
	}

	public Thing FindThing(Func<Thing, bool> func) // [!code ++]
	{ // [!code ++]
		if (detail != null) // [!code ++]
		{ // [!code ++]
			foreach (Thing thing in detail.things) // [!code ++]
			{ // [!code ++]
				if (func(thing)) // [!code ++]
				{ // [!code ++]
					return thing; // [!code ++]
				} // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return null; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public List<Card> ListThings<T>(bool onlyInstalled = true) where T : Trait
	{
		listCard.Clear();
```

## Portrait

[`@@ -210,11 +210,15 @@ public Color GetRandomHairColor(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Portrait.cs#L210)
```cs:line-numbers=210
		return randomColor;
	}

	public void SetPortrait(string id, Color colorOverlay = default(Color)) // [!code --]
	public void SetPortrait(string id, Color colorOverlay = default(Color), bool applyColorMod = true) // [!code ++]
	{
		Sprite @object = modPortraits.GetItem(id).GetObject();
		Sprite object2 = modOverlays.GetObject(id + "-overlay");
		Sprite spriteFull = ((enableFull && (bool)imageFull) ? modFull.GetObject(id + "-full") : null);
		if (applyColorMod) // [!code ++]
		{ // [!code ++]
			colorOverlay = PCCManager.current.ApplyColorMod(colorOverlay); // [!code ++]
		} // [!code ++]
		SetPortrait(isPortrait: true, @object, object2, colorOverlay, spriteFull);
	}

```

## Recipe

[`@@ -904,6 +904,10 @@ public int GetSortVal()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Recipe.cs#L904)
```cs:line-numbers=904

	public bool HasFirstTimeBonus()
	{
		if (IsStaticLV()) // [!code ++]
		{ // [!code ++]
			return false; // [!code ++]
		} // [!code ++]
		if (EClass.player.recipes.craftedRecipes.Contains(id))
		{
			return false;
```

## RecipeCard

[`@@ -246,7 +246,11 @@ public override Thing Craft(BlessedState blessed, bool sound = false, List<Thing`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/RecipeCard.cs#L246)
```cs:line-numbers=246
	{
		if (isDish)
		{
			if (!flag) // [!code --]
			if (flag) // [!code ++]
			{ // [!code ++]
				thing.ChangeMaterial("meat"); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{
				MakeDish(thing);
				if (EClass.pc.HasElement(1658))
```

## Scene

[`@@ -100,6 +100,8 @@ public enum Mode`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Scene.cs#L100)
```cs:line-numbers=100

	public Tileset tileset;

	public Material matFloorEx; // [!code ++]
 // [!code ++]
	public ParticleSystem psFoot;

	public ParticleSystem psSmoke;
```

## SerializedCards

[`@@ -673,10 +673,7 @@ public void Restore(Map map, Map orgMap, bool addToZone, PartialMap partial = nu`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/SerializedCards.cs#L673)
```cs:line-numbers=673
		card2.isImported = true;
		card2.refVal = card4.refVal;
		card2.idSkin = card4.idSkin;
		if (isUserZone) // [!code --]
		{ // [!code --]
			card2.c_idDeity = card4.idDeity; // [!code --]
		} // [!code --]
		card2.c_idDeity = card4.idDeity; // [!code ++]
		if (isUserZone && (card2.isHidden || card2.isMasked) && ((card2.TileType.IsBlockPass && card2.IsInstalled) || card2.trait is TraitCoreZone || card2.trait is TraitWaystone))
		{
			Card card3 = card2;
```

## SourceMaterial

[`@@ -136,10 +136,10 @@ public void AddBlood(Point p, int a = 1)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/SourceMaterial.cs#L136)
```cs:line-numbers=136
			}
		}

		public void PlayHitEffect(Point p) // [!code --]
		public void PlayHitEffect(Point p, int emit = 2) // [!code ++]
		{
			Effect.Get("mine2").Play(p).SetParticleColor(GetColor())
				.Emit(2 + EClass.rnd(4)); // [!code --]
				.Emit(emit + EClass.rnd(4)); // [!code ++]
		}

		public Color GetColor()
```

## +TaskChopWoord

::: details File Created
```cs
using System.Collections.Generic;
using UnityEngine;

public class TaskChopWoord : TaskDesignation
{
	public override CursorInfo CursorIcon => CursorSystem.Cut;

	public override int destDist => 1;

	public override bool Loop => GetLog() != null;

	public override bool CanManualCancel()
	{
		return true;
	}

	public Thing GetLog()
	{
		return pos.FindThing((Thing t) => t.id == "log");
	}

	public override HitResult GetHitResult()
	{
		if (GetLog() != null)
		{
			return HitResult.Valid;
		}
		return HitResult.Invalid;
	}

	public override bool CanProgress()
	{
		if (base.CanProgress() && GetLog() != null && owner.Tool != null && owner.Tool.trait is TraitTool)
		{
			return owner.Tool.HasElement(225);
		}
		return false;
	}

	public override void OnCreateProgress(Progress_Custom p)
	{
		p.textHint = Name;
		p.maxProgress = Mathf.Max((15 + EClass.rnd(20)) * 100 / (100 + owner.Tool.material.hardness * 3), 2);
		p.onProgressBegin = delegate
		{
			if (owner.Tool != null)
			{
				owner.Say("chopwood_start", owner, GetLog().GetName(NameStyle.Full, 1));
			}
		};
		p.onProgress = delegate
		{
			Thing log2 = GetLog();
			SourceMaterial.Row material2 = log2.material;
			log2.PlaySoundImpact();
			material2.AddBlood(pos);
			log2.PlayAnime(AnimeID.HitObj);
			material2.PlayHitEffect(pos);
			owner.renderer.NextFrame();
		};
		p.onProgressComplete = delegate
		{
			Thing log = GetLog();
			SourceMaterial.Row material = log.material;
			log.PlaySoundDead();
			material.AddBlood(pos, 3 + EClass.rnd(2));
			log.material.PlayHitEffect(pos, 10);
			Thing thing = ThingGen.Create("plank", material.id).SetNum(1 + EClass.rnd(2));
			CraftUtil.MixIngredients(thing, new List<Thing> { log }, CraftUtil.MixType.General, 999);
			log.ModNum(-1);
			owner.elements.ModExp(225, 30);
			owner.stamina.Mod(-1);
			EClass._map.TrySmoothPick(pos, thing, EClass.pc);
		};
	}
}
```

:::
## TaskWater

[`@@ -74,7 +74,7 @@ public override IEnumerable<Status> Run()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TaskWater.cs#L74)
```cs:line-numbers=74
			}
			if (p.cell.HasFire)
			{
				EClass._map.ModFire(p.x, p.z, -50); // [!code --]
				p.ModFire(-50, extinguish: true); // [!code ++]
			}
			owner.PlaySound("water_farm");
			owner.Say("water_farm", owner, p.cell.GetFloorName());
```

## Thing

[`@@ -570,7 +570,7 @@ public override string GetName(NameStyle style, int _num = -1)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Thing.cs#L570)
```cs:line-numbers=570
		}
		if (!(text7 == "*r"))
		{
			text = ((!source.name2.IsEmpty()) ? source.GetTextArray("name2")[0].Replace("#1b", (base.refCard != null) ? base.refCard.GetName() : text7).Replace("#1", text7) : (source.naming.Contains("last") ? (text + Lang.space + text7) : (source.naming.Contains("first") ? (text7 + Lang.space + text) : ((!source.naming.Contains("of")) ? (text6.IsEmpty() ? "_of3" : "_of2").lang(text7, text) : "_of".lang(text7, text))))); // [!code --]
			text = ((!source.name2.IsEmpty()) ? source.GetTextArray("name2")[0].Replace("#1b", base.c_extraNameRef.IsEmpty((base.refCard != null) ? base.refCard.GetName() : text7)).Replace("#1", base.c_extraNameRef.IsEmpty(text7)) : (source.naming.Contains("last") ? (text + Lang.space + text7) : (source.naming.Contains("first") ? (text7 + Lang.space + text) : ((!source.naming.Contains("of")) ? (text6.IsEmpty() ? "_of3" : "_of2").lang(text7, text) : "_of".lang(text7, text))))); // [!code ++]
		}
		else
		{
```

[`@@ -1979,6 +1979,48 @@ public Thing Identify(bool show = true, IDTSource idtSource = IDTSource.Identify`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Thing.cs#L1979)
```cs:line-numbers=1979
		LayerInventory.SetDirty(this);
		return this;
	}
 // [!code ++]
	public override bool MatchEncSearch(string s) // [!code ++]
	{ // [!code ++]
		if (trait is TraitGene) // [!code ++]
		{ // [!code ++]
			DNA dNA = base.c_DNA; // [!code ++]
			if (dNA == null || dNA.type == DNA.Type.Brain || dNA.type == DNA.Type.Inferior) // [!code ++]
			{ // [!code ++]
				return false; // [!code ++]
			} // [!code ++]
			for (int i = 0; i < dNA.vals.Count; i += 2) // [!code ++]
			{ // [!code ++]
				SourceElement.Row row = EClass.sources.elements.map.TryGetValue(dNA.vals[i]); // [!code ++]
				if (row.name.ToLower().Contains(s)) // [!code ++]
				{ // [!code ++]
					return true; // [!code ++]
				} // [!code ++]
				if (!Lang.isEN && row.GetName().ToLower().Contains(s)) // [!code ++]
				{ // [!code ++]
					return true; // [!code ++]
				} // [!code ++]
			} // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			foreach (Element value in elements.dict.Values) // [!code ++]
			{ // [!code ++]
				if (value.Value != 0) // [!code ++]
				{ // [!code ++]
					if (value.source.name.ToLower().Contains(s)) // [!code ++]
					{ // [!code ++]
						return true; // [!code ++]
					} // [!code ++]
					if (!Lang.isEN && value.source.GetName().ToLower().Contains(s)) // [!code ++]
					{ // [!code ++]
						return true; // [!code ++]
					} // [!code ++]
				} // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return false; // [!code ++]
	} // [!code ++]
}
public static class THING
{
```

## ThingContainer

[`@@ -149,12 +149,17 @@ public void RefreshGrid(UIMagicChest magic, Window.SaveData data)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ThingContainer.cs#L149)
```cs:line-numbers=149
	magic.cats.Clear();
	magic.catCount.Clear();
	grid = new List<Thing>(new Thing[GridSize]);
	string lastSearch = magic.lastSearch; // [!code --]
	bool flag = !lastSearch.IsEmpty(); // [!code --]
	string text = magic.lastSearch; // [!code ++]
	bool flag = !text.IsEmpty(); // [!code ++]
	bool flag2 = !magic.idCat.IsEmpty();
	Window.SaveData.CategoryType category = data.category;
	bool flag3 = category != Window.SaveData.CategoryType.None;
	string text = ""; // [!code --]
	string text2 = ""; // [!code ++]
	bool flag4 = text != null && text.Length >= 2 && (text[0] == '@' || text[1] == '＠'); // [!code ++]
	if (flag4) // [!code ++]
	{ // [!code ++]
		text = text.Substring(1); // [!code ++]
	} // [!code ++]
	using (Enumerator enumerator = GetEnumerator())
	{
		while (enumerator.MoveNext())
```

[`@@ -165,37 +170,47 @@ public void RefreshGrid(UIMagicChest magic, Window.SaveData data)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/ThingContainer.cs#L165)
```cs:line-numbers=165
				switch (category)
				{
				case Window.SaveData.CategoryType.Main:
					text = current.category.GetRoot().id; // [!code --]
					text2 = current.category.GetRoot().id; // [!code ++]
					break;
				case Window.SaveData.CategoryType.Sub:
					text = current.category.GetSecondRoot().id; // [!code --]
					text2 = current.category.GetSecondRoot().id; // [!code ++]
					break;
				case Window.SaveData.CategoryType.Exact:
					text = current.category.id; // [!code --]
					text2 = current.category.id; // [!code ++]
					break;
				}
				magic.cats.Add(text); // [!code --]
				if (magic.catCount.ContainsKey(text)) // [!code --]
				magic.cats.Add(text2); // [!code ++]
				if (magic.catCount.ContainsKey(text2)) // [!code ++]
				{
					magic.catCount[text]++; // [!code --]
					magic.catCount[text2]++; // [!code ++]
				}
				else
				{
					magic.catCount.Add(text, 1); // [!code --]
					magic.catCount.Add(text2, 1); // [!code ++]
				}
			}
			if (flag)
			{
				if (current.tempName == null) // [!code --]
				if (flag4) // [!code ++]
				{
					current.tempName = current.GetName(NameStyle.Full, 1).ToLower(); // [!code --]
					if (!current.MatchEncSearch(text)) // [!code ++]
					{ // [!code ++]
						continue; // [!code ++]
					} // [!code ++]
				}
				if (!current.tempName.Contains(lastSearch) && !current.source.GetSearchName(jp: false).Contains(lastSearch) && !current.source.GetSearchName(jp: true).Contains(lastSearch)) // [!code --]
				else // [!code ++]
				{
					continue; // [!code --]
					if (current.tempName == null) // [!code ++]
					{ // [!code ++]
						current.tempName = current.GetName(NameStyle.Full, 1).ToLower(); // [!code ++]
					} // [!code ++]
					if (!current.tempName.Contains(text) && !current.source.GetSearchName(jp: false).Contains(text) && !current.source.GetSearchName(jp: true).Contains(text)) // [!code ++]
					{ // [!code ++]
						continue; // [!code ++]
					} // [!code ++]
				}
			}
			if (!flag2 || !(text != magic.idCat)) // [!code --]
			if (!flag2 || !(text2 != magic.idCat)) // [!code ++]
			{
				magic.filteredList.Add(current);
			}
```

## TraitAdventurer

[`@@ -12,6 +12,8 @@ public class TraitAdventurer : TraitChara`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitAdventurer.cs#L12)
```cs:line-numbers=12

	public override bool CanBout => true;

	public override bool IsWearingPanty => true; // [!code ++]
 // [!code ++]
	public override Adv_Type AdvType
	{
		get
```

## TraitChara

[`@@ -118,6 +118,18 @@ public virtual bool CanGiveRandomQuest`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitChara.cs#L118)
```cs:line-numbers=118

	public virtual bool UseRandomAlias => false;

	public virtual bool IsWearingPanty // [!code ++]
	{ // [!code ++]
		get // [!code ++]
		{ // [!code ++]
			if ((!IsUnique || owner.bio.gender != 2) && (owner.race.IsHuman || owner.race.IsFairy)) // [!code ++]
			{ // [!code ++]
				return !(this is TraitMerchant); // [!code ++]
			} // [!code ++]
			return false; // [!code ++]
		} // [!code ++]
	} // [!code ++]
 // [!code ++]
	public override string IDInvStyle => "backpack";

	public virtual string IDRumor => "";
```

## TraitCrafter

[`@@ -446,6 +446,11 @@ public override bool CanUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitCrafter.cs#L446)
```cs:line-numbers=446

	public override bool OnUse(Chara c)
	{
		if (EClass._zone.IsRegion) // [!code ++]
		{ // [!code ++]
			Msg.SayCannotUseHere(); // [!code ++]
			return false; // [!code ++]
		} // [!code ++]
		if (IsFactory)
		{
			Thing thing = owner.Thing;
```

## TraitGiftJure

[`@@ -28,6 +28,7 @@ public override bool OnUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitGiftJure.cs#L28)
```cs:line-numbers=28
	Add("cake_festival", 3);
	Add("bushdenoel", 3);
	Add("mancookie", 3);
	EClass.pc.Pick(ThingGen.CreateRecipe("xmas_tree")); // [!code ++]
	Thing thing = ThingGen.CreateLetter("letter_juremas");
	thing.ChangeMaterial("grass_forest");
	EClass.pc.Pick(thing);
```

## TraitKettle

[`@@ -56,6 +56,16 @@ public override bool CanCopy(Thing t)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitKettle.cs#L56)
```cs:line-numbers=56
		{
			return true;
		}
		if (t.sockets != null) // [!code ++]
		{ // [!code ++]
			foreach (int socket in t.sockets) // [!code ++]
			{ // [!code ++]
				if (socket != 0) // [!code ++]
				{ // [!code ++]
					return false; // [!code ++]
				} // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return t.isCrafted;
	}
}
```

## TraitMoongate

[`@@ -25,7 +25,10 @@ public override bool OnUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitMoongate.cs#L25)
```cs:line-numbers=25
			Msg.SayNothingHappen();
			return false;
		}
		LayerProgress.StartAsync("Loading", UseMoongate()); // [!code --]
		Core.TryWarnMod(delegate // [!code ++]
		{ // [!code ++]
			LayerProgress.StartAsync("Loading", UseMoongate()); // [!code ++]
		}, warn: false); // [!code ++]
		return false;
	}

```

## TraitMoongateEx

[`@@ -11,6 +11,15 @@ public override bool OnUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitMoongateEx.cs#L11)
```cs:line-numbers=11
			Msg.SayNothingHappen();
			return false;
		}
		Core.TryWarnMod(delegate // [!code ++]
		{ // [!code ++]
			_OnUse(); // [!code ++]
		}, warn: false); // [!code ++]
		return false; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public void _OnUse() // [!code ++]
	{ // [!code ++]
		List<MapMetaData> list = new List<MapMetaData>();
		foreach (FileInfo item in new DirectoryInfo(CorePath.ZoneSaveUser).GetFiles().Concat(MOD.listMaps))
		{
```

[`@@ -27,7 +36,7 @@ public override bool OnUse(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitMoongateEx.cs#L27)
```cs:line-numbers=27
	if (list.Count == 0)
	{
		EClass.pc.SayNothingHappans();
		return false; // [!code --]
		return; // [!code ++]
	}
	LayerList layer = null;
	bool skipDialog = false;
```

[`@@ -68,6 +77,5 @@ void func()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitMoongateEx.cs#L68)
```cs:line-numbers=68
			}
		}).SetSize(500f)
			.SetTitles("wMoongate") as LayerList;
		return false; // [!code --]
	}
}
```

## TraitRollingFortune

[`@@ -4,6 +4,8 @@ public class TraitRollingFortune : TraitCrafter`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/TraitRollingFortune.cs#L4)
```cs:line-numbers=4

	public override string CrafterTitle => "invRoll";

	public override bool CanUseFromInventory => false; // [!code ++]
 // [!code ++]
	public override AnimeType animeType => AnimeType.Microwave;

	public override string idSoundProgress => "fortuneroll";
```

## WidgetSearch

[`@@ -95,14 +95,20 @@ public override void Search(string s)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/WidgetSearch.cs#L95)
```cs:line-numbers=95
	}
	s = s.ToLower();
	buttonClear.SetActive(field.text != "");
	if (s == lastSearch) // [!code --]
	if (s == lastSearch || s.Length == 0) // [!code ++]
	{
		return;
	}
	lastSearch = s; // [!code ++]
	bool encSearch = s.Length >= 2 && (s[0] == '@' || s[1] == '＠'); // [!code ++]
	if (encSearch) // [!code ++]
	{ // [!code ++]
		s = s.Substring(1); // [!code ++]
	} // [!code ++]
	HashSet<Card> newCards = new HashSet<Card>();
	if (!s.IsEmpty())
	{
		if (EMono._zone.IsTown || EMono._zone.IsPCFaction || EMono._zone is Zone_Tent) // [!code --]
		if (!encSearch && (EMono._zone.IsTown || EMono._zone.IsPCFaction || EMono._zone is Zone_Tent)) // [!code ++]
		{
			foreach (Chara chara in EMono._map.charas)
			{
```

[`@@ -116,14 +122,32 @@ public override void Search(string s)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/WidgetSearch.cs#L116)
```cs:line-numbers=116
		{
			foreach (Thing thing in EMono._map.things)
			{
				if (thing.Name.ToLower().Contains(s) || thing.sourceCard.GetSearchName(jp: false).Contains(s)) // [!code --]
				if (encSearch) // [!code ++]
				{ // [!code ++]
					if (thing.MatchEncSearch(s)) // [!code ++]
					{ // [!code ++]
						newCards.Add(thing); // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else if (thing.Name.ToLower().Contains(s) || thing.sourceCard.GetSearchName(jp: false).Contains(s)) // [!code ++]
				{
					newCards.Add(thing);
				}
			}
			foreach (Card value in EMono._map.props.stocked.all.Values)
			{
				if (value.parent is Thing && (value.parent as Thing).c_lockLv <= 0 && (value.Name.ToLower().Contains(s) || value.sourceCard.GetSearchName(jp: false).Contains(s))) // [!code --]
				if (!(value.parent is Thing) || (value.parent as Thing).c_lockLv > 0) // [!code ++]
				{ // [!code ++]
					continue; // [!code ++]
				} // [!code ++]
				if (encSearch) // [!code ++]
				{ // [!code ++]
					if (value.MatchEncSearch(s)) // [!code ++]
					{ // [!code ++]
						newCards.Add(value); // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else if (value.Name.ToLower().Contains(s) || value.sourceCard.GetSearchName(jp: false).Contains(s)) // [!code ++]
				{
					newCards.Add(value);
				}
```

[`@@ -139,9 +163,19 @@ public override void Search(string s)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/WidgetSearch.cs#L139)
```cs:line-numbers=139
				}
				chara2.things.Foreach(delegate(Thing t)
				{
					if (!((t.parent as Card)?.trait is TraitChestMerchant) && (t.Name.ToLower().Contains(s) || t.source.GetSearchName(jp: false).Contains(s))) // [!code --]
					if (!((t.parent as Card)?.trait is TraitChestMerchant)) // [!code ++]
					{
						newCards.Add(t); // [!code --]
						if (encSearch) // [!code ++]
						{ // [!code ++]
							if (t.MatchEncSearch(s)) // [!code ++]
							{ // [!code ++]
								newCards.Add(t); // [!code ++]
							} // [!code ++]
						} // [!code ++]
						else if (t.Name.ToLower().Contains(s) || t.source.GetSearchName(jp: false).Contains(s)) // [!code ++]
						{ // [!code ++]
							newCards.Add(t); // [!code ++]
						} // [!code ++]
					}
				});
			}
```

[`@@ -153,7 +187,6 @@ public override void Search(string s)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/WidgetSearch.cs#L153)
```cs:line-numbers=153
			RefreshList();
		}
		cgResult.alpha = ((list.ItemCount > 0) ? 1f : 0f);
		lastSearch = s; // [!code --]
	}

	public void RefreshWords()
```

## Zone

[`@@ -3437,7 +3437,7 @@ public FortuneRollData GetOrCreateFortuneRollData(bool refresh = true)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/fdb24a94448462206e79dbe0fcb014f727be10c2/Elin/Zone.cs#L3437)
```cs:line-numbers=3437
	if (fortuneRoll == null)
	{
		fortuneRoll = new FortuneRollData();
		fortuneRoll.seed = EClass.rnd(50000) + 1; // [!code --]
		fortuneRoll.seed = EClass._zone.uid * 100 + EClass.game.seed; // [!code ++]
	}
	if (refresh || fortuneRoll.count == 0)
	{
```

<style scoped>.vp-doc h1,.vp-doc h2,.vp-doc h3,.vp-doc h4,.vp-doc h5,.vp-doc h6 {text-transform: none;} .h3 {}</style>