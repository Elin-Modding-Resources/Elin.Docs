---
exclude: true
aside: false
pageClass: diff-single-page
footer: false
editLink: false
lastUpdated: false
description: 16 files modified. 1 new file created.
version: EA 23.136 Nightly
changes: ActEffect/BaseTileMap/Biography/ConBuffStats/ELEMENT/EffectId/EloMap/GameDate/PrefFlag/QuestManager/+QuestNegotiationDarkness/SourcePref/Thing/TraitDeed/TraitDrinkMilkMother/TraitFoodEggFertilized/Zone_Exile
---

# EA 23.136 Nightly

May 11, 2025

16 files modified. 1 new file created.

## Important Changes

**None.**
## ActEffect

[`@@ -685,7 +685,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L685-L691)
```cs:line-numbers=685
		float radius2 = ((id == EffectId.Suicide) ? 3.5f : ((float)((id == EffectId.BallBubble) ? 2 : 5)));
		if (id == EffectId.Explosive && actRef.refThing != null)
		{
			radius2 = 2f; // [!code --]
			radius2 = 2 + actRef.refThing.Evalue(666); // [!code ++]
		}
		if (id == EffectId.Suicide)
		{
```

[`@@ -1375,26 +1375,26 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1375-L1400)
```cs:line-numbers=1375
			TC.Say((actRef.n1 == "money") ? "abStealNegateMoney" : "abStealNegate", TC);
			break;
		}
		Thing thing6 = null; // [!code --]
		bool flag7 = actRef.n1 == "food"; // [!code --]
		Thing thing4 = null; // [!code ++]
		bool flag6 = actRef.n1 == "food"; // [!code ++]
		if (actRef.n1 == "money")
		{
			int currency = TC.GetCurrency();
			if (currency > 0)
			{
				currency = Mathf.Clamp(EClass.rnd(currency / 10), 1, 100 + EClass.rndHalf(CC.LV * 200));
				thing6 = ThingGen.Create("money").SetNum(currency); // [!code --]
				thing4 = ThingGen.Create("money").SetNum(currency); // [!code ++]
				TC.ModCurrency(-currency);
			}
		}
		else
		{
			Func<Thing, bool> func = (Thing t) => true;
			if (flag7) // [!code --]
			if (flag6) // [!code ++]
			{
				func = (Thing t) => t.IsFood;
			}
			List<Thing> list6 = TC.things.List(delegate(Thing t) // [!code --]
			List<Thing> list3 = TC.things.List(delegate(Thing t) // [!code ++]
			{
				if (t.parentCard?.trait is TraitChestMerchant || t.trait is TraitTool || t.IsThrownWeapon)
				{
```

[`@@ -1402,30 +1402,30 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1402-L1431)
```cs:line-numbers=1402
				}
				return t.trait.CanBeDestroyed && t.things.Count == 0 && t.invY != 1 && t.trait.CanBeStolen && !t.trait.CanOnlyCarry && !t.IsUnique && !t.isEquipped && t.blessedState == BlessedState.Normal && func(t);
			}, onlyAccessible: true);
			if (list6.Count > 0) // [!code --]
			if (list3.Count > 0) // [!code ++]
			{
				thing6 = list6.RandomItem(); // [!code --]
				if (thing6.Num > 1) // [!code --]
				thing4 = list3.RandomItem(); // [!code ++]
				if (thing4.Num > 1) // [!code ++]
				{
					thing6 = thing6.Split(1); // [!code --]
					thing4 = thing4.Split(1); // [!code ++]
				}
			}
			CC.AddCooldown(6640, 200);
		}
		if (thing6 == null) // [!code --]
		if (thing4 == null) // [!code ++]
		{
			CC.Say("abStealNothing", CC, TC);
			break;
		}
		thing6.SetInt(116, 1); // [!code --]
		TC.PlaySound(thing6.material.GetSoundDrop(thing6.sourceCard)); // [!code --]
		CC.Pick(thing6, msg: false); // [!code --]
		CC.Say("abSteal", CC, TC, thing6.Name); // [!code --]
		thing4.SetInt(116, 1); // [!code ++]
		TC.PlaySound(thing4.material.GetSoundDrop(thing4.sourceCard)); // [!code ++]
		CC.Pick(thing4, msg: false); // [!code ++]
		CC.Say("abSteal", CC, TC, thing4.Name); // [!code ++]
		if (actRef.n1 == "food")
		{
			if (CC.hunger.value != 0)
			{
				CC.InstantEat(thing6); // [!code --]
				CC.InstantEat(thing4); // [!code ++]
			}
		}
		else
```

[`@@ -1450,7 +1450,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1450-L1456)
```cs:line-numbers=1450
		{
			break;
		}
		List<Thing> list3 = TC.things.List(delegate(Thing t) // [!code --]
		List<Thing> list5 = TC.things.List(delegate(Thing t) // [!code ++]
		{
			if (!t.isEquipped || t.blessedState == BlessedState.Doomed || t.IsToolbelt)
			{
```

[`@@ -1458,15 +1458,15 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1458-L1472)
```cs:line-numbers=1458
			}
			return (t.blessedState < BlessedState.Blessed || EClass.rnd(10) == 0) ? true : false;
		});
		if (list3.Count == 0) // [!code --]
		if (list5.Count == 0) // [!code ++]
		{
			CC.SayNothingHappans();
			break;
		}
		Thing thing4 = list3.RandomItem(); // [!code --]
		TC.Say("curse_hit", TC, thing4); // [!code --]
		thing4.SetBlessedState((thing4.blessedState == BlessedState.Cursed) ? BlessedState.Doomed : BlessedState.Cursed); // [!code --]
		LayerInventory.SetDirty(thing4); // [!code --]
		Thing thing6 = list5.RandomItem(); // [!code ++]
		TC.Say("curse_hit", TC, thing6); // [!code ++]
		thing6.SetBlessedState((thing6.blessedState == BlessedState.Cursed) ? BlessedState.Doomed : BlessedState.Cursed); // [!code ++]
		LayerInventory.SetDirty(thing6); // [!code ++]
		break;
	}
	case EffectId.UncurseEQ:
```

[`@@ -1572,13 +1572,13 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1572-L1584)
```cs:line-numbers=1572
	{
		EClass.game.religions.Trickery.Talk("ability");
		bool hex2 = CC.IsHostile(TC);
		List<SourceStat.Row> list4 = EClass.sources.stats.rows.Where((SourceStat.Row con) => con.tag.Contains("random") && con.group == (hex2 ? "Debuff" : "Buff")).ToList(); // [!code --]
		List<SourceStat.Row> list6 = EClass.sources.stats.rows.Where((SourceStat.Row con) => con.tag.Contains("random") && con.group == (hex2 ? "Debuff" : "Buff")).ToList(); // [!code ++]
		int power2 = power;
		for (int k = 0; k < 4 + EClass.rnd(2); k++)
		{
			SourceStat.Row row2 = list4.RandomItem(); // [!code --]
			list4.Remove(row2); // [!code --]
			Proc(hex2 ? EffectId.Debuff : EffectId.Buff, CC, TC, power2, new ActRef // [!code --]
			SourceStat.Row row2 = list6.RandomItem(); // [!code ++]
			list6.Remove(row2); // [!code ++]
			Proc(hex2 ? EffectId.DebuffKizuami : EffectId.Buff, CC, TC, power2, new ActRef // [!code ++]
			{
				n1 = row2.alias
			});
```

[`@@ -1590,6 +1590,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1590-L1595)
```cs:line-numbers=1590
		break;
	}
	case EffectId.Debuff:
	case EffectId.DebuffKizuami: // [!code ++]
	{
		CC.DoHostileAction(TC);
		bool isPowerful = TC.IsPowerful;
```

[`@@ -1605,7 +1606,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1605-L1611)
```cs:line-numbers=1605
		{
			num8 += condition3.power * 5;
		}
		if (EClass.rnd(a2) < num8 / EClass.sources.stats.alias[n].hexPower && EClass.rnd(10) != 0) // [!code --]
		if (id != EffectId.DebuffKizuami && EClass.rnd(a2) < num8 / EClass.sources.stats.alias[n].hexPower && EClass.rnd(10) != 0) // [!code ++]
		{
			TC.Say("debuff_resist", TC);
			CC.DoHostileAction(TC);
```

[`@@ -1815,19 +1816,19 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1815-L1833)
```cs:line-numbers=1815
	case EffectId.RestoreBody:
	case EffectId.RestoreMind:
	{
		bool flag6 = id == EffectId.RestoreBody; // [!code --]
		bool flag7 = id == EffectId.RestoreBody; // [!code ++]
		if (flag)
		{
			Redirect(flag6 ? EffectId.DamageBodyGreat : EffectId.DamageMindGreat, BlessedState.Normal, default(ActRef)); // [!code --]
			Redirect(flag7 ? EffectId.DamageBodyGreat : EffectId.DamageMindGreat, BlessedState.Normal, default(ActRef)); // [!code ++]
			break;
		}
		TC.Say(flag6 ? "restoreBody" : "restoreMind", TC); // [!code --]
		TC.Say(flag7 ? "restoreBody" : "restoreMind", TC); // [!code ++]
		TC.PlaySound("heal");
		TC.PlayEffect("heal");
		TC.CureHost(flag6 ? CureType.CureBody : CureType.CureMind, power, state); // [!code --]
		TC.CureHost(flag7 ? CureType.CureBody : CureType.CureMind, power, state); // [!code ++]
		if (blessed)
		{
			Redirect(flag6 ? EffectId.EnhanceBodyGreat : EffectId.EnhanceMindGreat, BlessedState.Normal, default(ActRef)); // [!code --]
			Redirect(flag7 ? EffectId.EnhanceBodyGreat : EffectId.EnhanceMindGreat, BlessedState.Normal, default(ActRef)); // [!code ++]
		}
		break;
	}
```

[`@@ -1857,7 +1858,7 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L1857-L1863)
```cs:line-numbers=1857
			TC.DamageHP(num9 / 2, 919, power);
			break;
		}
		TC.HealHPHost(num9, (actRef.refThing == null) ? HealSource.Magic : HealSource.Item); // [!code --]
		TC.HealHPHost(num9, (actRef.refThing == null && id != EffectId.JureHeal) ? HealSource.Magic : HealSource.Item); // [!code ++]
		TC.CureHost(CureType.Heal, power, state);
		TC.Say((power >= 300) ? "heal_heavy" : "heal_light", TC);
		break;
```

[`@@ -2128,10 +2129,10 @@ public static bool DamageEle(Card CC, EffectId id, int power, Element e, List<Po`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ActEffect.cs#L2128-L2137)
```cs:line-numbers=2128
		{
			power /= 4;
		}
		List<Thing> list5 = TC.things.List((Thing t) => (t.Num <= 1 && t.IsEquipmentOrRanged && !t.IsToolbelt && !t.IsLightsource && t.isEquipped) ? true : false); // [!code --]
		if (list5.Count != 0) // [!code --]
		List<Thing> list4 = TC.things.List((Thing t) => (t.Num <= 1 && t.IsEquipmentOrRanged && !t.IsToolbelt && !t.IsLightsource && t.isEquipped) ? true : false); // [!code ++]
		if (list4.Count != 0) // [!code ++]
		{
			Thing thing5 = list5.RandomItem(); // [!code --]
			Thing thing5 = list4.RandomItem(); // [!code ++]
			TC.Say("acid_hit", TC);
			if (thing5.isAcidproof)
			{
```

## BaseTileMap

[`@@ -298,9 +298,15 @@ public enum ScreenHighlight`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L298-L306)
```cs:line-numbers=298
	[NonSerialized]
	public bool fogged;

	[NonSerialized] // [!code ++]
	public int[] floatVs = new int[10] { 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 }; // [!code ++]
 // [!code ++]
	[NonSerialized]
	public float[] lightLookUp;

	[NonSerialized] // [!code ++]
	public float[] floatYs = new float[10] { 0f, 1f, 2f, 3f, 4f, 5f, 6f, 7f, 8f, 9f }; // [!code ++]
 // [!code ++]
	[NonSerialized]
	public float _lightMod;

```

[`@@ -467,6 +473,8 @@ public enum ScreenHighlight`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L467-L472)
```cs:line-numbers=467

	protected bool showBorder;

	protected bool isUnderwater; // [!code ++]
 // [!code ++]
	protected Vector3 thingPos;

	protected Vector3 orgPos;
```

[`@@ -552,6 +560,7 @@ public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L552-L557)
```cs:line-numbers=552
	cinemaMode = ActionMode.Cinema.IsActive;
	isMining = EMono.scene.actionMode == ActionMode.Mine;
	iconMode = EMono.scene.actionMode.cardIconMode;
	isUnderwater = EMono._zone.IsUnderwater; // [!code ++]
	showAllCards = buildMode;
	highlightCells = ActionMode.FlagCell.IsActive;
	subtleHighlightArea = EMono.scene.actionMode.AreaHihlight != 0 && (EMono.scene.actionMode.AreaHihlight == AreaHighlightMode.Build || EMono.scene.actionMode.AreaHihlight != AreaHighlightMode.Edit);
```

[`@@ -608,16 +617,21 @@ public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L608-L623)
```cs:line-numbers=608
	if (floatTimer > floatSpeed)
	{
		floatTimer -= floatSpeed;
		floatY += floatV; // [!code --]
		if (floatY >= (float)maxFloat) // [!code --]
		{ // [!code --]
			floatV *= -1; // [!code --]
		} // [!code --]
		if (floatY < 0f) // [!code --]
		for (int i = 0; i < floatYs.Length; i++) // [!code ++]
		{
			floatV *= -1; // [!code --]
			floatYs[i] += floatVs[i]; // [!code ++]
			if (floatYs[i] >= (float)maxFloat) // [!code ++]
			{ // [!code ++]
				floatVs[i] = -1; // [!code ++]
			} // [!code ++]
			if (floatYs[i] < 0f) // [!code ++]
			{ // [!code ++]
				floatVs[i] = 1; // [!code ++]
			} // [!code ++]
		}
	}
	floatY = floatYs[0]; // [!code ++]
	floatV = floatVs[0]; // [!code ++]
	waterAnimeTimer += num2;
	if (waterAnimeTimer > 0.5f)
	{
```

[`@@ -854,18 +868,18 @@ public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L854-L871)
```cs:line-numbers=854
	int valueOrDefault = (this.room?.lot?.idBGM).GetValueOrDefault();
	if (valueOrDefault == 0)
	{
		goto IL_1671; // [!code --]
		goto IL_16b9; // [!code ++]
	}
	if (!(EMono.Sound.currentPlaylist != EMono.Sound.plLot))
	{
		BGMData data = EMono.Sound.plLot.list[0].data;
		if ((object)data != null && data.id == valueOrDefault)
		{
			goto IL_1671; // [!code --]
			goto IL_16b9; // [!code ++]
		}
	}
	goto IL_1690; // [!code --]
	IL_169a: // [!code --]
	goto IL_16d8; // [!code ++]
	IL_16e2: // [!code ++]
	if (this.room != lastRoom)
	{
		screen.RefreshWeather();
```

[`@@ -874,15 +888,15 @@ public virtual void Draw()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L874-L888)
```cs:line-numbers=874
		SoundManager.bgmVolumeMod = ((!LayerDrama.maxBGMVolume && !EMono._map.IsIndoor && this.room != null && !this.room.data.atrium && this.room.HasRoof) ? (-0.6f) : 0f);
		screenHighlight = ScreenHighlight.None;
		return;
		IL_1690: // [!code --]
		EMono._zone.RefreshBGM(); // [!code --]
		goto IL_169a; // [!code --]
		IL_1671: // [!code --]
		IL_16b9: // [!code ++]
		if (valueOrDefault == 0 && EMono.Sound.currentPlaylist == EMono.Sound.plLot)
		{
			goto IL_1690; // [!code --]
			goto IL_16d8; // [!code ++]
		}
		goto IL_169a; // [!code --]
		goto IL_16e2; // [!code ++]
		IL_16d8: // [!code ++]
		EMono._zone.RefreshBGM(); // [!code ++]
		goto IL_16e2; // [!code ++]
	}

	public void RefreshHeight()
```

[`@@ -978,7 +992,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L978-L984)
```cs:line-numbers=978
	{
		blockLight -= heightLightMod * (float)(currentHeight - height);
	}
	liquidLv = (param.liquidLv = ((!flag) ? (((this.cell.liquidLv + this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.LiquidLV : sourceFloor.tileType.LiquidLV) * 10) : 0)); // [!code --]
	liquidLv = (param.liquidLv = ((!flag && !isUnderwater) ? (((this.cell.liquidLv + this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.LiquidLV : sourceFloor.tileType.LiquidLV) * 10) : 0)); // [!code ++]
	if (this.cell.shore != 0 && liquidLv > 20)
	{
		liquidLv = (param.liquidLv = 20);
```

[`@@ -1183,7 +1197,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1183-L1189)
```cs:line-numbers=1183
	bool flag4 = this.cell.isSurrounded && innerMode != 0 && sourceBlock.tileType.IsFullBlock;
	if (!(!isSeen || flag4))
	{
		goto IL_167b; // [!code --]
		goto IL_1683; // [!code ++]
	}
	bool isRoomEdge = this.cell.IsRoomEdge;
	orgY = param.y;
```

[`@@ -1245,7 +1259,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1245-L1251)
```cs:line-numbers=1245
	{
		if (isRoomEdge)
		{
			goto IL_167b; // [!code --]
			goto IL_1683; // [!code ++]
		}
		if (detail == null || !EMono.pc.hasTelepathy)
		{
```

[`@@ -1256,591 +1270,142 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1256-L1846)
```cs:line-numbers=1256
			fogged = true;
		}
	}
	goto IL_7b80; // [!code --]
	IL_7b80: // [!code --]
	if (detail.things.Count == 0 && detail.charas.Count == 0) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	int num3 = 0; // [!code --]
	thingPos.x = 0f; // [!code --]
	thingPos.y = 0f; // [!code --]
	thingPos.z = 0f; // [!code --]
	freePos.x = (freePos.y = (freePos.z = 0f)); // [!code --]
	if (this.cell.HasRamp) // [!code --]
	goto IL_7b88; // [!code ++]
	IL_6fcd: // [!code ++]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code ++]
	{
		Vector3 rampFix = sourceBlock.tileType.GetRampFix(this.cell.blockDir); // [!code --]
		param.x += rampFix.x; // [!code --]
		param.y += rampFix.y; // [!code --]
		param.z += rampFix.z; // [!code --]
		freePos.x += rampFix.x; // [!code --]
		freePos.y += rampFix.y; // [!code --]
		freePos.z += rampFix.z; // [!code --]
		snowed = true; // [!code ++]
	}
	param.y += (flag ? 0f : ((this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight)); // [!code --]
	orgPos.x = (orgX = param.x); // [!code --]
	orgPos.y = (orgY = param.y); // [!code --]
	orgPos.z = (orgZ = param.z); // [!code --]
	if (flag && liquidLv > 0) // [!code --]
	if (this.cell.effect != null) // [!code ++]
	{
		if (liquidLv > 10) // [!code --]
		if (this.cell.effect.IsLiquid) // [!code ++]
		{
			liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code ++]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code ++]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code ++]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code ++]
			param.mat = defaultMaterial; // [!code ++]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code ++]
			sourceEffect.renderData.Draw(param); // [!code ++]
		}
		liquidLv -= (int)(floatY * 0.5f); // [!code --]
		param.liquidLv = liquidLv; // [!code --]
		param.y -= TileType.FloorWaterShallow.FloorHeight; // [!code --]
	} // [!code --]
	Thing thing = null; // [!code --]
	bool shadow = liquidLv == 0; // [!code --]
	float num4 = 0f; // [!code --]
	float num5 = 0f; // [!code --]
	bool flag6 = false; // [!code --]
	float num6 = 0f; // [!code --]
	bool flag7 = false; // [!code --]
	float num7 = 0f; // [!code --]
	if (detail.things.Count > 0 && isSeen) // [!code --]
	{ // [!code --]
		_ = zSetting.max1; // [!code --]
		float num8 = 0f; // [!code --]
		for (int j = 0; j < detail.things.Count; j++) // [!code --]
		else // [!code ++]
		{
			Thing t = detail.things[j]; // [!code --]
			if ((fogged && !t.isRoofItem) || ((t.isHidden || t.trait.HideInAdv || t.isMasked) && !EMono.scene.actionMode.ShowMaskedThings) || (t.isRoofItem && ((this.room == null && !sourceBlock.tileType.IsFullBlock && !EMono._zone.IsPCFaction) || (lowBlock && !showFullWall && this.room != null) || (noRoofMode && currentRoom == null))) || (flag3 && !t.isRoofItem)) // [!code --]
			{ // [!code --]
				continue; // [!code --]
			} // [!code --]
			TileType tileType = t.trait.tileType; // [!code --]
			bool isInstalled = t.IsInstalled; // [!code --]
			SourcePref pref = t.Pref; // [!code --]
			if (!isInstalled && t.category.tileDummy != 0) // [!code --]
			{ // [!code --]
				pref = rendererObjDummy.shadowPref; // [!code --]
			} // [!code --]
			float num9 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code --]
			if (t.ignoreStackHeight) // [!code --]
			{ // [!code --]
				thingPos.y -= num4; // [!code --]
			} // [!code --]
			shadow = thingPos.y < 0.16f && num7 < 0.16f; // [!code --]
			_ = pref.bypassShadow; // [!code --]
			param.shadowFix = 0f - thingPos.y; // [!code --]
			param.liquidLv = ((thingPos.y + (float)t.altitude < 0.1f) ? liquidLv : 0); // [!code --]
			if (t.isRoofItem) // [!code --]
			{ // [!code --]
				param.snow = isSnowCovered && !this.cell.isClearSnow; // [!code --]
				SetRoofHeight(param, this.cell, cx, cz); // [!code --]
				_actorPos.x = param.x; // [!code --]
				_actorPos.y = param.y; // [!code --]
				_actorPos.z = param.z + num8; // [!code --]
				if (this.room != null) // [!code --]
				{ // [!code --]
					param.color = GetRoofLight(this.room.lot); // [!code --]
				} // [!code --]
				shadow = false; // [!code --]
				param.liquidLv = 0; // [!code --]
			} // [!code --]
			else // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code ++]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code ++]
			if (sourceEffect2.anime.Length != 0) // [!code ++]
			{
				param.snow = snowed; // [!code --]
				_actorPos.x = orgX + num5; // [!code --]
				_actorPos.y = orgY; // [!code --]
				_actorPos.z = orgZ + num8 + thingPos.z; // [!code --]
				if (tileType.CanStack || !isInstalled) // [!code --]
				{ // [!code --]
					if (thing?.id != t.id) // [!code --]
					{ // [!code --]
						_actorPos.x += thingPos.x; // [!code --]
					} // [!code --]
					_actorPos.y += thingPos.y; // [!code --]
					if (t.trait.IgnoreLastStackHeight && (thing == null || !thing.trait.IgnoreLastStackHeight)) // [!code --]
					{ // [!code --]
						thingPos.y -= num4; // [!code --]
						if (thing != null) // [!code --]
						{ // [!code --]
							_actorPos.z -= 0.2f; // [!code --]
							thingPos.z -= 0.2f; // [!code --]
						} // [!code --]
						_actorPos.y -= num4; // [!code --]
					} // [!code --]
					_actorPos.z += renderSetting.thingZ + (float)j * -0.01f + zSetting.mod1 * thingPos.y; // [!code --]
				} // [!code --]
				if (isInstalled) // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code ++]
				{
					if (t.TileType.IsRamp) // [!code --]
					{ // [!code --]
						Vector3 rampFix2 = t.TileType.GetRampFix(t.dir, pref); // [!code --]
						orgX += rampFix2.x; // [!code --]
						orgY += rampFix2.y; // [!code --]
						orgZ += rampFix2.z; // [!code --]
						freePos.x += rampFix2.x; // [!code --]
						freePos.y += rampFix2.y; // [!code --]
						freePos.z += rampFix2.z; // [!code --]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code --]
						{ // [!code --]
							num7 += rampFix2.y; // [!code --]
						} // [!code --]
						liquidLv -= (int)(rampFix2.y * 150f); // [!code --]
						if (liquidLv < 0) // [!code --]
						{ // [!code --]
							liquidLv = 0; // [!code --]
						} // [!code --]
					} // [!code --]
					else if (!flag7 && t.trait.IsChangeFloorHeight && !t.ignoreStackHeight) // [!code --]
					{ // [!code --]
						orgY += num9 + (float)t.altitude * altitudeFix.y; // [!code --]
						orgZ += (float)t.altitude * altitudeFix.z; // [!code --]
						freePos.y += num9 + (float)t.altitude * altitudeFix.y; // [!code --]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code --]
						{ // [!code --]
							num7 += num9 + (float)t.altitude * altitudeFix.y; // [!code --]
						} // [!code --]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
						_actorPos.z += pref.z; // [!code --]
						thingPos.z += pref.z; // [!code --]
						liquidLv -= (int)(num9 * 150f); // [!code --]
						if (liquidLv < 0) // [!code --]
						{ // [!code --]
							liquidLv = 0; // [!code --]
						} // [!code --]
					} // [!code --]
					else // [!code --]
					{ // [!code --]
						thingPos.y += num9; // [!code --]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
						_actorPos.z += pref.z; // [!code --]
						if (pref.height >= 0f) // [!code --]
						{ // [!code --]
							thingPos.z += pref.z; // [!code --]
						} // [!code --]
					} // [!code --]
					if (!tileType.UseMountHeight && j > 10) // [!code --]
					float num3 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code ++]
					if (!(num3 >= (float)sourceEffect2.anime[0])) // [!code ++]
					{
						flag7 = true; // [!code --]
						param.tile += num3; // [!code ++]
					}
				}
				else
				{
					thingPos.y += num9; // [!code --]
					_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
					_actorPos.z += pref.z; // [!code --]
					thingPos.z += pref.z; // [!code --]
					float num4 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code ++]
					param.tile += num4; // [!code ++]
				}
				if (t.isFloating && isWater && !hasBridge && !flag) // [!code --]
			} // [!code ++]
			if (this.cell.effect.IsFire) // [!code ++]
			{ // [!code ++]
				rendererEffect.Draw(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				this.cell.effect.source.renderData.Draw(param); // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	param.color = floorLight; // [!code ++]
	if (this.cell.critter != null) // [!code ++]
	{ // [!code ++]
		Critter critter = this.cell.critter; // [!code ++]
		int snowTile = critter.tile; // [!code ++]
		if (snowed && critter.SnowTile != 0) // [!code ++]
		{ // [!code ++]
			critter.x = 0.06f; // [!code ++]
			critter.y = -0.06f; // [!code ++]
			snowTile = critter.SnowTile; // [!code ++]
		} // [!code ++]
		else // [!code ++]
		{ // [!code ++]
			critter.Update(); // [!code ++]
		} // [!code ++]
		pass = passObjSS; // [!code ++]
		batch = pass.batches[pass.batchIdx]; // [!code ++]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code ++]
		batch.matrices[pass.idx].m23 = param.z; // [!code ++]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code ++]
		batch.colors[pass.idx] = floorLight; // [!code ++]
		pass.idx++; // [!code ++]
		if (pass.idx == pass.batchSize) // [!code ++]
		{ // [!code ++]
			pass.NextBatch(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (detail != null) // [!code ++]
	{ // [!code ++]
		TransAnime anime3 = detail.anime; // [!code ++]
		if (anime3 != null && !anime3.animeBlock) // [!code ++]
		{ // [!code ++]
			TransAnime anime4 = detail.anime; // [!code ++]
			param.x += anime4.v.x; // [!code ++]
			param.y += anime4.v.y; // [!code ++]
			param.z += anime4.v.z; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code ++]
	{ // [!code ++]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code ++]
		if (!snowed || sourceObj.snowTile <= 0) // [!code ++]
		{ // [!code ++]
			param.snow = snowed; // [!code ++]
			param.mat = this.cell.matObj; // [!code ++]
			orgY = param.y; // [!code ++]
			if (param.liquidLv > 0) // [!code ++]
			{ // [!code ++]
				if (sourceObj.pref.Float) // [!code ++]
				{
					flag = true; // [!code --]
					float num10 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
					orgY += 0.01f * floatY - num10; // [!code --]
					num6 = num9; // [!code --]
					_actorPos.y += 0.01f * floatY - num10; // [!code --]
					param.y += 0.01f * floatY; // [!code ++]
					if (liquidLv > 10)
					{
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10;
					}
					liquidLv -= (int)(floatY * 0.5f);
					if (liquidLv < 0) // [!code --]
					{ // [!code --]
						liquidLv = 0; // [!code --]
					} // [!code --]
					param.liquidLv = liquidLv;
				}
				num4 = num9; // [!code --]
				if (t.sourceCard.multisize && !t.trait.IsGround) // [!code --]
				if (sourceObj.tileType.IsWaterTop) // [!code ++]
				{
					num8 += zSetting.multiZ; // [!code --]
					param.liquidLv = 0; // [!code ++]
				}
				orgZ += t.renderer.data.stackZ; // [!code --]
				if (param.liquidLv > 0) // [!code --]
				else // [!code ++]
				{
					param.liquidLv += pref.liquidMod; // [!code --]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1)
					{
						param.liquidLv = 1; // [!code --]
						param.liquid = 1f; // [!code ++]
					}
					else if (param.liquidLv > 99 + pref.liquidModMax) // [!code --]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code ++]
					{
						param.liquidLv = 99 + pref.liquidModMax; // [!code --]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code ++]
					}
				}
			}
			if (isInstalled && tileType.UseMountHeight) // [!code --]
			if (sourceObj.useAltColor) // [!code ++]
			{
				if (tileType != TileType.Illumination || !this.cell.HasObj) // [!code --]
				{ // [!code --]
					if (noRoofMode && currentRoom == null && t.altitude >= lowWallObjAltitude) // [!code --]
					{ // [!code --]
						continue; // [!code --]
					} // [!code --]
					if (hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code --]
					{ // [!code --]
						Room room = ((t.dir == 0) ? this.cell.Back.room : this.cell.Left.room); // [!code --]
						if (t.trait.AlwaysHideOnLowWall) // [!code --]
						{ // [!code --]
							if (room == null || !room.data.showWallItem) // [!code --]
							{ // [!code --]
								continue; // [!code --]
							} // [!code --]
						} // [!code --]
						else if (t.altitude >= lowWallObjAltitude) // [!code --]
						{ // [!code --]
							continue; // [!code --]
						} // [!code --]
					} // [!code --]
				} // [!code --]
				if (tileType.UseHangZFix) // [!code --]
				{ // [!code --]
					flag6 = true; // [!code --]
				} // [!code --]
				tileType.GetMountHeight(ref _actorPos, Point.shared.Set(index), t.dir, t); // [!code --]
				shadow = false; // [!code --]
				param.liquidLv = 0; // [!code --]
				if (t.freePos) // [!code --]
				{ // [!code --]
					_actorPos.x += t.fx; // [!code --]
					_actorPos.y += t.fy; // [!code --]
				} // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				if (t.altitude != 0) // [!code --]
				{ // [!code --]
					_actorPos += altitudeFix * t.altitude; // [!code --]
					if (t.altitude > 2 && ((this.cell.Back.room != null && this.cell.Back.IsRoomEdge) || (this.cell.Left.room != null && this.cell.Left.IsRoomEdge)) && hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code --]
					{ // [!code --]
						continue; // [!code --]
					} // [!code --]
				} // [!code --]
				if (t.freePos) // [!code --]
				{ // [!code --]
					_actorPos.x = orgX + t.fx - freePos.x; // [!code --]
					_actorPos.y = orgY + t.fy - freePos.y; // [!code --]
				} // [!code --]
				if (t.trait is TraitDoor && (t.trait as TraitDoor).IsOpen()) // [!code --]
				{ // [!code --]
					_actorPos.z += -0.5f; // [!code --]
				} // [!code --]
			} // [!code --]
			if (!t.sourceCard.multisize || (t.pos.x == cx && t.pos.z == cz)) // [!code --]
			{ // [!code --]
				if (iconMode != 0) // [!code --]
				{ // [!code --]
					int num11 = 0; // [!code --]
					switch (iconMode) // [!code --]
					{ // [!code --]
					case CardIconMode.Visibility: // [!code --]
						if (t.isMasked) // [!code --]
						{ // [!code --]
							num11 = 17; // [!code --]
						} // [!code --]
						break; // [!code --]
					case CardIconMode.State: // [!code --]
						if (t.placeState == PlaceState.installed) // [!code --]
						{ // [!code --]
							num11 = 18; // [!code --]
						} // [!code --]
						break; // [!code --]
					case CardIconMode.Deconstruct: // [!code --]
						if (t.isDeconstructing) // [!code --]
						{ // [!code --]
							num11 = 14; // [!code --]
						} // [!code --]
						break; // [!code --]
					} // [!code --]
					if (t.isNPCProperty && !EMono.debug.godBuild) // [!code --]
					{ // [!code --]
						num11 = 13; // [!code --]
					} // [!code --]
					if (num11 != 0) // [!code --]
					{ // [!code --]
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num11); // [!code --]
					} // [!code --]
				} // [!code --]
				t.SetRenderParam(param); // [!code --]
				if (_lowblock && t.trait.UseLowblock && !this.cell.HasFullBlock) // [!code --]
				{ // [!code --]
					param.tile += ((param.tile < 0f) ? (-64) : 64); // [!code --]
				} // [!code --]
				if (t.trait is TraitTrolley && EMono.pc.ai is AI_Trolley aI_Trolley && aI_Trolley.trolley.owner == t) // [!code --]
				{ // [!code --]
					RenderParam _param = new RenderParam(param); // [!code --]
					EMono.core.actionsLateUpdate.Add(delegate // [!code --]
					{ // [!code --]
						t.SetRenderParam(_param); // [!code --]
						_actorPos.x = EMono.pc.renderer.position.x; // [!code --]
						_actorPos.y = EMono.pc.renderer.position.y - pref.height; // [!code --]
						_actorPos.z = EMono.pc.renderer.position.z + 0.02f; // [!code --]
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code --]
					}); // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code --]
				} // [!code --]
			} // [!code --]
			if (isInstalled) // [!code --]
			{ // [!code --]
				num5 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code --]
			} // [!code --]
			param.x = orgX; // [!code --]
			param.y = orgY; // [!code --]
			param.z = orgZ; // [!code --]
			param.color = floorLight; // [!code --]
			thing = t; // [!code --]
			if (pref.Float) // [!code --]
			{ // [!code --]
				liquidLv = 0; // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	orgY += num6; // [!code --]
	if (detail.charas.Count <= 0) // [!code --]
	{ // [!code --]
		return; // [!code --]
	} // [!code --]
	param.shadowFix = 0f - num7; // [!code --]
	param.color += 1310720f; // [!code --]
	float max = zSetting.max2; // [!code --]
	for (int k = 0; k < detail.charas.Count; k++) // [!code --]
	{ // [!code --]
		Chara chara = detail.charas[k]; // [!code --]
		if (chara.host != null || (chara != EMono.pc && chara != LayerDrama.alwaysVisible && (flag3 || fogged || (!showAllCards && !EMono.player.CanSee(chara))))) // [!code --]
		{ // [!code --]
			continue; // [!code --]
		} // [!code --]
		_actorPos.x = orgX; // [!code --]
		_actorPos.y = orgY; // [!code --]
		_actorPos.z = orgZ; // [!code --]
		chara.SetRenderParam(param); // [!code --]
		_ = chara.IsAliveInCurrentZone; // [!code --]
		if (chara.isRestrained) // [!code --]
		{ // [!code --]
			TraitShackle restrainer = chara.GetRestrainer(); // [!code --]
			if (restrainer != null) // [!code --]
			{ // [!code --]
				Vector3 getRestrainPos = restrainer.GetRestrainPos; // [!code --]
				if (getRestrainPos != default(Vector3)) // [!code --]
				{ // [!code --]
					Vector3 position = restrainer.owner.renderer.position; // [!code --]
					float defCharaHeight = EMono.setting.render.defCharaHeight; // [!code --]
					float num12 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code --]
					_actorPos.x = position.x + getRestrainPos.x * (float)((restrainer.owner.dir % 2 == 0) ? 1 : (-1)); // [!code --]
					_actorPos.y = position.y + num12; // [!code --]
					_actorPos.z = position.z + getRestrainPos.z; // [!code --]
					param.liquidLv = 0; // [!code --]
					param.shadowFix = orgY - _actorPos.y; // [!code --]
					chara.renderer.SetFirst(first: true); // [!code --]
					chara.renderer.Draw(param, ref _actorPos, drawShadow: true); // [!code --]
					param.shadowFix = 0f; // [!code --]
					continue; // [!code --]
				} // [!code --]
			} // [!code --]
		} // [!code --]
		if (!chara.sourceCard.multisize || (chara.pos.x == cx && chara.pos.z == cz)) // [!code --]
		{ // [!code --]
			if (chara.IsDeadOrSleeping && chara.IsPCC) // [!code --]
			{ // [!code --]
				float num13 = chara.renderer.data.size.y * 0.3f; // [!code --]
				if (thingPos.y > max) // [!code --]
				{ // [!code --]
					thingPos.y = max; // [!code --]
				} // [!code --]
				float num14 = thingPos.y + num13; // [!code --]
				float num15 = (float)k * -0.01f; // [!code --]
				if (num14 > zSetting.thresh1) // [!code --]
				{ // [!code --]
					num15 = zSetting.mod1; // [!code --]
				} // [!code --]
				_actorPos.x += thingPos.x; // [!code --]
				_actorPos.y += thingPos.y; // [!code --]
				_actorPos.z += renderSetting.laydownZ + num15; // [!code --]
				param.liquidLv = ((thingPos.y == 0f && liquidLv > 0) ? 90 : 0); // [!code --]
				thingPos.y += num13 * 0.8f; // [!code --]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.liquidLv = liquidLv; // [!code --]
				if (liquidLv > 0) // [!code --]
				{ // [!code --]
					if (chara.Pref.Float && !flag && !hasBridge) // [!code --]
					{ // [!code --]
						if (liquidLv > 20) // [!code --]
						{ // [!code --]
							float num16 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code --]
							orgY += 0.01f * floatY - num16; // [!code --]
							_actorPos.y += 0.01f * floatY - num16; // [!code --]
							int num17 = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
							num17 -= (int)(floatY * 0.5f); // [!code --]
							param.liquidLv = num17; // [!code --]
						} // [!code --]
						else // [!code --]
						{ // [!code --]
							param.liquidLv -= 20; // [!code --]
						} // [!code --]
					} // [!code --]
					param.liquidLv += chara.Pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					{ // [!code --]
						param.liquidLv = 1; // [!code --]
					} // [!code --]
					else if (param.liquidLv > 99 + chara.Pref.liquidModMax) // [!code --]
					{ // [!code --]
						param.liquidLv = 99 + chara.Pref.liquidModMax; // [!code --]
					} // [!code --]
				} // [!code --]
				if (!chara.IsPC && !chara.renderer.IsMoving && detail.charas.Count > 1 && (detail.charas.Count != 2 || !detail.charas[0].IsDeadOrSleeping || !detail.charas[0].IsPCC)) // [!code --]
				{ // [!code --]
					_actorPos += renderSetting.charaPos[1 + ((num3 < 4) ? num3 : 3)]; // [!code --]
				} // [!code --]
				_actorPos.z += 0.01f * (float)k + renderSetting.charaZ; // [!code --]
				num3++; // [!code --]
				if (flag6) // [!code --]
				{ // [!code --]
					_actorPos.z += chara.renderer.data.hangedFixZ; // [!code --]
				} // [!code --]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code --]
			} // [!code --]
		} // [!code --]
		param.x = orgX; // [!code --]
		param.y = orgY; // [!code --]
		param.z = orgZ; // [!code --]
	} // [!code --]
	return; // [!code --]
	IL_6fc5: // [!code --]
	if (isSnowCovered && (sourceBlock.id != 0 || this.cell.hasDoor) && !snowed && !this.cell.isClearSnow && ((!this.cell.Front.HasRoof && !this.cell.Front.HasBlock) || (!this.cell.Right.HasRoof && !this.cell.Right.HasBlock))) // [!code --]
	{ // [!code --]
		snowed = true; // [!code --]
	} // [!code --]
	if (this.cell.effect != null) // [!code --]
	{ // [!code --]
		if (this.cell.effect.IsLiquid) // [!code --]
		{ // [!code --]
			SourceCellEffect.Row sourceEffect = this.cell.sourceEffect; // [!code --]
			SourceMaterial.Row defaultMaterial = sourceEffect.DefaultMaterial; // [!code --]
			tile = 4 + Rand.bytes[index % Rand.MaxBytes] % 4; // [!code --]
			param.tile = tile + this.cell.sourceEffect._tiles[0]; // [!code --]
			param.mat = defaultMaterial; // [!code --]
			param.matColor = ((this.cell.effect.color == 0) ? GetColorInt(ref defaultMaterial.matColor, sourceEffect.colorMod) : this.cell.effect.color); // [!code --]
			sourceEffect.renderData.Draw(param); // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			param.tile = this.cell.effect.source._tiles[0]; // [!code --]
			SourceCellEffect.Row sourceEffect2 = this.cell.sourceEffect; // [!code --]
			if (sourceEffect2.anime.Length != 0) // [!code --]
			{ // [!code --]
				if (sourceEffect2.anime.Length > 2) // [!code --]
				{ // [!code --]
					float num18 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[2]; // [!code --]
					if (!(num18 >= (float)sourceEffect2.anime[0])) // [!code --]
					{ // [!code --]
						param.tile += num18; // [!code --]
					} // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					float num19 = Time.realtimeSinceStartup * 1000f / (float)sourceEffect2.anime[1] % (float)sourceEffect2.anime[0]; // [!code --]
					param.tile += num19; // [!code --]
				} // [!code --]
			} // [!code --]
			if (this.cell.effect.IsFire) // [!code --]
			{ // [!code --]
				rendererEffect.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				this.cell.effect.source.renderData.Draw(param); // [!code --]
			} // [!code --]
		} // [!code --]
	} // [!code --]
	param.color = floorLight; // [!code --]
	if (this.cell.critter != null) // [!code --]
	{ // [!code --]
		Critter critter = this.cell.critter; // [!code --]
		int snowTile = critter.tile; // [!code --]
		if (snowed && critter.SnowTile != 0) // [!code --]
		{ // [!code --]
			critter.x = 0.06f; // [!code --]
			critter.y = -0.06f; // [!code --]
			snowTile = critter.SnowTile; // [!code --]
		} // [!code --]
		else // [!code --]
		{ // [!code --]
			critter.Update(); // [!code --]
		} // [!code --]
		pass = passObjSS; // [!code --]
		batch = pass.batches[pass.batchIdx]; // [!code --]
		batch.matrices[pass.idx].m03 = param.x + (float)(int)(critter.x * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m13 = param.y + (float)(int)(critter.y * 100f) * 0.01f; // [!code --]
		batch.matrices[pass.idx].m23 = param.z; // [!code --]
		batch.tiles[pass.idx] = snowTile * ((!critter.reverse) ? 1 : (-1)); // [!code --]
		batch.colors[pass.idx] = floorLight; // [!code --]
		pass.idx++; // [!code --]
		if (pass.idx == pass.batchSize) // [!code --]
		{ // [!code --]
			pass.NextBatch(); // [!code --]
		} // [!code --]
	} // [!code --]
	if (detail != null) // [!code --]
	{ // [!code --]
		TransAnime anime3 = detail.anime; // [!code --]
		if (anime3 != null && !anime3.animeBlock) // [!code --]
		{ // [!code --]
			TransAnime anime4 = detail.anime; // [!code --]
			param.x += anime4.v.x; // [!code --]
			param.y += anime4.v.y; // [!code --]
			param.z += anime4.v.z; // [!code --]
		} // [!code --]
	} // [!code --]
	if (this.cell.obj != 0 && !this.cell.sourceObj.renderData.SkipOnMap) // [!code --]
	{ // [!code --]
		SourceObj.Row sourceObj = this.cell.sourceObj; // [!code --]
		if (!snowed || sourceObj.snowTile <= 0) // [!code --]
		{ // [!code --]
			param.snow = snowed; // [!code --]
			param.mat = this.cell.matObj; // [!code --]
			orgY = param.y; // [!code --]
			if (param.liquidLv > 0) // [!code --]
			{ // [!code --]
				if (sourceObj.pref.Float) // [!code --]
				{ // [!code --]
					param.y += 0.01f * floatY; // [!code --]
					if (liquidLv > 10) // [!code --]
					{ // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code --]
					} // [!code --]
					liquidLv -= (int)(floatY * 0.5f); // [!code --]
					param.liquidLv = liquidLv; // [!code --]
				} // [!code --]
				if (sourceObj.tileType.IsWaterTop) // [!code --]
				{ // [!code --]
					param.liquidLv = 0; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					param.liquidLv += sourceObj.pref.liquidMod; // [!code --]
					if (param.liquidLv < 1) // [!code --]
					{ // [!code --]
						param.liquid = 1f; // [!code --]
					} // [!code --]
					else if (param.liquidLv > 99 + sourceObj.pref.liquidModMax) // [!code --]
					{ // [!code --]
						param.liquidLv = 99 + sourceObj.pref.liquidModMax; // [!code --]
					} // [!code --]
				} // [!code --]
			} // [!code --]
			if (sourceObj.useAltColor) // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code --]
			} // [!code --]
			if (sourceObj.HasGrowth) // [!code --]
			{ // [!code --]
				this.cell.growth.OnRenderTileMap(param); // [!code --]
				if (this.cell.obj == 118 && Core.fixedFrame % 10f == 0f && sourceObj.growth.IsMature) // [!code --]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				param.matColor = ((sourceObj.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, sourceObj.colorMod)); // [!code ++]
			} // [!code ++]
			if (sourceObj.HasGrowth) // [!code ++]
			{ // [!code ++]
				this.cell.growth.OnRenderTileMap(param); // [!code ++]
				if (this.cell.obj == 118 && Core.fixedFrame % 10f == 0f && sourceObj.growth.IsMature) // [!code ++]
				{
					EMono.scene.psFey.transform.position = new Vector3(param.x, param.y, param.z - 2f);
					EMono.scene.psFey.Emit(1);
```

[`@@ -1929,19 +1494,11 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1929-L1947)
```cs:line-numbers=1929
		param.matColor = 104025f;
		renderFootmark.Draw(param);
	}
	goto IL_7b80; // [!code --]
	IL_6f65: // [!code --]
	int num20; // [!code --]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code --]
	{ // [!code --]
		param.tile = num20; // [!code --]
		rendererFov.Draw(param); // [!code --]
	} // [!code --]
	goto IL_6fc5; // [!code --]
	IL_167b: // [!code --]
	goto IL_7b88; // [!code ++]
	IL_1683: // [!code ++]
	if (this.cell.isSlopeEdge)
	{
		float num21 = (float)height * _heightMod.y; // [!code --]
		float num5 = (float)height * _heightMod.y; // [!code ++]
		orgY = param.y;
		orgZ = param.z;
		param.dir = this.cell.blockDir;
```

[`@@ -1971,17 +1528,17 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1971-L1987)
```cs:line-numbers=1971
				param.matColor = 104025f;
			}
		}
		for (int l = 0; (float)l < num21 / heightBlockSize; l++) // [!code --]
		for (int j = 0; (float)j < num5 / heightBlockSize; j++) // [!code ++]
		{
			param.y += ugFix.y;
			param.z += ugFix.z + slopeFixZ * (float)l; // [!code --]
			param.z += ugFix.z + slopeFixZ * (float)j; // [!code ++]
			defBlock.renderData.Draw(param);
			if (this.cell.pcSync && EMono.player.lightPower > 0f)
			{
				float num22 = param.tile; // [!code --]
				float num6 = param.tile; // [!code ++]
				param.tile = 0f;
				rendererFov.Draw(param);
				param.tile = num22; // [!code --]
				param.tile = num6; // [!code ++]
			}
		}
		param.y = orgY;
```

[`@@ -1992,29 +1549,29 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L1992-L2020)
```cs:line-numbers=1992
	{
		orgY = param.y;
		orgZ = param.z;
		int num23 = 0; // [!code --]
		int num7 = 0; // [!code ++]
		if (sourceBlock.tileType.IsFullBlock)
		{
			SourceBlock.Row row3 = sourceBlock;
			num23 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			num7 = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
		}
		else
		{
			SourceBlock.Row row3 = sourceFloor._defBlock;
			num23 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code --]
			num7 = row3._tiles[this.cell.blockDir % row3._tiles.Length]; // [!code ++]
		}
		if (((this.cell.Front.shore / 12) & 1) == 0 && this.cell.Front.sourceFloor.tileType.IsWater && this.cell.Front.height <= height && this.cell.Front.sourceBlock.tileType.RenderWaterBlock)
		{
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Front.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Front.height * _heightMod.y;
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z;
			param.tile = num23 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			param.tile = num7 + ((!this.cell.Front.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param);
		}
		if (((this.cell.Right.shore / 12) & 8) == 0 && this.cell.Right.sourceFloor.tileType.IsWater && this.cell.Right.height <= height && this.cell.Right.sourceBlock.tileType.RenderWaterBlock)
		{
			param.y = (float)(cz - cx) * screen.tileAlign.y - (this.cell.Right.sourceFloor.tileType.IsDeepWater ? 0.6f : 0.4f) + (float)(int)this.cell.Right.height * _heightMod.y;
			param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z;
			param.tile = num23 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code --]
			param.tile = num7 + ((!this.cell.Right.sourceFloor.tileType.IsDeepWater) ? 3000000 : 0); // [!code ++]
			rendererWaterBlock.Draw(param);
		}
		param.y = orgY;
```

[`@@ -2055,10 +1612,10 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2055-L2064)
```cs:line-numbers=2055
		{
			param.matColor = 104025f;
		}
		for (int m = 0; m < ((!this.cell.isSkyFloor) ? 1 : EMono._map.config.skyBlockHeight); m++) // [!code --]
		for (int k = 0; k < ((!this.cell.isSkyFloor) ? 1 : EMono._map.config.skyBlockHeight); k++) // [!code ++]
		{
			param.y += ugFix.y;
			param.z += ugFix.z + slopeFixZ * (float)m; // [!code --]
			param.z += ugFix.z + slopeFixZ * (float)k; // [!code ++]
			defBlock2.renderData.Draw(param);
		}
		param.y = orgY;
```

[`@@ -2112,20 +1669,20 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2112-L2131)
```cs:line-numbers=2112
				}
				sourceFloor.renderData.Draw(param);
			}
			int num24 = 0; // [!code --]
			int num8 = 0; // [!code ++]
			if (isSnowCovered && sourceFloor == FLOOR.sourceSnow && !this.cell.hasDoor)
			{
				if (!this.cell.Right.IsSnowTile && this.cell.Right.topHeight == this.cell.topHeight)
				{
					num24++; // [!code --]
					num8++; // [!code ++]
				}
				if (!this.cell.Front.IsSnowTile && this.cell.Front.topHeight == this.cell.topHeight)
				{
					num24 += 2; // [!code --]
					num8 += 2; // [!code ++]
				}
				if (num24 != 0) // [!code --]
				if (num8 != 0) // [!code ++]
				{
					param.tile = 448 + num24 + 12; // [!code --]
					param.tile = 448 + num8 + 12; // [!code ++]
					param.z -= 0.1f;
					sourceFloor.renderData.Draw(param);
					param.z += 0.1f;
```

[`@@ -2196,7 +1753,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2196-L2202)
```cs:line-numbers=2196
					}
				}
			}
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num24 == 0) // [!code --]
			if (this.cell.autotile != 0 && sourceFloor.autotile != 0 && (!hasBridge || this.cell.bridgeHeight - this.cell.height > 3) && !this.cell.skipRender && num8 == 0) // [!code ++]
			{
				pass = (isWater ? passAutoTileWater : passAutoTile);
				batch = pass.batches[pass.batchIdx];
```

[`@@ -2215,16 +1772,16 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2215-L2230)
```cs:line-numbers=2215
		}
		if (isWater)
		{
			int num25 = 12; // [!code --]
			int num26 = this.cell.shore / num25; // [!code --]
			int num27 = this.cell.shore % num25; // [!code --]
			int num9 = 12; // [!code ++]
			int num10 = this.cell.shore / num9; // [!code ++]
			int num11 = this.cell.shore % num9; // [!code ++]
			bool isShoreSand = this.cell.isShoreSand;
			if (this.cell.shore != 0)
			{
				Cell cell = ((((uint)num26 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num26 & 2u) != 0) ? this.cell.Right : ((((uint)num26 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code --]
				Cell cell = ((((uint)num10 & (true ? 1u : 0u)) != 0) ? this.cell.Back : ((((uint)num10 & 2u) != 0) ? this.cell.Right : ((((uint)num10 & 4u) != 0) ? this.cell.Front : this.cell.Left))); // [!code ++]
				if (isShoreSand && !cell.sourceFloor.isBeach)
				{
					cell = ((((uint)num26 & 8u) != 0) ? this.cell.Left : ((((uint)num26 & 4u) != 0) ? this.cell.Front : ((((uint)num26 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code --]
					cell = ((((uint)num10 & 8u) != 0) ? this.cell.Left : ((((uint)num10 & 4u) != 0) ? this.cell.Front : ((((uint)num10 & 2u) != 0) ? this.cell.Right : this.cell.Back))); // [!code ++]
				}
				if (!cell.IsSnowTile)
				{
```

[`@@ -2236,7 +1793,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2236-L2242)
```cs:line-numbers=2236
						batch.matrices[pass.idx].m03 = param.x;
						batch.matrices[pass.idx].m13 = param.y;
						batch.matrices[pass.idx].m23 = param.z;
						batch.tiles[pass.idx] = 768 + this.cell.shore / num25; // [!code --]
						batch.tiles[pass.idx] = 768 + this.cell.shore / num9; // [!code ++]
						batch.colors[pass.idx] = param.color;
						batch.matColors[pass.idx] = param.matColor;
						pass.idx++;
```

[`@@ -2244,38 +1801,38 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2244-L2281)
```cs:line-numbers=2244
						{
							pass.NextBatch();
						}
						num27 = 2; // [!code --]
						num11 = 2; // [!code ++]
					}
					else
					{
						num27 = cell.sourceFloor.edge; // [!code --]
						num11 = cell.sourceFloor.edge; // [!code ++]
					}
					param.tile = (24 + num27 / 2) * 32 + num27 % 2 * 16 + num26; // [!code --]
					param.tile = (24 + num11 / 2) * 32 + num11 % 2 * 16 + num10; // [!code ++]
					rendererShore.Draw(param);
				}
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num25) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num25) & (true ? 1u : 0u)) != 0) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num9) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num9) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				param.tile = 785f;
				param.matColor = GetColorInt(ref this.cell.BackLeft.matFloor.matColor, this.cell.BackLeft.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(60);
			}
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num25) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num25) & (true ? 1u : 0u)) != 0) // [!code --]
			if (this.cell.Back.isShoreSand && ((uint)(this.cell.Back.shore / num9) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num9) & (true ? 1u : 0u)) != 0) // [!code ++]
			{
				param.tile = 786f;
				param.matColor = GetColorInt(ref this.cell.BackRight.matFloor.matColor, this.cell.BackRight.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(56);
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num25) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num25) & 4u) != 0) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num9) & 2u) != 0 && this.cell.Right.isShoreSand && ((uint)(this.cell.Right.shore / num9) & 4u) != 0) // [!code ++]
			{
				param.tile = 787f;
				param.matColor = GetColorInt(ref this.cell.FrontRight.matFloor.matColor, this.cell.FrontRight.sourceFloor.colorMod);
				passShore.Add(param);
				Draw(48);
			}
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num25) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num25) & 4u) != 0) // [!code --]
			if (this.cell.Front.isShoreSand && ((uint)(this.cell.Front.shore / num9) & 8u) != 0 && this.cell.Left.isShoreSand && ((uint)(this.cell.Left.shore / num9) & 4u) != 0) // [!code ++]
			{
				param.tile = 788f;
				param.matColor = GetColorInt(ref this.cell.FrontLeft.matFloor.matColor, this.cell.FrontLeft.sourceFloor.colorMod);
```

[`@@ -2298,48 +1855,48 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2298-L2345)
```cs:line-numbers=2298
					pass.NextBatch();
				}
			}
			bool flag8 = false; // [!code --]
			bool flag6 = false; // [!code ++]
			if (isShoreSand)
			{
				if (((uint)num26 & (true ? 1u : 0u)) != 0) // [!code --]
				if (((uint)num10 & (true ? 1u : 0u)) != 0) // [!code ++]
				{
					if (((uint)num26 & 8u) != 0) // [!code --]
					if (((uint)num10 & 8u) != 0) // [!code ++]
					{
						if ((num26 & 2) == 0 && (num26 & 4) == 0) // [!code --]
						if ((num10 & 2) == 0 && (num10 & 4) == 0) // [!code ++]
						{
							Draw(16);
						}
						flag8 = true; // [!code --]
						flag6 = true; // [!code ++]
					}
					if (((uint)num26 & 2u) != 0) // [!code --]
					if (((uint)num10 & 2u) != 0) // [!code ++]
					{
						if ((num26 & 8) == 0 && (num26 & 4) == 0) // [!code --]
						if ((num10 & 8) == 0 && (num10 & 4) == 0) // [!code ++]
						{
							Draw(20);
						}
						flag8 = true; // [!code --]
						flag6 = true; // [!code ++]
					}
				}
				if (((uint)num26 & 4u) != 0) // [!code --]
				if (((uint)num10 & 4u) != 0) // [!code ++]
				{
					if (((uint)num26 & 8u) != 0) // [!code --]
					if (((uint)num10 & 8u) != 0) // [!code ++]
					{
						if ((num26 & 2) == 0 && (num26 & 1) == 0) // [!code --]
						if ((num10 & 2) == 0 && (num10 & 1) == 0) // [!code ++]
						{
							Draw(24);
						}
						flag8 = true; // [!code --]
						flag6 = true; // [!code ++]
					}
					if (((uint)num26 & 2u) != 0) // [!code --]
					if (((uint)num10 & 2u) != 0) // [!code ++]
					{
						if ((num26 & 8) == 0 && (num26 & 1) == 0) // [!code --]
						if ((num10 & 8) == 0 && (num10 & 1) == 0) // [!code ++]
						{
							Draw(28);
						}
						flag8 = true; // [!code --]
						flag6 = true; // [!code ++]
					}
				}
				if (!flag8) // [!code --]
				if (!flag6) // [!code ++]
				{
					if (!this.cell.Front.sourceFloor.tileType.IsWater && !this.cell.Front.isDeck)
					{
```

[`@@ -2351,7 +1908,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2351-L2357)
```cs:line-numbers=2351
					}
				}
			}
			if (!flag8) // [!code --]
			if (!flag6) // [!code ++]
			{
				if (!this.cell.Back.sourceFloor.tileType.IsWater && !this.cell.Back.isDeck)
				{
```

[`@@ -2359,7 +1916,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2359-L2365)
```cs:line-numbers=2359
					batch = pass.batches[pass.batchIdx];
					batch.tiles[pass.idx] = 608 + waterAnimeIndex % 4;
					batch.matColors[pass.idx] = 104025f;
					if (((uint)(this.cell.shore / num25) & (true ? 1u : 0u)) != 0) // [!code --]
					if (((uint)(this.cell.shore / num9) & (true ? 1u : 0u)) != 0) // [!code ++]
					{
						if (isShoreSand)
						{
```

[`@@ -2397,7 +1954,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2397-L2403)
```cs:line-numbers=2397
					batch = pass.batches[pass.batchIdx];
					batch.tiles[pass.idx] = 612 + waterAnimeIndex % 4;
					batch.matColors[pass.idx] = 104025f;
					if (((uint)(this.cell.shore / num25) & 8u) != 0) // [!code --]
					if (((uint)(this.cell.shore / num9) & 8u) != 0) // [!code ++]
					{
						if (isShoreSand)
						{
```

[`@@ -2513,16 +2070,16 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2513-L2528)
```cs:line-numbers=2513
			param.z += bridgeFix.z;
			param.dir = 0;
			SourceBlock.Row row4 = sourceBridge._bridgeBlock;
			float num28 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code --]
			float num12 = (float)(this.cell.bridgeHeight - this.cell.height) * _heightMod.y; // [!code ++]
			if (this.cell.sourceFloor.tileType == TileType.Sky)
			{
				num28 += (float)EMono._map.config.skyBlockHeight; // [!code --]
				num12 += (float)EMono._map.config.skyBlockHeight; // [!code ++]
			}
			int num29 = (int)(num28 / heightBlockSize) + 2; // [!code --]
			int num13 = (int)(num12 / heightBlockSize) + 2; // [!code ++]
			if (this.cell.bridgePillar != 0)
			{
				row4 = EMono.sources.blocks.rows[this.cell.bridgePillar];
				param.tile = row4._tiles[0] + ((num29 == 2) ? 32 : 0); // [!code --]
				param.tile = row4._tiles[0] + ((num13 == 2) ? 32 : 0); // [!code ++]
				param.mat = ((sourceBridge.DefaultMaterial == row4.DefaultMaterial) ? sourceBridge.DefaultMaterial : row4.DefaultMaterial);
				param.matColor = ((row4.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, row4.colorMod));
			}
```

[`@@ -2534,9 +2091,9 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2534-L2542)
```cs:line-numbers=2534
			}
			param.y += ugFixBridgeTop.y;
			param.z += ugFixBridgeTop.z;
			for (int n = 0; n < num29; n++) // [!code --]
			for (int l = 0; l < num13; l++) // [!code ++]
			{
				if (n == num29 - 1) // [!code --]
				if (l == num13 - 1) // [!code ++]
				{
					param.y = (float)(cz - cx) * screen.tileAlign.y + (float)height * _heightMod.y + ugFixBridgeBottom.y;
					param.z = 1000f + param.x * screen.tileWeight.x + param.y * screen.tileWeight.z + (float)height * _heightMod.z + ugFixBridgeBottom.z;
```

[`@@ -2568,13 +2125,13 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2568-L2580)
```cs:line-numbers=2568
	{
		snowed = false;
	}
	num20 = 0; // [!code --]
	int num14 = 0; // [!code ++]
	if (sourceBlock.id != 0)
	{
		this.tileType = sourceBlock.tileType;
		roomHeight = 0f;
		int blockDir = this.cell.blockDir;
		bool flag9 = false; // [!code --]
		bool flag7 = false; // [!code ++]
		switch (wallClipMode)
		{
		case WallClipMode.ByRoom:
```

[`@@ -2618,8 +2175,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2618-L2625)
```cs:line-numbers=2618
					}
				}
			}
			flag9 = (this.room != null && this.room.data.atrium) || (this.cell.room != null && this.cell.room.data.atrium); // [!code --]
			if (flag9) // [!code --]
			flag7 = (this.room != null && this.room.data.atrium) || (this.cell.room != null && this.cell.room.data.atrium); // [!code ++]
			if (flag7) // [!code ++]
			{
				_lowblock = false;
			}
```

[`@@ -2641,8 +2198,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2641-L2648)
```cs:line-numbers=2641
					roomHeight = 0f;
					break;
				}
				int num30 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code --]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num30) ? this.room.lot.height : num30) + 0.01f * (float)this.room.lot.heightFix; // [!code --]
				int num15 = ((this.room.data.maxHeight == 0) ? 2 : this.room.data.maxHeight); // [!code ++]
				roomHeight = EMono.setting.render.roomHeightMod * (float)((this.room.lot.height < num15) ? this.room.lot.height : num15) + 0.01f * (float)this.room.lot.heightFix; // [!code ++]
			}
			break;
		case WallClipMode.ByLot:
```

[`@@ -2688,11 +2245,11 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2688-L2698)
```cs:line-numbers=2688
		}
		if (!_lowblock && (double)roomHeight > 1.2 && this.tileType.RepeatBlock)
		{
			num20 = 1; // [!code --]
			num14 = 1; // [!code ++]
		}
		else if (lowBlock)
		{
			num20 = 2; // [!code --]
			num14 = 2; // [!code ++]
		}
		param.mat = matBlock;
		param.dir = this.cell.blockDir;
```

[`@@ -2739,11 +2296,11 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2739-L2749)
```cs:line-numbers=2739
				}
				if (!_lowblock)
				{
					int num31 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code --]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num31) ? currentRoom.lot.height : num31) + 0.01f * (float)currentRoom.lot.heightFix; // [!code --]
					int num16 = ((currentRoom.data.maxHeight == 0) ? 2 : currentRoom.data.maxHeight); // [!code ++]
					roomHeight = EMono.setting.render.roomHeightMod * (float)((currentRoom.lot.height < num16) ? currentRoom.lot.height : num16) + 0.01f * (float)currentRoom.lot.heightFix; // [!code ++]
				}
			}
			if (flag9) // [!code --]
			if (flag7) // [!code ++]
			{
				_lowblock = (!this.cell.Front.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Front.HasFullBlock || !this.cell.Left.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Right.HasFullBlock) && (!this.cell.Back.HasFullBlock || !this.cell.Left.HasFullBlock);
				if (_lowblock)
```

[`@@ -2773,62 +2330,62 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2773-L2834)
```cs:line-numbers=2773
			{
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0, isBlock: true);
			}
			Room room2 = this.cell.Front.room ?? this.cell.room; // [!code --]
			if (room2 == null && this.cell.Right.room != null) // [!code --]
			Room room = this.cell.Front.room ?? this.cell.room; // [!code ++]
			if (room == null && this.cell.Right.room != null) // [!code ++]
			{
				room2 = this.cell.Right.room; // [!code --]
				room = this.cell.Right.room; // [!code ++]
			}
			if (!invisible && room2 != null) // [!code --]
			if (!invisible && room != null) // [!code ++]
			{
				if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
				if (room.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
				{
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco); // [!code --]
					param.matColor = room2.lot.colDeco; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco); // [!code ++]
					param.matColor = room.lot.colDeco; // [!code ++]
					float y = param.y;
					param.y += (float)room2.lot.decoFix * 0.01f; // [!code --]
					param.y += (float)room.lot.decoFix * 0.01f; // [!code ++]
					rendererWallDeco.Draw(param);
					param.y = y;
				}
				if (room2.lot.idDeco2 != 0 && roomHeight != 0f && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
				if (room.lot.idDeco2 != 0 && roomHeight != 0f && (float)room.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
				{
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2); // [!code --]
					param.matColor = room2.lot.colDeco2; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2); // [!code ++]
					param.matColor = room.lot.colDeco2; // [!code ++]
					float y2 = param.y;
					float num32 = param.z; // [!code --]
					param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code --]
					param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
					float num17 = param.z; // [!code ++]
					param.y += (float)room.lot.decoFix2 * 0.01f; // [!code ++]
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
					rendererWallDeco.Draw(param);
					param.y = y2;
					param.z = num32; // [!code --]
					param.z = num17; // [!code ++]
				}
			}
			room2 = this.cell.Right.room ?? this.cell.room; // [!code --]
			if (room2 == null && this.cell.Front.room != null) // [!code --]
			room = this.cell.Right.room ?? this.cell.room; // [!code ++]
			if (room == null && this.cell.Front.room != null) // [!code ++]
			{
				room2 = this.cell.Front.room; // [!code --]
				room = this.cell.Front.room; // [!code ++]
			}
			if (!invisible && room2 != null) // [!code --]
			if (!invisible && room != null) // [!code ++]
			{
				if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
				if (room.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
				{
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco) * -1; // [!code --]
					param.matColor = room2.lot.colDeco; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco) * -1; // [!code ++]
					param.matColor = room.lot.colDeco; // [!code ++]
					float y3 = param.y;
					param.y += (float)room2.lot.decoFix * 0.01f; // [!code --]
					param.y += (float)room.lot.decoFix * 0.01f; // [!code ++]
					rendererWallDeco.Draw(param);
					param.y = y3;
				}
				if (room2.lot.idDeco2 != 0 && roomHeight != 0f && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
				if (room.lot.idDeco2 != 0 && roomHeight != 0f && (float)room.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
				{
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2) * -1; // [!code --]
					param.matColor = room2.lot.colDeco2; // [!code --]
					param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room.lot.idDeco2) * -1; // [!code ++]
					param.matColor = room.lot.colDeco2; // [!code ++]
					float y4 = param.y;
					float num33 = param.z; // [!code --]
					param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code --]
					param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
					float num18 = param.z; // [!code ++]
					param.y += (float)room.lot.decoFix2 * 0.01f; // [!code ++]
					param.z += (float)room.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
					rendererWallDeco.Draw(param);
					param.y = y4;
					param.z = num33; // [!code --]
					param.z = num18; // [!code ++]
				}
			}
			break;
```

[`@@ -2843,56 +2400,167 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2843-L2898)
```cs:line-numbers=2843
			orgY = param.y;
			orgZ = param.z;
			param.color = (this.tileType.IsFence ? (floorLight - (float)((int)(_shadowStrength * 0.8f * 50f) * 262144)) : blockLight);
			bool flag10 = blockDir == 1 || _lowblock || flag9; // [!code --]
			bool flag11 = blockDir == 0 || _lowblock || flag9; // [!code --]
			bool flag8 = blockDir == 1 || _lowblock || flag7; // [!code ++]
			bool flag9 = blockDir == 0 || _lowblock || flag7; // [!code ++]
			if (!showFullWall && currentRoom != null)
			{
				if (!flag10) // [!code --]
				if (!flag8) // [!code ++]
				{
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Front.room != currentRoom))
					{
						if (!this.cell.IsRoomEdge || (this.cell.Front.room != this.cell.room && this.cell.FrontRight.room != this.cell.room))
						{
							flag10 = true; // [!code --]
							flag8 = true; // [!code ++]
						}
					}
					else if ((!this.cell.Front.lotWall || this.cell.Front.room?.lot != currentLot) && this.cell.Front.room != currentRoom)
					{
						flag10 = true; // [!code --]
						flag8 = true; // [!code ++]
					}
				}
				if (!flag11) // [!code --]
				if (!flag9) // [!code ++]
				{
					if (currentRoom == this.cell.room || (this.cell.lotWall && this.cell.room?.lot == currentLot && this.cell.Right.room != currentRoom))
					{
						if (!this.cell.IsRoomEdge || (this.cell.Right.room != this.cell.room && this.cell.FrontRight.room != this.cell.room))
						{
							flag11 = true; // [!code --]
							flag9 = true; // [!code ++]
						}
					}
					else if ((!this.cell.Right.lotWall || this.cell.Right.room?.lot != currentLot) && this.cell.Right.room != currentRoom)
					{
						flag11 = true; // [!code --]
						flag9 = true; // [!code ++]
					}
				}
			}
			if (blockDir == 0 || blockDir == 2)
			{
				param.dir = 0;
				Room room3 = this.cell.Front.room ?? this.cell.room; // [!code --]
				Room room2 = this.cell.Front.room ?? this.cell.room; // [!code ++]
				if (room2 != null && this.tileType.IsWall) // [!code ++]
				{ // [!code ++]
					if (room2.lot.idDeco != 0 && !this.cell.hasDoor) // [!code ++]
					{ // [!code ++]
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco); // [!code ++]
						param.matColor = room2.lot.colDeco; // [!code ++]
						param.y += (float)room2.lot.decoFix * 0.01f; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
					} // [!code ++]
					if (room2.lot.idDeco2 != 0 && roomHeight != 0f && !flag8 && (float)room2.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
					{ // [!code ++]
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room2.lot.idDeco2); // [!code ++]
						param.matColor = room2.lot.colDeco2; // [!code ++]
						param.y += (float)room2.lot.decoFix2 * 0.01f; // [!code ++]
						param.z += (float)room2.lot.decoFix2 * 0.01f * heightModDeco; // [!code ++]
						rendererWallDeco.Draw(param); // [!code ++]
						param.y = orgY; // [!code ++]
						param.z = orgZ; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				Cell left = this.cell.Left; // [!code ++]
				if (blockDir == 2 && left.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code ++]
				{ // [!code ++]
					_sourceBlock = left.sourceBlock; // [!code ++]
					param.mat = left.matBlock; // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					_sourceBlock = sourceBlock; // [!code ++]
					param.mat = matBlock; // [!code ++]
				} // [!code ++]
				this.tileType = _sourceBlock.tileType; // [!code ++]
				param.tile = (tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock) ? 32 : 0)); // [!code ++]
				if (_sourceBlock.useAltColor) // [!code ++]
				{ // [!code ++]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code ++]
				} // [!code ++]
				if (roomHeight == 0f || flag8 || !this.tileType.RepeatBlock) // [!code ++]
				{ // [!code ++]
					if (!this.cell.hasDoor) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code ++]
				} // [!code ++]
				param.z += cornerWallFix2.z; // [!code ++]
				if ((blockDir == 2 || (this.cell.Front.HasWallOrFence && this.cell.Front.blockDir != 0)) != this.cell.isToggleWallPillar) // [!code ++]
				{ // [!code ++]
					if (this.cell.Back.IsSnowTile && this.cell.Right.IsSnowTile) // [!code ++]
					{ // [!code ++]
						param.snow = true; // [!code ++]
					} // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag8 && flag9 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					if (roomHeight == 0f || !this.tileType.RepeatBlock || (flag8 && flag9 && !flag7)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code ++]
					} // [!code ++]
				} // [!code ++]
				if (!flag8 && !showRoof && this.cell.Left.HasWallOrFence && this.cell.Left.blockDir != 0 && !this.cell.isToggleWallPillar) // [!code ++]
				{ // [!code ++]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					param.x += cornerWallFix3.x; // [!code ++]
					param.y += cornerWallFix3.y; // [!code ++]
					param.z += cornerWallFix3.z; // [!code ++]
					if (!flag7 && (roomHeight == 0f || flag8)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code ++]
					} // [!code ++]
					param.x = orgX; // [!code ++]
				} // [!code ++]
				else if (this.cell.FrontLeft.HasWallOrFence && this.cell.FrontLeft.blockDir != 0 && (!flag8 || !this.cell.Left.HasWall) && !this.cell.isToggleWallPillar) // [!code ++]
				{ // [!code ++]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag8 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					param.x += cornerWallFix.x; // [!code ++]
					param.y += cornerWallFix.y; // [!code ++]
					param.z += cornerWallFix.z; // [!code ++]
					if (!flag7 && (roomHeight == 0f || flag8)) // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.Draw(param); // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code ++]
					} // [!code ++]
					param.x = orgX; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (blockDir == 1 || blockDir == 2) // [!code ++]
			{ // [!code ++]
				param.y = orgY; // [!code ++]
				param.z = orgZ; // [!code ++]
				param.dir = 1; // [!code ++]
				Room room3 = this.cell.Right.room ?? this.cell.room; // [!code ++]
				if (room3 != null && this.tileType.IsWall)
				{
					if (room3.lot.idDeco != 0 && !this.cell.hasDoor)
					{
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco); // [!code --]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco); // [!code ++]
						param.matColor = room3.lot.colDeco;
						param.y += (float)room3.lot.decoFix * 0.01f;
						rendererWallDeco.Draw(param);
						param.y = orgY;
					}
					if (room3.lot.idDeco2 != 0 && roomHeight != 0f && !flag10 && (float)room3.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
					if (room3.lot.idDeco2 != 0 && roomHeight != 0f && !flag9 && (float)room3.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code ++]
					{
						param.tile = EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco2); // [!code --]
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room3.lot.idDeco2); // [!code ++]
						param.matColor = room3.lot.colDeco2;
						param.y += (float)room3.lot.decoFix2 * 0.01f;
						param.z += (float)room3.lot.decoFix2 * 0.01f * heightModDeco;
```

[`@@ -2901,11 +2569,29 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2901-L2911)
```cs:line-numbers=2901
						param.z = orgZ;
					}
				}
				Cell left = this.cell.Left; // [!code --]
				if (blockDir == 2 && left.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code --]
				if (blockDir == 2 && this.cell.room == null && this.cell.Right.room != null) // [!code ++]
				{ // [!code ++]
					Room room4 = this.cell.Right.room; // [!code ++]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)room4.lot.mh * _heightMod.y; // [!code ++]
					if (showRoof) // [!code ++]
					{ // [!code ++]
						roomHeight = room4.lot.realHeight; // [!code ++]
					} // [!code ++]
					else if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code ++]
					{ // [!code ++]
						roomHeight = 0f; // [!code ++]
					} // [!code ++]
					else // [!code ++]
					{ // [!code ++]
						int num19 = ((room4.data.maxHeight == 0) ? 2 : room4.data.maxHeight); // [!code ++]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room4.lot.height < num19) ? room4.lot.height : num19) + 0.01f * (float)room4.lot.heightFix; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				Cell back2 = this.cell.Back; // [!code ++]
				if (blockDir == 2 && back2.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code ++]
				{
					_sourceBlock = left.sourceBlock; // [!code --]
					param.mat = left.matBlock; // [!code --]
					_sourceBlock = back2.sourceBlock; // [!code ++]
					param.mat = back2.matBlock; // [!code ++]
				}
				else
				{
```

[`@@ -2913,7 +2599,7 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2913-L2919)
```cs:line-numbers=2913
					param.mat = matBlock;
				}
				this.tileType = _sourceBlock.tileType;
				param.tile = (tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock) ? 32 : 0)); // [!code --]
				param.tile = (tile = -_sourceBlock._tiles[0] + ((flag9 && this.tileType.UseLowBlock) ? (-32) : 0)); // [!code ++]
				if (_sourceBlock.useAltColor)
				{
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod));
```

[`@@ -2922,7 +2608,8 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2922-L2928)
```cs:line-numbers=2922
				{
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod));
				}
				if (roomHeight == 0f || flag10 || !this.tileType.RepeatBlock) // [!code --]
				param.color += _rightWallShade; // [!code ++]
				if (roomHeight == 0f || flag9 || !this.tileType.RepeatBlock) // [!code ++]
				{
					if (!this.cell.hasDoor)
					{
```

[`@@ -2933,15 +2620,15 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2933-L2947)
```cs:line-numbers=2933
				{
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0);
				}
				param.z += cornerWallFix2.z; // [!code --]
				if ((blockDir == 2 || (this.cell.Front.HasWallOrFence && this.cell.Front.blockDir != 0)) != this.cell.isToggleWallPillar) // [!code --]
				if ((this.cell.Right.HasWallOrFence && this.cell.Right.blockDir != 1) != this.cell.isToggleWallPillar && (blockDir != 2 || !this.cell.isToggleWallPillar)) // [!code ++]
				{
					if (this.cell.Back.IsSnowTile && this.cell.Right.IsSnowTile) // [!code --]
					if (this.cell.Left.IsSnowTile && this.cell.Front.IsSnowTile) // [!code ++]
					{
						param.snow = true;
					}
					param.tile = _sourceBlock._tiles[0] + ((flag10 && flag11 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					if (roomHeight == 0f || !this.tileType.RepeatBlock || (flag10 && flag11 && !flag9)) // [!code --]
					orgX = param.x; // [!code ++]
					param.tile = _sourceBlock._tiles[0] + ((flag9 && this.tileType.UseLowBlock && !flag7) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code ++]
					if (!flag7 && (roomHeight == 0f || !this.tileType.RepeatBlock || flag9)) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param);
					}
```

[`@@ -2949,203 +2636,539 @@ public virtual void DrawTile()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/BaseTileMap.cs#L2949-L3151)
```cs:line-numbers=2949
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix);
					}
					param.x = orgX; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			param.y = orgY; // [!code ++]
			param.z = orgZ; // [!code ++]
			break; // [!code ++]
		} // [!code ++]
		case BlockRenderMode.HalfBlock: // [!code ++]
			param.color = floorLight; // [!code ++]
			_sourceBlock = ((sourceBlock.id == 5) ? EMono.sources.blocks.rows[matBlock.defBlock] : sourceBlock); // [!code ++]
			param.tile = _sourceBlock._tiles[0]; // [!code ++]
			param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.colorMod)); // [!code ++]
			param.tile2 = _sourceBlock.sourceAutoFloor._tiles[0]; // [!code ++]
			param.halfBlockColor = ((_sourceBlock.sourceAutoFloor.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.sourceAutoFloor.colorMod)); // [!code ++]
			sourceBlock.renderData.Draw(param); // [!code ++]
			break; // [!code ++]
		case BlockRenderMode.Pillar: // [!code ++]
		{ // [!code ++]
			RenderData renderData2 = sourceBlock.renderData; // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
			int num20 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code ++]
			if (num20 == 0) // [!code ++]
			{ // [!code ++]
				renderData2.Draw(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				renderData2.DrawRepeat(param, num20, sourceBlock.tileType.RepeatSize); // [!code ++]
			} // [!code ++]
			param.tile = renderData2.idShadow; // [!code ++]
			SourcePref shadowPref2 = renderData2.shadowPref; // [!code ++]
			int shadow4 = shadowPref2.shadow; // [!code ++]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow4], shadowPref2, 0, param.snow); // [!code ++]
			break; // [!code ++]
		} // [!code ++]
		default: // [!code ++]
			param.color = floorLight; // [!code ++]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + ((_lowblock && this.tileType.UseLowBlock) ? 3000000 : 0); // [!code ++]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code ++]
			if (roomHeight == 0f) // [!code ++]
			{ // [!code ++]
				sourceBlock.renderData.Draw(param); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock); // [!code ++]
			} // [!code ++]
			break; // [!code ++]
		} // [!code ++]
	} // [!code ++]
	if (this.cell.pcSync && EMono.player.lightPower > 0f && !cinemaMode) // [!code ++]
	{ // [!code ++]
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof) // [!code ++]
		{ // [!code ++]
			goto IL_6f6d; // [!code ++]
		} // [!code ++]
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock) // [!code ++]
		{ // [!code ++]
			Room obj = this.cell.FrontRight.room; // [!code ++]
			if (obj == null || !obj.HasRoof) // [!code ++]
			{ // [!code ++]
				goto IL_6f6d; // [!code ++]
			} // [!code ++]
		} // [!code ++]
	} // [!code ++]
	goto IL_6fcd; // [!code ++]
	IL_6f6d: // [!code ++]
	if (!showRoof || !roof || this.cell.room == null || this.cell.Front.room == null || this.cell.Right.room == null) // [!code ++]
	{ // [!code ++]
		param.tile = num14; // [!code ++]
		rendererFov.Draw(param); // [!code ++]
	} // [!code ++]
	goto IL_6fcd; // [!code ++]
	IL_7b88: // [!code ++]
	if (detail.things.Count == 0 && detail.charas.Count == 0) // [!code ++]
	{ // [!code ++]
		return; // [!code ++]
	} // [!code ++]
	int num21 = 0; // [!code ++]
	thingPos.x = 0f; // [!code ++]
	thingPos.y = 0f; // [!code ++]
	thingPos.z = 0f; // [!code ++]
	freePos.x = (freePos.y = (freePos.z = 0f)); // [!code ++]
	if (this.cell.HasRamp) // [!code ++]
	{ // [!code ++]
		Vector3 rampFix = sourceBlock.tileType.GetRampFix(this.cell.blockDir); // [!code ++]
		param.x += rampFix.x; // [!code ++]
		param.y += rampFix.y; // [!code ++]
		param.z += rampFix.z; // [!code ++]
		freePos.x += rampFix.x; // [!code ++]
		freePos.y += rampFix.y; // [!code ++]
		freePos.z += rampFix.z; // [!code ++]
	} // [!code ++]
	param.y += (flag ? 0f : ((this.cell._bridge != 0) ? this.cell.sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight)); // [!code ++]
	orgPos.x = (orgX = param.x); // [!code ++]
	orgPos.y = (orgY = param.y); // [!code ++]
	orgPos.z = (orgZ = param.z); // [!code ++]
	if (flag && liquidLv > 0) // [!code ++]
	{ // [!code ++]
		if (liquidLv > 10) // [!code ++]
		{ // [!code ++]
			liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
		} // [!code ++]
		liquidLv -= (int)(floatY * 0.5f); // [!code ++]
		param.liquidLv = liquidLv; // [!code ++]
		param.y -= TileType.FloorWaterShallow.FloorHeight; // [!code ++]
	} // [!code ++]
	Thing thing = null; // [!code ++]
	bool shadow = liquidLv == 0; // [!code ++]
	float num22 = 0f; // [!code ++]
	float num23 = 0f; // [!code ++]
	bool flag10 = false; // [!code ++]
	float num24 = 0f; // [!code ++]
	bool flag11 = false; // [!code ++]
	float num25 = 0f; // [!code ++]
	if (detail.things.Count > 0 && isSeen) // [!code ++]
	{ // [!code ++]
		_ = zSetting.max1; // [!code ++]
		float num26 = 0f; // [!code ++]
		for (int m = 0; m < detail.things.Count; m++) // [!code ++]
		{ // [!code ++]
			Thing t = detail.things[m]; // [!code ++]
			if ((fogged && !t.isRoofItem) || ((t.isHidden || t.trait.HideInAdv || t.isMasked) && !EMono.scene.actionMode.ShowMaskedThings) || (t.isRoofItem && ((this.room == null && !sourceBlock.tileType.IsFullBlock && !EMono._zone.IsPCFaction) || (lowBlock && !showFullWall && this.room != null) || (noRoofMode && currentRoom == null))) || (flag3 && !t.isRoofItem)) // [!code ++]
			{ // [!code ++]
				continue; // [!code ++]
			} // [!code ++]
			TileType tileType = t.trait.tileType; // [!code ++]
			bool isInstalled = t.IsInstalled; // [!code ++]
			SourcePref pref = t.Pref; // [!code ++]
			if (!isInstalled && t.category.tileDummy != 0) // [!code ++]
			{ // [!code ++]
				pref = rendererObjDummy.shadowPref; // [!code ++]
			} // [!code ++]
			float num27 = ((tileType.UseMountHeight && isInstalled) ? 0f : ((pref.height < 0f) ? 0f : ((pref.height == 0f) ? 0.1f : pref.height))); // [!code ++]
			if (t.ignoreStackHeight) // [!code ++]
			{ // [!code ++]
				thingPos.y -= num22; // [!code ++]
			} // [!code ++]
			shadow = thingPos.y < 0.16f && num25 < 0.16f; // [!code ++]
			_ = pref.bypassShadow; // [!code ++]
			param.shadowFix = 0f - thingPos.y; // [!code ++]
			param.liquidLv = ((thingPos.y + (float)t.altitude < 0.1f) ? liquidLv : 0); // [!code ++]
			if (t.isRoofItem) // [!code ++]
			{ // [!code ++]
				param.snow = isSnowCovered && !this.cell.isClearSnow; // [!code ++]
				SetRoofHeight(param, this.cell, cx, cz); // [!code ++]
				_actorPos.x = param.x; // [!code ++]
				_actorPos.y = param.y; // [!code ++]
				_actorPos.z = param.z + num26; // [!code ++]
				if (this.room != null) // [!code ++]
				{ // [!code ++]
					param.color = GetRoofLight(this.room.lot); // [!code ++]
				} // [!code ++]
				shadow = false; // [!code ++]
				param.liquidLv = 0; // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				param.snow = snowed; // [!code ++]
				_actorPos.x = orgX + num23; // [!code ++]
				_actorPos.y = orgY; // [!code ++]
				_actorPos.z = orgZ + num26 + thingPos.z; // [!code ++]
				if (tileType.CanStack || !isInstalled) // [!code ++]
				{ // [!code ++]
					if (thing?.id != t.id) // [!code ++]
					{ // [!code ++]
						_actorPos.x += thingPos.x; // [!code ++]
					} // [!code ++]
					_actorPos.y += thingPos.y; // [!code ++]
					if (t.trait.IgnoreLastStackHeight && (thing == null || !thing.trait.IgnoreLastStackHeight)) // [!code ++]
					{ // [!code ++]
						thingPos.y -= num22; // [!code ++]
						if (thing != null) // [!code ++]
						{ // [!code ++]
							_actorPos.z -= 0.2f; // [!code ++]
							thingPos.z -= 0.2f; // [!code ++]
						} // [!code ++]
						_actorPos.y -= num22; // [!code ++]
					} // [!code ++]
					_actorPos.z += renderSetting.thingZ + (float)m * -0.01f + zSetting.mod1 * thingPos.y; // [!code ++]
				}
				if (!flag10 && !showRoof && this.cell.Left.HasWallOrFence && this.cell.Left.blockDir != 0 && !this.cell.isToggleWallPillar) // [!code --]
				if (isInstalled) // [!code ++]
				{
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					param.x += cornerWallFix3.x; // [!code --]
					param.y += cornerWallFix3.y; // [!code --]
					param.z += cornerWallFix3.z; // [!code --]
					if (!flag9 && (roomHeight == 0f || flag10)) // [!code --]
					if (t.TileType.IsRamp) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						Vector3 rampFix2 = t.TileType.GetRampFix(t.dir, pref); // [!code ++]
						orgX += rampFix2.x; // [!code ++]
						orgY += rampFix2.y; // [!code ++]
						orgZ += rampFix2.z; // [!code ++]
						freePos.x += rampFix2.x; // [!code ++]
						freePos.y += rampFix2.y; // [!code ++]
						freePos.z += rampFix2.z; // [!code ++]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code ++]
						{ // [!code ++]
							num25 += rampFix2.y; // [!code ++]
						} // [!code ++]
						liquidLv -= (int)(rampFix2.y * 150f); // [!code ++]
						if (liquidLv < 0) // [!code ++]
						{ // [!code ++]
							liquidLv = 0; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					else if (!flag11 && t.trait.IsChangeFloorHeight && !t.ignoreStackHeight) // [!code ++]
					{ // [!code ++]
						orgY += num27 + (float)t.altitude * altitudeFix.y; // [!code ++]
						orgZ += (float)t.altitude * altitudeFix.z; // [!code ++]
						freePos.y += num27 + (float)t.altitude * altitudeFix.y; // [!code ++]
						if (!this.cell.IsTopWater || t.altitude > 0) // [!code ++]
						{ // [!code ++]
							num25 += num27 + (float)t.altitude * altitudeFix.y; // [!code ++]
						} // [!code ++]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
						_actorPos.z += pref.z; // [!code ++]
						thingPos.z += pref.z; // [!code ++]
						liquidLv -= (int)(num27 * 150f); // [!code ++]
						if (liquidLv < 0) // [!code ++]
						{ // [!code ++]
							liquidLv = 0; // [!code ++]
						} // [!code ++]
					}
					else
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code --]
						thingPos.y += num27; // [!code ++]
						_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
						_actorPos.z += pref.z; // [!code ++]
						if (pref.height >= 0f) // [!code ++]
						{ // [!code ++]
							thingPos.z += pref.z; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					if (!tileType.UseMountHeight && m > 10) // [!code ++]
					{ // [!code ++]
						flag11 = true; // [!code ++]
					}
					param.x = orgX; // [!code --]
				}
				else if (this.cell.FrontLeft.HasWallOrFence && this.cell.FrontLeft.blockDir != 0 && (!flag10 || !this.cell.Left.HasWall) && !this.cell.isToggleWallPillar) // [!code --]
				else // [!code ++]
				{
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag10 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					param.x += cornerWallFix.x; // [!code --]
					param.y += cornerWallFix.y; // [!code --]
					param.z += cornerWallFix.z; // [!code --]
					if (!flag9 && (roomHeight == 0f || flag10)) // [!code --]
					thingPos.y += num27; // [!code ++]
					_actorPos.x += pref.x * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
					_actorPos.z += pref.z; // [!code ++]
					thingPos.z += pref.z; // [!code ++]
				} // [!code ++]
				if (t.isFloating && isWater && !hasBridge && !flag) // [!code ++]
				{ // [!code ++]
					flag = true; // [!code ++]
					float num28 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
					orgY += 0.01f * floatY - num28; // [!code ++]
					num24 = num27; // [!code ++]
					_actorPos.y += 0.01f * floatY - num28; // [!code ++]
					if (liquidLv > 10) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						liquidLv = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
					}
					else // [!code --]
					liquidLv -= (int)(floatY * 0.5f); // [!code ++]
					if (liquidLv < 0) // [!code ++]
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight + cornerWallFix.y, ref renderSetting.peakFix); // [!code --]
						liquidLv = 0; // [!code ++]
					}
					param.x = orgX; // [!code --]
					param.liquidLv = liquidLv; // [!code ++]
				}
			} // [!code --]
			if (blockDir == 1 || blockDir == 2) // [!code --]
			{ // [!code --]
				param.y = orgY; // [!code --]
				param.z = orgZ; // [!code --]
				param.dir = 1; // [!code --]
				Room room4 = this.cell.Right.room ?? this.cell.room; // [!code --]
				if (room4 != null && this.tileType.IsWall) // [!code --]
				num22 = num27; // [!code ++]
				if (t.sourceCard.multisize && !t.trait.IsGround) // [!code ++]
				{ // [!code ++]
					num26 += zSetting.multiZ; // [!code ++]
				} // [!code ++]
				orgZ += t.renderer.data.stackZ; // [!code ++]
				if (param.liquidLv > 0) // [!code ++]
				{
					if (room4.lot.idDeco != 0 && !this.cell.hasDoor) // [!code --]
					param.liquidLv += pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room4.lot.idDeco); // [!code --]
						param.matColor = room4.lot.colDeco; // [!code --]
						param.y += (float)room4.lot.decoFix * 0.01f; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
						param.liquidLv = 1; // [!code ++]
					}
					if (room4.lot.idDeco2 != 0 && roomHeight != 0f && !flag11 && (float)room4.lot.decoFix2 * 0.01f + heightLimitDeco < roomHeight + maxHeight - param.y) // [!code --]
					else if (param.liquidLv > 99 + pref.liquidModMax) // [!code ++]
					{
						param.tile = -EMono.sources.blocks.rows[0].ConvertTile(1000 + room4.lot.idDeco2); // [!code --]
						param.matColor = room4.lot.colDeco2; // [!code --]
						param.y += (float)room4.lot.decoFix2 * 0.01f; // [!code --]
						param.z += (float)room4.lot.decoFix2 * 0.01f * heightModDeco; // [!code --]
						rendererWallDeco.Draw(param); // [!code --]
						param.y = orgY; // [!code --]
						param.z = orgZ; // [!code --]
						param.liquidLv = 99 + pref.liquidModMax; // [!code ++]
					}
				}
				if (blockDir == 2 && this.cell.room == null && this.cell.Right.room != null) // [!code --]
			} // [!code ++]
			if (isInstalled && tileType.UseMountHeight) // [!code ++]
			{ // [!code ++]
				if (tileType != TileType.Illumination || !this.cell.HasObj) // [!code ++]
				{
					Room room5 = this.cell.Right.room; // [!code --]
					maxHeight = (float)(cz - cx) * screen.tileAlign.y + (float)room5.lot.mh * _heightMod.y; // [!code --]
					if (showRoof) // [!code --]
					{ // [!code --]
						roomHeight = room5.lot.realHeight; // [!code --]
					} // [!code --]
					else if ((noRoofMode && currentRoom == null) || (_lowblock && !this.tileType.ForceRpeatBlock)) // [!code --]
					if (noRoofMode && currentRoom == null && t.altitude >= lowWallObjAltitude) // [!code ++]
					{
						roomHeight = 0f; // [!code --]
						continue; // [!code ++]
					}
					else // [!code --]
					if (hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code ++]
					{
						int num34 = ((room5.data.maxHeight == 0) ? 2 : room5.data.maxHeight); // [!code --]
						roomHeight = EMono.setting.render.roomHeightMod * (float)((room5.lot.height < num34) ? room5.lot.height : num34) + 0.01f * (float)room5.lot.heightFix; // [!code --]
						Room room5 = ((t.dir == 0) ? this.cell.Back.room : this.cell.Left.room); // [!code ++]
						if (t.trait.AlwaysHideOnLowWall) // [!code ++]
						{ // [!code ++]
							if (room5 == null || !room5.data.showWallItem) // [!code ++]
							{ // [!code ++]
								continue; // [!code ++]
							} // [!code ++]
						} // [!code ++]
						else if (t.altitude >= lowWallObjAltitude) // [!code ++]
						{ // [!code ++]
							continue; // [!code ++]
						} // [!code ++]
					}
				}
				Cell back2 = this.cell.Back; // [!code --]
				if (blockDir == 2 && back2.sourceBlock.tileType.IsWallOrFence && !this.cell.crossWall) // [!code --]
				{ // [!code --]
					_sourceBlock = back2.sourceBlock; // [!code --]
					param.mat = back2.matBlock; // [!code --]
				} // [!code --]
				else // [!code --]
				{ // [!code --]
					_sourceBlock = sourceBlock; // [!code --]
					param.mat = matBlock; // [!code --]
				} // [!code --]
				this.tileType = _sourceBlock.tileType; // [!code --]
				param.tile = (tile = -_sourceBlock._tiles[0] + ((flag11 && this.tileType.UseLowBlock) ? (-32) : 0)); // [!code --]
				if (_sourceBlock.useAltColor) // [!code --]
				if (tileType.UseHangZFix) // [!code ++]
				{
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.altColor, _sourceBlock.colorMod)); // [!code --]
					flag10 = true; // [!code ++]
				}
				else // [!code --]
				tileType.GetMountHeight(ref _actorPos, Point.shared.Set(index), t.dir, t); // [!code ++]
				shadow = false; // [!code ++]
				param.liquidLv = 0; // [!code ++]
				if (t.freePos) // [!code ++]
				{
					param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref param.mat.matColor, _sourceBlock.colorMod)); // [!code --]
					_actorPos.x += t.fx; // [!code ++]
					_actorPos.y += t.fy; // [!code ++]
				}
				param.color += _rightWallShade; // [!code --]
				if (roomHeight == 0f || flag11 || !this.tileType.RepeatBlock) // [!code --]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				if (t.altitude != 0) // [!code ++]
				{
					if (!this.cell.hasDoor) // [!code --]
					_actorPos += altitudeFix * t.altitude; // [!code ++]
					if (t.altitude > 2 && ((this.cell.Back.room != null && this.cell.Back.IsRoomEdge) || (this.cell.Left.room != null && this.cell.Left.IsRoomEdge)) && hideHang && (this.cell.room?.lot != currentLot || (!this.cell.lotWall && this.cell.room != currentRoom))) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						continue; // [!code ++]
					}
				}
				else // [!code --]
				if (t.freePos) // [!code ++]
				{
					_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix, this.cell.hasDoor, this.cell.effect?.FireAmount ?? 0); // [!code --]
					_actorPos.x = orgX + t.fx - freePos.x; // [!code ++]
					_actorPos.y = orgY + t.fy - freePos.y; // [!code ++]
				}
				if ((this.cell.Right.HasWallOrFence && this.cell.Right.blockDir != 1) != this.cell.isToggleWallPillar && (blockDir != 2 || !this.cell.isToggleWallPillar)) // [!code --]
				if (t.trait is TraitDoor && (t.trait as TraitDoor).IsOpen()) // [!code ++]
				{
					if (this.cell.Left.IsSnowTile && this.cell.Front.IsSnowTile) // [!code --]
					_actorPos.z += -0.5f; // [!code ++]
				} // [!code ++]
			} // [!code ++]
			if (!t.sourceCard.multisize || (t.pos.x == cx && t.pos.z == cz)) // [!code ++]
			{ // [!code ++]
				if (iconMode != 0) // [!code ++]
				{ // [!code ++]
					int num29 = 0; // [!code ++]
					switch (iconMode) // [!code ++]
					{
						param.snow = true; // [!code --]
					case CardIconMode.Visibility: // [!code ++]
						if (t.isMasked) // [!code ++]
						{ // [!code ++]
							num29 = 17; // [!code ++]
						} // [!code ++]
						break; // [!code ++]
					case CardIconMode.State: // [!code ++]
						if (t.placeState == PlaceState.installed) // [!code ++]
						{ // [!code ++]
							num29 = 18; // [!code ++]
						} // [!code ++]
						break; // [!code ++]
					case CardIconMode.Deconstruct: // [!code ++]
						if (t.isDeconstructing) // [!code ++]
						{ // [!code ++]
							num29 = 14; // [!code ++]
						} // [!code ++]
						break; // [!code ++]
					}
					orgX = param.x; // [!code --]
					param.tile = _sourceBlock._tiles[0] + ((flag11 && this.tileType.UseLowBlock && !flag9) ? 32 : 0) + (this.tileType.IsFence ? 32 : 64); // [!code --]
					if (!flag9 && (roomHeight == 0f || !this.tileType.RepeatBlock || flag11)) // [!code --]
					if (t.isNPCProperty && !EMono.debug.godBuild) // [!code ++]
					{
						_sourceBlock.renderData.Draw(param); // [!code --]
						num29 = 13; // [!code ++]
					}
					else // [!code --]
					if (num29 != 0) // [!code ++]
					{
						_sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFix); // [!code --]
						passGuideBlock.Add(_actorPos.x, _actorPos.y, _actorPos.z - 10f, num29); // [!code ++]
					}
					param.x = orgX; // [!code --]
				} // [!code ++]
				t.SetRenderParam(param); // [!code ++]
				if (_lowblock && t.trait.UseLowblock && !this.cell.HasFullBlock) // [!code ++]
				{ // [!code ++]
					param.tile += ((param.tile < 0f) ? (-64) : 64); // [!code ++]
				} // [!code ++]
				if (t.trait is TraitTrolley && EMono.pc.ai is AI_Trolley aI_Trolley && aI_Trolley.trolley.owner == t) // [!code ++]
				{ // [!code ++]
					RenderParam _param = new RenderParam(param); // [!code ++]
					EMono.core.actionsLateUpdate.Add(delegate // [!code ++]
					{ // [!code ++]
						t.SetRenderParam(_param); // [!code ++]
						_actorPos.x = EMono.pc.renderer.position.x; // [!code ++]
						_actorPos.y = EMono.pc.renderer.position.y - pref.height; // [!code ++]
						_actorPos.z = EMono.pc.renderer.position.z + 0.02f; // [!code ++]
						t.renderer.Draw(_param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code ++]
					}); // [!code ++]
				} // [!code ++]
				else // [!code ++]
				{ // [!code ++]
					t.renderer.Draw(param, ref _actorPos, !t.noShadow && (shadow || tileType.AlwaysShowShadow)); // [!code ++]
				}
			}
			param.y = orgY; // [!code --]
			param.z = orgZ; // [!code --]
			break; // [!code --]
		} // [!code --]
		case BlockRenderMode.HalfBlock: // [!code --]
			param.color = floorLight; // [!code --]
			_sourceBlock = ((sourceBlock.id == 5) ? EMono.sources.blocks.rows[matBlock.defBlock] : sourceBlock); // [!code --]
			param.tile = _sourceBlock._tiles[0]; // [!code --]
			param.matColor = ((_sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.colorMod)); // [!code --]
			param.tile2 = _sourceBlock.sourceAutoFloor._tiles[0]; // [!code --]
			param.halfBlockColor = ((_sourceBlock.sourceAutoFloor.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, _sourceBlock.sourceAutoFloor.colorMod)); // [!code --]
			sourceBlock.renderData.Draw(param); // [!code --]
			break; // [!code --]
		case BlockRenderMode.Pillar: // [!code --]
		{ // [!code --]
			RenderData renderData2 = sourceBlock.renderData; // [!code --]
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length]; // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			int num35 = this.cell.objDir + ((this.cell.objDir >= 7) ? this.cell.objDir : 0) + 1; // [!code --]
			if (num35 == 0) // [!code --]
			{ // [!code --]
				renderData2.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			if (isInstalled) // [!code ++]
			{
				renderData2.DrawRepeat(param, num35, sourceBlock.tileType.RepeatSize); // [!code --]
				num23 += pref.stackX * (float)((!t.flipX) ? 1 : (-1)); // [!code ++]
			}
			param.tile = renderData2.idShadow; // [!code --]
			SourcePref shadowPref2 = renderData2.shadowPref; // [!code --]
			int shadow4 = shadowPref2.shadow; // [!code --]
			passShadow.AddShadow(param.x + renderData2.offsetShadow.x, param.y + renderData2.offsetShadow.y, param.z + renderData2.offsetShadow.z, ShadowData.Instance.items[shadow4], shadowPref2, 0, param.snow); // [!code --]
			break; // [!code --]
		} // [!code --]
		default: // [!code --]
			param.x = orgX; // [!code ++]
			param.y = orgY; // [!code ++]
			param.z = orgZ; // [!code ++]
			param.color = floorLight;
			param.tile = sourceBlock._tiles[this.cell.blockDir % sourceBlock._tiles.Length] + ((_lowblock && this.tileType.UseLowBlock) ? 3000000 : 0); // [!code --]
			param.matColor = ((sourceBlock.colorMod == 0) ? 104025 : GetColorInt(ref matBlock.matColor, sourceBlock.colorMod)); // [!code --]
			if (roomHeight == 0f) // [!code --]
			{ // [!code --]
				sourceBlock.renderData.Draw(param); // [!code --]
			} // [!code --]
			else // [!code --]
			thing = t; // [!code ++]
			if (pref.Float) // [!code ++]
			{
				sourceBlock.renderData.DrawRepeatTo(param, maxHeight, roomHeight, ref renderSetting.peakFixBlock); // [!code --]
				liquidLv = 0; // [!code ++]
			}
			break; // [!code --]
		}
	}
	if (this.cell.pcSync && EMono.player.lightPower > 0f && !cinemaMode) // [!code --]
	orgY += num24; // [!code ++]
	if (detail.charas.Count <= 0) // [!code ++]
	{
		if (this.cell.room != null || !this.cell.IsRoomEdge || !showRoof) // [!code --]
		return; // [!code ++]
	} // [!code ++]
	param.shadowFix = 0f - num25; // [!code ++]
	param.color += 1310720f; // [!code ++]
	float max = zSetting.max2; // [!code ++]
	for (int n = 0; n < detail.charas.Count; n++) // [!code ++]
	{ // [!code ++]
		Chara chara = detail.charas[n]; // [!code ++]
		if (chara.host != null || (chara != EMono.pc && chara != LayerDrama.alwaysVisible && (flag3 || fogged || (!showAllCards && !EMono.player.CanSee(chara))))) // [!code ++]
		{
			goto IL_6f65; // [!code --]
			continue; // [!code ++]
		}
		if (this.cell._block == 0 || !this.cell.sourceBlock.tileType.RepeatBlock) // [!code --]
		_actorPos.x = orgX; // [!code ++]
		_actorPos.y = orgY; // [!code ++]
		_actorPos.z = orgZ; // [!code ++]
		chara.SetRenderParam(param); // [!code ++]
		_ = chara.IsAliveInCurrentZone; // [!code ++]
		if (chara.isRestrained) // [!code ++]
		{
			Room obj = this.cell.FrontRight.room; // [!code --]
			if (obj == null || !obj.HasRoof) // [!code --]
			TraitShackle restrainer = chara.GetRestrainer(); // [!code ++]
			if (restrainer != null) // [!code ++]
			{ // [!code ++]
				Vector3 getRestrainPos = restrainer.GetRestrainPos; // [!code ++]
				if (getRestrainPos != default(Vector3)) // [!code ++]
				{ // [!code ++]
					Vector3 position = restrainer.owner.renderer.position; // [!code ++]
					float defCharaHeight = EMono.setting.render.defCharaHeight; // [!code ++]
					float num30 = getRestrainPos.y + defCharaHeight - ((chara.Pref.height == 0f) ? defCharaHeight : chara.source.pref.height); // [!code ++]
					_actorPos.x = position.x + getRestrainPos.x * (float)((restrainer.owner.dir % 2 == 0) ? 1 : (-1)); // [!code ++]
					_actorPos.y = position.y + num30; // [!code ++]
					_actorPos.z = position.z + getRestrainPos.z; // [!code ++]
					param.liquidLv = 0; // [!code ++]
					param.shadowFix = orgY - _actorPos.y; // [!code ++]
					chara.renderer.SetFirst(first: true); // [!code ++]
					chara.renderer.Draw(param, ref _actorPos, drawShadow: true); // [!code ++]
					param.shadowFix = 0f; // [!code ++]
					continue; // [!code ++]
				} // [!code ++]
			} // [!code ++]
		} // [!code ++]
		if (!chara.sourceCard.multisize || (chara.pos.x == cx && chara.pos.z == cz)) // [!code ++]
		{ // [!code ++]
			if (chara.IsDeadOrSleeping && chara.IsPCC) // [!code ++]
			{ // [!code ++]
				float num31 = chara.renderer.data.size.y * 0.3f; // [!code ++]
				if (thingPos.y > max) // [!code ++]
				{ // [!code ++]
					thingPos.y = max; // [!code ++]
				} // [!code ++]
				float num32 = thingPos.y + num31; // [!code ++]
				float num33 = (float)n * -0.01f; // [!code ++]
				if (num32 > zSetting.thresh1) // [!code ++]
				{ // [!code ++]
					num33 = zSetting.mod1; // [!code ++]
				} // [!code ++]
				_actorPos.x += thingPos.x; // [!code ++]
				_actorPos.y += thingPos.y; // [!code ++]
				_actorPos.z += renderSetting.laydownZ + num33; // [!code ++]
				param.liquidLv = ((thingPos.y == 0f && liquidLv > 0) ? 90 : 0); // [!code ++]
				thingPos.y += num31 * 0.8f; // [!code ++]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{
				goto IL_6f65; // [!code --]
				param.liquidLv = liquidLv; // [!code ++]
				if (isUnderwater) // [!code ++]
				{ // [!code ++]
					if (chara.Pref.FloatUnderwater) // [!code ++]
					{ // [!code ++]
						float num34 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
						float num35 = floatYs[chara.uid % 10] + 10f + (float)(chara.uid % 30); // [!code ++]
						orgY += 0.01f * num35 - num34; // [!code ++]
						_actorPos.y += 0.01f * num35 - num34; // [!code ++]
						param.shadowFix -= 0.01f * num35 - num34; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				else if (liquidLv > 0) // [!code ++]
				{ // [!code ++]
					if (chara.Pref.Float && !flag && !hasBridge) // [!code ++]
					{ // [!code ++]
						if (liquidLv > 20) // [!code ++]
						{ // [!code ++]
							float num36 = ((this.cell._bridge != 0) ? sourceBridge.tileType.FloorHeight : sourceFloor.tileType.FloorHeight); // [!code ++]
							orgY += 0.01f * floatY - num36; // [!code ++]
							_actorPos.y += 0.01f * floatY - num36; // [!code ++]
							int num37 = TileType.FloorWaterShallow.LiquidLV * 10; // [!code ++]
							num37 -= (int)(floatY * 0.5f); // [!code ++]
							param.liquidLv = num37; // [!code ++]
						} // [!code ++]
						else // [!code ++]
						{ // [!code ++]
							param.liquidLv -= 20; // [!code ++]
						} // [!code ++]
					} // [!code ++]
					param.liquidLv += chara.Pref.liquidMod; // [!code ++]
					if (param.liquidLv < 1) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 1; // [!code ++]
					} // [!code ++]
					else if (param.liquidLv > 99 + chara.Pref.liquidModMax) // [!code ++]
					{ // [!code ++]
						param.liquidLv = 99 + chara.Pref.liquidModMax; // [!code ++]
					} // [!code ++]
				} // [!code ++]
				if (!chara.IsPC && !chara.renderer.IsMoving && detail.charas.Count > 1 && (detail.charas.Count != 2 || !detail.charas[0].IsDeadOrSleeping || !detail.charas[0].IsPCC)) // [!code ++]
				{ // [!code ++]
					_actorPos += renderSetting.charaPos[1 + ((num21 < 4) ? num21 : 3)]; // [!code ++]
				} // [!code ++]
				_actorPos.z += 0.01f * (float)n + renderSetting.charaZ; // [!code ++]
				num21++; // [!code ++]
				if (flag10) // [!code ++]
				{ // [!code ++]
					_actorPos.z += chara.renderer.data.hangedFixZ; // [!code ++]
				} // [!code ++]
				chara.renderer.Draw(param, ref _actorPos, liquidLv == 0); // [!code ++]
			}
		}
		param.x = orgX; // [!code ++]
		param.y = orgY; // [!code ++]
		param.z = orgZ; // [!code ++]
	}
	goto IL_6fc5; // [!code --]
	void Draw(int tile)
	{
		pass = passEdge;
```

## Biography

[`@@ -462,21 +462,19 @@ public void SetGender(int g)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/Biography.cs#L462-L482)
```cs:line-numbers=462

	public void SetPortrait(Chara c)
	{
		string id = c.id; // [!code --]
		if (!(id == "shojo")) // [!code --]
		{ // [!code --]
			if (id == "sister") // [!code --]
			{ // [!code --]
				c.c_idPortrait = Portrait.GetRandomPortrait("special_f-littlesister"); // [!code --]
			} // [!code --]
			else // [!code --]
			{ // [!code --]
				c.c_idPortrait = Portrait.GetRandomPortrait(gender, c.GetIdPortraitCat()); // [!code --]
			} // [!code --]
		} // [!code --]
		else // [!code --]
		switch (c.id) // [!code ++]
		{
		case "shojo": // [!code ++]
			c.c_idPortrait = Portrait.GetRandomPortrait("special_f-littlegirl");
			break; // [!code ++]
		case "sister": // [!code ++]
		case "sister_shark": // [!code ++]
		case "sister_penguin": // [!code ++]
			c.c_idPortrait = Portrait.GetRandomPortrait("special_f-littlesister"); // [!code ++]
			break; // [!code ++]
		default: // [!code ++]
			c.c_idPortrait = Portrait.GetRandomPortrait(gender, c.GetIdPortraitCat()); // [!code ++]
			break; // [!code ++]
		}
	}

```

## ConBuffStats

[`@@ -27,7 +27,7 @@ public override ConditionType Type`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ConBuffStats.cs#L27-L33)
```cs:line-numbers=27

	public override int EvaluateTurn(int p)
	{
		if (base.refVal2 == 267) // [!code --]
		if (base.refVal2 == 268) // [!code ++]
		{
			return 7;
		}
```

[`@@ -95,7 +95,7 @@ public override void SetOwner(Chara _owner, bool onDeserialize = false)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ConBuffStats.cs#L95-L101)
```cs:line-numbers=95

	public int CalcValue()
	{
		if (base.refVal2 == 267) // [!code --]
		if (base.refVal2 == 268) // [!code ++]
		{
			return 100 + (int)Mathf.Sqrt(base.power) * 2;
		}
```

## ELEMENT

[`@@ -624,7 +624,7 @@ public void _WriteNote(UINote n, Chara c, Act act)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/ELEMENT.cs#L624-L630)
```cs:line-numbers=624
				switch (act.id)
				{
				case 6902:
					condition.SetRefVal(79, 267); // [!code --]
					condition.SetRefVal(79, 268); // [!code ++]
					break;
				case 8510:
				case 8710:
```

## EffectId

[`@@ -80,40 +80,41 @@ public enum EffectId`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/EffectId.cs#L80-L119)
```cs:line-numbers=80
	Buff = 256,
	Debuff = 257,
	Weaken = 258,
	Bubble = 259, // [!code --]
	Web = 260, // [!code --]
	MistOfDarkness = 261, // [!code --]
	NeckHunt = 262, // [!code --]
	Puddle = 263, // [!code --]
	PuddleEffect = 264, // [!code --]
	RemedyJure = 265, // [!code --]
	AbsorbMana = 266, // [!code --]
	LulwyTrick = 267, // [!code --]
	JureHeal = 268, // [!code --]
	KizuamiTrick = 269, // [!code --]
	CureCorruption = 270, // [!code --]
	Headpat = 271, // [!code --]
	Meteor = 272, // [!code --]
	Exterminate = 273, // [!code --]
	Earthquake = 274, // [!code --]
	MagicMap = 275, // [!code --]
	Escape = 276, // [!code --]
	Boost = 277, // [!code --]
	EnchantWeaponGreat = 278, // [!code --]
	EnchantArmorGreat = 279, // [!code --]
	RemoveHex = 280, // [!code --]
	RemoveHexAll = 281, // [!code --]
	Duplicate = 282, // [!code --]
	Suicide = 283, // [!code --]
	ShutterHex = 284, // [!code --]
	Draw = 285, // [!code --]
	Reconstruction = 286, // [!code --]
	DrainBlood = 287, // [!code --]
	Steal = 288, // [!code --]
	Scream = 289, // [!code --]
	DropMine = 290, // [!code --]
	ThrowPotion = 291, // [!code --]
	DrainMana = 292, // [!code --]
	Swarm = 293, // [!code --]
	Sword = 294 // [!code --]
	DebuffKizuami = 259, // [!code ++]
	Bubble = 260, // [!code ++]
	Web = 261, // [!code ++]
	MistOfDarkness = 262, // [!code ++]
	NeckHunt = 263, // [!code ++]
	Puddle = 264, // [!code ++]
	PuddleEffect = 265, // [!code ++]
	RemedyJure = 266, // [!code ++]
	AbsorbMana = 267, // [!code ++]
	LulwyTrick = 268, // [!code ++]
	JureHeal = 269, // [!code ++]
	KizuamiTrick = 270, // [!code ++]
	CureCorruption = 271, // [!code ++]
	Headpat = 272, // [!code ++]
	Meteor = 273, // [!code ++]
	Exterminate = 274, // [!code ++]
	Earthquake = 275, // [!code ++]
	MagicMap = 276, // [!code ++]
	Escape = 277, // [!code ++]
	Boost = 278, // [!code ++]
	EnchantWeaponGreat = 279, // [!code ++]
	EnchantArmorGreat = 280, // [!code ++]
	RemoveHex = 281, // [!code ++]
	RemoveHexAll = 282, // [!code ++]
	Duplicate = 283, // [!code ++]
	Suicide = 284, // [!code ++]
	ShutterHex = 285, // [!code ++]
	Draw = 286, // [!code ++]
	Reconstruction = 287, // [!code ++]
	DrainBlood = 288, // [!code ++]
	Steal = 289, // [!code ++]
	Scream = 290, // [!code ++]
	DropMine = 291, // [!code ++]
	ThrowPotion = 292, // [!code ++]
	DrainMana = 293, // [!code ++]
	Swarm = 294, // [!code ++]
	Sword = 295 // [!code ++]
}
```

## EloMap

[`@@ -378,6 +378,10 @@ public bool CanBuildSite(int gx, int gy, int radius = 0, ElomapSiteType type = E`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/EloMap.cs#L378-L383)
```cs:line-numbers=378
		return false;
	}
	SourceGlobalTile.Row row = GetSources(gx, gy).LastItem();
	if (row == null) // [!code ++]
	{ // [!code ++]
		return false; // [!code ++]
	} // [!code ++]
	switch (type)
	{
	case ElomapSiteType.NefiaWater:
```

## GameDate

[`@@ -193,6 +193,10 @@ public void AdvanceDay()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/GameDate.cs#L193-L198)
```cs:line-numbers=193
	{
		EClass.game.quests.Add("fiama_starter_gift", "fiama");
	}
	if (EClass.game.quests.completedIDs.Contains("demitas_spellwriter") && !EClass.game.quests.IsAdded<QuestNegotiationDarkness>()) // [!code ++]
	{ // [!code ++]
		EClass.game.quests.Add("negotiation_darkness", "loytel"); // [!code ++]
	} // [!code ++]
	if (EClass.game.quests.IsCompleted("exploration"))
	{
		EClass.player.flags.daysAfterQuestExploration++;
```

## PrefFlag

[`@@ -6,5 +6,6 @@ public enum PrefFlag`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/PrefFlag.cs#L6-L10)
```cs:line-numbers=6
	UsePref = 1,
	Test1 = 2,
	Float = 4,
	Surface = 8 // [!code --]
	Surface = 8, // [!code ++]
	FloatUnderwater = 0x10 // [!code ++]
}
```

## QuestManager

[`@@ -124,6 +124,22 @@ public void OnAdvanceHour()`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/QuestManager.cs#L124-L129)
```cs:line-numbers=124
		});
	}

	public bool IsAdded<T>() where T : Quest // [!code ++]
	{ // [!code ++]
		if (IsStarted<T>()) // [!code ++]
		{ // [!code ++]
			return true; // [!code ++]
		} // [!code ++]
		foreach (Quest global in globalList) // [!code ++]
		{ // [!code ++]
			if (global is T) // [!code ++]
			{ // [!code ++]
				return true; // [!code ++]
			} // [!code ++]
		} // [!code ++]
		return false; // [!code ++]
	} // [!code ++]
 // [!code ++]
	public bool IsStarted<T>() where T : Quest
	{
		return GetPhase<T>() != -1;
```

## +QuestNegotiationDarkness

::: details File Created
```cs
public class QuestNegotiationDarkness : QuestProgression
{
	public override string TitlePrefix => "";

	public override bool CanUpdateOnTalk(Chara c)
	{
		return false;
	}
}
```

:::
## SourcePref

[`@@ -313,6 +313,8 @@ public bool bypassShadow`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/SourcePref.cs#L313-L318)
```cs:line-numbers=313

	public bool Surface => (ints[1] & 8) != 0;

	public bool FloatUnderwater => (ints[1] & 0x10) != 0; // [!code ++]
 // [!code ++]
	public void OnAfterDeserialize()
	{
		if (ints.Length >= 25)
```

## Thing

[`@@ -1594,7 +1594,7 @@ public override bool CanStackTo(Thing to)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/Thing.cs#L1594-L1600)
```cs:line-numbers=1594
	{
		return false;
	}
	if (to.c_priceAdd != base.c_priceAdd || to.c_priceFix != base.c_priceFix) // [!code --]
	if (to.c_priceAdd != base.c_priceAdd || to.c_priceFix != base.c_priceFix || to.c_priceCopy != base.c_priceCopy) // [!code ++]
	{
		return false;
	}
```

## TraitDeed

[`@@ -13,21 +13,28 @@ public override void OnRead(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/TraitDeed.cs#L13-L33)
```cs:line-numbers=13
		}
		Dialog.YesNo("dialog_claimLand", delegate
		{
			EClass._zone.ClaimZone(); // [!code --]
			owner.ModNum(-1); // [!code --]
			WidgetMenuPanel.OnChangeMode(); // [!code --]
			if (EClass._zone == EClass.game.StartZone) // [!code --]
			if (EClass._zone.GetInt(2) != 0) // [!code ++]
			{
				if (EClass.game.quests.Get<QuestHome>() != null) // [!code --]
				{ // [!code --]
					EClass.game.quests.Home.ChangePhase(1); // [!code --]
				} // [!code --]
				if (QuestMain.Phase < 200) // [!code --]
				Msg.Say("claimCooldown2"); // [!code ++]
			} // [!code ++]
			else // [!code ++]
			{ // [!code ++]
				EClass._zone.ClaimZone(); // [!code ++]
				owner.ModNum(-1); // [!code ++]
				WidgetMenuPanel.OnChangeMode(); // [!code ++]
				if (EClass._zone == EClass.game.StartZone) // [!code ++]
				{
					EClass.game.quests.Main.ChangePhase(200); // [!code --]
					if (EClass.game.quests.Get<QuestHome>() != null) // [!code ++]
					{ // [!code ++]
						EClass.game.quests.Home.ChangePhase(1); // [!code ++]
					} // [!code ++]
					if (QuestMain.Phase < 200) // [!code ++]
					{ // [!code ++]
						EClass.game.quests.Main.ChangePhase(200); // [!code ++]
					} // [!code ++]
				}
				EClass.player.EndTurn(); // [!code ++]
			}
			EClass.player.EndTurn(); // [!code --]
		});
	}
}
```

## TraitDrinkMilkMother

[`@@ -82,6 +82,7 @@ public override void OnDrink(Chara c)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/TraitDrinkMilkMother.cs#L82-L87)
```cs:line-numbers=82
			case "duck":
			case "shamo":
			case "penguin":
			case "penguin_emperor": // [!code ++]
				c.idSkin = 0;
				break;
			}
```

## TraitFoodEggFertilized

[`@@ -82,6 +82,7 @@ public static void MakeBaby(Chara c, int baby)`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/TraitFoodEggFertilized.cs#L82-L87)
```cs:line-numbers=82
	case "chicken":
	case "duck":
	case "penguin":
	case "penguin_emperor": // [!code ++]
		c.idSkin = 1;
		break;
	}
```

## Zone_Exile

[`@@ -1,3 +1,10 @@`](https://github.com/Elin-Modding-Resources/Elin-Decompiled/blob/f1b66de9c8713b507d73ddfd9e943861a12a29a6/Elin/Zone_Exile.cs#L1-L3)
```cs:line-numbers=1
public class Zone_Exile : Zone_SubTown
{
	public override void OnActivate() // [!code ++]
	{ // [!code ++]
		if (EClass.game.quests.GetPhase<QuestNegotiationDarkness>() == 0) // [!code ++]
		{ // [!code ++]
			EClass.game.quests.Get<QuestNegotiationDarkness>().NextPhase(); // [!code ++]
		} // [!code ++]
	} // [!code ++]
}
```
